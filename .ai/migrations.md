# Migration Rules

## ⚠️ КРИТИЧЕСКИ ВАЖНОЕ ПРАВИЛО

**ВСЕ изменения структуры и данных в базе данных должны производиться ТОЛЬКО через миграции!**

- ❌ **ЗАПРЕЩЕНО** выполнять прямые SQL запросы для изменения схемы или данных через psql
- ✅ **ОБЯЗАТЕЛЬНО** создавать миграции для ЛЮБЫХ изменений в БД
- ✅ **ОБЯЗАТЕЛЬНО** проверять возможность отката миграции

## Основные правила

- Директория для миграций - [@backend/migrations](backend/migrations)
- Каждая миграция должна иметь up и down файл
- Файлы именуем как `<migration-number>_<migration-short-description>.<up/down>.sql`
- Старайся не использовать SQL триггеры в миграциях

## Fixtures (тестовые данные)

Мигратор поддерживает загрузку фикстур - тестовых данных для разработки и тестирования.

### Флаги мигратора

- `--with-fixtures` - применить миграции и загрузить фикстуры
- `--only-fixtures` - загрузить только фикстуры (без применения миграций)

### Переменные окружения

- `MIGRATIONS_FIXTURES_PATH` - путь к директории с SQL файлами фикстур (по умолчанию: `fixtures`)
- `MIGRATIONS_FIXTURES_TABLE` - имя таблицы для отслеживания примененных фикстур (по умолчанию: `fixtures_applied`)

### Примеры использования

```bash
# Применить миграции и загрузить фикстуры
./migrator migrate --with-fixtures

# Загрузить только фикстуры (миграции не применяются)
./migrator migrate --only-fixtures

# Использовать кастомный путь к фикстурам
MIGRATIONS_FIXTURES_PATH=./test-fixtures ./migrator migrate --with-fixtures

# Использовать кастомную таблицу для отслеживания фикстур
MIGRATIONS_FIXTURES_TABLE=test_fixtures_applied ./migrator migrate --only-fixtures
```

### Организация фикстур

- Фикстуры размещаются в директории, указанной в `MIGRATIONS_FIXTURES_PATH`
- Файлы фикстур должны иметь расширение `.sql`
- Фикстуры применяются в алфавитном порядке
- Каждая фикстура применяется только один раз (отслеживается в таблице `MIGRATIONS_FIXTURES_TABLE`)
