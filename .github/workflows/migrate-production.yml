name: Migrate - Production

on:
    workflow_dispatch:
        inputs:
            migration_direction:
                description: 'Migration direction'
                required: true
                default: 'up'
                type: choice
                options:
                    - up
                    - down
            target_version:
                description: 'Target migration version (optional, e.g. 000050)'
                required: false
                type: string

env:
    MIGRATOR_IMAGE: svetu/migrator

jobs:
    migrate:
        runs-on: ubuntu-latest
        steps:
            -   name: Checkout code
                uses: actions/checkout@v3

            # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ SSH –∫–ª—é—á–∞ –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É
            -   name: Setup SSH key
                uses: webfactory/ssh-agent@v0.7.0
                with:
                    ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

            # –î–æ–±–∞–≤–ª–µ–Ω–∏–µ host key –≤ known hosts
            -   name: Add host key to known hosts
                run: |
                    mkdir -p ~/.ssh
                    ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts

            # –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
            -   name: Run migration on production
                run: |
                    echo "üöÄ Running database migration..."
                    
                    ssh ${{ secrets.SSH_USER }}@${{ secrets.SERVER_HOST }} << 'EOF'
                      set -e
                      
                      cd /opt/svetu
                      
                      # –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
                      source .env
                      
                      # –°–∫–∞—á–∏–≤–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π –æ–±—Ä–∞–∑ –º–∏–≥—Ä–∞—Ç–æ—Ä–∞
                      echo "üì• Pulling migrator image..."
                      docker pull ${{ secrets.DOCKER_REGISTRY }}/${{ env.MIGRATOR_IMAGE }}:latest
                      
                      # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö
                      DB_CONTAINER=$(docker ps --format "{{.Names}}" | grep -E "db|postgres" | head -n 1)
                      if [ -z "$DB_CONTAINER" ]; then
                        echo "‚ùå Database container not found"
                        exit 1
                      fi
                      echo "üìä Using database container: $DB_CONTAINER"
                      
                      # –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è –º–∏–≥—Ä–∞—Ü–∏–∏
                      if [ "${{ github.event.inputs.migration_direction }}" = "up" ]; then
                        if [ -n "${{ github.event.inputs.target_version }}" ]; then
                          echo "üîº Running migration UP to version ${{ github.event.inputs.target_version }}..."
                        else
                          echo "üîº Running migration UP to latest..."
                        fi
                      else
                        if [ -n "${{ github.event.inputs.target_version }}" ]; then
                          echo "üîΩ Running migration DOWN to version ${{ github.event.inputs.target_version }}..."
                        else
                          echo "üîΩ Running migration DOWN (reverts ALL migrations)..."
                          echo "‚ö†Ô∏è  WARNING: This will revert ALL migrations!"
                        fi
                      fi
                      
                      # –ó–∞–ø—É—Å–∫ –º–∏–≥—Ä–∞—Ü–∏–∏
                      docker run --rm --network svetu_default \
                        -e DATABASE_URL="postgres://${POSTGRES_USER}:${POSTGRES_PASSWORD}@${DB_CONTAINER}:5432/${POSTGRES_DB}?sslmode=disable" \
                        -e MIGRATIONS_PATH="/migrations" \
                        -e MIGRATION_DIRECTION="${{ github.event.inputs.migration_direction }}" \
                        -e MIGRATION_TARGET="${{ github.event.inputs.target_version }}" \
                        ${{ secrets.DOCKER_REGISTRY }}/${{ env.MIGRATOR_IMAGE }}:latest
                      
                      echo "‚úÖ Migration completed successfully"
                    EOF

            # –û–ø–æ–≤–µ—â–µ–Ω–∏–µ –æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏
            -   name: Migration notification
                if: always()
                run: |
                    echo "Migration ${{ job.status }}"