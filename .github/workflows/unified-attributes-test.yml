name: Unified Attributes System Tests

on:
  push:
    branches:
      - main
      - feature/unified-attributes
      - feature/improvements-*
    paths:
      - 'backend/internal/services/attributes/**'
      - 'backend/internal/proj/marketplace/handler/unified_*.go'
      - 'backend/internal/storage/postgres/unified_*.go'
      - 'backend/migrations/*unified*.sql'
      - 'frontend/svetu/src/components/shared/Unified*.tsx'
      - 'frontend/svetu/src/services/unified*.ts'
      - '.github/workflows/unified-attributes-test.yml'
  pull_request:
    branches:
      - main
    paths:
      - 'backend/internal/services/attributes/**'
      - 'backend/internal/proj/marketplace/handler/unified_*.go'
      - 'backend/internal/storage/postgres/unified_*.go'
      - 'backend/migrations/*unified*.sql'
      - 'frontend/svetu/src/components/shared/Unified*.tsx'
      - 'frontend/svetu/src/services/unified*.ts'

env:
  GO_VERSION: '1.23'
  NODE_VERSION: '20.15'
  POSTGRES_VERSION: '16'

permissions:
  contents: read
  packages: read

jobs:
  backend-tests:
    name: Backend Tests
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: testpassword
          POSTGRES_DB: testdb
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
      redis:
        image: redis:alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure Git for private modules
        run: |
          git config --global url."https://${{ secrets.PRIVATE_MODULES_TOKEN }}@github.com/".insteadOf "https://github.com/"

      - name: Set GOPRIVATE
        run: echo "GOPRIVATE=github.com/sveturs/*" >> $GITHUB_ENV

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true
          cache-dependency-path: backend/go.sum

      - name: Install dependencies
        working-directory: backend
        run: |
          go mod download
          go install gotest.tools/gotestsum@latest

      - name: Run migrations
        working-directory: backend
        env:
          DATABASE_URL: postgres://postgres:testpassword@localhost:5432/testdb?sslmode=disable
        run: |
          go build -o migrator ./cmd/migrator/migrator.go
          ./migrator up

      - name: Run unified attributes tests
        working-directory: backend
        env:
          DATABASE_URL: postgres://postgres:testpassword@localhost:5432/testdb?sslmode=disable
          REDIS_URL: redis://localhost:6379
          USE_UNIFIED_ATTRIBUTES: true
          UNIFIED_ATTRIBUTES_FALLBACK: true
          DUAL_WRITE_ATTRIBUTES: true
        run: |
          gotestsum --format testname -- \
            ./internal/services/attributes/... \
            ./internal/proj/marketplace/handler/unified_attributes_test.go \
            -v -race -coverprofile=coverage.txt -covermode=atomic

      - name: Check test coverage
        working-directory: backend
        run: |
          go tool cover -func=coverage.txt
          COVERAGE=$(go tool cover -func=coverage.txt | grep total | awk '{print $3}' | sed 's/%//')
          echo "Coverage: $COVERAGE%"
          if (( $(echo "$COVERAGE < 80" | bc -l) )); then
            echo "Coverage is below 80%"
            exit 1
          fi

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          file: ./backend/coverage.txt
          flags: backend-unified-attributes

  frontend-tests:
    name: Frontend Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'yarn'
          cache-dependency-path: frontend/svetu/yarn.lock

      - name: Install dependencies
        working-directory: frontend/svetu
        run: yarn install --frozen-lockfile

      - name: Run unified attributes component tests
        working-directory: frontend/svetu
        env:
          NEXT_PUBLIC_USE_UNIFIED_ATTRIBUTES: true
          NEXT_PUBLIC_UNIFIED_ATTRIBUTES_FALLBACK: true
        run: |
          yarn test:ci \
            --testPathPattern="Unified" \
            --coverage \
            --coverageDirectory=coverage

      - name: Check test coverage
        working-directory: frontend/svetu
        run: |
          COVERAGE=$(cat coverage/coverage-summary.json | jq '.total.lines.pct')
          echo "Coverage: $COVERAGE%"
          if (( $(echo "$COVERAGE < 80" | bc -l) )); then
            echo "Coverage is below 80%"
            exit 1
          fi

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          directory: ./frontend/svetu/coverage
          flags: frontend-unified-attributes

  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: [backend-tests, frontend-tests]
    
    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: testpassword
          POSTGRES_DB: testdb
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
      redis:
        image: redis:alpine
        ports:
          - 6379:6379

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure Git for private modules
        run: |
          git config --global url."https://${{ secrets.PRIVATE_MODULES_TOKEN }}@github.com/".insteadOf "https://github.com/"

      - name: Set GOPRIVATE
        run: echo "GOPRIVATE=github.com/sveturs/*" >> $GITHUB_ENV

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Start backend
        working-directory: backend
        env:
          DATABASE_URL: postgres://postgres:testpassword@localhost:5432/testdb?sslmode=disable
          REDIS_URL: redis://localhost:6379
          USE_UNIFIED_ATTRIBUTES: true
          UNIFIED_ATTRIBUTES_FALLBACK: true
          DUAL_WRITE_ATTRIBUTES: true
          PORT: 3000
        run: |
          go mod download
          go build -o migrator ./cmd/migrator/migrator.go
          ./migrator up
          go run ./cmd/api/main.go &
          sleep 5
          curl -f http://localhost:3000/health/ready || exit 1

      - name: Run dual-write validation
        working-directory: backend
        env:
          API_URL: http://localhost:3000
        run: |
          # Test dual-write mechanism
          go run scripts/test_dual_write.go

      - name: Run fallback tests
        working-directory: backend
        env:
          DATABASE_URL: postgres://postgres:testpassword@localhost:5432/testdb?sslmode=disable
        run: |
          # Test fallback mechanism
          go run scripts/test_fallback.go

  load-tests:
    name: Load Tests
    runs-on: ubuntu-latest
    needs: integration-tests

    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: testpassword
          POSTGRES_DB: testdb
        ports:
          - 5432:5432
      redis:
        image: redis:alpine
        ports:
          - 6379:6379

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure Git for private modules
        run: |
          git config --global url."https://${{ secrets.PRIVATE_MODULES_TOKEN }}@github.com/".insteadOf "https://github.com/"

      - name: Set GOPRIVATE
        run: echo "GOPRIVATE=github.com/sveturs/*" >> $GITHUB_ENV

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Start backend with unified attributes
        working-directory: backend
        env:
          DATABASE_URL: postgres://postgres:testpassword@localhost:5432/testdb?sslmode=disable
          REDIS_URL: redis://localhost:6379
          USE_UNIFIED_ATTRIBUTES: true
          UNIFIED_ATTRIBUTES_FALLBACK: false
          DUAL_WRITE_ATTRIBUTES: false
          PORT: 3000
        run: |
          go build -o migrator ./cmd/migrator/migrator.go
          ./migrator up
          go run ./cmd/api/main.go &
          sleep 5

      - name: Install k6
        run: |
          sudo apt-get update
          sudo apt-get install -y gnupg software-properties-common
          sudo gpg -k
          sudo gpg --no-default-keyring --keyring /usr/share/keyrings/k6-archive-keyring.gpg --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys C5AD17C747E3415A3642D57D77C6C491D6AC1D69
          echo "deb [signed-by=/usr/share/keyrings/k6-archive-keyring.gpg] https://dl.k6.io/deb stable main" | sudo tee /etc/apt/sources.list.d/k6.list
          sudo apt-get update
          sudo apt-get install k6

      - name: Run k6 load tests
        run: |
          k6 run --out json=results.json backend/scripts/k6_unified_attributes.js

      - name: Analyze results
        run: |
          # Extract and check metrics
          cat results.json | jq -s '
            . | 
            map(select(.type == "Point" and .metric == "http_req_duration" and .data.tags.status == "200")) | 
            map(.data.value) |
            {
              p95: (sort | .[floor(length * 0.95)]),
              p99: (sort | .[floor(length * 0.99)]),
              max: max,
              min: min,
              avg: (add / length)
            }
          '
          
          # Check if p95 < 100ms
          P95=$(cat results.json | jq -s '
            . | 
            map(select(.type == "Point" and .metric == "http_req_duration")) | 
            map(.data.value) |
            sort | .[floor(length * 0.95)]
          ')
          
          if (( $(echo "$P95 > 100" | bc -l) )); then
            echo "P95 latency is above 100ms: ${P95}ms"
            exit 1
          fi

  migration-test:
    name: Migration Rollback Test
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: testpassword
          POSTGRES_DB: testdb
        ports:
          - 5432:5432

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure Git for private modules
        run: |
          git config --global url."https://${{ secrets.PRIVATE_MODULES_TOKEN }}@github.com/".insteadOf "https://github.com/"

      - name: Set GOPRIVATE
        run: echo "GOPRIVATE=github.com/sveturs/*" >> $GITHUB_ENV

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Test migration up and down
        working-directory: backend
        env:
          DATABASE_URL: postgres://postgres:testpassword@localhost:5432/testdb?sslmode=disable
        run: |
          go build -o migrator ./cmd/migrator/migrator.go
          
          # Apply all migrations
          ./migrator up
          
          # Rollback unified attributes migrations
          ./migrator rollback --steps 2
          
          # Re-apply migrations
          ./migrator up
          
          # Verify data integrity
          go run scripts/verify_migration_integrity.go

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: 'trivy-results.sarif'

      - name: Check for SQL injection vulnerabilities
        working-directory: backend
        run: |
          # Check for potential SQL injection in unified attributes code
          grep -r "fmt.Sprintf.*SELECT\|UPDATE\|INSERT\|DELETE" internal/services/attributes/ || true
          grep -r "\"SELECT.*\+.*\"" internal/services/attributes/ || true