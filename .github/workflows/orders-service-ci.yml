name: Orders Service CI/CD

on:
  push:
    branches: [ main, develop, feature/orders-* ]
  pull_request:
    branches: [ main, develop ]

env:
  GO_VERSION: '1.23'
  CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: golangci-lint
        uses: golangci/golangci-lint-action@v4
        with:
          version: latest
          args: --timeout=5m

  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_DB: listings_db_test
          POSTGRES_USER: listings_user
          POSTGRES_PASSWORD: listings_password
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Cache Go modules
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-

      - name: Download dependencies
        run: go mod download

      - name: Run unit tests with coverage
        env:
          SVETULISTINGS_DB_HOST: localhost
          SVETULISTINGS_DB_PORT: 5432
          SVETULISTINGS_DB_USER: listings_user
          SVETULISTINGS_DB_PASSWORD: listings_password
          SVETULISTINGS_DB_NAME: listings_db_test
          SVETULISTINGS_REDIS_HOST: localhost
          SVETULISTINGS_REDIS_PORT: 6379
        run: |
          go test -v -race -coverprofile=coverage.txt -covermode=atomic -short \
            ./internal/... \
            ./pkg/...

      - name: Generate coverage report
        run: |
          go tool cover -func=coverage.txt > coverage_report.txt
          cat coverage_report.txt

      - name: Check coverage threshold
        run: |
          COVERAGE=$(go tool cover -func=coverage.txt | grep total | awk '{print $3}' | sed 's/%//')
          echo "Total coverage: $COVERAGE%"
          if (( $(echo "$COVERAGE < 80" | bc -l) )); then
            echo "❌ Coverage $COVERAGE% is below 80% threshold"
            exit 1
          else
            echo "✅ Coverage $COVERAGE% meets threshold"
          fi

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          file: ./coverage.txt
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false

  integration-tests:
    name: Integration Tests (E2E)
    runs-on: ubuntu-latest
    needs: [lint, unit-tests]
    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_DB: listings_db_test
          POSTGRES_USER: listings_user
          POSTGRES_PASSWORD: listings_password
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      opensearch:
        image: opensearchproject/opensearch:2.11.0
        env:
          discovery.type: single-node
          OPENSEARCH_JAVA_OPTS: "-Xms512m -Xmx512m"
          DISABLE_SECURITY_PLUGIN: true
        ports:
          - 9200:9200
        options: >-
          --health-cmd "curl -f http://localhost:9200/_cluster/health || exit 1"
          --health-interval 30s
          --health-timeout 10s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Cache Go modules
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-

      - name: Run database migrations
        env:
          SVETULISTINGS_DB_HOST: localhost
          SVETULISTINGS_DB_PORT: 5432
          SVETULISTINGS_DB_USER: listings_user
          SVETULISTINGS_DB_PASSWORD: listings_password
          SVETULISTINGS_DB_NAME: listings_db_test
        run: |
          # Run migrations using golang-migrate or your migrator
          # For now, using go test which handles migrations
          echo "Migrations will be handled by test setup"

      - name: Run E2E tests (Orders)
        env:
          SVETULISTINGS_DB_HOST: localhost
          SVETULISTINGS_DB_PORT: 5432
          SVETULISTINGS_DB_USER: listings_user
          SVETULISTINGS_DB_PASSWORD: listings_password
          SVETULISTINGS_DB_NAME: listings_db_test
          SVETULISTINGS_REDIS_HOST: localhost
          SVETULISTINGS_REDIS_PORT: 6379
          SVETULISTINGS_OPENSEARCH_HOST: localhost
          SVETULISTINGS_OPENSEARCH_PORT: 9200
        run: |
          # Run integration tests for Orders domain
          go test -v -timeout=10m -tags=integration \
            ./internal/transport/grpc/... \
            ./test/integration/...

      - name: Upload E2E test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-test-results
          path: |
            test-results/
            coverage.txt
          retention-days: 7

  performance-tests:
    name: Performance Tests
    runs-on: ubuntu-latest
    needs: [integration-tests]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_DB: listings_db_test
          POSTGRES_USER: listings_user
          POSTGRES_PASSWORD: listings_password
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Cache Go modules
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-

      - name: Run benchmark tests
        env:
          SVETULISTINGS_DB_HOST: localhost
          SVETULISTINGS_DB_PORT: 5432
          SVETULISTINGS_DB_USER: listings_user
          SVETULISTINGS_DB_PASSWORD: listings_password
          SVETULISTINGS_DB_NAME: listings_db_test
          SVETULISTINGS_REDIS_HOST: localhost
          SVETULISTINGS_REDIS_PORT: 6379
        run: |
          # Run Go benchmarks
          go test -bench=. -benchmem -benchtime=10s \
            -run=^$ \
            ./tests/performance/... \
            | tee benchmark_results.txt

      - name: Analyze benchmark results
        run: |
          echo "## Benchmark Results" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          cat benchmark_results.txt >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Upload benchmark results
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-results
          path: benchmark_results.txt
          retention-days: 30

      - name: Compare with baseline (if exists)
        continue-on-error: true
        run: |
          # Download previous benchmark results
          # Compare and fail if regression > 20%
          echo "Benchmark comparison will be implemented in future"

  build:
    name: Build
    runs-on: ubuntu-latest
    needs: [lint, unit-tests]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Cache Go modules
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-

      - name: Build Orders service
        run: |
          make build

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: orders-service-binary
          path: bin/listings-service
          retention-days: 7

  docker:
    name: Docker Build
    runs-on: ubuntu-latest
    needs: [build, integration-tests]
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop')
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub (optional)
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: |
            sveturs/listings-service
          tags: |
            type=ref,event=branch
            type=sha,prefix={{branch}}-
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  deploy-dev:
    name: Deploy to Dev Environment
    runs-on: ubuntu-latest
    needs: [docker]
    if: github.event_name == 'push' && github.ref == 'refs/heads/develop'
    environment:
      name: development
      url: https://dev.svetu.rs
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to dev server
        run: |
          echo "Deployment to dev environment will be configured"
          # Add actual deployment steps here

  summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [lint, unit-tests, integration-tests, build]
    if: always()
    steps:
      - name: Generate summary
        run: |
          echo "## CI/CD Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "✅ Lint: ${{ needs.lint.result }}" >> $GITHUB_STEP_SUMMARY
          echo "✅ Unit Tests: ${{ needs.unit-tests.result }}" >> $GITHUB_STEP_SUMMARY
          echo "✅ Integration Tests: ${{ needs.integration-tests.result }}" >> $GITHUB_STEP_SUMMARY
          echo "✅ Build: ${{ needs.build.result }}" >> $GITHUB_STEP_SUMMARY
