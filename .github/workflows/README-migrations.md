# üóÑÔ∏è Database Migration Workflows

–ü—Ä–æ—Å—Ç–∞—è —Å–∏—Å—Ç–µ–º–∞ –º–∏–≥—Ä–∞—Ü–∏–π –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–Ω —Å–µ—Ä–≤–µ—Ä–∞.

## üì¶ 1. Migrate - Build

**–§–∞–π–ª:** `.github/workflows/migrate-build.yml`

**–ß—Ç–æ –¥–µ–ª–∞–µ—Ç:** –°–æ–±–∏—Ä–∞–µ—Ç Docker –æ–±—Ä–∞–∑ —Å –º–∏–≥—Ä–∞—Ç–æ—Ä–æ–º –∏ –≤—Å–µ–º–∏ —Ñ–∞–π–ª–∞–º–∏ –º–∏–≥—Ä–∞—Ü–∏–π.

**–ó–∞–ø—É—Å–∫:** –†—É—á–Ω–æ–π —á–µ—Ä–µ–∑ GitHub Actions

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** 
- `harbor.svetu.rs/svetu/migrator:latest`
- `harbor.svetu.rs/svetu/migrator:TIMESTAMP`

## üöÄ 2. Migrate - Production

**–§–∞–π–ª:** `.github/workflows/migrate-production.yml`

**–ß—Ç–æ –¥–µ–ª–∞–µ—Ç:** –ó–∞–ø—É—Å–∫–∞–µ—Ç –º–∏–≥—Ä–∞—Ü–∏–∏ –Ω–∞ –ø—Ä–æ–¥–∞–∫—à–Ω —Å–µ—Ä–≤–µ—Ä–µ.

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:**
- `migration_direction` - up/down
- `target_version` - –∫–æ–Ω–∫—Ä–µ—Ç–Ω–∞—è –≤–µ—Ä—Å–∏—è –º–∏–≥—Ä–∞—Ü–∏–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –Ω–∞–ø—Ä–∏–º–µ—Ä: 000050)

**–ü—Ä–æ—Ü–µ—Å—Å:**
1. –ü–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è –∫ —Å–µ—Ä–≤–µ—Ä—É –ø–æ SSH
2. –°–∫–∞—á–∏–≤–∞–µ—Ç –ø–æ—Å–ª–µ–¥–Ω–∏–π –æ–±—Ä–∞–∑ –º–∏–≥—Ä–∞—Ç–æ—Ä–∞
3. –ó–∞–ø—É—Å–∫–∞–µ—Ç –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å –Ω—É–∂–Ω—ã–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏
4. –ü–µ—Ä–µ–¥–∞—ë—Ç –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –±–∞–∑–µ

## üîß –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

### –°–±–æ—Ä–∫–∞ –æ–±—Ä–∞–∑–∞ –º–∏–≥—Ä–∞—Ç–æ—Ä–∞

1. GitHub Actions ‚Üí Migrate - Build
2. Run workflow
3. –û–±—Ä–∞–∑ –±—É–¥–µ—Ç —Å–æ–±—Ä–∞–Ω –∏ –∑–∞–≥—Ä—É–∂–µ–Ω –≤ Harbor

### –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π (UP)

#### –í—Å–µ –Ω–æ–≤—ã–µ –º–∏–≥—Ä–∞—Ü–∏–∏
1. GitHub Actions ‚Üí Migrate - Production
2. –ü–∞—Ä–∞–º–µ—Ç—Ä—ã:
   - `migration_direction`: up
   - `target_version`: (–æ—Å—Ç–∞–≤–∏—Ç—å –ø—É—Å—Ç—ã–º)
3. Run workflow

#### –î–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –≤–µ—Ä—Å–∏–∏
1. GitHub Actions ‚Üí Migrate - Production
2. –ü–∞—Ä–∞–º–µ—Ç—Ä—ã:
   - `migration_direction`: up
   - `target_version`: 000050 (–Ω–æ–º–µ—Ä –≤–µ—Ä—Å–∏–∏)
3. Run workflow

### –û—Ç–∫–∞—Ç –º–∏–≥—Ä–∞—Ü–∏–π (DOWN)

#### –û—Ç–∫–∞—Ç –æ–¥–Ω–æ–π –º–∏–≥—Ä–∞—Ü–∏–∏
1. –ü–æ—Å–º–æ—Ç—Ä–∏—Ç–µ —Ç–µ–∫—É—â—É—é –≤–µ—Ä—Å–∏—é –≤ –±–∞–∑–µ
2. GitHub Actions ‚Üí Migrate - Production
3. –ü–∞—Ä–∞–º–µ—Ç—Ä—ã:
   - `migration_direction`: down
   - `target_version`: –ø—Ä–µ–¥—ã–¥—É—â–∞—è –≤–µ—Ä—Å–∏—è
4. Run workflow

#### –û—Ç–∫–∞—Ç –≤—Å–µ—Ö –º–∏–≥—Ä–∞—Ü–∏–π
‚ö†Ô∏è **–í–ù–ò–ú–ê–ù–ò–ï: –û—Ç–∫–∞—Ç—ã–≤–∞–µ—Ç –í–°–ï –º–∏–≥—Ä–∞—Ü–∏–∏!**

1. GitHub Actions ‚Üí Migrate - Production  
2. –ü–∞—Ä–∞–º–µ—Ç—Ä—ã:
   - `migration_direction`: down
   - `target_version`: (–æ—Å—Ç–∞–≤–∏—Ç—å –ø—É—Å—Ç—ã–º)
3. Run workflow

## üìã –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

### –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ

–í —Ñ–∞–π–ª–µ `/opt/svetu/.env`:
```bash
POSTGRES_USER=...
POSTGRES_PASSWORD=...
POSTGRES_DB=...
```

### Docker –∫–æ–º–∞–Ω–¥–∞ –¥–ª—è –º–∏–≥—Ä–∞—Ü–∏–π

```bash
docker run --rm --network svetu_default \
  -e DATABASE_URL="postgres://..." \
  -e MIGRATIONS_PATH="/migrations" \
  -e MIGRATION_DIRECTION="up" \
  -e MIGRATION_TARGET="000050" \
  harbor.svetu.rs/svetu/migrator:latest
```

### –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –º–∏–≥—Ä–∞—Ç–æ—Ä

- **–ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è:**
  - `DATABASE_URL` - —Å—Ç—Ä–æ–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
  - `MIGRATIONS_PATH` - –ø—É—Ç—å –∫ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ —Å –º–∏–≥—Ä–∞—Ü–∏—è–º–∏ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: "migrations")
  - `MIGRATION_DIRECTION` - –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–∏: up/down (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: "up")
  - `MIGRATION_TARGET` - —Ü–µ–ª–µ–≤–∞—è –≤–µ—Ä—Å–∏—è –º–∏–≥—Ä–∞—Ü–∏–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

- **–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:**
  - `up` - –ø—Ä–∏–º–µ–Ω–∏—Ç—å –≤—Å–µ –Ω–æ–≤—ã–µ –º–∏–≥—Ä–∞—Ü–∏–∏
  - `up` —Å `MIGRATION_TARGET` - –º–∏–≥—Ä–∏—Ä–æ–≤–∞—Ç—å –¥–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –≤–µ—Ä—Å–∏–∏
  - `down` - –æ—Ç–∫–∞—Ç–∏—Ç—å –í–°–ï –º–∏–≥—Ä–∞—Ü–∏–∏
  - `down` —Å `MIGRATION_TARGET` - –æ—Ç–∫–∞—Ç–∏—Ç—å –¥–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –≤–µ—Ä—Å–∏–∏

- **–û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å:**
  - –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –∞—Ä–≥—É–º–µ–Ω—Ç—ã –∫–æ–º–∞–Ω–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–∏: `migrator up` –∏–ª–∏ `migrator down`
  - –ï—Å–ª–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –Ω–µ –∑–∞–¥–∞–Ω—ã, –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é

## üîó –°–≤—è–∑–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

- `.github/workflows/migrate-build.yml` - —Å–±–æ—Ä–∫–∞ –æ–±—Ä–∞–∑–∞
- `.github/workflows/migrate-production.yml` - –∑–∞–ø—É—Å–∫ –º–∏–≥—Ä–∞—Ü–∏–π
- `backend/Dockerfile.migrator` - Dockerfile –¥–ª—è –º–∏–≥—Ä–∞—Ç–æ—Ä–∞
- `backend/migrations/` - —Ñ–∞–π–ª—ã –º–∏–≥—Ä–∞—Ü–∏–π

