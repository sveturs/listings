name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

env:
  GOPRIVATE: github.com/vondi-global/*

jobs:
  validate:
    name: Validate go.mod
    runs-on: [self-hosted, svetu]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check no replace directives in go.mod
        run: |
          if grep -q "^replace" go.mod; then
            echo "❌ ERROR: go.mod contains replace directives!"
            echo ""
            echo "Found replace directives:"
            grep "^replace" go.mod
            echo ""
            echo "Replace directives are for local development only."
            echo "Remove them before committing to main/develop."
            exit 1
          else
            echo "✅ No replace directives found in go.mod"
          fi

  lint:
    name: Lint
    runs-on: [self-hosted, svetu]
    needs: [validate]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure git for private modules
        run: git config --global url."https://${{ secrets.GO_MODULES_TOKEN }}@github.com/".insteadOf "https://github.com/"

      - name: Download dependencies
        env:
          GOPRIVATE: github.com/vondi-global/*
        run: |
          go mod download
          go mod tidy

      - name: golangci-lint
        uses: golangci/golangci-lint-action@v7
        with:
          version: v2.7.2
          args: --timeout=5m
        env:
          GOPRIVATE: github.com/vondi-global/*

  test:
    name: Test
    runs-on: [self-hosted, svetu]
    needs: [validate]
    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_DB: listings_db_test
          POSTGRES_USER: listings_user
          POSTGRES_PASSWORD: listings_password
        ports:
          - 5435:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      redis:
        image: redis:7-alpine
        ports:
          - 6380:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure git for private modules
        run: git config --global url."https://${{ secrets.GO_MODULES_TOKEN }}@github.com/".insteadOf "https://github.com/"

      - name: Cache Go modules
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-

      - name: Download dependencies
        run: go mod download

      - name: Run unit tests
        env:
          VONDILISTINGS_DB_HOST: localhost
          VONDILISTINGS_DB_PORT: 5435
          VONDILISTINGS_DB_USER: listings_user
          VONDILISTINGS_DB_PASSWORD: listings_password
          VONDILISTINGS_DB_NAME: listings_db_test
          VONDILISTINGS_REDIS_HOST: localhost
          VONDILISTINGS_REDIS_PORT: 6380
        run: go test -v -race -short ./internal/... ./test/...

  build:
    name: Build
    runs-on: [self-hosted, svetu]
    needs: [validate, lint, test]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure git for private modules
        run: git config --global url."https://${{ secrets.GO_MODULES_TOKEN }}@github.com/".insteadOf "https://github.com/"

      - name: Cache Go modules
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-

      - name: Build application
        run: make build

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: listings-service
          path: bin/listings-service
          retention-days: 7

  docker:
    name: Docker Build
    runs-on: [self-hosted, svetu]
    needs: [lint, test]
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop')
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: false
          tags: listings-service:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  integration-test:
    name: Integration Tests
    runs-on: [self-hosted, svetu]
    needs: [build]
    if: github.event_name == 'pull_request'
    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_DB: listings_db_test
          POSTGRES_USER: listings_user
          POSTGRES_PASSWORD: listings_password
        ports:
          - 5435:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      redis:
        image: redis:7-alpine
        ports:
          - 6380:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure git for private modules
        run: git config --global url."https://${{ secrets.GO_MODULES_TOKEN }}@github.com/".insteadOf "https://github.com/"

      - name: Run integration tests
        env:
          VONDILISTINGS_DB_HOST: localhost
          VONDILISTINGS_DB_PORT: 5432
          VONDILISTINGS_DB_USER: listings_user
          VONDILISTINGS_DB_PASSWORD: listings_password
          VONDILISTINGS_DB_NAME: listings_db_test
          VONDILISTINGS_REDIS_HOST: localhost
          VONDILISTINGS_REDIS_PORT: 6379
        run: go test -v -tags=integration ./internal/... ./test/...
