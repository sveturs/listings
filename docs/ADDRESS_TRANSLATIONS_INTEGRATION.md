# Интеграция переводов адресов в систему объявлений

## Обзор

Реализована автоматическая система перевода адресных полей объявлений на поддерживаемые языки платформы (английский, русский, сербский).

## Изменения в коде

### 1. Добавлен метод `SaveAddressTranslations`

Файл: `/backend/internal/proj/marketplace/service/marketplace.go`

```go
func (s *MarketplaceService) SaveAddressTranslations(ctx context.Context, listingID int, addressFields map[string]string, sourceLanguage string, targetLanguages []string) error
```

Метод:
- Принимает адресные поля (location, city, country)
- Использует сервис перевода для перевода на целевые языки
- Сохраняет переводы в таблицу `translations`
- Добавляет метаданные для отслеживания переводов адресов

### 2. Модифицирован метод `CreateListing`

При создании объявления:
- Извлекаются адресные поля
- Определяется исходный язык из контекста или используется русский по умолчанию
- Запускается асинхронный процесс перевода адресов
- Переводы сохраняются в фоновом режиме для ускорения отклика API

### 3. Модифицирован метод `UpdateListing`

При обновлении объявления:
- Проверяется, изменились ли адресные поля
- Если да, запускается процесс обновления переводов
- Обновление происходит асинхронно

### 4. Обновлен интерфейс `MarketplaceServiceInterface`

Добавлен метод `SaveAddressTranslations` в интерфейс для поддержки новой функциональности.

## Структура данных

Переводы сохраняются в таблице `translations` со следующей структурой:
- `entity_type`: "listing"
- `entity_id`: ID объявления
- `language`: целевой язык (en, ru, sr)
- `field_name`: имя поля (location, city, country)
- `translated_text`: переведенный текст
- `metadata`: дополнительная информация (provider, source_language, is_address)

## Миграция базы данных

Используется существующая таблица `translations` с добавленными индексами для оптимизации (миграция 000134).

## Тестирование

Создан unit-тест для проверки логики перевода:
- `/backend/internal/proj/marketplace/service/address_translation_test.go`
- Тест проверяет правильность вызова методов перевода
- Тест проверяет структуру возвращаемых переводов

## Асинхронная обработка

Переводы выполняются асинхронно для:
- Минимизации задержки при создании/обновлении объявлений
- Возможности повторной попытки при сбоях
- Масштабируемости системы

## Поддерживаемые языки

- Русский (ru)
- Английский (en)
- Сербский (sr)

## Примечания

1. Исходный язык определяется автоматически из контекста запроса
2. Переводы кешируются в таблице translations для повторного использования
3. При ошибке перевода процесс продолжается с другими полями
4. Система использует Google Translate API через фабрику сервисов перевода