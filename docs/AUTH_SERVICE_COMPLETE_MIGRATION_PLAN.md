# –ü–ª–∞–Ω –ø–æ–ª–Ω–æ–π –º–∏–≥—Ä–∞—Ü–∏–∏ –Ω–∞ —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—É—é —Å–∏—Å—Ç–µ–º—É –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ Auth Service

## üìã –û–≥–ª–∞–≤–ª–µ–Ω–∏–µ
- [–ü—Ä–∏–Ω—Ü–∏–ø—ã –º–∏–≥—Ä–∞—Ü–∏–∏](#–ø—Ä–∏–Ω—Ü–∏–ø—ã-–º–∏–≥—Ä–∞—Ü–∏–∏)
- [–§–∞–∑–∞ 1: –ü–æ–ª–Ω—ã–π –ø–µ—Ä–µ—Ö–æ–¥ –Ω–∞ RS256](#—Ñ–∞–∑–∞-1-–ø–æ–ª–Ω—ã–π-–ø–µ—Ä–µ—Ö–æ–¥-–Ω–∞-rs256)
- [–§–∞–∑–∞ 2: –ú–∏–≥—Ä–∞—Ü–∏—è –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π](#—Ñ–∞–∑–∞-2-–º–∏–≥—Ä–∞—Ü–∏—è-–≤—Å–µ—Ö-–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π)
- [–§–∞–∑–∞ 3: –£–¥–∞–ª–µ–Ω–∏–µ legacy –∫–æ–¥–∞](#—Ñ–∞–∑–∞-3-—É–¥–∞–ª–µ–Ω–∏–µ-legacy-–∫–æ–¥–∞)
- [–§–∞–∑–∞ 4: –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã –ø—Ä–∞–≤](#—Ñ–∞–∑–∞-4-—Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ-—Å–∏—Å—Ç–µ–º—ã-–ø—Ä–∞–≤)
- [–ß–µ–∫-–ª–∏—Å—Ç –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è](#—á–µ–∫-–ª–∏—Å—Ç-–∑–∞–≤–µ—Ä—à–µ–Ω–∏—è)

## üéØ –ü—Ä–∏–Ω—Ü–∏–ø—ã –º–∏–≥—Ä–∞—Ü–∏–∏

### –ì–ª–∞–≤–Ω—ã–π –ø—Ä–∏–Ω—Ü–∏–ø: **–ù–∏–∫–∞–∫–æ–≥–æ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–≥–æ –¥–æ–ª–≥–∞!**

- ‚ùå –ù–ï –æ—Å—Ç–∞–≤–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è
- ‚ùå –ù–ï –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º –¥–≤–µ —Å–∏—Å—Ç–µ–º—ã –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ
- ‚ùå –ù–ï –æ—Ç–∫–ª–∞–¥—ã–≤–∞–µ–º —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ "–Ω–∞ –ø–æ—Ç–æ–º"
- ‚úÖ –î–µ–ª–∞–µ–º —Å—Ä–∞–∑—É –ø—Ä–∞–≤–∏–ª—å–Ω–æ
- ‚úÖ –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–π –∫–æ–¥ –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ
- ‚úÖ –î–æ–∫—É–º–µ–Ω—Ç–∏—Ä—É–µ–º –≤—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è

## üîÑ –§–∞–∑–∞ 1: –ü–æ–ª–Ω—ã–π –ø–µ—Ä–µ—Ö–æ–¥ –Ω–∞ RS256
**–°—Ä–æ–∫**: 1-2 –¥–Ω—è  
**Downtime**: 1-2 —á–∞—Å–∞ (–ø–ª–∞–Ω–∏—Ä—É–µ–º—ã–π)

### 1.1 –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–ª—é—á–µ–π –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ Auth Service

```bash
# –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ–Ω–Ω—ã–µ –∫–ª—é—á–∏ RSA 4096 bit
cd /data/auth_svetu
mkdir -p keys
openssl genrsa -out keys/private.pem 4096
openssl rsa -in keys/private.pem -pubout -out keys/public.pem

# –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é Auth Service
cat >> .env << EOF
JWT_ALGORITHM=RS256
JWT_PRIVATE_KEY_PATH=./keys/private.pem
JWT_PUBLIC_KEY_PATH=./keys/public.pem
EOF
```

### 1.2 –ü–æ–ª–Ω–∞—è –∫–æ–º–ø–∏–ª—è—Ü–∏—è Auth Service —Å Role Service

```go
// /data/auth_svetu/cmd/server/main.go

import (
    "github.com/svetu/auth-service/internal/service/role"
    // ...
)

func main() {
    // ...
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Role Service
    roleService := role.NewService(db.GetDB(), userRepo, logger.GetLogger())
    
    // JWT Service —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π —Ä–æ–ª–µ–π
    tokenService, err := token.NewJWTService(&cfg.JWT, roleService)
    if err != nil {
        logger.Fatal("Failed to initialize JWT service", map[string]interface{}{"error": err.Error()})
    }
    
    // HTTP handlers –¥–ª—è —Ä–æ–ª–µ–π
    roleHandler := handlers.NewRoleHandlerFiber(roleService, logger.GetLogger())
    
    // –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —Ä–æ—É—Ç–æ–≤
    api := app.Group("/api/v1")
    roleHandler.RegisterRoutes(api, middleware.AuthMiddleware(authService))
    
    // ...
}
```

### 1.3 –û—Ç–∫–ª—é—á–µ–Ω–∏–µ HS256 –≤ –æ—Å–Ω–æ–≤–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏

```go
// /data/hostel-booking-system/backend/internal/middleware/auth_jwt.go

func (m *Middleware) AuthRequiredJWT(c *fiber.Ctx) error {
    // –£–î–ê–õ–Ø–ï–ú –≤—Å—é –ª–æ–≥–∏–∫—É HS256
    // –û–°–¢–ê–í–õ–Ø–ï–ú —Ç–æ–ª—å–∫–æ RS256 –≤–∞–ª–∏–¥–∞—Ü–∏—é
    
    authHeader := c.Get("Authorization")
    if authHeader == "" {
        return utils.ErrorResponse(c, fiber.StatusUnauthorized, "users.auth.error.authentication_required")
    }
    
    parts := strings.Split(authHeader, " ")
    if len(parts) != 2 || parts[0] != "Bearer" {
        return utils.ErrorResponse(c, fiber.StatusUnauthorized, "users.auth.error.invalid_token")
    }
    
    // –¢–û–õ–¨–ö–û RS256 –ø—Ä–æ–≤–µ—Ä–∫–∞
    authClaims, err := jwt.ValidateAuthServiceToken(parts[1], m.authServicePubKey)
    if err != nil {
        return utils.ErrorResponse(c, fiber.StatusUnauthorized, "users.auth.error.invalid_token")
    }
    
    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    c.Locals("user_id", authClaims.UserID)
    c.Locals("user_email", authClaims.Email)
    c.Locals("roles", authClaims.Roles)
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–¥–º–∏–Ω–∞
    isAdmin := false
    for _, role := range authClaims.Roles {
        if role == "admin" {
            isAdmin = true
            break
        }
    }
    c.Locals("is_admin", isAdmin)
    
    return c.Next()
}
```

### 1.4 –£–¥–∞–ª–µ–Ω–∏–µ JWT_SECRET –∏–∑ –≤—Å–µ—Ö .env —Ñ–∞–π–ª–æ–≤

```bash
# Backend
sed -i '/JWT_SECRET=/d' /data/hostel-booking-system/backend/.env

# –î–æ–±–∞–≤–ª—è–µ–º –ø—É—Ç—å –∫ –ø—É–±–ª–∏—á–Ω–æ–º—É –∫–ª—é—á—É
echo "AUTH_SERVICE_PUBLIC_KEY_PATH=/data/auth_svetu/keys/public.pem" >> /data/hostel-booking-system/backend/.env

# Frontend - —É–¥–∞–ª—è–µ–º –≤—Å–µ —É–ø–æ–º–∏–Ω–∞–Ω–∏—è JWT
sed -i '/JWT/d' /data/hostel-booking-system/frontend/svetu/.env.local

# –î–æ–±–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ Auth Service URL
echo "NEXT_PUBLIC_AUTH_SERVICE_URL=http://localhost:28080" >> /data/hostel-booking-system/frontend/svetu/.env.local
```

### 1.5 –£–¥–∞–ª–µ–Ω–∏–µ –ª–æ–∫–∞–ª—å–Ω–æ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ç–æ–∫–µ–Ω–æ–≤

```bash
# –£–¥–∞–ª—è–µ–º –≤—Å–µ —Å–∫—Ä–∏–ø—Ç—ã –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ç–æ–∫–µ–Ω–æ–≤
rm /data/hostel-booking-system/backend/scripts/create_test_jwt.go
rm /data/hostel-booking-system/backend/scripts/create_admin_jwt.go

# –£–¥–∞–ª—è–µ–º –ø–∞–∫–µ—Ç JWT –∏–∑ backend (–æ—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –≤–∞–ª–∏–¥–∞—Ü–∏—é RS256)
rm -rf /data/hostel-booking-system/backend/pkg/jwt/generate.go
```

## üöÄ –§–∞–∑–∞ 2: –ú–∏–≥—Ä–∞—Ü–∏—è –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
**–°—Ä–æ–∫**: 1 –¥–µ–Ω—å  
**Downtime**: 30 –º–∏–Ω—É—Ç

### 2.1 –ü–æ–ª–Ω—ã–π –¥–∞–º–ø –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏–∑ –æ—Å–Ω–æ–≤–Ω–æ–π –ë–î

```sql
-- –°–æ–∑–¥–∞–µ–º –ø–æ–ª–Ω—ã–π —ç–∫—Å–ø–æ—Ä—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
COPY (
    SELECT 
        u.id,
        u.email,
        u.name,
        u.phone,
        u.created_at,
        u.google_id,
        u.facebook_id,
        u.account_status,
        CASE 
            WHEN au.email IS NOT NULL THEN 'admin'
            ELSE 'user'
        END as role
    FROM users u
    LEFT JOIN admin_users au ON u.email = au.email
) TO '/tmp/users_export.csv' WITH CSV HEADER;
```

### 2.2 –ú–∞—Å—Å–æ–≤—ã–π –∏–º–ø–æ—Ä—Ç –≤ Auth Service

```go
// /data/auth_svetu/scripts/mass_import_users.go

package main

import (
    "encoding/csv"
    "os"
    "database/sql"
    "time"
)

func main() {
    // –ß–∏—Ç–∞–µ–º CSV
    file, _ := os.Open("/tmp/users_export.csv")
    defer file.Close()
    
    reader := csv.NewReader(file)
    records, _ := reader.ReadAll()
    
    // –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ Auth Service DB
    authDB, _ := sql.Open("postgres", "postgres://auth_user:AuthP@ssw0rd2025!@localhost:25432/auth_db")
    
    // Batch insert
    tx, _ := authDB.Begin()
    
    for _, record := range records[1:] { // Skip header
        // –í—Å—Ç–∞–≤–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        var userID int
        err := tx.QueryRow(`
            INSERT INTO auth.users (email, name, provider, created_at)
            VALUES ($1, $2, 'migrated', $3)
            ON CONFLICT (email) DO UPDATE SET name = EXCLUDED.name
            RETURNING id
        `, record[1], record[2], record[4]).Scan(&userID)
        
        if err == nil && record[9] == "admin" {
            // –ù–∞–∑–Ω–∞—á–∞–µ–º —Ä–æ–ª—å –∞–¥–º–∏–Ω–∞
            tx.Exec(`
                INSERT INTO auth.user_roles (user_id, role_id, granted_at, is_active, notes)
                SELECT $1, r.id, NOW(), true, 'Migrated from main DB'
                FROM auth.roles r WHERE r.name = 'admin'
                ON CONFLICT DO NOTHING
            `, userID)
        }
    }
    
    tx.Commit()
    
    println("Migration completed!")
}
```

### 2.3 –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ Frontend –Ω–∞ Auth Service

```typescript
// /data/hostel-booking-system/frontend/svetu/src/services/auth.ts

class AuthService {
    // –£–î–ê–õ–Ø–ï–ú –≤—Å–µ –º–µ—Ç–æ–¥—ã —Ä–∞–±–æ—Ç—ã —Å backend auth
    // –¢–û–õ–¨–ö–û Auth Service
    
    async login(email: string, password: string) {
        const response = await fetch(`${config.getAuthServiceUrl()}/api/v1/auth/login`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email, password })
        });
        
        const data = await response.json();
        if (data.access_token) {
            tokenManager.setTokens(data.access_token, data.refresh_token);
        }
        return data;
    }
    
    async register(userData: RegisterData) {
        // –¢–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ Auth Service
        return fetch(`${config.getAuthServiceUrl()}/api/v1/auth/register`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(userData)
        });
    }
    
    // –£–¥–∞–ª—è–µ–º –º–µ—Ç–æ–¥—ã:
    // - loginWithBackend()
    // - registerWithBackend()
    // - validateWithBackend()
}
```

### 2.4 –û—Ç–∫–ª—é—á–µ–Ω–∏–µ auth endpoints –≤ Backend

```go
// /data/hostel-booking-system/backend/internal/server/routes.go

func SetupRoutes(app *fiber.App) {
    // –£–î–ê–õ–Ø–ï–ú –≤—Å–µ auth endpoints
    // ‚ùå api.Post("/auth/login", handlers.Login)
    // ‚ùå api.Post("/auth/register", handlers.Register)
    // ‚ùå api.Post("/auth/refresh", handlers.RefreshToken)
    // ‚ùå api.Get("/auth/validate", handlers.ValidateToken)
    
    // –û—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫—É
    api := app.Group("/api/v1")
    
    // Marketplace
    api.Get("/marketplace/listings", middleware.AuthRequiredJWT, handlers.GetListings)
    api.Post("/marketplace/listings", middleware.AuthRequiredJWT, handlers.CreateListing)
    
    // Admin (–ø—Ä–æ–≤–µ—Ä–∫–∞ —Ä–æ–ª–µ–π —á–µ—Ä–µ–∑ —Ç–æ–∫–µ–Ω)
    admin := api.Group("/admin", middleware.AuthRequiredJWT, middleware.RequireAdmin)
    admin.Get("/users", handlers.AdminGetUsers)
    admin.Put("/users/:id/status", handlers.AdminUpdateUserStatus)
}
```

## üóëÔ∏è –§–∞–∑–∞ 3: –£–¥–∞–ª–µ–Ω–∏–µ legacy –∫–æ–¥–∞
**–°—Ä–æ–∫**: 1 –¥–µ–Ω—å  
**Downtime**: 0

### 3.1 –£–¥–∞–ª–µ–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã admin_users

```sql
-- –°–Ω–∞—á–∞–ª–∞ —Å–æ—Ö—Ä–∞–Ω—è–µ–º backup
CREATE TABLE admin_users_backup_2025_01_09 AS SELECT * FROM admin_users;

-- –£–¥–∞–ª—è–µ–º –≤—Å–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
ALTER TABLE admin_users DROP CONSTRAINT IF EXISTS admin_users_created_by_fkey;
DROP INDEX IF EXISTS idx_admin_users_email;

-- –£–¥–∞–ª—è–µ–º —Ç–∞–±–ª–∏—Ü—É
DROP TABLE admin_users;

-- –£–¥–∞–ª—è–µ–º –∏–∑ –º–∏–≥—Ä–∞—Ü–∏–π —É–ø–æ–º–∏–Ω–∞–Ω–∏—è
DELETE FROM schema_migrations WHERE version IN (
    SELECT version FROM schema_migrations 
    WHERE version LIKE '%admin_users%'
);
```

### 3.2 –£–¥–∞–ª–µ–Ω–∏–µ –∫–æ–¥–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∞–¥–º–∏–Ω–æ–≤

```go
// –£–¥–∞–ª—è–µ–º —Ñ–∞–π–ª—ã:
rm /data/hostel-booking-system/backend/internal/proj/users/storage/postgres/admin_users.go
rm /data/hostel-booking-system/backend/internal/storage/postgres/admin_methods.go

// –£–¥–∞–ª—è–µ–º –º–µ—Ç–æ–¥—ã –∏–∑ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–≤:
// - IsUserAdmin()
// - GetAllAdmins()
// - AddAdmin()
// - RemoveAdmin()
```

### 3.3 –£–¥–∞–ª–µ–Ω–∏–µ —Å–µ—Å—Å–∏–π –∏ cookie auth

```go
// –£–¥–∞–ª—è–µ–º –∏–∑ middleware:
// - –ü—Ä–æ–≤–µ—Ä–∫—É session_token cookie
// - Fallback –Ω–∞ —Å–µ—Å—Å–∏–∏
// - –ì–µ–Ω–µ—Ä–∞—Ü–∏—é JWT –∏–∑ —Å–µ—Å—Å–∏–π

// –£–¥–∞–ª—è–µ–º —Ç–∞–±–ª–∏—Ü—ã:
DROP TABLE user_sessions;
DROP TABLE session_tokens;
```

### 3.4 –û—á–∏—Å—Ç–∫–∞ Frontend

```typescript
// –£–¥–∞–ª—è–µ–º:
// - –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –ª–æ–∫–∞–ª—å–Ω–æ–π –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
// - –•—É–∫–∏ –¥–ª—è session-based auth
// - Cookie –º–µ–Ω–µ–¥–∂–µ—Ä—ã –¥–ª—è JWT
// - Fallback –ª–æ–≥–∏–∫—É

// –û—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ:
// - –†–∞–±–æ—Ç—É —Å Auth Service
// - Token manager –¥–ª—è access/refresh —Ç–æ–∫–µ–Ω–æ–≤
```

## üöÄ –§–∞–∑–∞ 4: –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã –ø—Ä–∞–≤
**–°—Ä–æ–∫**: 3-5 –¥–Ω–µ–π  
**Downtime**: 0

### 4.1 –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –¥–µ—Ç–∞–ª—å–Ω—ã—Ö permissions

```sql
-- –¢–∞–±–ª–∏—Ü–∞ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π
CREATE TABLE auth.permissions (
    id SERIAL PRIMARY KEY,
    name VARCHAR(100) UNIQUE NOT NULL,
    resource VARCHAR(50) NOT NULL,
    action VARCHAR(50) NOT NULL,
    description TEXT
);

-- –°–≤—è–∑—å —Ä–æ–ª—å-—Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ
CREATE TABLE auth.role_permissions (
    role_id INTEGER REFERENCES auth.roles(id),
    permission_id INTEGER REFERENCES auth.permissions(id),
    PRIMARY KEY (role_id, permission_id)
);

-- –ë–∞–∑–æ–≤—ã–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è
INSERT INTO auth.permissions (name, resource, action) VALUES
    ('users.read', 'users', 'read'),
    ('users.write', 'users', 'write'),
    ('users.delete', 'users', 'delete'),
    ('listings.moderate', 'listings', 'moderate'),
    ('payments.manage', 'payments', 'manage'),
    ('analytics.view', 'analytics', 'view');

-- –ù–∞–∑–Ω–∞—á–∞–µ–º —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è —Ä–æ–ª—è–º
INSERT INTO auth.role_permissions (role_id, permission_id)
SELECT r.id, p.id
FROM auth.roles r
CROSS JOIN auth.permissions p
WHERE r.name = 'admin'; -- –ê–¥–º–∏–Ω –ø–æ–ª—É—á–∞–µ—Ç –≤—Å–µ

INSERT INTO auth.role_permissions (role_id, permission_id)
SELECT r.id, p.id
FROM auth.roles r
CROSS JOIN auth.permissions p
WHERE r.name = 'moderator' 
  AND p.name IN ('users.read', 'listings.moderate');
```

### 4.2 –î–æ–±–∞–≤–ª–µ–Ω–∏–µ resource-based permissions

```go
// –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –Ω–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π —Ä–µ—Å—É—Ä—Å
type ResourcePermission struct {
    UserID     int
    Resource   string  // "listing:123"
    Permission string  // "edit"
}

func CheckResourcePermission(ctx context.Context, req ResourcePermission) bool {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º:
    // 1. –û–±—â–∏–µ –ø—Ä–∞–≤–∞ —Ä–æ–ª–∏
    // 2. –°–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ –ø—Ä–∞–≤–∞ –Ω–∞ —Ä–µ—Å—É—Ä—Å
    // 3. Ownership (–≤–ª–∞–¥–µ–ª–µ—Ü —Ä–µ—Å—É—Ä—Å–∞)
}
```

### 4.3 –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Frontend

```typescript
// –ö–æ–º–ø–æ–Ω–µ–Ω—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–∞–≤
function Can({ 
    permission, 
    resource, 
    children, 
    fallback = null 
}: CanProps) {
    const { user, permissions } = useAuth();
    
    const hasPermission = checkPermission(user, permission, resource);
    
    return hasPermission ? children : fallback;
}

// –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ
<Can permission="listings.moderate">
    <button onClick={moderateListing}>–ú–æ–¥–µ—Ä–∏—Ä–æ–≤–∞—Ç—å</button>
</Can>

<Can permission="users.delete" resource={`user:${userId}`}>
    <button onClick={deleteUser}>–£–¥–∞–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</button>
</Can>
```

### 4.4 –ê—É–¥–∏—Ç –∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

```sql
-- –¢–∞–±–ª–∏—Ü–∞ –∞—É–¥–∏—Ç–∞ –¥–µ–π—Å—Ç–≤–∏–π
CREATE TABLE auth.audit_log (
    id BIGSERIAL PRIMARY KEY,
    user_id INTEGER,
    action VARCHAR(100),
    resource VARCHAR(200),
    details JSONB,
    ip_address INET,
    user_agent TEXT,
    created_at TIMESTAMP DEFAULT NOW()
);

-- –ò–Ω–¥–µ–∫—Å—ã –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞
CREATE INDEX idx_audit_user_id ON auth.audit_log(user_id);
CREATE INDEX idx_audit_action ON auth.audit_log(action);
CREATE INDEX idx_audit_created_at ON auth.audit_log(created_at);
```

## ‚úÖ –ß–µ–∫-–ª–∏—Å—Ç –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è

### –§–∞–∑–∞ 1 - RS256
- [ ] –ö–ª—é—á–∏ RSA 4096 —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω—ã
- [ ] Auth Service –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Ç–æ–ª—å–∫–æ RS256
- [ ] Backend –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Ç–æ–ª—å–∫–æ RS256 —Ç–æ–∫–µ–Ω—ã
- [ ] JWT_SECRET —É–¥–∞–ª–µ–Ω –∏–∑ –≤—Å–µ—Ö .env
- [ ] –õ–æ–∫–∞–ª—å–Ω–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç–æ–∫–µ–Ω–æ–≤ —É–¥–∞–ª–µ–Ω–∞
- [ ] –í—Å–µ —Å–µ—Ä–≤–∏—Å—ã –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω—ã

### –§–∞–∑–∞ 2 - –ú–∏–≥—Ä–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- [ ] –í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã
- [ ] –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã –≤ Auth Service
- [ ] –†–æ–ª–∏ –Ω–∞–∑–Ω–∞—á–µ–Ω—ã –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- [ ] Frontend –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Ç–æ–ª—å–∫–æ Auth Service
- [ ] Backend auth endpoints —É–¥–∞–ª–µ–Ω—ã
- [ ] –¢–µ—Å—Ç—ã –æ–±–Ω–æ–≤–ª–µ–Ω—ã

### –§–∞–∑–∞ 3 - –£–¥–∞–ª–µ–Ω–∏–µ legacy
- [ ] –¢–∞–±–ª–∏—Ü–∞ admin_users —É–¥–∞–ª–µ–Ω–∞
- [ ] –ö–æ–¥ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∞–¥–º–∏–Ω–æ–≤ —É–¥–∞–ª–µ–Ω
- [ ] Session auth —É–¥–∞–ª–µ–Ω
- [ ] Cookie auth —É–¥–∞–ª–µ–Ω
- [ ] –°—Ç–∞—Ä—ã–µ –º–∏–≥—Ä–∞—Ü–∏–∏ –æ—á–∏—â–µ–Ω—ã
- [ ] –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∞

### –§–∞–∑–∞ 4 - –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ
- [ ] Permissions —Å–∏—Å—Ç–µ–º–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞
- [ ] Resource-based –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–∞–±–æ—Ç–∞—é—Ç
- [ ] Frontend –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –æ–±–Ω–æ–≤–ª–µ–Ω—ã
- [ ] –ê—É–¥–∏—Ç –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ
- [ ] Monitoring –∏ alerting –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã
- [ ] Load testing –ø—Ä–æ–≤–µ–¥–µ–Ω

## üìä –ú–µ—Ç—Ä–∏–∫–∏ —É—Å–ø–µ—Ö–∞ –ø–æ—Å–ª–µ –º–∏–≥—Ä–∞—Ü–∏–∏

1. **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å**
   - –í—Ä–µ–º—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏ —Ç–æ–∫–µ–Ω–∞ < 10ms
   - –í—Ä–µ–º—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ç–æ–∫–µ–Ω–∞ < 50ms
   - Zero downtime –ø—Ä–∏ —Ä–æ—Ç–∞—Ü–∏–∏ –∫–ª—é—á–µ–π

2. **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å**
   - 0 —Å–µ–∫—Ä–µ—Ç–Ω—ã—Ö –∫–ª—é—á–µ–π –≤ –∫–æ–¥–µ
   - –í—Å–µ —Ç–æ–∫–µ–Ω—ã RS256
   - –ê—É–¥–∏—Ç –ª–æ–≥ 100% –¥–µ–π—Å—Ç–≤–∏–π

3. **–ß–∏—Å—Ç–æ—Ç–∞ –∫–æ–¥–∞**
   - 0 legacy auth –∫–æ–¥–∞
   - 0 TODO –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤
   - 100% –ø–æ–∫—Ä—ã—Ç–∏–µ —Ç–µ—Å—Ç–∞–º–∏

4. **–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å**
   - Auth Service –º–æ–∂–µ—Ç –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å 10k RPS
   - –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–µ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
   - Cache —Å–ª–æ–π –¥–ª—è —Ç–æ–∫–µ–Ω–æ–≤

## üéâ –†–µ–∑—É–ª—å—Ç–∞—Ç

–ü–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –≤—Å–µ—Ö —Ñ–∞–∑:
- **–ï–¥–∏–Ω–∞—è** —Å–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
- **–ë–µ–∑–æ–ø–∞—Å–Ω–∞—è** RS256 –∫—Ä–∏–ø—Ç–æ–≥—Ä–∞—Ñ–∏—è  
- **–ß–∏—Å—Ç—ã–π** –∫–æ–¥ –±–µ–∑ legacy
- **–†–∞—Å—à–∏—Ä—è–µ–º–∞—è** —Å–∏—Å—Ç–µ–º–∞ –ø—Ä–∞–≤
- **–ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å** –∫ production

**–ù–∏–∫–∞–∫–æ–≥–æ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–≥–æ –¥–æ–ª–≥–∞!** üöÄ