# üîß –û–¢–ß–ï–¢ –û –í–´–ü–û–õ–ù–ï–ù–ù–´–• –†–ê–ë–û–¢–ê–• –ü–û –ò–°–ü–†–ê–í–õ–ï–ù–ò–Æ –ê–í–¢–û–†–ò–ó–ê–¶–ò–ò
## –î–∞—Ç–∞: 2025-09-16
## –°—Ç–∞—Ç—É—Å: ‚úÖ Frontend –≥–æ—Ç–æ–≤, –æ–∂–∏–¥–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ Auth Service

---

## üéØ –ü–†–û–ë–õ–ï–ú–ê

–ù–∞ dev.svetu.rs –ø–æ—Å–ª–µ OAuth –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Ç–µ—Ä—è–ª–∏ —Å–µ—Å—Å–∏—é –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã. –ü—Ä–æ–±–ª–µ–º–∞ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–ª–∏—è–ª–∞ –Ω–∞ UX - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –≤—ã–Ω—É–∂–¥–µ–Ω—ã –±—ã–ª–∏ –ª–æ–≥–∏–Ω–∏—Ç—å—Å—è –∑–∞–Ω–æ–≤–æ –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è.

---

## üîç –ü–†–û–í–ï–î–ï–ù–ù–´–ô –ê–ù–ê–õ–ò–ó

### 1. –í—ã—è–≤–ª–µ–Ω—ã –∫–æ—Ä–Ω–µ–≤—ã–µ –ø—Ä–∏—á–∏–Ω—ã:

1. **–ù–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –º–µ—Ç–æ–¥–æ–≤ —Ö—Ä–∞–Ω–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–æ–≤:**
   - Auth Service –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç refresh_token –≤ HTTP-only cookie
   - Frontend –æ–∂–∏–¥–∞–ª refresh_token –≤ localStorage
   - –ü—Ä–∏ refresh —Ç–æ–∫–µ–Ω–∞ Frontend –Ω–µ –º–æ–≥ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å cookie

2. **–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è cookies –≤ Auth Service:**
   - `SameSite: "Strict"` –∏ `"Lax"` –±–ª–æ–∫–∏—Ä–æ–≤–∞–ª–∏ –ø–µ—Ä–µ–¥–∞—á—É cookies
   - –¢—Ä–µ–±–æ–≤–∞–ª–æ—Å—å `SameSite: "None"` –¥–ª—è cross-origin –∑–∞–ø—Ä–æ—Å–æ–≤

3. **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ dual-mode –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏:**
   - OAuth –∏—Å–ø–æ–ª—å–∑—É–µ—Ç cookies
   - Email auth –∏—Å–ø–æ–ª—å–∑—É–µ—Ç localStorage
   - –°–∏—Å—Ç–µ–º–∞ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–ª–∞ –æ–±–∞ –º–µ—Ç–æ–¥–∞ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ

---

## ‚úÖ –í–´–ü–û–õ–ù–ï–ù–ù–´–ï –†–ê–ë–û–¢–´ –ù–ê FRONTEND

### 1. **–ú–æ–¥–µ—Ä–Ω–∏–∑–∞—Ü–∏—è TokenManager** (`/frontend/svetu/src/utils/tokenManager.ts`)

#### –î–æ–±–∞–≤–ª–µ–Ω –Ω–æ–≤—ã–π –º–µ—Ç–æ–¥ –¥–ª—è cookie-based refresh:
```typescript
private async performCookieRefresh(): Promise<string | null> {
  const response = await fetch('/api/v1/auth/refresh', {
    method: 'POST',
    credentials: 'include', // –ö–†–ò–¢–ò–ß–ù–û: –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç cookies
    headers: { 'Content-Type': 'application/json' },
  });

  if (response.ok) {
    const data = await response.json();
    if (data.access_token) {
      this.setAccessToken(data.access_token);
      return data.access_token;
    }
  }
  return null;
}
```

#### –û–±–Ω–æ–≤–ª–µ–Ω–∞ –ª–æ–≥–∏–∫–∞ refresh —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º –≤—ã–±–æ—Ä–æ–º –º–µ—Ç–æ–¥–∞:
```typescript
private async performRefresh(): Promise<string> {
  // –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–±—É–µ–º cookie refresh (–¥–ª—è OAuth)
  const cookieResponse = await this.performCookieRefresh();
  if (cookieResponse) {
    return cookieResponse;
  }

  // Fallback –Ω–∞ localStorage refresh (–¥–ª—è email auth)
  const refreshToken = this.getRefreshToken();
  if (refreshToken) {
    // ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∞—è –ª–æ–≥–∏–∫–∞
  }
}
```

### 2. **–£–ª—É—á—à–µ–Ω OAuthProcessor** (`/frontend/svetu/src/app/[locale]/auth/oauth/google/callback/OAuthProcessor.tsx`)

–î–æ–±–∞–≤–ª–µ–Ω –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π –≤—ã–∑–æ–≤ –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ session cookies:
```typescript
// –ü–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞ –∏–∑ URL
fetch('/api/v1/auth/session', {
  method: 'GET',
  credentials: 'include', // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç cookies
  headers: {
    'Authorization': `Bearer ${token}`,
  },
})
```

### 3. **–û–±–Ω–æ–≤–ª–µ–Ω AuthService** (`/frontend/svetu/src/services/auth.ts`)

–ú–µ—Ç–æ–¥ `restoreSession()` —Ç–µ–ø–µ—Ä—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –æ–±–∞ —Ç–∏–ø–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏:
```typescript
static async restoreSession(): Promise<SessionResponse | null> {
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π —Ç–æ–∫–µ–Ω
  let accessToken = tokenManager.getAccessToken();

  if (!accessToken || tokenManager.isTokenExpired(accessToken)) {
    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –≤—ã–±–æ—Ä –º–µ—Ç–æ–¥–∞ refresh
    // TokenManager —Å–∞–º –æ–ø—Ä–µ–¥–µ–ª–∏—Ç cookie –∏–ª–∏ localStorage
    accessToken = await tokenManager.refreshAccessToken();
  }

  if (accessToken) {
    return await this.getSession();
  }
  return null;
}
```

### 4. **–°–æ–∑–¥–∞–Ω–∞ –ø–æ–ª–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è**

- **TOKEN_CLEANUP_LOCATIONS.md** - –∫–∞—Ä—Ç–∞ –≤—Å–µ—Ö –º–µ—Å—Ç —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞–º–∏ (–¥–ª—è –±—É–¥—É—â–∏—Ö —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤)
- **AUTH_SERVICE_TASK_2025-09-16.md** - –¥–µ—Ç–∞–ª—å–Ω–æ–µ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ –∑–∞–¥–∞–Ω–∏–µ –¥–ª—è Auth Service

---

## üìä –†–ï–ó–£–õ–¨–¢–ê–¢–´ –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–Ø

### ‚úÖ –õ–æ–∫–∞–ª—å–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ (localhost):
- OAuth –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è: **—Ä–∞–±–æ—Ç–∞–µ—Ç**
- Email –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è: **—Ä–∞–±–æ—Ç–∞–µ—Ç**
- Refresh —Ç–æ–∫–µ–Ω–æ–≤: **—Ä–∞–±–æ—Ç–∞–µ—Ç**
- –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–µ—Å—Å–∏–∏: **—Ä–∞–±–æ—Ç–∞–µ—Ç**

### ‚ö†Ô∏è –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ dev.svetu.rs:
- –¢—Ä–µ–±—É–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ Auth Service (SameSite cookies)
- Frontend –∫–æ–¥ –≥–æ—Ç–æ–≤ –∏ –æ–∂–∏–¥–∞–µ—Ç backend

---

## üöÄ –ü–†–ï–ò–ú–£–©–ï–°–¢–í–ê –†–ï–®–ï–ù–ò–Ø

1. **–£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ—Å—Ç—å:**
   - –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –¥–≤—É—Ö –º–µ—Ç–æ–¥–æ–≤ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ
   - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –≤—ã–±–æ—Ä –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ–≥–æ –º–µ—Ç–æ–¥–∞

2. **–û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å:**
   - –°—É—â–µ—Å—Ç–≤—É—é—â–∞—è email –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –Ω–µ –∑–∞—Ç—Ä–æ–Ω—É—Ç–∞
   - –ü–ª–∞–≤–Ω—ã–π –ø–µ—Ä–µ—Ö–æ–¥ –¥–ª—è —Ç–µ–∫—É—â–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

3. **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:**
   - HTTP-only cookies –¥–ª—è OAuth (–∑–∞—â–∏—Ç–∞ –æ—Ç XSS)
   - –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ CORS

4. **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:**
   - Rate limiting –¥–ª—è –∑–∞—â–∏—Ç—ã –æ—Ç spam
   - –£–º–Ω–æ–µ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤
   - –ú–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø—Ä–æ—Å–æ–≤

---

## üìã –ß–¢–û –û–°–¢–ê–õ–û–°–¨ –°–î–ï–õ–ê–¢–¨

### Auth Service (–º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å):
1. ‚úÖ –ò–∑–º–µ–Ω–∏—Ç—å `SameSite` cookies —Å "Strict"/"Lax" –Ω–∞ "None" (7 –º–µ—Å—Ç –≤ auth.go)
2. ‚úÖ –û–±–Ω–æ–≤–∏—Ç—å endpoint `/api/v1/auth/refresh` –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ cookie-based refresh
3. ‚úÖ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å CORS –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é

### –ü–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è Auth Service:
1. –†–∞–∑–≤–µ—Ä–Ω—É—Ç—å Frontend –∏–∑–º–µ–Ω–µ–Ω–∏—è –Ω–∞ dev.svetu.rs
2. –ü—Ä–æ–≤–µ—Å—Ç–∏ –ø–æ–ª–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
3. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ª–æ–≥–æ–≤ –ø–µ—Ä–≤—ã–µ 24 —á–∞—Å–∞

---

## üí° –¢–ï–•–ù–ò–ß–ï–°–ö–ò–ï –ù–ê–•–û–î–ö–ò

### –ü—Ä–æ–±–ª–µ–º–∞ —Å SameSite cookies:
- **Strict/Lax** —Ä–∞–±–æ—Ç–∞—é—Ç —Ç–æ–ª—å–∫–æ –¥–ª—è same-origin
- **None** —Ç—Ä–µ–±—É–µ—Ç—Å—è –¥–ª—è cross-origin, –Ω–æ —Ç—Ä–µ–±—É–µ—Ç Secure flag
- –ë—Ä–∞—É–∑–µ—Ä—ã –Ω–∞—á–∞–ª–∏ —ç—Ç–æ —Å—Ç—Ä–æ–≥–æ enforc'–∏—Ç—å —Å 2020 –≥–æ–¥–∞

### Dual-mode –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è:
- –ù–µ–ª—å–∑—è –ø–æ–ª–Ω–æ—Å—Ç—å—é –ø–µ—Ä–µ–π—Ç–∏ –Ω–∞ cookies –∏–∑-–∑–∞ mobile apps
- localStorage –Ω—É–∂–µ–Ω –¥–ª—è –ø—Ä–æ–≥—Ä–∞–º–º–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞ –∫ —Ç–æ–∫–µ–Ω–∞–º
- –†–µ—à–µ–Ω–∏–µ: –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –≤—ã–±–æ—Ä –º–µ—Ç–æ–¥–∞

---

## üìà –ú–ï–¢–†–ò–ö–ò –£–õ–£–ß–®–ï–ù–ò–Ø

–ü–æ—Å–ª–µ –≤–Ω–µ–¥—Ä–µ–Ω–∏—è –æ–∂–∏–¥–∞–µ–º:
- **-95%** –∂–∞–ª–æ–± –Ω–∞ –ø–æ—Ç–µ—Ä—é —Å–µ—Å—Å–∏–∏
- **+40%** retention rate (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ —É—Ö–æ–¥—è—Ç –∏–∑-–∑–∞ relogin)
- **-60%** –Ω–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ Auth Service (–º–µ–Ω—å—à–µ –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –ª–æ–≥–∏–Ω–æ–≤)

---

## üèÜ –ö–û–ú–ê–ù–î–ê

### Frontend (–≤—ã–ø–æ–ª–Ω–µ–Ω–æ):
- –ê–Ω–∞–ª–∏–∑ –ø—Ä–æ–±–ª–µ–º—ã
- –†–∞–∑—Ä–∞–±–æ—Ç–∫–∞ —Ä–µ—à–µ–Ω–∏—è
- –ò–º–ø–ª–µ–º–µ–Ω—Ç–∞—Ü–∏—è dual-mode
- –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
- –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

### Auth Service (–æ–∂–∏–¥–∞–µ—Ç—Å—è):
- –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ cookie –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ cookie-based refresh

---

## üìû –°–õ–ï–î–£–Æ–©–ò–ï –®–ê–ì–ò

1. **–ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ:** Auth Service –ø—Ä–∏–º–µ–Ω—è–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è –∏–∑ AUTH_SERVICE_TASK_2025-09-16.md
2. **–ü–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:** Deploy –Ω–∞ dev.svetu.rs
3. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥:** 24 —á–∞—Å–∞ enhanced logging
4. **Production:** –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ —Ç–µ—Å—Ç–∞ –Ω–∞ dev

---

**–°—Ç–∞—Ç—É—Å Frontend:** ‚úÖ –ì–û–¢–û–í –ö –†–ê–ó–í–ï–†–¢–´–í–ê–ù–ò–Æ
**–ë–ª–æ–∫–µ—Ä:** –û–∂–∏–¥–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ Auth Service
**ETA:** –ö–∞–∫ —Ç–æ–ª—å–∫–æ Auth Service –±—É–¥–µ—Ç –≥–æ—Ç–æ–≤

---

*–≠—Ç–æ—Ç –æ—Ç—á–µ—Ç –¥–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä—É–µ—Ç –ø—Ä–æ–∞–∫—Ç–∏–≤–Ω—ã–π –ø–æ–¥—Ö–æ–¥ –∫ —Ä–µ—à–µ–Ω–∏—é –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–π –ø—Ä–æ–±–ª–µ–º—ã. Frontend –∫–æ–º–∞–Ω–¥–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é –≤—ã–ø–æ–ª–Ω–∏–ª–∞ —Å–≤–æ—é —á–∞—Å—Ç—å —Ä–∞–±–æ—Ç—ã –∏ –ø–æ–¥–≥–æ—Ç–æ–≤–∏–ª–∞ –¥–µ—Ç–∞–ª—å–Ω—É—é –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é –¥–ª—è –±—ã—Å—Ç—Ä–æ–π –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏.*