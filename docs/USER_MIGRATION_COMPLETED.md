# Миграция пользователей в Auth Service - ЗАВЕРШЕНА

## Дата выполнения
09.09.2025

## Проблема
Была обнаружена рассинхронизация пользователей между основной БД и Auth Service:
- В Auth Service user_id=6 имел email=boxmail386@gmail.com
- В основной БД user_id=6 имел email=4hash92@gmail.com
- Это приводило к путанице при аутентификации через Google OAuth

## Решение
Выполнена полная миграция всех пользователей из основной БД в Auth Service с сохранением оригинальных ID.

## Результаты миграции

### Успешно мигрировано
- **11 пользователей** из основной БД
- Все ID сохранены без изменений
- Роли назначены корректно

### Админы в системе
1. ID=2: voroshilovdo@gmail.com
2. ID=3: boxmail386@gmail.com

### Проверенные соответствия
- ✅ User ID=3: boxmail386@gmail.com (корректно)
- ✅ User ID=6: 4hash92@gmail.com (корректно)

## Технические детали

### Созданные файлы
1. `/data/hostel-booking-system/scripts/migrate_users_to_auth_service.go` - скрипт миграции
2. `/data/auth_svetu/auth.users_backup_before_migration` - резервная таблица в БД

### Что было сделано
1. Создана резервная копия данных Auth Service
2. Очищены существующие данные пользователей в Auth Service
3. Мигрированы все пользователи с сохранением:
   - ID пользователей
   - Email адресов
   - Имён
   - Паролей (хешированы если были в открытом виде)
   - Дат создания
4. Назначены роли (admin/user) на основе email
5. Сброшена последовательность ID для новых пользователей

## Важные замечания

### Синхронизация ID
Теперь ID пользователей синхронизированы между системами:
- JWT токены от Auth Service содержат правильные user_id
- Backend может использовать user_id из токена для поиска в основной БД
- Нет больше путаницы с email адресами

### Безопасность
- Пароли автоматически хешированы при миграции
- OAuth пользователи определены по отсутствию пароля
- Админские права назначены только проверенным email

## Восстановление при необходимости

Если нужно откатить миграцию:
```sql
-- В Auth Service БД
DROP TABLE IF EXISTS auth.users;
ALTER TABLE auth.users_backup_before_migration RENAME TO users;
```

## Рекомендации на будущее

1. **Синхронизация при создании пользователей**: При регистрации новых пользователей через Auth Service, нужно создавать их и в основной БД с тем же ID.

2. **Единый источник истины**: Постепенно переходить на Auth Service как единственный источник данных о пользователях.

3. **Регулярная проверка**: Периодически проверять синхронизацию ID между системами.

## Статус
✅ **МИГРАЦИЯ УСПЕШНО ЗАВЕРШЕНА**