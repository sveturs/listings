# –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –¥–æ—Å—Ç–∞–≤–æ–∫ —Å Viber Bot

## –û–±–∑–æ—Ä

–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å–∏—Å—Ç–µ–º—ã –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –¥–æ—Å—Ç–∞–≤–æ–∫ —Å Viber –±–æ—Ç–æ–º, –ø–æ–∑–≤–æ–ª—è—é—â–∞—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å —Å–≤–æ–∏ –ø–æ—Å—ã–ª–∫–∏ –ø—Ä—è–º–æ –≤ –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä–µ Viber.

## –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å

### 1. –ö–æ–º–∞–Ω–¥–∞ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –≤ –±–æ—Ç–µ
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –º–æ–≥—É—Ç –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–æ–º–∞–Ω–¥—É –±–æ—Ç—É:
```
track_TEST-TOKEN-123
```

### 2. Rich Media –∫–∞—Ä—Ç–∞ –≤ Viber
–ë–æ—Ç –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –≤ –æ—Ç–≤–µ—Ç:
- **–°—Ç–∞—Ç–∏—á–µ—Å–∫—É—é –∫–∞—Ä—Ç—É** —Å –º–∞—Ä—à—Ä—É—Ç–æ–º –¥–æ—Å—Ç–∞–≤–∫–∏ (—á–µ—Ä–µ–∑ Mapbox Static API)
- **–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –¥–æ—Å—Ç–∞–≤–∫–µ**: —Å—Ç–∞—Ç—É—Å, –≤—Ä–µ–º—è –ø—Ä–∏–±—ã—Ç–∏—è
- **–ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π**:
  - üó∫Ô∏è "–û—Ç–∫—Ä—ã—Ç—å –∫–∞—Ä—Ç—É" - –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—É—é –∫–∞—Ä—Ç—É
  - üîÑ "–û–±–Ω–æ–≤–∏—Ç—å" - –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç —Å–≤–µ–∂—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é

### 3. –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∞—è –≤–µ–±-–∫–∞—Ä—Ç–∞
–ü—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ –Ω–∞ "–û—Ç–∫—Ä—ã—Ç—å –∫–∞—Ä—Ç—É" –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è:
- –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã —Ç—Ä–µ–∫–∏–Ω–≥–∞ –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤
- –ü–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω–∞—è –∫–∞—Ä—Ç–∞ —Å —Ä–µ–∞–ª—å–Ω—ã–º –ø–æ–ª–æ–∂–µ–Ω–∏–µ–º –∫—É—Ä—å–µ—Ä–∞
- –ö–æ–º–ø–∞–∫—Ç–Ω–∞—è –ø–∞–Ω–µ–ª—å —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –¥–æ—Å—Ç–∞–≤–∫–µ
- WebSocket –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏

## –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

### Backend

#### –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥ Viber (`/backend/internal/proj/viber/handler/`)
```go
// HandleTrackDelivery - –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥—ã track_
func (m *MessageHandler) HandleTrackDelivery(ctx context.Context, viberID, trackingToken string) error {
    // –°–æ–∑–¥–∞—ë–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –∫–∞—Ä—Ç—ã
    delivery := &service.DeliveryInfo{
        TrackingToken:     trackingToken,
        CourierLatitude:   44.95,
        CourierLongitude:  20.10,
        DeliveryLatitude:  45.2671,
        DeliveryLongitude: 19.8335,
        EstimatedTime:     time.Now().Add(2 * time.Hour),
    }

    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º Rich Media —Å –∫–∞—Ä—Ç–æ–π
    return m.infobipService.SendTrackingNotification(ctx, viberID, delivery)
}
```

#### –°–µ—Ä–≤–∏—Å Infobip (`/backend/internal/proj/viber/service/infobip_bot_service.go`)
```go
func (s *InfobipBotService) SendTrackingNotification(ctx context.Context, viberID string, delivery *DeliveryInfo) error {
    // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Å—Ç–∞—Ç–∏—á–µ—Å–∫—É—é –∫–∞—Ä—Ç—É
    mapURL := s.generateStaticMapURL(delivery)

    // –°–æ–∑–¥–∞—ë–º Rich Media —Å –∫–Ω–æ–ø–∫–∞–º–∏
    buttons := []infobip.ViberRichMediaButton{
        {
            // –°—Ç–∞—Ç–∏—á–µ—Å–∫–∞—è –∫–∞—Ä—Ç–∞
            Columns: 6, Rows: 4,
            Image: mapURL,
        },
        {
            // –ö–Ω–æ–ø–∫–∞ –æ—Ç–∫—Ä—ã—Ç–∏—è –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ–π –∫–∞—Ä—Ç—ã
            ActionType: "open-url",
            ActionBody: fmt.Sprintf("https://svetu.rs/track/%s?viber=true&embedded=true", token),
            Text: "üó∫Ô∏è –û—Ç–∫—Ä—ã—Ç—å –∫–∞—Ä—Ç—É",
        },
        {
            // –ö–Ω–æ–ø–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
            ActionType: "reply",
            ActionBody: fmt.Sprintf("update_track_%s", token),
            Text: "üîÑ –û–±–Ω–æ–≤–∏—Ç—å",
        },
    }
}
```

### Frontend

#### –ê–¥–∞–ø—Ç–∏–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ —Ç—Ä–µ–∫–∏–Ω–≥–∞ (`/frontend/svetu/src/app/[locale]/track/[token]/TrackingClient.tsx`)

–°—Ç—Ä–∞–Ω–∏—Ü–∞ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç, –æ—Ç–∫—É–¥–∞ –æ–Ω–∞ –æ—Ç–∫—Ä—ã—Ç–∞:
```typescript
const isViber = searchParams.get('viber') === 'true';
const isEmbedded = searchParams.get('embedded') === 'true';

// –ï—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç–∞ –∏–∑ Viber –≤–æ –≤—Å—Ç—Ä–æ–µ–Ω–Ω–æ–º —Ä–µ–∂–∏–º–µ
if (isEmbedded && isViber) {
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –ø–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω—É—é –∫–∞—Ä—Ç—É
    return (
        <div className="h-screen w-full relative">
            <TrackingMap delivery={delivery} />
            {/* –ö–æ–º–ø–∞–∫—Ç–Ω–∞—è –ø–∞–Ω–µ–ª—å —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π */}
            <div className="absolute bottom-0 left-0 right-0">
                <div>–°—Ç–∞—Ç—É—Å: {delivery.status}</div>
                <div>ETA: {delivery.estimated_time}</div>
                <div>–°–∫–æ—Ä–æ—Å—Ç—å: {courier.speed} –∫–º/—á</div>
            </div>
        </div>
    );
}
```

## URL –ø–∞—Ä–∞–º–µ—Ç—Ä—ã

- `?viber=true` - —É–∫–∞–∑—ã–≤–∞–µ—Ç —á—Ç–æ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –æ—Ç–∫—Ä—ã—Ç–∞ –∏–∑ Viber
- `?embedded=true` - –≤–∫–ª—é—á–∞–µ—Ç —Ä–µ–∂–∏–º –≤—Å—Ç—Ä–æ–µ–Ω–Ω–æ–π –∫–∞—Ä—Ç—ã (–±–µ–∑ —Ö–µ–¥–µ—Ä–∞ –∏ —Ñ—É—Ç–µ—Ä–∞)

## –ü–æ—Ç–æ–∫ –¥–∞–Ω–Ω—ã—Ö

1. **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å** ‚Üí –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç `track_TOKEN` –≤ Viber –±–æ—Ç
2. **Webhook Handler** ‚Üí —Ä–∞—Å–ø–æ–∑–Ω–∞—ë—Ç –∫–æ–º–∞–Ω–¥—É –∏ –≤—ã–∑—ã–≤–∞–µ—Ç `HandleTrackDelivery`
3. **Message Handler** ‚Üí –ø–æ–ª—É—á–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –æ –¥–æ—Å—Ç–∞–≤–∫–µ –∏–∑ –ë–î
4. **Infobip Service** ‚Üí –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç Rich Media —Å –∫–∞—Ä—Ç–æ–π
5. **Viber API** ‚Üí –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
6. **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å** ‚Üí –Ω–∞–∂–∏–º–∞–µ—Ç "–û—Ç–∫—Ä—ã—Ç—å –∫–∞—Ä—Ç—É"
7. **Web Browser** ‚Üí –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç `/track/TOKEN?viber=true&embedded=true`
8. **Tracking Page** ‚Üí –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—É—é –∫–∞—Ä—Ç—É
9. **WebSocket** ‚Üí –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è –¥–ª—è real-time –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π

## –°—Ç–∞—Ç–∏—á–µ—Å–∫–∞—è –∫–∞—Ä—Ç–∞ Mapbox

URL –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è –≤ —Ñ–æ—Ä–º–∞—Ç–µ:
```
https://api.mapbox.com/styles/v1/mapbox/streets-v11/static/
    pin-l-bicycle+3b82f6(lon,lat),  // –ú–∞—Ä–∫–µ—Ä –∫—É—Ä—å–µ—Ä–∞
    pin-l-home+ef4444(lon,lat)      // –ú–∞—Ä–∫–µ—Ä –¥–æ—Å—Ç–∞–≤–∫–∏
    /auto/600x400@2x                 // –†–∞–∑–º–µ—Ä –∏ –º–∞—Å—à—Ç–∞–±
    ?access_token=TOKEN
```

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –°–æ–∑–¥–∞–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö
```sql
INSERT INTO post_express_shipments (
    tracking_number, status,
    sender_name, sender_address, sender_city, sender_postal_code, sender_phone,
    recipient_name, recipient_address, recipient_city, recipient_postal_code, recipient_phone,
    weight_kg
) VALUES (
    'TEST-TOKEN-123', 'in_transit',
    'Test Sender', 'Test Street 1', 'Belgrade', '11000', '+381601234567',
    'Test Recipient', 'Test Avenue 2', 'Novi Sad', '21000', '+381607654321',
    1.5
);
```

### –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ Viber
1. –û—Ç–ø—Ä–∞–≤–∏—Ç—å –±–æ—Ç—É: `track_TEST-TOKEN-123`
2. –ü–æ–ª—É—á–∏—Ç—å Rich Media —Å –∫–∞—Ä—Ç–æ–π
3. –ù–∞–∂–∞—Ç—å "–û—Ç–∫—Ä—ã—Ç—å –∫–∞—Ä—Ç—É"
4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—É—é –∫–∞—Ä—Ç—É

### –ü—Ä—è–º–∞—è —Å—Å—ã–ª–∫–∞ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
- –û–±—ã—á–Ω–∞—è –≤–µ—Ä—Å–∏—è: http://localhost:3001/en/track/TEST-TOKEN-123
- Viber –≤–µ—Ä—Å–∏—è: http://localhost:3001/en/track/TEST-TOKEN-123?viber=true&embedded=true

## –ë—É–¥—É—â–∏–µ —É–ª—É—á—à–µ–Ω–∏—è

1. **–†–µ–∞–ª—å–Ω—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –∫—É—Ä—å–µ—Ä–∞** –∏–∑ GPS —Ç—Ä–µ–∫–µ—Ä–∞
2. **Push-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è** —á–µ—Ä–µ–∑ Viber –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞
3. **–ò—Å—Ç–æ—Ä–∏—è –º–∞—Ä—à—Ä—É—Ç–∞** —Å –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º –ø—Ä–æ–π–¥–µ–Ω–Ω–æ–≥–æ –ø—É—Ç–∏
4. **–ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º–æ–µ –≤—Ä–µ–º—è –ø—Ä–∏–±—ã—Ç–∏—è** –Ω–∞ –æ—Å–Ω–æ–≤–µ ML-–º–æ–¥–µ–ª–∏
5. **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Post Express API** –¥–ª—è —Ä–µ–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
6. **–û—Ñ–ª–∞–π–Ω –∫–∞—Ä—Ç—ã** –¥–ª—è —ç–∫–æ–Ω–æ–º–∏–∏ —Ç—Ä–∞—Ñ–∏–∫–∞

## –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

–¢—Ä–µ–±—É–µ—Ç—Å—è –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å:
```bash
# Backend
MAPBOX_ACCESS_TOKEN=pk.xxx...  # –î–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏—Ö –∫–∞—Ä—Ç
INFOBIP_API_KEY=xxx...          # –î–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ Rich Media
INFOBIP_SENDER_ID=xxx...        # ID –±–æ—Ç–∞ –≤ Viber

# Frontend
NEXT_PUBLIC_MAPBOX_ACCESS_TOKEN=pk.xxx...  # –î–ª—è –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ–π –∫–∞—Ä—Ç—ã
```

## –°—Ç–∞—Ç—É—Å: ‚úÖ –ì–æ—Ç–æ–≤–æ –∫ –ø—Ä–æ–¥–∞–∫—à–µ–Ω—É

–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω –∏ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω. –û–∂–∏–¥–∞–µ—Ç:
- –†–µ–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –æ—Ç Post Express API
- GPS –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –æ—Ç –∫—É—Ä—å–µ—Ä–æ–≤
- Production credentials –¥–ª—è Infobip