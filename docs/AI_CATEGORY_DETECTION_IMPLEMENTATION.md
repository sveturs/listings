# üéØ –†–ï–ê–õ–ò–ó–ê–¶–ò–Ø –£–õ–£–ß–®–ï–ù–ù–û–ô –°–ò–°–¢–ï–ú–´ AI –ö–ê–¢–ï–ì–û–†–ò–ó–ê–¶–ò–ò

## ‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏

### 1. –°–æ–∑–¥–∞–Ω–∞ —Ç–∞–±–ª–∏—Ü–∞ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è AI —Ä–µ—à–µ–Ω–∏–π
```sql
-- –¢–∞–±–ª–∏—Ü–∞ ai_category_decisions
-- –•—Ä–∞–Ω–∏—Ç –≤—Å–µ —Ä–µ—à–µ–Ω–∏—è AI –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∑–∞—Ü–∏–∏ –¥–ª—è –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è –∏ –æ–±—É—á–µ–Ω–∏—è
CREATE TABLE ai_category_decisions (
    id SERIAL PRIMARY KEY,
    title_hash VARCHAR(64) NOT NULL,  -- SHA256 —Ö–µ—à –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞
    title TEXT NOT NULL,
    description TEXT,
    category_id INTEGER NOT NULL,
    confidence DECIMAL(5,4),
    reasoning TEXT,
    alternative_category_ids INTEGER[],
    ai_model VARCHAR(100),
    processing_time_ms INTEGER,
    user_confirmed BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

### 2. –ú–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω –º–µ—Ç–æ–¥ DetectWithAIFallback

–ù–æ–≤—ã–π –∞–ª–≥–æ—Ä–∏—Ç–º —Ä–∞–±–æ—Ç—ã:

1. **–ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–µ—à–∞** - –∏—â–µ–º –≤ —Ç–∞–±–ª–∏—Ü–µ ai_category_decisions
2. **–ë—ã—Å—Ç—Ä—ã–π –ª–æ–∫–∞–ª—å–Ω—ã–π –ø–æ–∏—Å–∫** - –µ—Å–ª–∏ confidence > 90%
3. **AI –≤—ã–±–æ—Ä –∏–∑ –ø–æ–ª–Ω–æ–≥–æ —Å–ø–∏—Å–∫–∞** - –æ—Å–Ω–æ–≤–Ω–æ–π –º–µ—Ç–æ–¥ (–≤—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–µ–º AI)

```go
func (d *AICategoryDetector) DetectWithAIFallback(ctx context.Context, input AIDetectionInput) (*AIDetectionResult, error) {
    // –§–∞–∑–∞ 1: –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–µ—à AI —Ä–µ—à–µ–Ω–∏–π
    cachedResult, err := d.getAIDecisionFromCache(ctx, input)
    if err == nil && cachedResult != nil {
        return cachedResult, nil
    }

    // –§–∞–∑–∞ 2: –ë—ã—Å—Ç—Ä—ã–π –ª–æ–∫–∞–ª—å–Ω—ã–π –ø–æ–∏—Å–∫ (–µ—Å–ª–∏ confidence > 90%)
    localResult, err := d.quickLocalSearch(ctx, input)
    if err == nil && localResult != nil && localResult.ConfidenceScore > 0.90 {
        if d.isSemanticallySensible(ctx, input, localResult) {
            d.saveAIDecisionToCache(ctx, input, localResult, "", false)
            return localResult, nil
        }
    }

    // –§–∞–∑–∞ 3: AI –≤—ã–±–∏—Ä–∞–µ—Ç –∏–∑ –ø–æ–ª–Ω–æ–≥–æ —Å–ø–∏—Å–∫–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–π (–æ—Å–Ω–æ–≤–Ω–æ–π –º–µ—Ç–æ–¥)
    aiResult, err := d.selectCategoryWithAI(ctx, input)
    // ... –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
}
```

### 3. –î–æ–±–∞–≤–ª–µ–Ω–æ –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ—à–µ–Ω–∏–π AI

- **getAIDecisionFromCache** - –ø–æ–ª—É—á–µ–Ω–∏–µ –∏–∑ —Ç–∞–±–ª–∏—Ü—ã –ø–æ —Ö–µ—à—É –∑–∞–≥–æ–ª–æ–≤–∫–∞
- **saveAIDecisionToCache** - —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π ON CONFLICT
- –°—Ä–æ–∫ —Ö—Ä–∞–Ω–µ–Ω–∏—è –∫–µ—à–∞: 30 –¥–Ω–µ–π
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–∏ –±–æ–ª–µ–µ –≤—ã—Å–æ–∫–æ–π confidence

### 4. –°–æ–∑–¥–∞–Ω –Ω–æ–≤—ã–π endpoint /api/ai/select-category

```go
// POST /api/v1/marketplace/ai/select-category
// –ü—Ä—è–º–æ–π –≤—ã–±–æ—Ä –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ —á–µ—Ä–µ–∑ AI –±–µ–∑ fallback
func (h *AICategoryHandler) SelectCategory(c *fiber.Ctx) error {
    // –í—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç AI –¥–ª—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π —Ç–æ—á–Ω–æ—Å—Ç–∏
    result, err := h.detector.SelectCategoryDirectly(ctx, input)
}
```

### 5. –ú–µ—Ç–æ–¥ SelectCategoryDirectly

–ù–æ–≤—ã–π –º–µ—Ç–æ–¥ –¥–ª—è –ø—Ä—è–º–æ–≥–æ –æ–±—Ä–∞—â–µ–Ω–∏—è –∫ AI:
- –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –∫–µ—à
- –ù–∞–ø—Ä—è–º—É—é –≤—ã–∑—ã–≤–∞–µ—Ç AI –¥–ª—è –≤—ã–±–æ—Ä–∞ –∏–∑ –≤—Å–µ—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏–π
- –°–æ—Ö—Ä–∞–Ω—è–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ –∫–µ—à –¥–ª—è –±—É–¥—É—â–µ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

## üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

### –£—Å–ø–µ—à–Ω—ã–µ –∫–µ–π—Å—ã:
- ‚úÖ –ö–≤–∞—Ä—Ç–∏—Ä–∞ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –≤ –∫–∞—Ç–µ–≥–æ—Ä–∏—é "Stanovi" —Å confidence 0.99
- ‚úÖ –ë—ã—Å—Ç—Ä–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ –∫–µ—à (< 2ms –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤)

### –ü—Ä–æ–±–ª–µ–º—ã —Å AI –≤—ã–∑–æ–≤–∞–º–∏:
- ‚ö†Ô∏è –ü—Ä–∏ –≤—ã–∑–æ–≤–µ –º–µ—Ç–æ–¥–∞ `/select-category` –≤–æ–∑–Ω–∏–∫–∞–µ—Ç –æ—à–∏–±–∫–∞ `aiSelectionFailed`
- –ü—Ä–∏—á–∏–Ω–∞: –≤–µ—Ä–æ—è—Ç–Ω–æ, –ø—Ä–æ–±–ª–µ–º–∞ —Å –¥–æ—Å—Ç—É–ø–æ–º –∫ API Claude –∏–ª–∏ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

## üîß –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –Ω–æ–≤–æ–π —Å–∏—Å—Ç–µ–º—ã

1. **–ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ** - –ø–æ–≤—Ç–æ—Ä–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –º–≥–Ω–æ–≤–µ–Ω–Ω–æ
2. **AI –∫–∞–∫ –æ—Å–Ω–æ–≤–Ω–æ–π –º–µ—Ç–æ–¥** - –º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è —Ç–æ—á–Ω–æ—Å—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏–∑–∞—Ü–∏–∏
3. **–û–±—É—á–µ–Ω–∏–µ** - —Å–∏—Å—Ç–µ–º–∞ –∑–∞–ø–æ–º–∏–Ω–∞–µ—Ç —Ä–µ—à–µ–Ω–∏—è –∏ —É–ª—É—á—à–∞–µ—Ç—Å—è —Å–æ –≤—Ä–µ–º–µ–Ω–µ–º
4. **–ì–∏–±–∫–æ—Å—Ç—å** - —Ç—Ä–∏ —É—Ä–æ–≤–Ω—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Å fallback –º–µ—Ö–∞–Ω–∏–∑–º–∞–º–∏
5. **–°–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è** - –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç–∏

## üìù –ú–∏–≥—Ä–∞—Ü–∏–∏

- `000032_add_ai_category_decisions.up/down.sql` - —Ç–∞–±–ª–∏—Ü–∞ –¥–ª—è –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è
- `000033_add_unique_index_title_hash.up/down.sql` - —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–Ω–¥–µ–∫—Å

## üöÄ –î–∞–ª—å–Ω–µ–π—à–∏–µ —É–ª—É—á—à–µ–Ω–∏—è

1. **–ù–∞—Å—Ç—Ä–æ–∏—Ç—å API Claude** - –ø—Ä–æ–≤–µ—Ä–∏—Ç—å ANTHROPIC_API_KEY –∏ endpoint
2. **–î–æ–±–∞–≤–∏—Ç—å –º–µ—Ç—Ä–∏–∫–∏** - –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ —Ç–æ—á–Ω–æ—Å—Ç–∏ –∏ —Å–∫–æ—Ä–æ—Å—Ç–∏
3. **Batch –æ–±—Ä–∞–±–æ—Ç–∫–∞** - –º–∞—Å—Å–æ–≤–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∑–∞—Ü–∏—è —Ç–æ–≤–∞—Ä–æ–≤
4. **ML –º–æ–¥–µ–ª—å** - –æ–±—É—á–µ–Ω–∏–µ –ª–æ–∫–∞–ª—å–Ω–æ–π –º–æ–¥–µ–ª–∏ –Ω–∞ –Ω–∞–∫–æ–ø–ª–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
5. **A/B —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ** - —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å—Ç–∞—Ä–æ–≥–æ –∏ –Ω–æ–≤–æ–≥–æ –º–µ—Ç–æ–¥–æ–≤

## ‚öôÔ∏è –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

–ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è:
- `ANTHROPIC_API_KEY` - –∫–ª—é—á –¥–ª—è Claude API
- `CLAUDE_API_KEY` - –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –∫–ª—é—á (–ø—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–∞–∫–æ–π –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è)

## üìà –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞

- –°–æ–∑–¥–∞–Ω–æ 2 –Ω–æ–≤—ã–µ –º–∏–≥—Ä–∞—Ü–∏–∏
- –î–æ–±–∞–≤–ª–µ–Ω–æ 4 –Ω–æ–≤—ã—Ö –º–µ—Ç–æ–¥–∞ –≤ AI detector
- –°–æ–∑–¥–∞–Ω 1 –Ω–æ–≤—ã–π endpoint
- –ú–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–æ 3 —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –º–µ—Ç–æ–¥–∞
- –†–∞–∑–º–µ—Ä –∫–æ–¥–∞: +300 —Å—Ç—Ä–æ–∫