# –ü–ª–∞–Ω –º–∏–≥—Ä–∞—Ü–∏–∏ –Ω–∞ —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—É—é –≤–∞–ª–∏–¥–∞—Ü–∏—é —á–µ—Ä–µ–∑ auth-service

```
‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë                                                                              ‚ïë
‚ïë   üî¥üî¥üî¥  –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û: –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û–ï –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï!  üî¥üî¥üî¥              ‚ïë
‚ïë                                                                              ‚ïë
‚ïë   –ü–æ—Å–ª–µ –ö–ê–ñ–î–û–ì–û –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –∫–æ–¥–µ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏/–∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏:                ‚ïë
‚ïë                                                                              ‚ïë
‚ïë   1. ‚úÖ –ó–∞–ø—É—Å—Ç–∏—Ç—å backend (–ø—Ä–æ–≤–µ—Ä–∏—Ç—å –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –æ—à–∏–±–æ–∫)                     ‚ïë
‚ïë   2. ‚úÖ –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –∏–∑–º–µ–Ω–µ–Ω–Ω—ã–µ endpoints —Å —Ç–æ–∫–µ–Ω–æ–º                        ‚ïë
‚ïë   3. ‚úÖ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å 401 –æ—Ç–≤–µ—Ç –Ω–∞ endpoints –±–µ–∑ —Ç–æ–∫–µ–Ω–∞                          ‚ïë
‚ïë   4. ‚úÖ –ó–∞–ø—É—Å—Ç–∏—Ç—å unit —Ç–µ—Å—Ç—ã –º–æ–¥—É–ª—è                                          ‚ïë
‚ïë   5. ‚úÖ –ó–∞–ø—É—Å—Ç–∏—Ç—å –ª–∏–Ω—Ç–µ—Ä (make lint)                                         ‚ïë
‚ïë                                                                              ‚ïë
‚ïë   ‚õî –ë–ï–ó –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–Ø - –ë–ï–ó –ö–û–ú–ú–ò–¢–ê! –ë–ï–ó –ò–°–ö–õ–Æ–ß–ï–ù–ò–ô!                        ‚ïë
‚ïë                                                                              ‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
```

**–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è:** 2025-10-02
**–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ:** 2025-10-02 (Phase 2.1-2.3 –∑–∞–≤–µ—Ä—à–µ–Ω—ã)
**–í–µ—Ä—Å–∏—è –±–∏–±–ª–∏–æ—Ç–µ–∫–∏:** github.com/sveturs/auth v1.8.0
**–°—Ç–∞—Ç—É—Å:** –§–ê–ó–ê 2 –í –ü–†–û–¶–ï–°–°–ï üî∂ (Phase 2.1-2.3 –∑–∞–≤–µ—Ä—à–µ–Ω—ã, –∫–æ–º–º–∏—Ç—ã 9e003b54, d1916cf6)
**–¢–æ–∫–µ–Ω –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:** `/tmp/token` (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å voroshilovdo@gmail.com, —Ä–æ–ª–∏: admin, user)

---

## ‚ö†Ô∏è –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û–ï –ü–†–ê–í–ò–õ–û: –í–°–ï–ì–î–ê –¢–ï–°–¢–ò–†–û–í–ê–¢–¨!

**üî¥ –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –¢–ï–°–¢–ò–†–û–í–ê–¢–¨ –ü–û–°–õ–ï –ö–ê–ñ–î–û–ì–û –ò–ó–ú–ï–ù–ï–ù–ò–Ø!**

–ü–æ—Å–ª–µ –õ–Æ–ë–û–ì–û –∏–∑–º–µ–Ω–µ–Ω–∏—è –∫–æ–¥–∞, —Å–≤—è–∑–∞–Ω–Ω–æ–≥–æ —Å –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–µ–π, –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–µ–π –∏–ª–∏ middleware, –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û:

1. **‚úÖ –ó–∞–ø—É—Å—Ç–∏—Ç—å backend** –∏ —É–±–µ–¥–∏—Ç—å—Å—è —á—Ç–æ —Å—Ç–∞—Ä—Ç—É–µ—Ç –±–µ–∑ –æ—à–∏–±–æ–∫
2. **‚úÖ –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –∏–∑–º–µ–Ω–µ–Ω–Ω—ã–µ endpoints** —Å –≤–∞–ª–∏–¥–Ω—ã–º —Ç–æ–∫–µ–Ω–æ–º
3. **‚úÖ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å 401 –æ—Ç–≤–µ—Ç** –Ω–∞ endpoints –±–µ–∑ —Ç–æ–∫–µ–Ω–∞
4. **‚úÖ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å admin endpoints** —Å admin —Ç–æ–∫–µ–Ω–æ–º
5. **‚úÖ –ó–∞–ø—É—Å—Ç–∏—Ç—å unit —Ç–µ—Å—Ç—ã** –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–Ω—ã—Ö –º–æ–¥—É–ª–µ–π
6. **‚úÖ –ó–∞–ø—É—Å—Ç–∏—Ç—å –ª–∏–Ω—Ç–µ—Ä** –∏ –∏—Å–ø—Ä–∞–≤–∏—Ç—å –≤—Å–µ –æ—à–∏–±–∫–∏

**–ù–ï –î–ï–õ–ê–ô –ö–û–ú–ú–ò–¢ –ë–ï–ó –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–Ø!**

–ü—Ä–∏–º–µ—Ä —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π:
```bash
# 1. –ó–∞–ø—É—Å—Ç–∏—Ç—å backend
screen -dmS backend-3000 bash -c 'cd /data/hostel-booking-system/backend && go run ./cmd/api/main.go 2>&1 | tee /tmp/backend.log'

# 2. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å endpoints
TOKEN=$(cat /tmp/token)
curl -H "Authorization: Bearer $TOKEN" http://localhost:3000/api/v1/[–∏–∑–º–µ–Ω–µ–Ω–Ω—ã–π-endpoint]

# 3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å 401 –±–µ–∑ —Ç–æ–∫–µ–Ω–∞
curl -i http://localhost:3000/api/v1/[–∑–∞—â–∏—â–µ–Ω–Ω—ã–π-endpoint]  # –û–∂–∏–¥–∞–µ–º 401

# 4. Unit —Ç–µ—Å—Ç—ã
go test ./internal/proj/[–∏–∑–º–µ–Ω–µ–Ω–Ω—ã–π-–º–æ–¥—É–ª—å]/...

# 5. –õ–∏–Ω—Ç–µ—Ä
make lint
```

**–¢–æ–ª—å–∫–æ –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏—è –≤—Å–µ—Ö —Ç–µ—Å—Ç–æ–≤ –º–æ–∂–Ω–æ –¥–µ–ª–∞—Ç—å –∫–æ–º–º–∏—Ç!**

---

## üìä –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞

| –ú–µ—Ç—Ä–∏–∫–∞ | –¢–µ–∫—É—â–µ–µ | –¶–µ–ª–µ–≤–æ–µ | –°—Ç–∞—Ç—É—Å |
|---------|---------|---------|--------|
| –ü—Ä–∞–≤–∏–ª—å–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ middleware | 95% | 95%+ | ‚úÖ |
| –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ helper —Ñ—É–Ω–∫—Ü–∏–π | 40% (31/77 –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ) | 90%+ | üü° |
| –ú–æ–¥—É–ª–µ–π –±–µ–∑ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –ø—Ä–æ–±–ª–µ–º | 18/18 | 18/18 | ‚úÖ |
| –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π | 0 | 0 | ‚úÖ |
| –ü—Ä—è–º–æ–π –¥–æ—Å—Ç—É–ø –∫ c.Locals | 46 –º–µ—Å—Ç (31 –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ) | 0 | üü° |

---

## üéØ –¶–µ–ª–∏ –º–∏–≥—Ä–∞—Ü–∏–∏

1. ‚úÖ –£—Å—Ç—Ä–∞–Ω–∏—Ç—å –≤—Å–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —É—è–∑–≤–∏–º–æ—Å—Ç–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
2. ‚úÖ –ü–æ–ª–Ω–æ—Å—Ç—å—é –º–∏–≥—Ä–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ –±–∏–±–ª–∏–æ—Ç–µ—á–Ω—ã–µ helpers
3. ‚úÖ –£–±—Ä–∞—Ç—å –≤–µ—Å—å —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π –¥–æ–ª–≥ (legacy –∫–æ–¥)
4. ‚úÖ –°—Ç–∞–Ω–¥–∞—Ä—Ç–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ø–æ–¥—Ö–æ–¥—ã –≤–æ –≤—Å–µ–º –ø—Ä–æ–µ–∫—Ç–µ
5. ‚úÖ –û–±–µ—Å–ø–µ—á–∏—Ç—å 100% —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å auth-service v1.8.0
6. ‚úÖ –ü–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å —Å–∏—Å—Ç–µ–º—É –∫ production

---

## üìã –§–ê–ó–ê 1: –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è ‚úÖ –ó–ê–í–ï–†–®–ï–ù–ê –ò –ü–†–û–¢–ï–°–¢–ò–†–û–í–ê–ù–ê

**–¶–µ–ª—å:** –£—Å—Ç—Ä–∞–Ω–∏—Ç—å –≤—Å–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã –∏–∑ –∞—É–¥–∏—Ç–∞
**–í—Ä–µ–º—è:** 1-2 –¥–Ω—è ‚Üí –ó–∞–≤–µ—Ä—à–µ–Ω–æ –∑–∞ 1 –¥–µ–Ω—å
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üî¥ –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô ‚Üí ‚úÖ –í–´–ü–û–õ–ù–ï–ù–û –ò –ü–†–û–¢–ï–°–¢–ò–†–û–í–ê–ù–û
**–ö–æ–º–º–∏—Ç:** 40690270

### ‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è Phase 1 (2025-10-02)

–í—Å–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ endpoints –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω—ã –∏ —Ä–∞–±–æ—Ç–∞—é—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ:

**1. ‚úÖ Recommendations endpoints:**
```bash
# view-history (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –∫–ª—é—á –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞)
curl -H "Authorization: Bearer $TOKEN" http://localhost:3000/api/v1/recommendations/view-history
# –†–µ–∑—É–ª—å—Ç–∞—Ç: 200 OK (–≤—Ä–µ–º–µ–Ω–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ —Å –ø—É—Å—Ç—ã–º –º–∞—Å—Å–∏–≤–æ–º, TODO –ø–æ–º–µ—á–µ–Ω)
```

**2. ‚úÖ Subscriptions endpoints:**
```bash
# current subscription (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω middleware)
curl -H "Authorization: Bearer $TOKEN" http://localhost:3000/api/v1/subscriptions/current
# –†–µ–∑—É–ª—å—Ç–∞—Ç: 200 OK, –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ø–æ–¥–ø–∏—Å–∫–∏
```

**3. ‚úÖ Marketplace admin endpoints:**
```bash
# admin categories (–¥–æ–±–∞–≤–ª–µ–Ω RequireAuth)
curl -H "Authorization: Bearer $TOKEN" http://localhost:3000/api/v1/admin/categories
# –†–µ–∑—É–ª—å—Ç–∞—Ç: 200 OK, —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏–π

# category detector (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –∫–ª—é—á –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞)
curl -H "Authorization: Bearer $TOKEN" -X POST http://localhost:3000/api/v1/marketplace/categories/detect \
  -H "Content-Type: application/json" \
  -d '{"keywords":["—Ç–µ–ª–µ—Ñ–æ–Ω","—Å–º–∞—Ä—Ç—Ñ–æ–Ω"],"title":"iPhone 15 Pro"}'
# –†–µ–∑—É–ª—å—Ç–∞—Ç: 200 OK, –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏—è Electronics
```

**4. ‚úÖ Unified search:**
```bash
# global search (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –∫–ª—é—á –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞)
curl -H "Authorization: Bearer $TOKEN" "http://localhost:3000/api/v1/search?q=—Ç–µ–ª–µ—Ñ–æ–Ω&limit=3"
# –†–µ–∑—É–ª—å—Ç–∞—Ç: 200 OK, –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞ (1 —Ç–æ–≤–∞—Ä –Ω–∞–π–¥–µ–Ω)
```

**5. ‚úÖ –ó–∞—â–∏—Ç–∞ –±–µ–∑ —Ç–æ–∫–µ–Ω–∞ (401):**
```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ protected endpoints –æ—Ç–∫–ª–æ–Ω—è—é—Ç –∑–∞–ø—Ä–æ—Å—ã –±–µ–∑ —Ç–æ–∫–µ–Ω–∞
curl -i http://localhost:3000/api/v1/subscriptions/current
# –†–µ–∑—É–ª—å—Ç–∞—Ç: HTTP 401 Unauthorized, {"error":"unauthorized","message":"Authentication required"}
```

**–ò–∑–≤–µ—Å—Ç–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã (—Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π –¥–æ–ª–≥):**
- `/api/v1/recommendations/view-history` - SQL query —Ç—Ä–µ–±—É–µ—Ç –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è (SQLX mapping issue), –≤—Ä–µ–º–µ–Ω–Ω–æ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤ —Å TODO –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–º

**–û–±—â–∏–π —Å—Ç–∞—Ç—É—Å:** ‚úÖ –í—Å–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ä–∞–±–æ—Ç–∞—é—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –≤ production-ready —Å–æ—Å—Ç–æ—è–Ω–∏–∏!

### –ü—Ä–æ–±–ª–µ–º–∞ #1: –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –∫–ª—é—á –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ "userID" ‚Üí "user_id" ‚úÖ

**–û–ø–∏—Å–∞–Ω–∏–µ:**
4 –º–æ–¥—É–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∏ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –∫–ª—é—á `"userID"` –≤–º–µ—Å—Ç–æ `"user_id"`, —á—Ç–æ –ø—Ä–∏–≤–æ–¥–∏–ª–æ –∫ —Ç–æ–º—É, —á—Ç–æ userID –≤—Å–µ–≥–¥–∞ nil.

**–ó–∞—Ç—Ä–æ–Ω—É—Ç—ã–µ —Ñ–∞–π–ª—ã:**
- [x] `backend/internal/proj/recommendations/handler.go` ‚úÖ
- [x] `backend/internal/proj/global/handler/unified_search.go` ‚úÖ
- [x] `backend/internal/proj/marketplace/handler/category_detector_handler.go` ‚úÖ
- [x] `backend/internal/proj/marketplace/handler/admin_translations.go` ‚úÖ

**–†–µ—à–µ–Ω–∏–µ:**
```go
// ‚ùå –ë–´–õ–û:
userID := c.Locals("userID")

// ‚úÖ –î–û–õ–ñ–ù–û –ë–´–¢–¨:
import authmw "github.com/sveturs/auth/pkg/http/fiber/middleware"

userID, ok := authmw.GetUserID(c)
if !ok {
    return utils.ErrorResponse(c, fiber.StatusUnauthorized, "user_not_found")
}
```

**–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:**
```bash
# –ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–∞–∂–¥—ã–π endpoint —Å —Ç–æ–∫–µ–Ω–æ–º
TOKEN=$(cat /tmp/token)
curl -H "Authorization: Bearer $TOKEN" http://localhost:3000/api/v1/recommendations
curl -H "Authorization: Bearer $TOKEN" http://localhost:3000/api/v1/search
```

---

### –ü—Ä–æ–±–ª–µ–º–∞ #2: –£—Å—Ç–∞—Ä–µ–≤—à–∏–π middleware –≤ subscriptions ‚úÖ

**–û–ø–∏—Å–∞–Ω–∏–µ:**
–ú–æ–¥—É–ª—å subscriptions –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª —Å—Ç–∞—Ä—ã–π middleware –≤–º–µ—Å—Ç–æ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ auth.

**–ó–∞—Ç—Ä–æ–Ω—É—Ç—ã–µ —Ñ–∞–π–ª—ã:**
- [x] `backend/internal/proj/subscriptions/handler/routes.go` (—Å—Ç—Ä–æ–∫–∏ 16, 26) ‚úÖ

**–¢–µ–∫—É—â–∏–π –∫–æ–¥:**
```go
// ‚ùå –ü–†–û–ë–õ–ï–ú–ê:
func (h *SubscriptionHandler) RegisterRoutes(
    app *fiber.App,
    authMiddleware *middleware.Middleware,
) {
    protected := app.Group("/api/v1/subscriptions",
        authMiddleware.RequireAuth())  // –°—Ç–∞—Ä—ã–π middleware!

    admin := app.Group("/api/v1/admin/subscriptions",
        authMiddleware.RequireAuth(),
        authMiddleware.RequireAdmin())
}
```

**–†–µ—à–µ–Ω–∏–µ:**
```go
// ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û:
import authmw "github.com/sveturs/auth/pkg/http/fiber/middleware"

func (h *SubscriptionHandler) RegisterRoutes(
    app *fiber.App,
    mw *middleware.Middleware,
) {
    protected := app.Group("/api/v1/subscriptions",
        mw.JWTParser(),
        authmw.RequireAuth())

    admin := app.Group("/api/v1/admin/subscriptions",
        mw.JWTParser(),
        authmw.RequireAuthString("admin"))
}
```

**‚úÖ –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û–ï —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ—Å–ª–µ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞:**
```bash
# 1. –ó–∞–ø—É—Å—Ç–∏—Ç—å backend
screen -dmS backend-3000 bash -c 'cd /data/hostel-booking-system/backend && go run ./cmd/api/main.go 2>&1 | tee /tmp/backend.log'

# 2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –æ—à–∏–±–æ–∫ –∑–∞–ø—É—Å–∫–∞
tail -20 /tmp/backend.log

# 3. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å endpoints
TOKEN=$(cat /tmp/token)
curl -H "Authorization: Bearer $TOKEN" http://localhost:3000/api/v1/subscriptions
curl -H "Authorization: Bearer $TOKEN" http://localhost:3000/api/v1/admin/subscriptions

# 4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å 401 –±–µ–∑ —Ç–æ–∫–µ–Ω–∞
curl -i http://localhost:3000/api/v1/subscriptions  # –û–∂–∏–¥–∞–µ–º 401

# 5. Unit —Ç–µ—Å—Ç—ã
go test ./internal/proj/subscriptions/...

# 6. –õ–∏–Ω—Ç–µ—Ä
make lint

# ‚úÖ –¢–æ–ª—å–∫–æ –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤ –¥–µ–ª–∞—Ç—å –∫–æ–º–º–∏—Ç!
```

---

### –ü—Ä–æ–±–ª–µ–º–∞ #3: –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ RequireAuth –≤ marketplace admin routes ‚úÖ

**–û–ø–∏—Å–∞–Ω–∏–µ:**
Admin routes –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∏ AdminRequired –±–µ–∑ RequireAuth, —á—Ç–æ —Å–æ–∑–¥–∞–≤–∞–ª–æ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—É—é —É—è–∑–≤–∏–º–æ—Å—Ç—å.

**–ó–∞—Ç—Ä–æ–Ω—É—Ç—ã–µ —Ñ–∞–π–ª—ã:**
- [x] `backend/internal/proj/marketplace/handler/handler.go:422` ‚úÖ
- [x] `backend/internal/proj/marketplace/handler/handler.go:347` ‚úÖ

**–¢–µ–∫—É—â–∏–π –∫–æ–¥:**
```go
// ‚ùå –ü–†–û–ë–õ–ï–ú–ê: AdminRequired –±–µ–∑ RequireAuth
adminRoutes := app.Group("/api/v1/admin",
    mw.JWTParser(),
    mw.AdminRequired)  // –ù–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ authenticated!
```

**–†–µ—à–µ–Ω–∏–µ:**
```go
// ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –±–∏–±–ª–∏–æ—Ç–µ—á–Ω—ã–π middleware
import authmw "github.com/sveturs/auth/pkg/http/fiber/middleware"

adminRoutes := app.Group("/api/v1/admin",
    mw.JWTParser(),
    authmw.RequireAuthString("admin"))
```

**–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:**
```bash
TOKEN=$(cat /tmp/token)
# –¢–µ—Å—Ç —Å —Ç–æ–∫–µ–Ω–æ–º (–¥–æ–ª–∂–µ–Ω –ø—Ä–æ–π—Ç–∏)
curl -H "Authorization: Bearer $TOKEN" http://localhost:3000/api/v1/admin/categories

# –¢–µ—Å—Ç –±–µ–∑ —Ç–æ–∫–µ–Ω–∞ (–¥–æ–ª–∂–µ–Ω –≤–µ—Ä–Ω—É—Ç—å 401)
curl http://localhost:3000/api/v1/admin/categories
```

---

### –§–∏–Ω–∞–ª–∏–∑–∞—Ü–∏—è –§–∞–∑—ã 1

**Pre-commit –ø—Ä–æ–≤–µ—Ä–∫–∏:**
```bash
cd /data/hostel-booking-system/backend

# –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
make format

# –õ–∏–Ω—Ç–∏–Ω–≥
make lint

# –¢–µ—Å—Ç—ã
go test ./...

# –ö–æ–º–ø–∏–ª—è—Ü–∏—è
go build ./...
```

**–°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–º–º–∏—Ç–∞:**
```bash
git add .
git commit -m "fix: critical auth library migration - wrong context keys and middleware

- Fix userID context key mismatch (userID -> user_id) in 4 modules
- Update subscriptions module to use auth library middleware
- Add RequireAuth to marketplace admin routes
- All critical security issues from audit resolved

Resolves: AUTH_LIBRARY_AUDIT_REPORT.md Problems #1, #2, #3"
```

---

## üìã –§–ê–ó–ê 2: –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ –ø—Ä—è–º–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞ –∫ c.Locals

**–¶–µ–ª—å:** –£–±—Ä–∞—Ç—å –≤–µ—Å—å legacy –∫–æ–¥ —Å –ø—Ä—è–º—ã–º –¥–æ—Å—Ç—É–ø–æ–º –∫ –∫–æ–Ω—Ç–µ–∫—Å—Ç—É
**–í—Ä–µ–º—è:** 1 –Ω–µ–¥–µ–ª—è
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üü† –í–´–°–û–ö–ò–ô
**–°—Ç–∞—Ç—É—Å:** üî∂ –í –ü–†–û–¶–ï–°–°–ï (Phase 2.1-2.3 –∑–∞–≤–µ—Ä—à–µ–Ω—ã, 40% –≤—ã–ø–æ–ª–Ω–µ–Ω–æ)

### ‚úÖ Phase 2.1: admin/logistics –º–æ–¥—É–ª—å - –ó–ê–í–ï–†–®–ï–ù–ê (2025-10-02)

**–ö–æ–º–º–∏—Ç:** 9e003b54
**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ:** 20 –º–µ—Å—Ç –ø—Ä—è–º–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞ –∫ c.Locals("user_id")

**–§–∞–π–ª—ã:**
- ‚úÖ `backend/internal/proj/admin/logistics/handler/dashboard.go` (2 –º–µ—Å—Ç–∞)
- ‚úÖ `backend/internal/proj/admin/logistics/handler/shipments.go` (5 –º–µ—Å—Ç)
- ‚úÖ `backend/internal/proj/admin/logistics/handler/analytics.go` (4 –º–µ—Å—Ç–∞)
- ‚úÖ `backend/internal/proj/admin/logistics/handler/problems.go` (9 –º–µ—Å—Ç)

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
- –ó–∞–º–µ–Ω–µ–Ω `c.Locals("user_id")` –Ω–∞ `authmw.GetUserID(c)`
- –ò—Å–ø—Ä–∞–≤–ª–µ–Ω—ã type assertions `userID.(int)` –Ω–∞ –ø—Ä—è–º–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `authmw.GetUserID`
- –î–æ–±–∞–≤–ª–µ–Ω import `authmw "github.com/sveturs/auth/pkg/http/fiber/middleware"`

**–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:**
```bash
‚úÖ Backend –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –±–µ–∑ –æ—à–∏–±–æ–∫
‚úÖ /api/v1/admin/logistics/dashboard - 200 OK (—Å —Ç–æ–∫–µ–Ω–æ–º)
‚úÖ /api/v1/admin/logistics/shipments - 200 OK (—Å —Ç–æ–∫–µ–Ω–æ–º)
‚úÖ /api/v1/admin/logistics/dashboard - 401 Unauthorized (–±–µ–∑ —Ç–æ–∫–µ–Ω–∞)
‚úÖ make lint - 0 issues
```

---

‚ö†Ô∏è **–í–ê–ñ–ù–û: –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û–ï –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï –ü–û–°–õ–ï –ö–ê–ñ–î–û–ì–û –ú–û–î–£–õ–Ø!**

–ü–æ—Å–ª–µ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞ –ö–ê–ñ–î–û–ì–û –º–æ–¥—É–ª—è –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û:
1. ‚úÖ –ó–∞–ø—É—Å—Ç–∏—Ç—å backend –∏ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –æ—à–∏–±–æ–∫
2. ‚úÖ –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ endpoints –º–æ–¥—É–ª—è —Å —Ç–æ–∫–µ–Ω–æ–º
3. ‚úÖ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å 401 –Ω–∞ –∑–∞—â–∏—â–µ–Ω–Ω—ã—Ö endpoints –±–µ–∑ —Ç–æ–∫–µ–Ω–∞
4. ‚úÖ –ó–∞–ø—É—Å—Ç–∏—Ç—å unit —Ç–µ—Å—Ç—ã –º–æ–¥—É–ª—è: `go test ./internal/proj/[–º–æ–¥—É–ª—å]/...`
5. ‚úÖ –ó–∞–ø—É—Å—Ç–∏—Ç—å –ª–∏–Ω—Ç–µ—Ä: `make lint`
6. ‚úÖ –°–¥–µ–ª–∞—Ç—å –∫–æ–º–º–∏—Ç —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤

**–ù–ï –ü–ï–†–ï–•–û–î–ò –ö –°–õ–ï–î–£–Æ–©–ï–ú–£ –ú–û–î–£–õ–Æ –ë–ï–ó –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–Ø –ü–†–ï–î–´–î–£–©–ï–ì–û!**

### ~~–ú–æ–¥—É–ª—å: admin/logistics (–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 1)~~ ‚úÖ –ó–ê–í–ï–†–®–ï–ù

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ó–∞–≤–µ—Ä—à–µ–Ω –∏ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω (–∫–æ–º–º–∏—Ç 9e003b54)
**–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:** 20 –º–µ—Å—Ç –ø—Ä—è–º–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ

**–§–∞–π–ª—ã:**
- [x] `backend/internal/proj/admin/logistics/handler/dashboard.go` (2 –º–µ—Å—Ç–∞)
- [x] `backend/internal/proj/admin/logistics/handler/shipments.go` (5 –º–µ—Å—Ç)
- [x] `backend/internal/proj/admin/logistics/handler/analytics.go` (4 –º–µ—Å—Ç–∞)
- [x] `backend/internal/proj/admin/logistics/handler/problems.go` (9 –º–µ—Å—Ç)

**–ü–∞—Ç—Ç–µ—Ä–Ω –∑–∞–º–µ–Ω—ã:**
```go
// ‚ùå –°–¢–ê–†–´–ô –ö–û–î:
userID := c.Locals("user_id")
// –∏–ª–∏
userID, ok := c.Locals("user_id").(int)
if !ok {
    userID = 0  // –ú–æ–ª—á–∞–ª–∏–≤—ã–π fallback - –ø–ª–æ—Ö–æ!
}

// ‚úÖ –ù–û–í–´–ô –ö–û–î:
import authmw "github.com/sveturs/auth/pkg/http/fiber/middleware"

userID, ok := authmw.GetUserID(c)
if !ok {
    logger.Warn().Msg("User ID not found in context")
    return utils.ErrorResponse(c, fiber.StatusUnauthorized, "unauthorized")
}
```

**‚úÖ –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û–ï —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ—Å–ª–µ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞:**
```bash
# 1. –ó–∞–ø—É—Å—Ç–∏—Ç—å backend
screen -dmS backend-3000 bash -c 'cd /data/hostel-booking-system/backend && go run ./cmd/api/main.go 2>&1 | tee /tmp/backend.log'

# 2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ –Ω–∞ –æ—à–∏–±–∫–∏
tail -50 /tmp/backend.log | grep -i error

# 3. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ endpoints –º–æ–¥—É–ª—è
TOKEN=$(cat /tmp/token)
curl -H "Authorization: Bearer $TOKEN" http://localhost:3000/api/v1/admin/logistics/points
curl -H "Authorization: Bearer $TOKEN" http://localhost:3000/api/v1/admin/logistics/drivers
curl -H "Authorization: Bearer $TOKEN" http://localhost:3000/api/v1/admin/logistics/vehicles
curl -H "Authorization: Bearer $TOKEN" http://localhost:3000/api/v1/admin/logistics/routes

# 4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å 401 –±–µ–∑ —Ç–æ–∫–µ–Ω–∞
curl -i http://localhost:3000/api/v1/admin/logistics/points  # –û–∂–∏–¥–∞–µ–º 401

# 5. Unit —Ç–µ—Å—Ç—ã
go test ./internal/proj/admin/logistics/...

# 6. –õ–∏–Ω—Ç–µ—Ä
cd /data/hostel-booking-system/backend && make lint

# ‚úÖ –¢–æ–ª—å–∫–æ –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤ –¥–µ–ª–∞—Ç—å –∫–æ–º–º–∏—Ç!
git add internal/proj/admin/logistics/
git commit -m "refactor(admin/logistics): migrate to authmw helpers (~20 places)"
```

---

### ~~–ú–æ–¥—É–ª—å: subscriptions~~ ‚úÖ –£–ñ–ï –ò–°–ü–†–ê–í–õ–ï–ù –í PHASE 1

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω –≤ Phase 1 (–∫–æ–º–º–∏—Ç 40690270)
**–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:** Middleware –æ–±–Ω–æ–≤–ª–µ–Ω, –ø—Ä—è–º–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞ –∫ c.Locals –Ω–µ—Ç

**–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:**
```bash
TOKEN=$(cat /tmp/token)
curl -H "Authorization: Bearer $TOKEN" http://localhost:3000/api/v1/subscriptions
curl -H "Authorization: Bearer $TOKEN" -X POST http://localhost:3000/api/v1/subscriptions \
  -H "Content-Type: application/json" \
  -d '{"plan": "premium"}'
```

---

### ‚úÖ Phase 2.2: payments –º–æ–¥—É–ª—å - –ó–ê–í–ï–†–®–ï–ù–ê (2025-10-02)

**–ö–æ–º–º–∏—Ç:** d1916cf6
**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ:** 5 –º–µ—Å—Ç –ø—Ä—è–º–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞ –∫ c.Locals("user_id")

**–§–∞–π–ª—ã:**
- ‚úÖ `backend/internal/proj/payments/handler/order_payment_handler.go` (2 –º–µ—Å—Ç–∞)
  - GetOrderPaymentStatus (—Å—Ç—Ä–æ–∫–∞ 135)
  - CancelOrderPayment (—Å—Ç—Ä–æ–∫–∞ 171)
- ‚úÖ `backend/internal/proj/payments/handler/payment_handler.go` (3 –º–µ—Å—Ç–∞)
  - CapturePayment (—Å—Ç—Ä–æ–∫–∞ 141)
  - RefundPayment (—Å—Ç—Ä–æ–∫–∞ 188)
  - GetPaymentStatus (—Å—Ç—Ä–æ–∫–∞ 243)

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
- –ó–∞–º–µ–Ω–µ–Ω `c.Locals("user_id")` –Ω–∞ `authMiddleware.GetUserID(c)`
- –ò—Å–ø—Ä–∞–≤–ª–µ–Ω—ã –ø—Ä–æ–≤–µ—Ä–∫–∏ `if userID == nil` –Ω–∞ `if !ok`
- –û–±–Ω–æ–≤–ª–µ–Ω—ã —Ñ–æ—Ä–º–∞—Ç—ã –ª–æ–≥–æ–≤ —Å `%v` –Ω–∞ `%d`

**–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:**
```bash
‚úÖ Backend –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –±–µ–∑ –æ—à–∏–±–æ–∫
‚úÖ make lint - 0 issues
‚úÖ –í—Å–µ handlers —Ä–∞–±–æ—Ç–∞—é—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —Å —Ç–æ–∫–µ–Ω–æ–º
```

---

### ‚úÖ Phase 2.3: orders –º–æ–¥—É–ª—å - –ó–ê–í–ï–†–®–ï–ù–ê (2025-10-02)

**–ö–æ–º–º–∏—Ç:** d1916cf6
**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ:** 6 –º–µ—Å—Ç –ø—Ä—è–º–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞ –∫ c.Locals("user_id")

**–§–∞–π–ª—ã:**
- ‚úÖ `backend/internal/proj/orders/handler/cart_handler.go` (6 –º–µ—Å—Ç)
  - AddToCart (—Å—Ç—Ä–æ–∫–∞ 45)
  - UpdateCartItem (—Å—Ç—Ä–æ–∫–∞ 113)
  - RemoveFromCart (—Å—Ç—Ä–æ–∫–∞ 164)
  - GetCart (—Å—Ç—Ä–æ–∫–∞ 207)
  - ClearCart (—Å—Ç—Ä–æ–∫–∞ 251)
  - GetUserCarts (—Å—Ç—Ä–æ–∫–∞ 283)

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
- –î–æ–±–∞–≤–ª–µ–Ω import `authMiddleware "github.com/sveturs/auth/pkg/http/fiber/middleware"`
- –ó–∞–º–µ–Ω–µ–Ω –ø–∞—Ç—Ç–µ—Ä–Ω `if userIDRaw := c.Locals("user_id"); userIDRaw != nil` –Ω–∞ `if userIDVal, ok := authMiddleware.GetUserID(c); ok`
- –ò—Å–ø—Ä–∞–≤–ª–µ–Ω—ã type assertions –∏ –ø—Ä–æ–≤–µ—Ä–∫–∏

**–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:**
```bash
‚úÖ Backend –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –±–µ–∑ –æ—à–∏–±–æ–∫
‚úÖ /api/v1/user/carts - 200 OK (user_id: 6 —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω)
‚úÖ make lint - 0 issues
‚úÖ –ö–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è —Ä–∞–±–æ—Ç–∞ cart endpoints —Å —Ç–æ–∫–µ–Ω–æ–º
```

---

### ~~–ú–æ–¥—É–ª—å: payments~~ ‚úÖ –ó–ê–í–ï–†–®–ï–ù (Phase 2.2)

–°–º. Phase 2.2 –≤—ã—à–µ

---

### ~~–ú–æ–¥—É–ª—å: orders~~ ‚úÖ –ó–ê–í–ï–†–®–ï–ù (Phase 2.3)

–°–º. Phase 2.3 –≤—ã—à–µ

---

### Phase 2.4: –û—Å—Ç–∞–≤—à–∏–µ—Å—è –º–æ–¥—É–ª–∏ (–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 4)

**–°—Ç–∞—Ç—É—Å:** üî∂ –¢–†–ï–ë–£–ï–¢–°–Ø –í–´–ü–û–õ–ù–ï–ù–ò–ï
**–û—Å—Ç–∞–ª–æ—Å—å:** 46 –º–µ—Å—Ç –≤ 12 —Ñ–∞–π–ª–∞—Ö

**–ü–æ–¥—Ä–æ–±–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Ñ–∞–π–ª–∞–º:**
- [ ] `notifications/handler/handler.go` (1 –º–µ—Å—Ç–æ)
- [ ] `behavior_tracking/handler/handler.go` (2 –º–µ—Å—Ç–∞)
- [ ] `subscriptions/handler/subscription_handler.go` (7 –º–µ—Å—Ç)
- [ ] `marketplace/handler/favorites.go` (5 –º–µ—Å—Ç)
- [ ] `marketplace/handler/search.go` (2 –º–µ—Å—Ç–∞)
- [ ] `marketplace/handler/images.go` (5 –º–µ—Å—Ç)
- [ ] `marketplace/handler/listings.go` (8 –º–µ—Å—Ç)
- [ ] `marketplace/handler/saved_searches.go` (6 –º–µ—Å—Ç)
- [ ] `marketplace/handler/custom_components.go` (4 –º–µ—Å—Ç–∞)
- [ ] `marketplace/handler/chat.go` (1 –º–µ—Å—Ç–æ)
- [ ] `marketplace/handler/indexing.go` (4 –º–µ—Å—Ç–∞)
- [ ] `marketplace/handler/translation.go` (1 –º–µ—Å—Ç–æ)

**–ò—Ç–æ–≥–æ marketplace:** 36 –º–µ—Å—Ç –≤ 9 —Ñ–∞–π–ª–∞—Ö
**–ò—Ç–æ–≥–æ –¥—Ä—É–≥–∏–µ:** 10 –º–µ—Å—Ç –≤ 3 —Ñ–∞–π–ª–∞—Ö

**–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:**
```bash
TOKEN=$(cat /tmp/token)
curl -H "Authorization: Bearer $TOKEN" http://localhost:3000/api/v1/marketplace/listings
curl -H "Authorization: Bearer $TOKEN" http://localhost:3000/api/v1/marketplace/favorites
curl -H "Authorization: Bearer $TOKEN" http://localhost:3000/api/v1/marketplace/saved-searches
```

---

### –§–∏–Ω–∞–ª–∏–∑–∞—Ü–∏—è –§–∞–∑—ã 2

**Pre-commit –ø—Ä–æ–≤–µ—Ä–∫–∏:**
```bash
cd /data/hostel-booking-system/backend
make format && make lint
go test ./...
go build ./...
```

**–°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–º–º–∏—Ç–∞:**
```bash
git add .
git commit -m "refactor: migrate all c.Locals direct access to authmw helpers

- Refactor admin/logistics module (~20 places)
- Refactor subscriptions module (7 places)
- Refactor payments module (5 places)
- Refactor orders module (6 places)
- Refactor marketplace module (~30 places)
- All direct c.Locals access replaced with authmw.GetUserID/GetEmail/etc
- Proper error handling added everywhere

Resolves: AUTH_LIBRARY_AUDIT_REPORT.md Problem #4"
```

---

## üìã –§–ê–ó–ê 3: –°—Ç–∞–Ω–¥–∞—Ä—Ç–∏–∑–∞—Ü–∏—è –∏ –æ—á–∏—Å—Ç–∫–∞

**–¶–µ–ª—å:** –£–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å –ø–æ–¥—Ö–æ–¥—ã, —É–¥–∞–ª–∏—Ç—å –¥—É–±–ª–∏—Ä—É—é—â–∏–π—Å—è –∫–æ–¥
**–í—Ä–µ–º—è:** 1-2 –¥–Ω—è
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üü° –°–†–ï–î–ù–ò–ô
**–°—Ç–∞—Ç—É—Å:** üî∂ –û–ñ–ò–î–ê–ï–¢ –ù–ê–ß–ê–õ–ê

‚ö†Ô∏è **–í–ê–ñ–ù–û: –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï –ü–û–°–õ–ï –ö–ê–ñ–î–û–ô –ó–ê–î–ê–ß–ò!**

–ü–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∫–∞–∂–¥–æ–π –∑–∞–¥–∞—á–∏ –≤ —ç—Ç–æ–π —Ñ–∞–∑–µ:
1. ‚úÖ –ó–∞–ø—É—Å—Ç–∏—Ç—å backend –∏ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –æ—à–∏–±–æ–∫ –∫–æ–º–ø–∏–ª—è—Ü–∏–∏
2. ‚úÖ –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–∞—Ç—Ä–æ–Ω—É—Ç—ã–µ endpoints
3. ‚úÖ –ó–∞–ø—É—Å—Ç–∏—Ç—å –ø–æ–ª–Ω—ã–π –Ω–∞–±–æ—Ä unit —Ç–µ—Å—Ç–æ–≤: `go test ./...`
4. ‚úÖ –ó–∞–ø—É—Å—Ç–∏—Ç—å –ª–∏–Ω—Ç–µ—Ä: `make lint`
5. ‚úÖ –°–¥–µ–ª–∞—Ç—å –∫–æ–º–º–∏—Ç —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤

### –ó–∞–¥–∞—á–∞ 1: –£–Ω–∏—Ñ–∏–∫–∞—Ü–∏—è –∏–º–ø–æ—Ä—Ç–æ–≤

**–û–ø–∏—Å–∞–Ω–∏–µ:**
–î–æ–±–∞–≤–∏—Ç—å —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π alias `authmw` –¥–ª—è auth middleware –≤–æ –≤—Å–µ—Ö –º–æ–¥—É–ª—è—Ö.

**–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –∏–º–ø–æ—Ä—Ç:**
```go
import authmw "github.com/sveturs/auth/pkg/http/fiber/middleware"
```

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**
```go
userID, ok := authmw.GetUserID(c)
email, ok := authmw.GetEmail(c)
roles, ok := authmw.GetRoles(c)
isAdmin := authmw.IsAdmin(c)
isAuth := authmw.IsAuthenticated(c)
```

**–ö–æ–º–∞–Ω–¥–∞ –¥–ª—è –ø–æ–∏—Å–∫–∞ —Ñ–∞–π–ª–æ–≤ –±–µ–∑ alias:**
```bash
grep -r "github.com/sveturs/auth/pkg/http/fiber/middleware" backend/internal/proj/ | grep -v "authmw"
```

---

### –ó–∞–¥–∞—á–∞ 2: –£–¥–∞–ª–µ–Ω–∏–µ –¥—É–±–ª–∏—Ä—É—é—â–µ–≥–æ—Å—è –∫–æ–¥–∞

**–û–ø–∏—Å–∞–Ω–∏–µ:**
–§—É–Ω–∫—Ü–∏—è `GetUserIDFromContext` –∏–∑ `pkg/utils/utils.go` –¥—É–±–ª–∏—Ä—É–µ—Ç `authmw.GetUserID`.

**–§–∞–π–ª—ã –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è:**
- [ ] –ù–∞–π—Ç–∏ –≤—Å–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è `utils.GetUserIDFromContext(c)`
- [ ] –ó–∞–º–µ–Ω–∏—Ç—å –Ω–∞ `authmw.GetUserID(c)`
- [ ] –£–¥–∞–ª–∏—Ç—å —Ñ—É–Ω–∫—Ü–∏—é –∏–∑ `backend/pkg/utils/utils.go`

**–ö–æ–º–∞–Ω–¥–∞ –¥–ª—è –ø–æ–∏—Å–∫–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–π:**
```bash
grep -rn "GetUserIDFromContext" backend/internal/proj/
```

**–ó–∞–º–µ–Ω–∞:**
```go
// ‚ùå –°–¢–ê–†–´–ô –ö–û–î:
import "backend/pkg/utils"
userID := utils.GetUserIDFromContext(c)

// ‚úÖ –ù–û–í–´–ô –ö–û–î:
import authmw "github.com/sveturs/auth/pkg/http/fiber/middleware"
userID, ok := authmw.GetUserID(c)
if !ok {
    return utils.ErrorResponse(c, fiber.StatusUnauthorized, "unauthorized")
}
```

---

### –ó–∞–¥–∞—á–∞ 3: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏

**–§–∞–π–ª:** `/data/hostel-booking-system/CLAUDE.md`

**–î–æ–±–∞–≤–∏—Ç—å —Å–µ–∫—Ü–∏—é:**
```markdown
### Auth Best Practices

**–í–°–ï–ì–î–ê –∏—Å–ø–æ–ª—å–∑—É–π –±–∏–±–ª–∏–æ—Ç–µ—á–Ω—ã–µ helpers:**
```go
import authmw "github.com/sveturs/auth/pkg/http/fiber/middleware"

// –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∏–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
userID, ok := authmw.GetUserID(c)
email, ok := authmw.GetEmail(c)
roles, ok := authmw.GetRoles(c)
isAdmin := authmw.IsAdmin(c)
```

**–ù–ò–ö–û–ì–î–ê –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–π –ø—Ä—è–º–æ–π –¥–æ—Å—Ç—É–ø:**
```go
// ‚ùå –ù–ï –î–ï–õ–ê–ô –¢–ê–ö:
userID := c.Locals("user_id")
userID, ok := c.Locals("user_id").(int)
```

**Middleware —Ü–µ–ø–æ—á–∫–∞:**
```go
protected := app.Group("/api/v1/resource",
    mw.JWTParser(),
    authmw.RequireAuth())

admin := app.Group("/api/v1/admin/resource",
    mw.JWTParser(),
    authmw.RequireAuthString("admin"))
```
```

---

### –§–∏–Ω–∞–ª–∏–∑–∞—Ü–∏—è –§–∞–∑—ã 3

**Pre-commit –ø—Ä–æ–≤–µ—Ä–∫–∏:**
```bash
cd /data/hostel-booking-system/backend
make format && make lint
go test ./...
```

**–°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–º–º–∏—Ç–∞:**
```bash
git add .
git commit -m "chore: standardize auth imports and cleanup

- Add authmw alias to all modules
- Remove duplicate GetUserIDFromContext from pkg/utils
- Update CLAUDE.md with auth best practices
- Code standardization complete

Resolves: AUTH_LIBRARY_AUDIT_REPORT.md Problem #5"
```

---

## üìã –§–ò–ù–ê–õ: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

**–¶–µ–ª—å:** –£–±–µ–¥–∏—Ç—å—Å—è —á—Ç–æ –≤—Å—ë —Ä–∞–±–æ—Ç–∞–µ—Ç, –Ω–µ—Ç —Ä–µ–≥—Ä–µ—Å—Å–∏–∏
**–í—Ä–µ–º—è:** 1-2 –¥–Ω—è
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üî¥ –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô
**–°—Ç–∞—Ç—É—Å:** üî∂ –û–ñ–ò–î–ê–ï–¢ –ù–ê–ß–ê–õ–ê

üî¥ **–ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û: –ü–û–õ–ù–û–ï –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï –ü–ï–†–ï–î PRODUCTION!**

–≠—Ç–∞ —Ñ–∞–∑–∞ —è–≤–ª—è–µ—Ç—Å—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–π –∏ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—Ä–æ–ø—É—â–µ–Ω–∞. –í—Å–µ —Ç–µ—Å—Ç—ã –¥–æ–ª–∂–Ω—ã –ø—Ä–æ–π—Ç–∏ —É—Å–ø–µ—à–Ω–æ –ø–µ—Ä–µ–¥ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ–º –≤ production.

### –ü–æ–ª–Ω–æ–µ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

**–¢–æ–∫–µ–Ω –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:**
```bash
TOKEN=$(cat /tmp/token)
```

**–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö protected endpoints:**

```bash
# Users
curl -H "Authorization: Bearer $TOKEN" http://localhost:3000/api/v1/users/me
curl -H "Authorization: Bearer $TOKEN" http://localhost:3000/api/v1/users/profile

# Marketplace
curl -H "Authorization: Bearer $TOKEN" http://localhost:3000/api/v1/marketplace/listings
curl -H "Authorization: Bearer $TOKEN" http://localhost:3000/api/v1/marketplace/favorites

# Orders
curl -H "Authorization: Bearer $TOKEN" http://localhost:3000/api/v1/cart
curl -H "Authorization: Bearer $TOKEN" http://localhost:3000/api/v1/orders

# Subscriptions
curl -H "Authorization: Bearer $TOKEN" http://localhost:3000/api/v1/subscriptions

# Payments
curl -H "Authorization: Bearer $TOKEN" http://localhost:3000/api/v1/payments/balance

# Storefronts
curl -H "Authorization: Bearer $TOKEN" http://localhost:3000/api/v1/storefronts

# Notifications
curl -H "Authorization: Bearer $TOKEN" http://localhost:3000/api/v1/notifications

# Analytics
curl -H "Authorization: Bearer $TOKEN" http://localhost:3000/api/v1/analytics/dashboard
```

**–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö admin endpoints:**

```bash
# Admin Users
curl -H "Authorization: Bearer $TOKEN" http://localhost:3000/api/v1/admin/users
curl -H "Authorization: Bearer $TOKEN" http://localhost:3000/api/v1/admin/users/6

# Admin Marketplace
curl -H "Authorization: Bearer $TOKEN" http://localhost:3000/api/v1/admin/categories
curl -H "Authorization: Bearer $TOKEN" http://localhost:3000/api/v1/admin/marketplace/listings

# Admin Logistics
curl -H "Authorization: Bearer $TOKEN" http://localhost:3000/api/v1/admin/logistics/points
curl -H "Authorization: Bearer $TOKEN" http://localhost:3000/api/v1/admin/logistics/drivers

# Admin Subscriptions
curl -H "Authorization: Bearer $TOKEN" http://localhost:3000/api/v1/admin/subscriptions
```

**–ü—Ä–æ–≤–µ—Ä–∫–∞ OAuth flow:**

```bash
# 1. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è OAuth
curl -i http://localhost:3000/api/v1/auth/google

# 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ callback endpoint (—Ä—É—á–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —á–µ—Ä–µ–∑ –±—Ä–∞—É–∑–µ—Ä)
# –û—Ç–∫—Ä—ã—Ç—å: http://localhost:3000/api/v1/auth/google
# –ü—Ä–æ–π—Ç–∏ OAuth flow
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ —Ç–æ–∫–µ–Ω—ã —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –≤ cookies
```

---

### üî¥ Pre-production Checklist - –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û!

**–ù–ï –†–ê–ó–í–û–†–ê–ß–ò–í–ê–ô –í PRODUCTION –ë–ï–ó –≠–¢–ò–• –ü–†–û–í–ï–†–û–ö!**

- [ ] **Unit —Ç–µ—Å—Ç—ã:** `go test ./...` - –≤—Å–µ –ø—Ä–æ—Ö–æ–¥—è—Ç ‚úÖ
- [ ] **–õ–∏–Ω—Ç–∏–Ω–≥:** `make lint` - –Ω–µ—Ç –æ—à–∏–±–æ–∫ ‚úÖ
- [ ] **–ö–æ–º–ø–∏–ª—è—Ü–∏—è:** `go build ./...` - —É—Å–ø–µ—à–Ω–∞ ‚úÖ
- [ ] **–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:** `make format` - –ø—Ä–∏–º–µ–Ω–µ–Ω–æ ‚úÖ
- [ ] **Integration —Ç–µ—Å—Ç—ã:** –í—Å–µ protected endpoints —Ä–∞–±–æ—Ç–∞—é—Ç ‚úÖ
- [ ] **Admin endpoints:** –í—Å–µ admin endpoints —Ç—Ä–µ–±—É—é—Ç admin —Ä–æ–ª—å ‚úÖ
- [ ] **OAuth flow:** Google login —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ ‚úÖ
- [ ] **Performance:** –ù–µ—Ç –¥–µ–≥—Ä–∞–¥–∞—Ü–∏–∏ (–±–µ–Ω—á–º–∞—Ä–∫–∏) ‚úÖ
- [ ] **Security:** `golangci-lint run` - –Ω–µ—Ç —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π ‚úÖ
- [ ] **–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è:** CLAUDE.md –æ–±–Ω–æ–≤–ª–µ–Ω–∞ ‚úÖ
- [ ] **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ staging:** –í—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏ —Ä–∞–±–æ—Ç–∞—é—Ç ‚úÖ
- [ ] **Load testing:** –°–∏—Å—Ç–µ–º–∞ –≤—ã–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –Ω–∞–≥—Ä—É–∑–∫—É ‚úÖ

**–ö–ê–ñ–î–´–ô –ø—É–Ω–∫—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ—Ç–º–µ—á–µ–Ω ‚úÖ –ø–µ—Ä–µ–¥ production deploy!**

**Performance —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:**
```bash
# Benchmark –¥–æ –º–∏–≥—Ä–∞—Ü–∏–∏
go test -bench=. -benchmem ./internal/middleware/... > /tmp/bench_before.txt

# Benchmark –ø–æ—Å–ª–µ –º–∏–≥—Ä–∞—Ü–∏–∏
go test -bench=. -benchmem ./internal/middleware/... > /tmp/bench_after.txt

# –°—Ä–∞–≤–Ω–µ–Ω–∏–µ
diff /tmp/bench_before.txt /tmp/bench_after.txt
```

**Security –ø—Ä–æ–≤–µ—Ä–∫–∏:**
```bash
cd /data/hostel-booking-system/backend

# golangci-lint —Å –ø–æ–ª–Ω—ã–º–∏ –ø—Ä–æ–≤–µ—Ä–∫–∞–º–∏
golangci-lint run --enable-all

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –Ω–∞ —É—è–∑–≤–∏–º–æ—Å—Ç–∏
go list -json -m all | nancy sleuth

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–µ–∫—Ä–µ—Ç–æ–≤ –≤ –∫–æ–¥–µ
gitleaks detect --source . --verbose
```

---

### –§–∏–Ω–∞–ª—å–Ω—ã–π –∫–æ–º–º–∏—Ç

**–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ç—á–µ—Ç–∞ –∞—É–¥–∏—Ç–∞:**
```bash
# –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å –≤ AUTH_LIBRARY_AUDIT_REPORT.md
sed -i 's/–°—Ç–∞—Ç—É—Å:** –ß–∞—Å—Ç–∏—á–Ω–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–º–∏ –ø—Ä–æ–±–ª–µ–º–∞–º–∏/–°—Ç–∞—Ç—É—Å:** ‚úÖ –ú–ò–ì–†–ê–¶–ò–Ø –ó–ê–í–ï–†–®–ï–ù–ê/' \
  /data/hostel-booking-system/docs/AUTH_LIBRARY_AUDIT_REPORT.md
```

**–°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–º–º–∏—Ç–∞:**
```bash
git add .
git commit -m "chore: complete auth library migration to v1.8.0

‚úÖ All critical issues resolved
‚úÖ All modules migrated to library helpers
‚úÖ All technical debt removed
‚úÖ Code standardized across project
‚úÖ 100% compatibility with auth-service v1.8.0
‚úÖ Ready for production

Migration summary:
- Fixed 3 critical security issues
- Refactored 50+ places of direct c.Locals access
- Standardized auth imports across 18 modules
- Removed duplicate code from pkg/utils
- Updated documentation with best practices
- All tests passing
- Performance: no degradation
- Security: no vulnerabilities

Closes: AUTH_LIBRARY_AUDIT_REPORT.md
See: docs/AUTH_MIGRATION_PLAN.md for full migration plan"
```

---

## üìà –ú–µ—Ç—Ä–∏–∫–∏ —É—Å–ø–µ—Ö–∞

### –î–æ –º–∏–≥—Ä–∞—Ü–∏–∏

| –ú–µ—Ç—Ä–∏–∫–∞ | –ó–Ω–∞—á–µ–Ω–∏–µ |
|---------|----------|
| –ü—Ä–∞–≤–∏–ª—å–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ middleware | 75% |
| –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ helper —Ñ—É–Ω–∫—Ü–∏–π | 65% |
| –ú–æ–¥—É–ª–µ–π –±–µ–∑ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –ø—Ä–æ–±–ª–µ–º | 15/18 (83%) |
| –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π | 3 |
| –ü—Ä—è–º–æ–π –¥–æ—Å—Ç—É–ø –∫ c.Locals | >50 –º–µ—Å—Ç |

### –ü–æ—Å–ª–µ –º–∏–≥—Ä–∞—Ü–∏–∏ (—Ü–µ–ª–µ–≤—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏)

| –ú–µ—Ç—Ä–∏–∫–∞ | –ó–Ω–∞—á–µ–Ω–∏–µ |
|---------|----------|
| –ü—Ä–∞–≤–∏–ª—å–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ middleware | 95%+ ‚úÖ |
| –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ helper —Ñ—É–Ω–∫—Ü–∏–π | 90%+ ‚úÖ |
| –ú–æ–¥—É–ª–µ–π –±–µ–∑ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –ø—Ä–æ–±–ª–µ–º | 18/18 (100%) ‚úÖ |
| –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π | 0 ‚úÖ |
| –ü—Ä—è–º–æ–π –¥–æ—Å—Ç—É–ø –∫ c.Locals | 0 ‚úÖ |

---

## üîç –ü–æ–ª–µ–∑–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã

### –ü–æ–∏—Å–∫ –ø—Ä–æ–±–ª–µ–º–Ω—ã—Ö –º–µ—Å—Ç

```bash
# –ù–∞–π—Ç–∏ –≤—Å–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –∫–ª—é—á–∞ "userID"
grep -rn 'c.Locals("userID")' backend/internal/proj/

# –ù–∞–π—Ç–∏ –ø—Ä—è–º–æ–π –¥–æ—Å—Ç—É–ø –∫ "user_id"
grep -rn 'c.Locals("user_id")' backend/internal/proj/ | grep -v "authmw"

# –ù–∞–π—Ç–∏ –≤—Å–µ —Ñ–∞–π–ª—ã –±–µ–∑ import authmw
grep -r "github.com/sveturs/auth" backend/internal/proj/ | grep -v "authmw"

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤–µ—Ä—Å–∏—é –±–∏–±–ª–∏–æ—Ç–µ–∫–∏
grep "github.com/sveturs/auth" backend/go.mod
```

### –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤

```bash
cd /data/hostel-booking-system/backend

# –í—Å–µ —Ç–µ—Å—Ç—ã
go test ./...

# –° verbose
go test -v ./...

# –¢–æ–ª—å–∫–æ auth —Ç–µ—Å—Ç—ã
go test -v ./internal/proj/users/... -run TestAuth

# –° coverage
go test -cover ./...
```

### –†–∞–±–æ—Ç–∞ —Å —Ç–æ–∫–µ–Ω–æ–º

```bash
# –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ç–æ–∫–µ–Ω –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é
export TOKEN=$(cat /tmp/token)

# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤ –∑–∞–ø—Ä–æ—Å–∞—Ö
curl -H "Authorization: Bearer $TOKEN" http://localhost:3000/api/v1/users/me

# –î–µ–∫–æ–¥–∏—Ä–æ–≤–∞—Ç—å JWT (–¥–ª—è –æ—Ç–ª–∞–¥–∫–∏)
echo $TOKEN | cut -d. -f2 | base64 -d | jq
```

---

## üìö –°—Å—ã–ª–∫–∏ –Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é

- [–°–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—è –±–∏–±–ª–∏–æ—Ç–µ–∫–∏](./AUTH_LIBRARY_SPECIFICATION.md)
- [–û—Ç—á–µ—Ç –∞—É–¥–∏—Ç–∞](./AUTH_LIBRARY_AUDIT_REPORT.md)
- [CLAUDE.md - Auth Service](../CLAUDE.md#auth-service)
- [–≠—Ç–∞–ª–æ–Ω–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è](../backend/internal/proj/users/handler/routes.go)

---

## üìù –ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π

| –î–∞—Ç–∞ | –í–µ—Ä—Å–∏—è | –ò–∑–º–µ–Ω–µ–Ω–∏—è | –ê–≤—Ç–æ—Ä |
|------|--------|-----------|-------|
| 2025-10-02 | 1.0 | –°–æ–∑–¥–∞–Ω–∏–µ –ø–ª–∞–Ω–∞ –º–∏–≥—Ä–∞—Ü–∏–∏ | Claude Code |
| | | | |
| | | | |

---

## ‚úÖ Acceptance Criteria

–ú–∏–≥—Ä–∞—Ü–∏—è —Å—á–∏—Ç–∞–µ—Ç—Å—è –∑–∞–≤–µ—Ä—à–µ–Ω–Ω–æ–π –∫–æ–≥–¥–∞:

1. ‚úÖ –í—Å–µ 3 –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã –∏–∑ –∞—É–¥–∏—Ç–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã **–ò –ü–†–û–¢–ï–°–¢–ò–†–û–í–ê–ù–´**
2. ‚úÖ –í—Å–µ –º–æ–¥—É–ª–∏ –∏—Å–ø–æ–ª—å–∑—É—é—Ç –±–∏–±–ª–∏–æ—Ç–µ—á–Ω—ã–µ helpers (0 –ø—Ä—è–º–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞ –∫ c.Locals) **–ò –ü–†–û–¢–ï–°–¢–ò–†–û–í–ê–ù–´**
3. ‚úÖ –í—Å–µ –∏–º–ø–æ—Ä—Ç—ã —Å—Ç–∞–Ω–¥–∞—Ä—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω—ã —Å alias authmw **–ò –ü–†–û–í–ï–†–ï–ù–´**
4. ‚úÖ –£–¥–∞–ª–µ–Ω –¥—É–±–ª–∏—Ä—É—é—â–∏–π—Å—è –∫–æ–¥ –∏–∑ pkg/utils **–ò –ü–†–û–¢–ï–°–¢–ò–†–û–í–ê–ù**
5. ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è CLAUDE.md **–° –ü–†–ò–ú–ï–†–ê–ú–ò –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–Ø**
6. ‚úÖ –í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ—Ö–æ–¥—è—Ç (unit + integration) **–ë–ï–ó –û–®–ò–ë–û–ö**
7. ‚úÖ –ù–µ—Ç –¥–µ–≥—Ä–∞–¥–∞—Ü–∏–∏ performance **–ü–û–î–¢–í–ï–†–ñ–î–ï–ù–û –ë–ï–ù–ß–ú–ê–†–ö–ê–ú–ò**
8. ‚úÖ –ù–µ—Ç security —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π **–ü–†–û–í–ï–†–ï–ù–û –õ–ò–ù–¢–ï–†–û–ú**
9. ‚úÖ –í—Å–µ protected endpoints —Ç—Ä–µ–±—É—é—Ç –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é **–ü–†–û–¢–ï–°–¢–ò–†–û–í–ê–ù–û**
10. ‚úÖ –í—Å–µ admin endpoints —Ç—Ä–µ–±—É—é—Ç admin —Ä–æ–ª—å **–ü–†–û–¢–ï–°–¢–ò–†–û–í–ê–ù–û**
11. ‚úÖ OAuth flow —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ **–ü–†–û–¢–ï–°–¢–ò–†–û–í–ê–ù–û –í–†–£–ß–ù–£–Æ**
12. ‚úÖ Pre-production checklist –ø–æ–ª–Ω–æ—Å—Ç—å—é –ø—Ä–æ–π–¥–µ–Ω **–í–°–ï –ü–£–ù–ö–¢–´ ‚úÖ**
13. ‚úÖ Staging —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–π–¥–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ **–ë–ï–ó –ö–†–ò–¢–ò–ß–ï–°–ö–ò–• –ë–ê–ì–û–í**
14. ‚úÖ –°–æ–∑–¥–∞–Ω —Ñ–∏–Ω–∞–ª—å–Ω—ã–π –∫–æ–º–º–∏—Ç **–° –ü–û–õ–ù–´–ú –û–ü–ò–°–ê–ù–ò–ï–ú**

üî¥ **–ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û:** –ö–∞–∂–¥—ã–π –∫—Ä–∏—Ç–µ—Ä–∏–π –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–µ –ø—Ä–æ—Å—Ç–æ –≤—ã–ø–æ–ª–Ω–µ–Ω, –Ω–æ –∏ –ü–†–û–¢–ï–°–¢–ò–†–û–í–ê–ù!

**–°—Ç–∞—Ç—É—Å –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –∫ production:**
- Phase 1: ‚úÖ –ó–ê–í–ï–†–®–ï–ù–ê –ò –ü–†–û–¢–ï–°–¢–ò–†–û–í–ê–ù–ê (–∫–æ–º–º–∏—Ç 40690270)
- Phase 2.1: ‚úÖ –ó–ê–í–ï–†–®–ï–ù–ê –ò –ü–†–û–¢–ï–°–¢–ò–†–û–í–ê–ù–ê (–∫–æ–º–º–∏—Ç 9e003b54)
- Phase 2 (–æ—Å—Ç–∞–ª—å–Ω–æ–µ): üî∂ –í –ü–†–û–¶–ï–°–°–ï (~41 –º–µ—Å—Ç–æ –æ—Å—Ç–∞–ª–æ—Å—å)
- Phase 3: üî∂ –û–ñ–ò–î–ê–ï–¢ –ù–ê–ß–ê–õ–ê
- Final Testing: üî∂ –û–ñ–ò–î–ê–ï–¢ –ù–ê–ß–ê–õ–ê
- **–û–±—â–∏–π —Å—Ç–∞—Ç—É—Å:** ‚è≥ 35% –ó–ê–í–ï–†–®–ï–ù–û (Phase 1 + Phase 2.1)

---

**–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ:** 2025-10-02 (–∞–∫—Ç—É–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω –ø–æ—Å–ª–µ Phase 2.1)
**–°–ª–µ–¥—É—é—â–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞:** –ü–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è Phase 2

**–ò—Å—Ç–æ—Ä–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π:**
- 2025-10-02 (Phase 2.1): –ó–∞–≤–µ—Ä—à–µ–Ω –º–æ–¥—É–ª—å admin/logistics (20 –º–µ—Å—Ç), –∫–æ–º–º–∏—Ç 9e003b54
- 2025-10-02 (Phase 1): –ó–∞–≤–µ—Ä—à–µ–Ω—ã –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è, –∫–æ–º–º–∏—Ç 40690270

---

## üìù –ö—Ä–∞—Ç–∫–æ–µ —Ä–µ–∑—é–º–µ –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ —Å—Ç–∞—Ä—Ç–∞

### ‚úÖ –ß–¢–û –°–î–ï–õ–ê–ù–û:
- **Phase 1:** –ò—Å–ø—Ä–∞–≤–ª–µ–Ω—ã –≤—Å–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ (–∫–æ–º–º–∏—Ç 40690270)
- **Phase 2.1:** –ú–æ–¥—É–ª—å admin/logistics - 20 –º–µ—Å—Ç –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ –∏ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–æ (–∫–æ–º–º–∏—Ç 9e003b54)
- **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:** –í—Å–µ endpoints —Ä–∞–±–æ—Ç–∞—é—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ, 0 –æ—à–∏–±–æ–∫ –ª–∏–Ω—Ç–µ—Ä–∞

### üî∂ –ß–¢–û –î–ï–õ–ê–¢–¨ –î–ê–õ–¨–®–ï:
1. **Phase 2.2-2.4:** –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ ~41 –º–µ—Å—Ç–∞ –≤ payments, orders, marketplace (~2-3 –¥–Ω—è)
2. **Phase 3:** –°—Ç–∞–Ω–¥–∞—Ä—Ç–∏–∑–∞—Ü–∏—è –∏–º–ø–æ—Ä—Ç–æ–≤ –∏ –æ—á–∏—Å—Ç–∫–∞ –∫–æ–¥–∞ (1-2 –¥–Ω—è)
3. **Final Testing:** –ü–æ–ª–Ω–æ–µ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ (1-2 –¥–Ω—è)

### üìä –î–µ—Ç–∞–ª—å–Ω—ã–π –ø—Ä–æ–≥—Ä–µ—Å—Å Phase 2:
- ‚úÖ admin/logistics: 20/20 –º–µ—Å—Ç (100%)
- ‚úÖ subscriptions: 0 –º–µ—Å—Ç (—É–∂–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω –≤ Phase 1)
- üî∂ payments: 0/~5 –º–µ—Å—Ç (0%)
- üî∂ orders: 0/~6 –º–µ—Å—Ç (0%)
- üî∂ marketplace: 0/~30 –º–µ—Å—Ç (0%)
- **–ò—Ç–æ–≥–æ:** 20/~61 –º–µ—Å—Ç = 33% –∑–∞–≤–µ—Ä—à–µ–Ω–æ

### üî¥ –ì–õ–ê–í–ù–û–ï –ü–†–ê–í–ò–õ–û:
**–í–°–ï–ì–î–ê –¢–ï–°–¢–ò–†–£–ô –ü–û–°–õ–ï –ö–ê–ñ–î–û–ì–û –ò–ó–ú–ï–ù–ï–ù–ò–Ø!**
–ë–µ–∑ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è - –±–µ–∑ –∫–æ–º–º–∏—Ç–∞. –ë–µ–∑ –∏—Å–∫–ª—é—á–µ–Ω–∏–π.
