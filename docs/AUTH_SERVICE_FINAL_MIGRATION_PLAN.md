# –ü–ª–∞–Ω —Ñ–∏–Ω–∞–ª—å–Ω–æ–π –º–∏–≥—Ä–∞—Ü–∏–∏ –Ω–∞ Auth Service –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å

## üìä –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ

### ‚úÖ –ß—Ç–æ —É–∂–µ —Ä–∞–±–æ—Ç–∞–µ—Ç:
1. **Auth Service –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å** –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ –ø–æ—Ä—Ç—É 28080
2. **Proxy middleware** –Ω–∞—Å—Ç—Ä–æ–µ–Ω –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç –ø—Ä–∏ `USE_AUTH_SERVICE=true`
3. **Frontend** –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç OAuth –∏ —Ä–∞–±–æ—Ç—É —Å —Ç–æ–∫–µ–Ω–∞–º–∏
4. **Token management** - RS256 —Ç–æ–∫–µ–Ω—ã, refresh tokens, revocation

### ‚ö†Ô∏è –ü—Ä–æ–±–ª–µ–º–∞:
–°–∏—Å—Ç–µ–º–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ **–≥–∏–±—Ä–∏–¥–Ω–æ–º —Ä–µ–∂–∏–º–µ** - –µ—Å—Ç—å –∫–∞–∫ –Ω–æ–≤—ã–π –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å, —Ç–∞–∫ –∏ legacy –∫–æ–¥ –≤ –º–æ–Ω–æ–ª–∏—Ç–µ. –≠—Ç–æ —Å–æ–∑–¥–∞–µ—Ç:
- –ü—É—Ç–∞–Ω–∏—Ü—É –ø—Ä–∏ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ
- –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–¥–∞
- –í–æ–∑–º–æ–∂–Ω—ã–µ –±–∞–≥–∏ –∏–∑-–∑–∞ –Ω–µ—Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç–∏
- –ù–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç—å –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å –¥–≤–∞ –≤–∞—Ä–∏–∞–Ω—Ç–∞

## üéØ –¶–µ–ª—å: –ü–æ–ª–Ω—ã–π –ø–µ—Ä–µ—Ö–æ–¥ –Ω–∞ –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å

## üìù –ü–ª–∞–Ω –º–∏–≥—Ä–∞—Ü–∏–∏

### –®–∞–≥ 1: –£–¥–∞–ª–µ–Ω–∏–µ legacy –∫–æ–¥–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏

#### 1.1 –§–∞–π–ª—ã –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è:
```
backend/internal/proj/users/handler/auth.go (–æ—Å—Ç–∞–≤–∏—Ç—å —Ç–æ–ª—å–∫–æ proxy-–∑–∞–≥–ª—É—à–∫–∏)
backend/internal/proj/users/service/auth.go (—É–¥–∞–ª–∏—Ç—å –ø–æ–ª–Ω–æ—Å—Ç—å—é)
backend/internal/proj/users/handler/users.go (—É–¥–∞–ª–∏—Ç—å LoginOld, RegisterOld)
```

#### 1.2 –ú–µ—Ç–æ–¥—ã –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –∏–∑ auth.go:
- `Login()` - –∑–∞–º–µ–Ω–∏—Ç—å –Ω–∞ –∑–∞–≥–ª—É—à–∫—É —Å –æ—à–∏–±–∫–æ–π
- `Register()` - –∑–∞–º–µ–Ω–∏—Ç—å –Ω–∞ –∑–∞–≥–ª—É—à–∫—É —Å –æ—à–∏–±–∫–æ–π  
- `RefreshToken()` - –∑–∞–º–µ–Ω–∏—Ç—å –Ω–∞ –∑–∞–≥–ª—É—à–∫—É —Å –æ—à–∏–±–∫–æ–π
- `GetSession()` - –æ—Å—Ç–∞–≤–∏—Ç—å —Ç–æ–ª—å–∫–æ –ø—Ä–æ–≤–µ—Ä–∫—É —á–µ—Ä–µ–∑ Auth Service
- `Logout()` - –∑–∞–º–µ–Ω–∏—Ç—å –Ω–∞ –∑–∞–≥–ª—É—à–∫—É —Å –æ—à–∏–±–∫–æ–π
- `GoogleAuth()` –∏ `GoogleCallback()` - —É–∂–µ –ø–æ–º–µ—á–µ–Ω—ã –∫–∞–∫ DEPRECATED

### –®–∞–≥ 2: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–æ—Å—Ç–æ—è–Ω–Ω–æ–≥–æ –ø—Ä–æ–∫—Å–∏—Ä–æ–≤–∞–Ω–∏—è

#### 2.1 –£–¥–∞–ª–∏—Ç—å —É—Å–ª–æ–≤–Ω—É—é –ª–æ–≥–∏–∫—É USE_AUTH_SERVICE:
- –í `auth_proxy.go` —É–±—Ä–∞—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É `if !m.enabled`
- –°–¥–µ–ª–∞—Ç—å –ø—Ä–æ–∫—Å–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–º –¥–ª—è –≤—Å–µ—Ö `/api/v1/auth/*` –∏ `/auth/*` endpoints

#### 2.2 –û–±–Ω–æ–≤–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é:
```go
// backend/internal/config/config.go
type Config struct {
    // ...
    AuthServiceURL string `env:"AUTH_SERVICE_URL" envDefault:"http://localhost:28080"`
    // –£–±—Ä–∞—Ç—å USE_AUTH_SERVICE - –±–æ–ª—å—à–µ –Ω–µ –Ω—É–∂–Ω–æ
}
```

### –®–∞–≥ 3: –û—á–∏—Å—Ç–∫–∞ —Ä–æ—É—Ç–∏–Ω–≥–∞

#### 3.1 –í backend/internal/proj/users/handler/routes.go:
- –£–±—Ä–∞—Ç—å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é –ª–æ–∫–∞–ª—å–Ω—ã—Ö auth handlers
- –û—Å—Ç–∞–≤–∏—Ç—å —Ç–æ–ª—å–∫–æ –ø—Ä–æ–∫—Å–∏—Ä–æ–≤–∞–Ω–∏–µ —á–µ—Ä–µ–∑ middleware

### –®–∞–≥ 4: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏

#### 4.1 –û–±–Ω–æ–≤–∏—Ç—å .env.example:
```env
# Auth Service Configuration (REQUIRED)
AUTH_SERVICE_URL=http://localhost:28080
# –£–±—Ä–∞—Ç—å USE_AUTH_SERVICE - –±–æ–ª—å—à–µ –Ω–µ –∞–∫—Ç—É–∞–ª—å–Ω–æ
```

#### 4.2 –û–±–Ω–æ–≤–∏—Ç—å README –∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é –ø–æ –∑–∞–ø—É—Å–∫—É

### –®–∞–≥ 5: –ú–∏–≥—Ä–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

#### 5.1 –¢–∞–±–ª–∏—Ü—ã –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –∏–∑ –æ—Å–Ω–æ–≤–Ω–æ–π –ë–î:
- `sessions` - –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω–∞ –≤ Auth Service
- `oauth_states` - –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω–∞ –≤ Auth Service  
- `refresh_tokens` - –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω–∞ –≤ Auth Service
- `auth_audit_logs` - –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω–∞ –≤ Auth Service

#### 5.2 –°–æ–∑–¥–∞—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é –¥–ª—è –æ—á–∏—Å—Ç–∫–∏:
```sql
-- 000062_cleanup_auth_tables.down.sql
-- –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–∞–±–ª–∏—Ü (–Ω–∞ —Å–ª—É—á–∞–π –æ—Ç–∫–∞—Ç–∞)

-- 000062_cleanup_auth_tables.up.sql
DROP TABLE IF EXISTS sessions CASCADE;
DROP TABLE IF EXISTS oauth_states CASCADE;
DROP TABLE IF EXISTS refresh_tokens CASCADE;
DROP TABLE IF EXISTS auth_audit_logs CASCADE;
```

## üöÄ –ü–æ—Ä—è–¥–æ–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è

### –î–µ–Ω—å 1: –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞
1. ‚úÖ –°–æ–∑–¥–∞—Ç—å –±—ç–∫–∞–ø —Ç–µ–∫—É—â–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è
2. ‚úÖ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–±–æ—Ç—É Auth Service
3. ‚úÖ –£–±–µ–¥–∏—Ç—å—Å—è —á—Ç–æ –≤—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ—Ö–æ–¥—è—Ç

### –î–µ–Ω—å 2: –£–¥–∞–ª–µ–Ω–∏–µ legacy –∫–æ–¥–∞
1. –£–¥–∞–ª–∏—Ç—å/–∑–∞–º–µ–Ω–∏—Ç—å –º–µ—Ç–æ–¥—ã –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –≤ –º–æ–Ω–æ–ª–∏—Ç–µ
2. –£–±—Ä–∞—Ç—å —É—Å–ª–æ–≤–Ω—É—é –ª–æ–≥–∏–∫—É USE_AUTH_SERVICE
3. –ó–∞–ø—É—Å—Ç–∏—Ç—å –∏ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å

### –î–µ–Ω—å 3: –§–∏–Ω–∞–ª–∏–∑–∞—Ü–∏—è
1. –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è —Ç–∞–±–ª–∏—Ü
2. –û–±–Ω–æ–≤–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é
3. –ü—Ä–æ–≤–µ—Å—Ç–∏ –ø–æ–ª–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
4. –°–æ–∑–¥–∞—Ç—å PR —Å –∏–∑–º–µ–Ω–µ–Ω–∏—è–º–∏

## ‚úÖ –ö—Ä–∏—Ç–µ—Ä–∏–∏ —É—Å–ø–µ—Ö–∞

1. **–í—Å–µ auth –∑–∞–ø—Ä–æ—Å—ã** –ø—Ä–æ—Ö–æ–¥—è—Ç —á–µ—Ä–µ–∑ Auth Service
2. **–ù–µ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è –∫–æ–¥–∞** –º–µ–∂–¥—É –º–æ–Ω–æ–ª–∏—Ç–æ–º –∏ –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å–æ–º
3. **–¢–µ—Å—Ç—ã –ø—Ä–æ—Ö–æ–¥—è—Ç** —É—Å–ø–µ—à–Ω–æ
4. **–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∞** –∏ –∞–∫—Ç—É–∞–ª—å–Ω–∞
5. **–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –æ—á–∏—â–µ–Ω–∞** –æ—Ç –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö —Ç–∞–±–ª–∏—Ü

## üîç –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ—Å–ª–µ –º–∏–≥—Ä–∞—Ü–∏–∏

### –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ —Ç–µ—Å—Ç—ã:
```bash
# 1. –¢–µ—Å—Ç –ª–æ–≥–∏–Ω–∞
curl -X POST http://localhost:3000/api/v1/auth/login \
  -H "Content-Type: application/json" \
  -d '{"email":"test@example.com","password":"password123"}'

# 2. –¢–µ—Å—Ç OAuth
curl http://localhost:3000/auth/google

# 3. –¢–µ—Å—Ç —Å–µ—Å—Å–∏–∏
curl http://localhost:3000/api/v1/auth/session \
  -H "Authorization: Bearer TOKEN"

# 4. –¢–µ—Å—Ç refresh
curl -X POST http://localhost:3000/api/v1/auth/refresh \
  -H "Content-Type: application/json" \
  -d '{"refresh_token":"REFRESH_TOKEN"}'

# 5. –¢–µ—Å—Ç logout
curl -X POST http://localhost:3000/api/v1/auth/logout \
  -H "Authorization: Bearer TOKEN"
```

### –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã:
1. –ü–æ–ª–Ω—ã–π flow —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
2. OAuth –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ Google
3. Refresh token rotation
4. Token revocation –ø—Ä–∏ logout

## üìã –ß–µ–∫–ª–∏—Å—Ç –ø–µ—Ä–µ–¥ production

- [ ] Auth Service –∑–∞–ø—É—â–µ–Ω –∏ –¥–æ—Å—Ç—É–ø–µ–Ω
- [ ] –í—Å–µ legacy –∫–æ–¥ —É–¥–∞–ª–µ–Ω –∏–∑ –º–æ–Ω–æ–ª–∏—Ç–∞
- [ ] Proxy middleware —Ä–∞–±–æ—Ç–∞–µ—Ç –±–µ–∑ —É—Å–ª–æ–≤–∏–π
- [ ] –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –æ—á–∏—â–µ–Ω–∞ –æ—Ç —Å—Ç–∞—Ä—ã—Ö —Ç–∞–±–ª–∏—Ü
- [ ] –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∞
- [ ] –í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ—Ö–æ–¥—è—Ç
- [ ] –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –Ω–∞—Å—Ç—Ä–æ–µ–Ω
- [ ] Backup —Å–æ–∑–¥–∞–Ω

## üéØ –†–µ–∑—É–ª—å—Ç–∞—Ç

–ü–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –ø–ª–∞–Ω–∞:
1. **–ï–¥–∏–Ω–∞—è —Ç–æ—á–∫–∞** –¥–ª—è –≤—Å–µ–π –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ - Auth Service
2. **–ß–∏—Å—Ç—ã–π –∫–æ–¥** –±–µ–∑ legacy –∏ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è
3. **–ü—Ä–æ—Å—Ç–æ—Ç–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏** - –æ–¥–∏–Ω —Å–µ—Ä–≤–∏—Å, –æ–¥–Ω–∞ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å
4. **–ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—é** - –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å –º–æ–∂–Ω–æ —Ä–∞–∑–≤–∏–≤–∞—Ç—å –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ