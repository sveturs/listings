# –°–∏—Å—Ç–µ–º–∞ –∞–Ω–∞–ª–∏–∑–∞ —Ü–µ–Ω –∏ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Å–∫–∏–¥–æ–∫

**–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è:** 2025-10-06
**–°—Ç–∞—Ç—É—Å:** üìã –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è —Ç–µ–∫—É—â–µ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏
**–°–≤—è–∑–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:**
- `backend/internal/proj/marketplace/service/price_history.go`
- `backend/internal/domain/models/price_history.go`
- `backend/internal/storage/postgres/price_history.go`

---

## üéØ –û–±—â–∞—è –∫–æ–Ω—Ü–µ–ø—Ü–∏—è

–ù–∞—à–∞ –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞ –∏–º–µ–µ—Ç **–Ω–µ–∑–∞–≤–∏—Å–∏–º—É—é —É–º–Ω—É—é —Å–∏—Å—Ç–µ–º—É –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Å–∫–∏–¥–æ–∫**, –∫–æ—Ç–æ—Ä–∞—è –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –∏—Å—Ç–æ—Ä–∏—é –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ü–µ–Ω –∏ –≤—ã—è–≤–ª—è–µ—Ç –∏—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω—ã–µ –º–∞–Ω–∏–ø—É–ª—è—Ü–∏–∏.

### –ö–ª—é—á–µ–≤—ã–µ –ø—Ä–∏–Ω—Ü–∏–ø—ã

1. **–ù–µ–∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –æ—Ç –≤–Ω–µ—à–Ω–∏—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤**
   - –ù–µ –¥–æ–≤–µ—Ä—è–µ–º –∞—Ç—Ä–∏–±—É—Ç–∞–º —Ç–∏–ø–∞ "–Ω–∞ –∞–∫—Ü–∏–∏" –∏–∑ –ø—Ä–∞–π—Å–æ–≤ –∫–ª–∏–µ–Ω—Ç–æ–≤
   - –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ —Ü–µ–Ω—ã –≤–æ –≤—Ä–µ–º–µ–Ω–∏
   - –û–ø—Ä–µ–¥–µ–ª—è–µ–º –Ω–∞—Å—Ç–æ—è—â–∏–µ —Å–∫–∏–¥–∫–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ –æ–±—ä–µ–∫—Ç–∏–≤–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö

2. **–ó–∞—â–∏—Ç–∞ –æ—Ç –º–∞–Ω–∏–ø—É–ª—è—Ü–∏–π**
   - –í—ã—è–≤–ª—è–µ–º –∏—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω–æ–µ –∑–∞–≤—ã—à–µ–Ω–∏–µ —Ü–µ–Ω—ã –ø–µ—Ä–µ–¥ "—Å–∫–∏–¥–∫–æ–π"
   - –ü—Ä–æ–≤–µ—Ä—è–µ–º –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è –¥–µ–π—Å—Ç–≤–∏—è –ø—Ä–µ–¥—ã–¥—É—â–µ–π —Ü–µ–Ω—ã
   - –¢—Ä–µ–±—É–µ–º –∑–Ω–∞—á–∏–º—ã–π –ø—Ä–æ—Ü–µ–Ω—Ç —Å–∫–∏–¥–∫–∏

3. **–ö–∞—Å–∫–∞–¥–Ω—ã–µ –±–µ–π–¥–∂–∏**
   - –¢–æ–≤–∞—Ä —Å –Ω–∞—Å—Ç–æ—è—â–µ–π —Å–∫–∏–¥–∫–æ–π ‚Üí –±–µ–π–¥–∂ "–°–∫–∏–¥–∫–∞ X%"
   - –í–∏—Ç—Ä–∏–Ω–∞ —Å –º–Ω–æ–∂–µ—Å—Ç–≤–æ–º —Å–∫–∏–¥–æ–∫ ‚Üí –±–µ–π–¥–∂ "–ß–µ—Ä–Ω–∞—è –ø—è—Ç–Ω–∏—Ü–∞"

---

## üìä –¢–∞–±–ª–∏—Ü–∞ price_history

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞

```sql
CREATE TABLE price_history (
    id                SERIAL PRIMARY KEY,
    listing_id        INTEGER NOT NULL,              -- ID —Ç–æ–≤–∞—Ä–∞ –≤ –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å–µ
    price             NUMERIC(12,2) NOT NULL,         -- –¶–µ–Ω–∞
    effective_from    TIMESTAMP NOT NULL DEFAULT NOW, -- –ù–∞—á–∞–ª–æ –¥–µ–π—Å—Ç–≤–∏—è —Ü–µ–Ω—ã
    effective_to      TIMESTAMP,                      -- –û–∫–æ–Ω—á–∞–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏—è (NULL = —Ç–µ–∫—É—â–∞—è)
    change_source     VARCHAR(50) NOT NULL,           -- –ò—Å—Ç–æ—á–Ω–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è
    change_percentage NUMERIC(10,2),                  -- –ü—Ä–æ—Ü–µ–Ω—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è
    created_at        TIMESTAMP NOT NULL DEFAULT NOW
);

-- –ò–Ω–¥–µ–∫—Å—ã
CREATE INDEX idx_price_history_listing_id ON price_history(listing_id);
CREATE INDEX idx_price_history_effective ON price_history(listing_id, effective_to);
CREATE INDEX idx_price_history_current ON price_history(listing_id, effective_from DESC)
    WHERE effective_to IS NULL;

-- –¢—Ä–∏–≥–≥–µ—Ä –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö
CREATE TRIGGER trig_update_metadata_after_price_change
    AFTER INSERT ON price_history
    FOR EACH ROW
    EXECUTE FUNCTION update_listing_metadata_after_price_change();
```

### –ò—Å—Ç–æ—á–Ω–∏–∫–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ü–µ–Ω—ã (change_source)

- **`import`** - –∏–∑–º–µ–Ω–µ–Ω–∏–µ —á–µ—Ä–µ–∑ –∏–º–ø–æ—Ä—Ç –ø—Ä–∞–π—Å–∞ (Digital Vision –∏ –¥—Ä.)
- **`manual`** - —Ä—É—á–Ω–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –ø—Ä–æ–¥–∞–≤—Ü–æ–º
- **`system`** - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º–æ–π
- **`scheduled`** - –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ (–∞–∫—Ü–∏–∏)

---

## üîç –ê–ª–≥–æ—Ä–∏—Ç–º –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Å–∫–∏–¥–∫–∏

### –ú–µ—Ç–æ–¥: AnalyzeDiscount

**–§–∞–π–ª:** `backend/internal/proj/marketplace/service/price_history.go:79`

```go
func (s *PriceHistoryService) AnalyzeDiscount(ctx context.Context, listingID int) (*models.DiscountInfo, error)
```

### –í—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
- `listingID` - ID —Ç–æ–≤–∞—Ä–∞ –≤ –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å–µ

### –ê–ª–≥–æ—Ä–∏—Ç–º

#### –®–∞–≥ 1: –ü–æ–ª—É—á–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ —Ü–µ–Ω
```go
history, err := s.GetPriceHistory(ctx, listingID)
if len(history) < 2 {
    return nil, ErrInsufficientPriceHistory
}
```

**–¢—Ä–µ–±–æ–≤–∞–Ω–∏–µ:** –ú–∏–Ω–∏–º—É–º 2 –∑–∞–ø–∏—Å–∏ –≤ –∏—Å—Ç–æ—Ä–∏–∏

---

#### –®–∞–≥ 2: –ê–Ω–∞–ª–∏–∑ —Ü–µ–Ω
```go
currentPrice          // –¢–µ–∫—É—â–∞—è —Ü–µ–Ω–∞
previousPrice         // –ü—Ä–µ–¥—ã–¥—É—â–∞—è —Ü–µ–Ω–∞
maxPrice              // –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è —Ü–µ–Ω–∞ –∑–∞ –≤—Å—é –∏—Å—Ç–æ—Ä–∏—é
currentEffectiveFrom  // –ö–æ–≥–¥–∞ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ —Ç–µ–∫—É—â–∞—è —Ü–µ–Ω–∞
previousEffectiveFrom // –ö–æ–≥–¥–∞ –±—ã–ª–∞ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –ø—Ä–µ–¥—ã–¥—É—â–∞—è —Ü–µ–Ω–∞
maxPriceEffectiveFrom // –ö–æ–≥–¥–∞ –±—ã–ª–∞ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è —Ü–µ–Ω–∞
```

---

#### –®–∞–≥ 3: –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Å–Ω–∏–∂–µ–Ω–∏–µ —Ü–µ–Ω—ã
```go
if currentPrice < previousPrice {
    // –í—ã—á–∏—Å–ª—è–µ–º –ø—Ä–æ—Ü–µ–Ω—Ç —Å–∫–∏–¥–∫–∏
    discountPercent = (1 - currentPrice/previousPrice) * 100
    maxDiscountPercent = (1 - currentPrice/maxPrice) * 100
}
```

---

#### –®–∞–≥ 4: –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –Ω–∞—Å—Ç–æ—è—â–µ–π —Å–∫–∏–¥–∫–∏

```go
daysSincePrevious := time.Since(previousEffectiveFrom).Hours() / 24

isRealDiscount :=
    discountPercent >= 5 &&           // –°–∫–∏–¥–∫–∞ –º–∏–Ω–∏–º—É–º 5%
    daysSincePrevious >= 7 &&          // –ü—Ä–µ–¥—ã–¥—É—â–∞—è —Ü–µ–Ω–∞ –¥–µ–π—Å—Ç–≤–æ–≤–∞–ª–∞ ‚â•7 –¥–Ω–µ–π
    !isSuspicious                      // –ù–µ—Ç –ø—Ä–∏–∑–Ω–∞–∫–æ–≤ –º–∞–Ω–∏–ø—É–ª—è—Ü–∏–∏
```

**–ö—Ä–∏—Ç–µ—Ä–∏–∏ –Ω–∞—Å—Ç–æ—è—â–µ–π —Å–∫–∏–¥–∫–∏:**

1. ‚úÖ **–°–∫–∏–¥–∫–∞ ‚â• 5%**
   - –ù–µ–∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω—ã–µ –∫–æ–ª–µ–±–∞–Ω–∏—è —Ü–µ–Ω—ã –Ω–µ —Å—á–∏—Ç–∞—é—Ç—Å—è —Å–∫–∏–¥–∫–æ–π
   - –ü—Ä–∏–º–µ—Ä: —Ü–µ–Ω–∞ 1000‚ÇΩ ‚Üí 940‚ÇΩ (6% —Å–∫–∏–¥–∫–∞) ‚úÖ
   - –ü—Ä–∏–º–µ—Ä: —Ü–µ–Ω–∞ 1000‚ÇΩ ‚Üí 970‚ÇΩ (3% —Å–∫–∏–¥–∫–∞) ‚ùå

2. ‚úÖ **–ü—Ä–µ–¥—ã–¥—É—â–∞—è —Ü–µ–Ω–∞ –¥–µ–π—Å—Ç–≤–æ–≤–∞–ª–∞ ‚â• 7 –¥–Ω–µ–π**
   - –ó–∞—â–∏—Ç–∞ –æ—Ç –º–∞–Ω–∏–ø—É–ª—è—Ü–∏–∏: –∑–∞–≤—ã—Å–∏–ª–∏ —Ü–µ–Ω—É ‚Üí —Å—Ä–∞–∑—É –ø–æ–Ω–∏–∑–∏–ª–∏
   - –ü—Ä–∏–º–µ—Ä: —Ü–µ–Ω–∞ 1000‚ÇΩ –¥–µ—Ä–∂–∞–ª–∞—Å—å 30 –¥–Ω–µ–π ‚Üí 800‚ÇΩ ‚úÖ
   - –ü—Ä–∏–º–µ—Ä: —Ü–µ–Ω–∞ 1500‚ÇΩ –¥–µ—Ä–∂–∞–ª–∞—Å—å 2 –¥–Ω—è ‚Üí 800‚ÇΩ ‚ùå (–ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω–æ)

3. ‚úÖ **–ù–µ—Ç –ø—Ä–∏–∑–Ω–∞–∫–æ–≤ –º–∞–Ω–∏–ø—É–ª—è—Ü–∏–∏**
   - –§–ª–∞–≥ `isSuspicious` (–ø–æ–∫–∞ –Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –ø–æ–ª–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞)
   - –ü–ª–∞–Ω–∏—Ä—É–µ—Ç—Å—è: –∞–Ω–∞–ª–∏–∑ –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤ "–∑–∞–≤—ã—Å–∏–ª–∏ ‚Üí –ø–æ–Ω–∏–∑–∏–ª–∏"

---

### –í—ã—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ: DiscountInfo

```go
type DiscountInfo struct {
    CurrentPrice          float64   // –¢–µ–∫—É—â–∞—è —Ü–µ–Ω–∞
    PreviousPrice         float64   // –ü—Ä–µ–¥—ã–¥—É—â–∞—è —Ü–µ–Ω–∞
    MaxPrice              float64   // –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è —Ü–µ–Ω–∞ –∑–∞ –∏—Å—Ç–æ—Ä–∏—é
    DiscountPercent       int       // –ü—Ä–æ—Ü–µ–Ω—Ç —Å–∫–∏–¥–∫–∏ –æ—Ç –ø—Ä–µ–¥—ã–¥—É—â–µ–π
    MaxDiscountPercent    int       // –ü—Ä–æ—Ü–µ–Ω—Ç —Å–∫–∏–¥–∫–∏ –æ—Ç –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π
    EffectiveFrom         time.Time // –ö–æ–≥–¥–∞ –Ω–∞—á–∞–ª–∞ –¥–µ–π—Å—Ç–≤–æ–≤–∞—Ç—å —Ç–µ–∫—É—â–∞—è —Ü–µ–Ω–∞
    PreviousEffectiveFrom time.Time // –ö–æ–≥–¥–∞ –±—ã–ª–∞ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –ø—Ä–µ–¥—ã–¥—É—â–∞—è
    MaxPriceEffectiveFrom time.Time // –ö–æ–≥–¥–∞ –±—ã–ª–∞ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è —Ü–µ–Ω–∞
    IsRealDiscount        bool      // ‚úÖ –ù–∞—Å—Ç–æ—è—â–∞—è —Å–∫–∏–¥–∫–∞
    IsSuspicious          bool      // ‚ö†Ô∏è –ü–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω–∞—è –º–∞–Ω–∏–ø—É–ª—è—Ü–∏—è
}
```

---

## üé® Frontend –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ

### –ú–æ–¥–µ–ª—å –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è: DiscountData

```go
type DiscountData struct {
    DiscountPercent int       // –ü—Ä–æ—Ü–µ–Ω—Ç —Å–∫–∏–¥–∫–∏ –¥–ª—è –±–µ–π–¥–∂–∞
    PreviousPrice   float64   // –ó–∞—á–µ—Ä–∫–Ω—É—Ç–∞—è —Ü–µ–Ω–∞
    EffectiveFrom   time.Time // "–°–∫–∏–¥–∫–∞ —Å 15 –æ–∫—Ç—è–±—Ä—è"
    HasPriceHistory bool      // –ü–æ–∫–∞–∑–∞—Ç—å –≥—Ä–∞—Ñ–∏–∫ —Ü–µ–Ω
}
```

### –ü—Ä–∏–º–µ—Ä –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è

```tsx
{discount.isRealDiscount && (
  <ProductCard>
    <DiscountBadge>-{discount.discountPercent}%</DiscountBadge>
    <CurrentPrice>{discount.currentPrice}‚ÇΩ</CurrentPrice>
    <PreviousPrice strikethrough>{discount.previousPrice}‚ÇΩ</PreviousPrice>
    <DiscountTimer>–°–∫–∏–¥–∫–∞ —Å {formatDate(discount.effectiveFrom)}</DiscountTimer>

    {discount.hasPriceHistory && (
      <PriceHistoryChart listingId={listing.id} />
    )}
  </ProductCard>
)}
```

---

## üè™ –ë–µ–π–¥–∂ "–ß–µ—Ä–Ω–∞—è –ø—è—Ç–Ω–∏—Ü–∞" –¥–ª—è –≤–∏—Ç—Ä–∏–Ω—ã

### –õ–æ–≥–∏–∫–∞ (–ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º–∞—è, –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –≤ –∫–æ–¥–µ)

```go
func (s *StorefrontService) CheckBlackFridayStatus(ctx context.Context, storefrontID int) (bool, error) {
    // 1. –ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ –∞–∫—Ç–∏–≤–Ω—ã–µ —Ç–æ–≤–∞—Ä—ã –≤–∏—Ç—Ä–∏–Ω—ã
    products, err := s.GetActiveProducts(ctx, storefrontID)
    if err != nil {
        return false, err
    }

    // 2. –ü–æ–¥—Å—á–∏—Ç–∞—Ç—å —Ç–æ–≤–∞—Ä—ã —Å –Ω–∞—Å—Ç–æ—è—â–µ–π —Å–∫–∏–¥–∫–æ–π
    discountCount := 0
    for _, product := range products {
        discount, err := s.priceHistoryService.AnalyzeDiscount(ctx, product.ListingID)
        if err == nil && discount.IsRealDiscount {
            discountCount++
        }
    }

    // 3. –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ø—Ä–æ—Ü–µ–Ω—Ç —Ç–æ–≤–∞—Ä–æ–≤ —Å–æ —Å–∫–∏–¥–∫–æ–π
    discountPercentage := float64(discountCount) / float64(len(products)) * 100

    // 4. –ë–µ–π–¥–∂ "–ß–µ—Ä–Ω–∞—è –ø—è—Ç–Ω–∏—Ü–∞" –µ—Å–ª–∏:
    // - –ú–∏–Ω–∏–º—É–º 20 —Ç–æ–≤–∞—Ä–æ–≤ —Å–æ —Å–∫–∏–¥–∫–æ–π
    // - –ú–∏–Ω–∏–º—É–º 30% —Ç–æ–≤–∞—Ä–æ–≤ —Å–æ —Å–∫–∏–¥–∫–æ–π
    isBlackFriday := discountCount >= 20 && discountPercentage >= 30

    return isBlackFriday, nil
}
```

### –ö—Ä–∏—Ç–µ—Ä–∏–∏ –±–µ–π–¥–∂–∞ "–ß–µ—Ä–Ω–∞—è –ø—è—Ç–Ω–∏—Ü–∞"

1. ‚úÖ **–ú–∏–Ω–∏–º—É–º 20 —Ç–æ–≤–∞—Ä–æ–≤ —Å–æ —Å–∫–∏–¥–∫–æ–π**
   - –ó–∞—â–∏—Ç–∞ –æ—Ç —Å–ª—É—á–∞–π–Ω—ã—Ö —Å–∫–∏–¥–æ–∫ –Ω–∞ 2-3 —Ç–æ–≤–∞—Ä–∞
   - –í–∏—Ç—Ä–∏–Ω–∞ –¥–æ–ª–∂–Ω–∞ —Ä–µ–∞–ª—å–Ω–æ –ø—Ä–æ–≤–æ–¥–∏—Ç—å —Ä–∞—Å–ø—Ä–æ–¥–∞–∂—É

2. ‚úÖ **–ú–∏–Ω–∏–º—É–º 30% —Ç–æ–≤–∞—Ä–æ–≤ —Å–æ —Å–∫–∏–¥–∫–æ–π**
   - –ú–∞—Å—Å–æ–≤–∞—è —Ä–∞—Å–ø—Ä–æ–¥–∞–∂–∞, –∞ –Ω–µ –µ–¥–∏–Ω–∏—á–Ω—ã–µ –∞–∫—Ü–∏–∏
   - –ü—Ä–∏–º–µ—Ä: 100 —Ç–æ–≤–∞—Ä–æ–≤, 35 —Å–æ —Å–∫–∏–¥–∫–æ–π ‚Üí 35% ‚úÖ Black Friday
   - –ü—Ä–∏–º–µ—Ä: 100 —Ç–æ–≤–∞—Ä–æ–≤, 10 —Å–æ —Å–∫–∏–¥–∫–æ–π ‚Üí 10% ‚ùå –û–±—ã—á–Ω—ã–µ –∞–∫—Ü–∏–∏

---

## üîÑ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –∏–º–ø–æ—Ä—Ç–æ–º

### –°—Ü–µ–Ω–∞—Ä–∏–π: –ò–º–ø–æ—Ä—Ç –ø—Ä–∞–π—Å–∞ Digital Vision

```go
// –ü—Ä–∏ –∏–º–ø–æ—Ä—Ç–µ —Ç–æ–≤–∞—Ä–∞ –∏–∑ Digital Vision
func (s *ImportService) createProduct(ctx context.Context, storefrontID int, importProduct models.ImportProductRequest) error {
    // 1. –°–æ–∑–¥–∞—Ç—å —Ç–æ–≤–∞—Ä —Å –Ω–æ–≤–æ–π —Ü–µ–Ω–æ–π
    product := &models.StorefrontProduct{
        Name:  importProduct.Name,
        Price: importProduct.Price,
        // ...
    }

    if err := s.productService.CreateProduct(ctx, product); err != nil {
        return err
    }

    // 2. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞–µ—Ç—Å—è –∑–∞–ø–∏—Å—å –≤ price_history
    // —á–µ—Ä–µ–∑ —Ç—Ä–∏–≥–≥–µ—Ä –∏–ª–∏ —è–≤–Ω—ã–π –≤—ã–∑–æ–≤:
    if product.ListingID != nil {
        err := s.priceHistoryService.RecordPriceChange(
            ctx,
            *product.ListingID,
            0,  // oldPrice (–¥–ª—è –Ω–æ–≤–æ–≥–æ —Ç–æ–≤–∞—Ä–∞)
            importProduct.Price,
            "import",  // source
        )
        if err != nil {
            log.Printf("Failed to record price: %v", err)
        }
    }

    // 3. –ê—Ç—Ä–∏–±—É—Ç "naAkciji" –∏–∑ Digital Vision –ù–ï –≤–ª–∏—è–µ—Ç –Ω–∞ —Å–∫–∏–¥–∫—É!
    // –û–Ω —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –∫–∞–∫ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:
    if importProduct.Attributes["naAkciji"] == "1" {
        product.Attributes["supplier_discount"] = true  // –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–æ
    }

    return nil
}

// –ü—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Ü–µ–Ω—ã —Ç–æ–≤–∞—Ä–∞
func (s *ImportService) updateProduct(ctx context.Context, product *models.StorefrontProduct, importProduct models.ImportProductRequest) error {
    oldPrice := product.Price
    newPrice := importProduct.Price

    // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–≤–∞—Ä
    product.Price = newPrice
    if err := s.productService.UpdateProduct(ctx, product); err != nil {
        return err
    }

    // –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Ü–µ–Ω—ã –≤ –∏—Å—Ç–æ—Ä–∏—é
    if product.ListingID != nil && oldPrice != newPrice {
        err := s.priceHistoryService.RecordPriceChange(
            ctx,
            *product.ListingID,
            oldPrice,
            newPrice,
            "import",
        )
        if err != nil {
            log.Printf("Failed to record price change: %v", err)
        }
    }

    return nil
}
```

### –í–∞–∂–Ω—ã–µ –º–æ–º–µ–Ω—Ç—ã

1. **–ê—Ç—Ä–∏–±—É—Ç "naAkciji" –∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç—Å—è –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Å–∫–∏–¥–∫–∏**
   ```go
   // ‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û:
   if importProduct.Attributes["naAkciji"] == "1" {
       product.ShowDiscountBadge = true  // –ù–ï –î–ï–õ–ê–¢–¨!
   }

   // ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û:
   if importProduct.Attributes["naAkciji"] == "1" {
       product.Attributes["supplier_discount_flag"] = true  // –¢–æ–ª—å–∫–æ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
   }
   // –ù–∞—Å—Ç–æ—è—â–∞—è —Å–∫–∏–¥–∫–∞ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è —á–µ—Ä–µ–∑ AnalyzeDiscount()
   ```

2. **–ò—Å—Ç–æ—Ä–∏—è —Ü–µ–Ω —Å–æ–∑–¥–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏**
   - –ü—Ä–∏ –∫–∞–∂–¥–æ–º –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ü–µ–Ω—ã —á–µ—Ä–µ–∑ –∏–º–ø–æ—Ä—Ç
   - `change_source = "import"`
   - –¢—Ä–∏–≥–≥–µ—Ä –æ–±–Ω–æ–≤–ª—è–µ—Ç –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ —Ç–æ–≤–∞—Ä–∞

3. **–°–∫–∏–¥–∫–∞ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ**
   - –ü–æ—Å–ª–µ –Ω–∞–∫–æ–ø–ª–µ–Ω–∏—è –∏—Å—Ç–æ—Ä–∏–∏ (–º–∏–Ω–∏–º—É–º 7 –¥–Ω–µ–π)
   - –ß–µ—Ä–µ–∑ –º–µ—Ç–æ–¥ `AnalyzeDiscount()`
   - –ù–∞ –æ—Å–Ω–æ–≤–µ –æ–±—ä–µ–∫—Ç–∏–≤–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö

---

## üìà –ü—Ä–∏–º–µ—Ä—ã —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤

### –°—Ü–µ–Ω–∞—Ä–∏–π 1: –ù–∞—Å—Ç–æ—è—â–∞—è —Å–∫–∏–¥–∫–∞

```
Day 1-30:  –¶–µ–Ω–∞ = 1000‚ÇΩ (–∏–∑ Digital Vision, naAkciji=0)
           ‚Üí price_history: 1000‚ÇΩ, effective_from=2025-01-01

Day 31:    –¶–µ–Ω–∞ = 700‚ÇΩ (–∏–∑ Digital Vision, naAkciji=1)
           ‚Üí price_history: 700‚ÇΩ, effective_from=2025-01-31

–ê–Ω–∞–ª–∏–∑:
- currentPrice = 700‚ÇΩ
- previousPrice = 1000‚ÇΩ
- discountPercent = 30%
- daysSincePrevious = 30 –¥–Ω–µ–π
- isRealDiscount = true ‚úÖ (30% >= 5% && 30 –¥–Ω–µ–π >= 7)

–†–µ–∑—É–ª—å—Ç–∞—Ç: –ë–µ–π–¥–∂ "–°–∫–∏–¥–∫–∞ 30%"
```

---

### –°—Ü–µ–Ω–∞—Ä–∏–π 2: –ú–∞–Ω–∏–ø—É–ª—è—Ü–∏—è —Ü–µ–Ω–æ–π

```
Day 1-30:  –¶–µ–Ω–∞ = 1000‚ÇΩ (naAkciji=0)
Day 31:    –¶–µ–Ω–∞ = 1500‚ÇΩ (naAkciji=0) ‚Üê –ò—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω–æ –∑–∞–≤—ã—à–µ–Ω–∞
Day 33:    –¶–µ–Ω–∞ = 900‚ÇΩ (naAkciji=1) ‚Üê "–°–∫–∏–¥–∫–∞ 40%"

–ê–Ω–∞–ª–∏–∑:
- currentPrice = 900‚ÇΩ
- previousPrice = 1500‚ÇΩ
- discountPercent = 40%
- daysSincePrevious = 2 –¥–Ω—è ‚ùå
- isRealDiscount = false (2 < 7 –¥–Ω–µ–π)

–†–µ–∑—É–ª—å—Ç–∞—Ç: –ù–ï–¢ –±–µ–π–¥–∂–∞ —Å–∫–∏–¥–∫–∏ (–ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω–∞—è –º–∞–Ω–∏–ø—É–ª—è—Ü–∏—è)
```

---

### –°—Ü–µ–Ω–∞—Ä–∏–π 3: –ù–µ–∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–∞—è —Å–∫–∏–¥–∫–∞

```
Day 1-30:  –¶–µ–Ω–∞ = 1000‚ÇΩ
Day 31:    –¶–µ–Ω–∞ = 970‚ÇΩ (naAkciji=1)

–ê–Ω–∞–ª–∏–∑:
- currentPrice = 970‚ÇΩ
- previousPrice = 1000‚ÇΩ
- discountPercent = 3%
- daysSincePrevious = 30 –¥–Ω–µ–π
- isRealDiscount = false ‚ùå (3% < 5%)

–†–µ–∑—É–ª—å—Ç–∞—Ç: –ù–ï–¢ –±–µ–π–¥–∂–∞ —Å–∫–∏–¥–∫–∏ (—Å–ª–∏—à–∫–æ–º –º–∞–ª–µ–Ω—å–∫–∞—è)
```

---

### –°—Ü–µ–Ω–∞—Ä–∏–π 4: –ß–µ—Ä–Ω–∞—è –ø—è—Ç–Ω–∏—Ü–∞ –≤–∏—Ç—Ä–∏–Ω—ã

```
–í–∏—Ç—Ä–∏–Ω–∞ Digital Vision:
- –í—Å–µ–≥–æ —Ç–æ–≤–∞—Ä–æ–≤: 17,353
- –ò–º–ø–æ—Ä—Ç —Å –Ω–æ–≤—ã–º–∏ —Ü–µ–Ω–∞–º–∏

–ß–µ—Ä–µ–∑ 7+ –¥–Ω–µ–π –ø–æ—Å–ª–µ –∏–º–ø–æ—Ä—Ç–∞:
- –ê–Ω–∞–ª–∏–∑ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç: 6,500 —Ç–æ–≤–∞—Ä–æ–≤ (37%) –∏–º–µ—é—Ç –Ω–∞—Å—Ç–æ—è—â—É—é —Å–∫–∏–¥–∫—É
- –ö—Ä–∏—Ç–µ—Ä–∏–∏: 6,500 >= 20 ‚úÖ && 37% >= 30% ‚úÖ

–†–µ–∑—É–ª—å—Ç–∞—Ç: –í–∏—Ç—Ä–∏–Ω–∞ –ø–æ–ª—É—á–∞–µ—Ç –±–µ–π–¥–∂ "üî• –ß–µ—Ä–Ω–∞—è –ø—è—Ç–Ω–∏—Ü–∞"
```

---

## üéØ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–ª—è –∏–º–ø–æ—Ä—Ç–∞

### 1. –í—Å–µ–≥–¥–∞ –∑–∞–ø–∏—Å—ã–≤–∞—Ç—å –∏—Å—Ç–æ—Ä–∏—é —Ü–µ–Ω

```go
// –ü—Ä–∏ –ª—é–±–æ–º –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ü–µ–Ω—ã —á–µ—Ä–µ–∑ –∏–º–ø–æ—Ä—Ç
err := s.priceHistoryService.RecordPriceChange(
    ctx,
    listingID,
    oldPrice,
    newPrice,
    "import",
)
```

### 2. –ù–ï –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤–Ω–µ—à–Ω–∏–µ —Ñ–ª–∞–≥–∏ —Å–∫–∏–¥–∫–∏

```go
// ‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û:
if externalData["on_sale"] == true {
    applyDiscountBadge()
}

// ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û:
// –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–∞–∫ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
product.Attributes["supplier_sale_flag"] = externalData["on_sale"]

// –°–∫–∏–¥–∫–∞ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —á–µ—Ä–µ–∑ AnalyzeDiscount()
```

### 3. –ú–æ–Ω–∏—Ç–æ—Ä–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ü–µ–Ω

```go
// –ü–æ—Å–ª–µ –∏–º–ø–æ—Ä—Ç–∞ - –ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è
log.Printf(
    "Price changed for product %d: %f ‚Üí %f (%.1f%%)",
    productID,
    oldPrice,
    newPrice,
    changePercent,
)
```

### 4. –†–µ–≥—É–ª—è—Ä–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è

```go
// Scheduled –∏–º–ø–æ—Ä—Ç Digital Vision (–µ–∂–µ–¥–Ω–µ–≤–Ω–æ)
// ‚Üí –ù–∞–∫–∞–ø–ª–∏–≤–∞–µ—Ç—Å—è –∏—Å—Ç–æ—Ä–∏—è —Ü–µ–Ω
// ‚Üí –ß–µ—Ä–µ–∑ –Ω–µ–¥–µ–ª—é —Å–∏—Å—Ç–µ–º–∞ –Ω–∞—á–Ω–µ—Ç –æ–ø—Ä–µ–¥–µ–ª—è—Ç—å –Ω–∞—Å—Ç–æ—è—â–∏–µ —Å–∫–∏–¥–∫–∏
```

---

## üîÆ –ü–ª–∞–Ω—ã —Ä–∞–∑–≤–∏—Ç–∏—è

### –ö—Ä–∞—Ç–∫–æ—Å—Ä–æ—á–Ω—ã–µ (1-2 –Ω–µ–¥–µ–ª–∏)

1. ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –ø–æ–ª–Ω—É—é –ø—Ä–æ–≤–µ—Ä–∫—É –º–∞–Ω–∏–ø—É–ª—è—Ü–∏–π (`isSuspicious`)
   - –ü–∞—Ç—Ç–µ—Ä–Ω: —Ä–µ–∑–∫–æ–µ –ø–æ–≤—ã—à–µ–Ω–∏–µ ‚Üí –ø–æ–Ω–∏–∂–µ–Ω–∏–µ
   - –ê–Ω–∞–ª–∏–∑ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–≥–æ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è —Ü–µ–Ω—ã
   - –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–µ–∑–æ–Ω–Ω—ã—Ö –∫–æ–ª–µ–±–∞–Ω–∏–π

2. ‚úÖ –î–æ–±–∞–≤–∏—Ç—å dashboard –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
   - –í–∏—Ç—Ä–∏–Ω—ã —Å –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—ã–º–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è–º–∏ —Ü–µ–Ω
   - –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–∫–∏–¥–æ–∫ –ø–æ –≤–∏—Ç—Ä–∏–Ω–∞–º
   - –¢–æ–ø —Ç–æ–≤–∞—Ä—ã —Å–æ —Å–∫–∏–¥–∫–∞–º–∏

3. ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å API –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–∫–∏–¥–æ–∫
   ```go
   GET /api/v1/storefronts/:id/discounts
   GET /api/v1/listings/:id/discount-analysis
   ```

### –°—Ä–µ–¥–Ω–µ—Å—Ä–æ—á–Ω—ã–µ (1-2 –º–µ—Å—è—Ü–∞)

1. ‚úÖ ML –º–æ–¥–µ–ª—å –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –º–∞–Ω–∏–ø—É–ª—è—Ü–∏–π
   - –û–±—É—á–µ–Ω–∏–µ –Ω–∞ –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö
   - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –≤—ã—è–≤–ª–µ–Ω–∏–µ –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤ –æ–±–º–∞–Ω–∞
   - Confidence score –¥–ª—è –∫–∞–∂–¥–æ–π —Å–∫–∏–¥–∫–∏

2. ‚úÖ –£–º–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
   - –ü–æ–∫—É–ø–∞—Ç–µ–ª—è–º: "–¶–µ–Ω–∞ —Å–Ω–∏–∑–∏–ª–∞—Å—å –Ω–∞ —Ç–æ–≤–∞—Ä –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ"
   - –ü—Ä–æ–¥–∞–≤—Ü–∞–º: "–í–∞—à–∏ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç—ã —Å–Ω–∏–∑–∏–ª–∏ —Ü–µ–Ω—ã"
   - –ê–¥–º–∏–Ω–∞–º: "–û–±–Ω–∞—Ä—É–∂–µ–Ω–∞ –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω–∞—è –º–∞–Ω–∏–ø—É–ª—è—Ü–∏—è"

3. ‚úÖ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ç–µ–ª—å–Ω–æ–π —Å–∏—Å—Ç–µ–º–æ–π
   - –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç —Ç–æ–≤–∞—Ä–æ–≤ —Å –Ω–∞—Å—Ç–æ—è—â–∏–º–∏ —Å–∫–∏–¥–∫–∞–º–∏
   - –ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è
   - "–ü–æ—Ö–æ–∂–∏–µ —Ç–æ–≤–∞—Ä—ã –¥–µ—à–µ–≤–ª–µ"

---

**–î–∞—Ç–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:** 2025-10-06
**–ê–≤—Ç–æ—Ä:** Claude Code
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ê–∫—Ç—É–∞–ª—å–Ω–æ
