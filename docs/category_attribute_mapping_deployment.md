# Инструкция по развертыванию функционала управления атрибутами категорий

Данный документ содержит подробные инструкции по развертыванию функционала управления атрибутами категорий на боевом сервере. Инструкция предназначена для администратора системы, выполняющего обновление приложения.

## 1. Необходимые миграции базы данных

Перед обновлением кода необходимо убедиться, что следующие миграции применены к базе данных:

1. **000011_create_category_attributes.up.sql** - создание базовых таблиц для атрибутов категорий
2. **000016_attribute_option_translations.up.sql** - поддержка переводов опций атрибутов
3. **000017_attribute_translations_trigger.up.sql** - триггеры для автоматического обновления переводов
4. **000023_attribute_indices.up.sql** - индексы для оптимизации запросов к атрибутам

Для проверки и применения миграций выполните:

```bash
cd /opt/hostel-booking-system/backend
docker-compose exec postgres psql -U postgres -d marketplace -c "SELECT * FROM schema_migrations ORDER BY version DESC LIMIT 30;"
```

Если какие-то миграции отсутствуют, примените их с помощью migrate:

```bash
cd /opt/hostel-booking-system/backend
docker-compose exec backend migrate -path=./migrations -database "postgres://postgres:postgres@postgres:5432/marketplace?sslmode=disable" up
```

## 2. Последовательность действий при обновлении кода

### 2.1. Бэкап данных

Перед обновлением обязательно создайте резервную копию базы данных:

```bash
cd /opt/hostel-booking-system
docker-compose exec postgres pg_dump -U postgres -d marketplace > marketplace_backup_$(date +%Y%m%d).sql
```

### 2.2. Обновление кода

1. Получите последние изменения из репозитория:

```bash
cd /opt/hostel-booking-system
git pull origin main
```

2. Запустите синий-зеленый деплой для обновления backend и frontend:

```bash
./harbor-scripts/blue_green_deploy_on_svetu.rs.sh all
```

Если требуется только backend или frontend:

```bash
./harbor-scripts/blue_green_deploy_on_svetu.rs.sh backend
# или
./harbor-scripts/blue_green_deploy_on_svetu.rs.sh frontend
```

3. Подождите завершения процесса деплоя и автоматического переключения трафика на новую версию.

### 2.3. Проверка обновления индексов в OpenSearch

После обновления необходимо проверить, что схемы индексов в OpenSearch актуальны:

```bash
cd /opt/hostel-booking-system/backend
docker-compose exec backend ./bin/reindex
```

## 3. Порядок проверки работоспособности

### 3.1. Проверка API

Выполните запросы к API для проверки основных функций:

```bash
# Получение списка категорий с атрибутами
curl -X GET "https://svetu.rs/api/marketplace/admin/categories" -H "Authorization: Bearer YOUR_ADMIN_TOKEN"

# Получение списка атрибутов
curl -X GET "https://svetu.rs/api/marketplace/admin/attributes" -H "Authorization: Bearer YOUR_ADMIN_TOKEN"
```

### 3.2. Проверка административного интерфейса

1. Войдите в административную панель с правами администратора
2. Перейдите в раздел "Управление категориями"
3. Проверьте:
   - Отображение дерева категорий
   - Возможность создания новой категории
   - Редактирование существующей категории
   - Присвоение атрибутов категории
   - Создание новых атрибутов
   - Удаление атрибутов

### 3.3. Проверка со стороны пользователей

1. Создайте тестовое объявление в категории с настроенными атрибутами
2. Убедитесь, что:
   - Форма создания объявления отображает все атрибуты категории
   - Атрибуты корректно сохраняются
   - Атрибуты правильно отображаются на странице объявления
   - Фильтрация по атрибутам работает корректно

## 4. Потенциальные проблемы и их решение

### 4.1. Ошибки миграции базы данных

**Проблема**: Ошибки при выполнении миграций

**Решение**:
1. Проверьте лог-файлы на наличие конкретных ошибок
2. Примените резервную копию базы данных
3. Исправьте ошибки в скриптах миграции
4. Запустите миграцию заново

### 4.2. Проблемы с OpenSearch

**Проблема**: Поиск не учитывает атрибуты категорий

**Решение**:
1. Проверьте логи OpenSearch на наличие ошибок
2. Убедитесь в корректности маппингов:
```bash
curl -X GET "http://localhost:9200/marketplace/_mapping" | jq
```
3. Выполните реиндексацию:
```bash
docker-compose exec backend ./bin/reindex
```

### 4.3. Проблемы совместимости с фронтендом

**Проблема**: Фронтенд не может получить данные атрибутов или отображает их некорректно

**Решение**:
1. Проверьте консоль браузера на наличие ошибок
2. Убедитесь, что версии фронтенда и бэкенда совместимы
3. Очистите кеш браузера или добавьте параметр версии к запросам статических ресурсов

### 4.4. Проблемы с производительностью

**Проблема**: Медленная загрузка страниц категорий с большим количеством атрибутов

**Решение**:
1. Проверьте запросы к БД на наличие долгих запросов:
```bash
docker-compose exec postgres psql -U postgres -d marketplace -c "SELECT * FROM pg_stat_activity WHERE state = 'active';"
```
2. Добавьте индексы для полей, участвующих в частых запросах
3. Внедрите кеширование для часто запрашиваемых данных категорий и атрибутов

### 4.5. Восстановление после сбоя

В случае критических проблем используйте процедуру отката:

1. Остановите новую версию:
```bash
cd /opt/hostel-booking-system
docker-compose down
```

2. Восстановите базу данных из резервной копии:
```bash
cat marketplace_backup_YYYYMMDD.sql | docker-compose exec -T postgres psql -U postgres -d marketplace
```

3. Верните предыдущую версию кода:
```bash
git checkout <previous_commit_hash>
```

4. Запустите систему:
```bash
docker-compose up -d
```

## 5. Мониторинг после развертывания

После успешного развертывания рекомендуется в течение 24-48 часов вести усиленный мониторинг:

1. Регулярно проверяйте логи сервисов:
```bash
docker-compose logs -f backend frontend
```

2. Отслеживайте метрики производительности:
   - Время ответа API
   - Загрузку CPU и памяти
   - Количество запросов к базе данных

3. Настройте оповещения о превышении пороговых значений для ключевых метрик

## 6. Контакты для обращения при возникновении проблем

В случае возникновения проблем, которые не удается решить с помощью данной инструкции, обратитесь:

- К руководителю технического отдела: [контактная информация]
- К разработчику, ответственному за функционал атрибутов: [контактная информация]