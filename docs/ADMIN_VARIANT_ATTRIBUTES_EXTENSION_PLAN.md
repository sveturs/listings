# План расширения админки для управления вариативными атрибутами

## Дата актуализации: 11.08.2025

## Важное обновление: Система управления переводами

✅ **ПОЛНОСТЬЮ РЕАЛИЗОВАНА** административная панель управления переводами:
- Создан отдельный модуль `/admin/translations` для управления всеми переводами системы
- Реализованы эндпоинты для Frontend и БД переводов
- Добавлены таблицы для версионирования и синхронизации
- Полная поддержка 3 языков (SR, EN, RU) с 14,232 переводами
- Подробный отчет: `/docs/TRANSLATION_ADMIN_STATUS.md`

## Текущее состояние

### Существующий функционал админки атрибутов
- **Местоположение**: `/admin/attributes`
- **Основные возможности**:
  - CRUD операции с атрибутами
  - Поиск и фильтрация по типам
  - Управление переводами
  - Настройка валидации и отображения
  - Выбор кастомных компонентов

### Проблемы текущей реализации
1. Отсутствует связь между общими атрибутами категорий и вариативными атрибутами товаров
2. Нет интерфейса для управления таблицей `product_variant_attributes`
3. Нет настройки какие атрибуты могут использоваться как варианты для разных категорий
4. Отсутствует свойство `affects_stock` в интерфейсе атрибутов

## План расширения функционала

### Фаза 1: Расширение модели атрибутов

#### 1.1 Добавление поля `is_variant_compatible`
```typescript
interface Attribute {
  // ... существующие поля
  is_variant_compatible?: boolean; // Может ли атрибут использоваться для вариантов
  affects_stock?: boolean;         // Влияет ли на учет остатков
}
```

#### 1.2 Обновление формы AttributeForm
- Добавить чекбокс "Может использоваться для вариантов товаров"
- Добавить чекбокс "Влияет на учет остатков" (активен только если is_variant_compatible = true)
- Расположить в секции "Настройки отображения"

### Фаза 2: Создание раздела "Вариативные атрибуты"

#### 2.1 Новая страница в админке
- **Путь**: `/admin/variant-attributes`
- **Навигация**: Добавить в sidebar после "Атрибуты"
- **Иконка**: Использовать иконку с множественными тегами

#### 2.2 Функционал страницы
1. **Список всех вариативных атрибутов** из таблицы `product_variant_attributes`
2. **Управление связями** между атрибутами категорий и вариативными атрибутами
3. **Настройка по категориям** - какие варианты доступны для каких категорий

### Фаза 3: Интерфейс управления вариативными атрибутами

#### 3.1 Основная таблица
```
| Вариативный атрибут | Связанные атрибуты | Категории | Влияет на остатки | Действия |
|---------------------|-------------------|-----------|-------------------|----------|
| color               | color, цвет, boja | Все       | ❌                | ✏️ 🗑️    |
| memory              | ram, memory       | Телефоны  | ✅                | ✏️ 🗑️    |
```

#### 3.2 Форма редактирования вариативного атрибута
```typescript
interface VariantAttributeForm {
  name: string;                    // Системное имя (color, size, memory)
  display_name: string;            // Отображаемое имя
  affects_stock: boolean;          // Влияет на остатки
  linked_attributes: string[];     // Связанные атрибуты из category_attributes
  allowed_categories: string[];    // Категории где доступен
  translations: Record<string, string>; // Переводы
}
```

### Фаза 4: Визуальный редактор связей

#### 4.1 Drag & Drop интерфейс
- Слева: список атрибутов категорий (из category_attributes)
- Справа: вариативные атрибуты (из product_variant_attributes)
- Перетаскивание для создания связей

#### 4.2 Автоматическое определение связей
- Кнопка "Автоопределение" для поиска связей по названиям
- Алгоритм сопоставления по ключевым словам
- Предпросмотр предлагаемых связей

### Фаза 5: Интеграция с категориями

#### 5.1 Расширение страницы категорий
- Новая вкладка "Вариативные атрибуты" при редактировании категории
- Чекбоксы для выбора доступных вариативных атрибутов
- Порядок отображения вариантов

#### 5.2 Массовые операции
- Применить набор вариативных атрибутов к нескольким категориям
- Копировать настройки между категориями

### Фаза 6: API endpoints

#### 6.1 Новые эндпоинты
```
GET    /api/v1/admin/variant-attributes
POST   /api/v1/admin/variant-attributes
PUT    /api/v1/admin/variant-attributes/:id
DELETE /api/v1/admin/variant-attributes/:id
GET    /api/v1/admin/variant-attributes/mappings
PUT    /api/v1/admin/variant-attributes/mappings
GET    /api/v1/admin/categories/:id/variant-attributes
PUT    /api/v1/admin/categories/:id/variant-attributes
```

### Фаза 7: Миграции базы данных

#### 7.1 Расширение таблицы category_attributes
```sql
ALTER TABLE category_attributes 
ADD COLUMN is_variant_compatible BOOLEAN DEFAULT FALSE;
```

#### 7.2 Создание таблицы связей
```sql
CREATE TABLE variant_attribute_mappings (
  id SERIAL PRIMARY KEY,
  variant_attribute_name VARCHAR(100) NOT NULL,
  category_attribute_id INTEGER REFERENCES category_attributes(id),
  created_at TIMESTAMP DEFAULT NOW()
);
```

#### 7.3 Создание таблицы категория-варианты
```sql
CREATE TABLE category_variant_attributes (
  id SERIAL PRIMARY KEY,
  category_id INTEGER REFERENCES marketplace_categories(id),
  variant_attribute_name VARCHAR(100) NOT NULL,
  sort_order INTEGER DEFAULT 0,
  is_required BOOLEAN DEFAULT FALSE,
  created_at TIMESTAMP DEFAULT NOW()
);
```

## UI/UX концепция

### Макет страницы вариативных атрибутов
```
┌─────────────────────────────────────────────────────────┐
│ Вариативные атрибуты                      [+ Добавить]  │
├─────────────────────────────────────────────────────────┤
│ [🔍 Поиск]  [▼ Категория: Все]  [▼ Влияет на остатки] │
├─────────────────────────────────────────────────────────┤
│ ┌─────────────────────────────────────────────────────┐ │
│ │ color · Color                                       │ │
│ │ Связи: color, цвет, boja                          │ │
│ │ Категории: 15 · Остатки: ❌                        │ │
│ └─────────────────────────────────────────────────────┘ │
│ ┌─────────────────────────────────────────────────────┐ │
│ │ memory · Memory (RAM)                               │ │
│ │ Связи: ram, memory, память                         │ │
│ │ Категории: Телефоны, Компьютеры · Остатки: ✅      │ │
│ └─────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────┘
```

### Форма редактирования
```
┌─────────────────────────────────────────────────────────┐
│ Редактировать вариативный атрибут                       │
├─────────────────────────────────────────────────────────┤
│ Системное имя*     [memory                            ] │
│ Отображаемое имя*  [Memory (RAM)                      ] │
│                                                         │
│ ☑ Влияет на учет остатков                             │
│                                                         │
│ Связанные атрибуты категорий:                         │
│ ┌─────────────────────────────────────────────────────┐ │
│ │ ✓ ram (RAM)                                         │ │
│ │ ✓ memory (Memory)                                   │ │
│ │ ⚬ storage (Storage)                                 │ │
│ │ ⚬ processor (Processor)                             │ │
│ └─────────────────────────────────────────────────────┘ │
│                                                         │
│ Доступен в категориях:                                 │
│ [✓ Телефоны] [✓ Компьютеры] [⚬ Планшеты]             │
│                                                         │
│ [🌍 Перевести]  [Отмена] [Сохранить]                   │
└─────────────────────────────────────────────────────────┘
```

## Приоритеты реализации

### Высокий приоритет (MVP)
1. Добавление поля is_variant_compatible в AttributeForm
2. Создание базовой страницы управления вариативными атрибутами
3. API для CRUD операций с вариативными атрибутами
4. Простой интерфейс связывания атрибутов

### Средний приоритет
1. Визуальный редактор связей
2. Интеграция с категориями
3. Массовые операции
4. Автоматическое определение связей

### Низкий приоритет
1. Расширенная аналитика использования
2. История изменений
3. Экспорт/импорт конфигурации

## Интеграция с автомобильным разделом

### Специфика автомобильных атрибутов
1. **Связь с внешними справочниками:**
   - `car_make_id` → таблица `car_makes` (98 записей)
   - `car_model_id` → таблица `car_models` (3,020 записей)
   - Использование внешних API для валидации

2. **Вариативные атрибуты для авто:**
   - `engine_type` (1.4 TSI, 2.0 TDI) - влияет на цену
   - `color` - не влияет на остатки
   - `trim_level` (Comfortline, Highline) - влияет на комплектацию

3. **Источники данных:**
   ```typescript
   interface AttributeDataSource {
     type: 'internal' | 'database' | 'api';
     config: {
       table?: string;         // для type: 'database'
       valueField?: string;    // поле для значения
       labelField?: string;    // поле для отображения
       apiEndpoint?: string;   // для type: 'api'
       cacheTime?: number;     // время кэширования
     };
   }
   ```

### Примеры конфигурации:
```sql
-- Атрибут car_make_id использует внешнюю таблицу
UPDATE category_attributes 
SET data_source = 'database',
    data_source_config = '{
      "table": "car_makes",
      "valueField": "id",
      "labelField": "name",
      "sortField": "popularity_rs"
    }'
WHERE name = 'car_make_id';

-- Атрибут engine_type как вариативный
INSERT INTO product_variant_attributes (name, display_name, affects_stock)
VALUES ('engine_type', 'Engine Type', false);
```

## Технические детали

### Frontend компоненты
```
src/app/[locale]/admin/variant-attributes/
├── page.tsx                    # Основная страница
├── [id]/page.tsx              # Редактирование атрибута
├── components/
│   ├── VariantAttributeList.tsx
│   ├── VariantAttributeForm.tsx
│   ├── AttributeMappingEditor.tsx
│   └── CategorySelector.tsx
```

### Backend структура
```
backend/internal/proj/admin/
├── handler/
│   └── variant_attributes.go
├── service/
│   └── variant_attributes.go
└── repository/
    └── variant_attributes.go
```

## Метрики успеха

1. **Сокращение времени** настройки вариантов для новых категорий на 80%
2. **Уменьшение ошибок** связанных с несоответствием атрибутов на 95%
3. **Повышение гибкости** системы для добавления новых типов вариантов
4. **Улучшение UX** для менеджеров при управлении каталогом

## Риски и митигация

1. **Риск**: Нарушение обратной совместимости
   - **Митигация**: Поэтапная миграция с поддержкой старого формата

2. **Риск**: Сложность UI для неопытных пользователей
   - **Митигация**: Пошаговый wizard для начальной настройки

3. **Риск**: Производительность при большом количестве атрибутов
   - **Митигация**: Пагинация, кеширование, индексы в БД

## Следующие шаги

1. **Интеграция с системой переводов (ГОТОВО):**
   - ✅ Создана полноценная панель управления переводами
   - ✅ Реализованы API для Frontend и БД переводов
   - ✅ Добавлена поддержка версионирования
   - Следующий этап: синхронизация и AI-переводы

2. **Приоритет для автомобильного раздела:**
   - Создать миграцию для поля `data_source` в `category_attributes`
   - Настроить связь car_make_id/car_model_id с таблицами
   - Добавить вариативные атрибуты для автомобилей (engine_type, trim_level)

3. **Общая реализация:**
   - Расширить модель атрибутов полем `is_variant_compatible`
   - Создать UI для управления вариативными атрибутами
   - Интегрировать с существующей системой витрин

4. **Тестирование:**
   - Проверить работу с большим объемом данных (3,000+ моделей)
   - Валидация связей между атрибутами
   - Производительность при фильтрации