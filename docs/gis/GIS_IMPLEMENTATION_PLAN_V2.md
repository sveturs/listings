# üó∫Ô∏è –ü–ª–∞–Ω —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ GIS –º–æ–¥—É–ª—è v2.0 - –° —É—á–µ—Ç–æ–º –≤–∏—Ç—Ä–∏–Ω

**–í–µ—Ä—Å–∏—è**: 2.0  
**–î–∞—Ç–∞**: 2025-01-10  
**–ò–∑–º–µ–Ω–µ–Ω–∏—è**: –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –≤–∏—Ç—Ä–∏–Ω —Å –≥–∏–±–∫–∏–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º —Ç–æ–≤–∞—Ä–æ–≤

## üìã –û–≥–ª–∞–≤–ª–µ–Ω–∏–µ

1. [–û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è](#–æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ-—Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è)
2. [–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è](#–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ-–∏–∑–º–µ–Ω–µ–Ω–∏—è)
3. [–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö - –¥–æ–ø–æ–ª–Ω–µ–Ω–∏—è](#–±–∞–∑–∞-–¥–∞–Ω–Ω—ã—Ö-–¥–æ–ø–æ–ª–Ω–µ–Ω–∏—è)
4. [API - –Ω–æ–≤—ã–µ endpoints](#api-–Ω–æ–≤—ã–µ-endpoints)
5. [Frontend –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã](#frontend-–∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã)
6. [–ê–∫—Ç—É–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–ª–∞–Ω —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏](#–∞–∫—Ç—É–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π-–ø–ª–∞–Ω-—Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏)

---

## 1. –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è

### 1.1 –¢–∏–ø—ã –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –Ω–∞ –∫–∞—Ä—Ç–µ

1. **–û–±—ã—á–Ω—ã–µ –æ–±—ä—è–≤–ª–µ–Ω–∏—è** - —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –º–∞—Ä–∫–µ—Ä—ã —Å —Ç–æ—á–Ω–æ–π/—Ä–∞–∑–º—ã—Ç–æ–π –≥–µ–æ–ª–æ–∫–∞—Ü–∏–µ–π
2. **–í–∏—Ç—Ä–∏–Ω—ã** - —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ –º–∞—Ä–∫–µ—Ä—ã –ø–æ –∞–¥—Ä–µ—Å—É –º–∞–≥–∞–∑–∏–Ω–∞
3. **–¢–æ–≤–∞—Ä—ã –≤–∏—Ç—Ä–∏–Ω** - –º–æ–≥—É—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è:
   - –í–Ω—É—Ç—Ä–∏ –≤–∏—Ç—Ä–∏–Ω—ã (–Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ)
   - –ù–∞ –∫–∞—Ä—Ç–µ —Å —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ–π –≥–µ–æ–ª–æ–∫–∞—Ü–∏–µ–π (–Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç—å, –ø—Ä–æ–∫–∞—Ç)

### 1.2 –£—Ä–æ–≤–Ω–∏ –ø—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç–∏

- **exact** - —Ç–æ—á–Ω—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã
- **district** - —Ä–∞–∑–º—ã—Ç–∏–µ ~500–º (–ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è —Ä–∞–π–æ–Ω)
- **area** - —Ä–∞–∑–º—ã—Ç–∏–µ ~2–∫–º (–ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –æ–±–ª–∞—Å—Ç—å)

### 1.3 –ë–∏–∑–Ω–µ—Å-—Å—Ü–µ–Ω–∞—Ä–∏–∏

1. **–ú–∞–≥–∞–∑–∏–Ω** - –≤–∏—Ç—Ä–∏–Ω–∞ –≤ –æ–¥–Ω–æ–π —Ç–æ—á–∫–µ, —Ç–æ–≤–∞—Ä—ã –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ
2. **–ê–≥–µ–Ω—Ç—Å—Ç–≤–æ –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏** - –æ—Ñ–∏—Å + –æ–±—ä–µ–∫—Ç—ã –ø–æ –≥–æ—Ä–æ–¥—É
3. **–°–µ—Ä–≤–∏—Å –ø—Ä–æ–∫–∞—Ç–∞** - —Ç–æ—á–∫–∞ –≤—ã–¥–∞—á–∏ + –ª–æ–∫–∞—Ü–∏–∏ —Ç–æ–≤–∞—Ä–æ–≤
4. **–ß–∞—Å—Ç–Ω—ã–π –ø—Ä–æ–¥–∞–≤–µ—Ü** - —Ä–∞–∑–º—ã—Ç–∞—è –ª–æ–∫–∞—Ü–∏—è –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

---

## 2. –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è

### 2.1 –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö

```typescript
// –†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è –º–æ–¥–µ–ª—å –≤–∏—Ç—Ä–∏–Ω—ã
interface StorefrontGeoSettings {
  // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤–∏—Ç—Ä–∏–Ω—ã
  displayLocation: 'exact' | 'district' | 'area';
  showOnMap: boolean;
  
  // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ç–æ–≤–∞—Ä–æ–≤
  productsDisplay: {
    showOnMap: boolean;           // –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –ª–∏ —Ç–æ–≤–∞—Ä—ã –æ—Ç–¥–µ–ª—å–Ω–æ
    inheritLocation: boolean;      // –Ω–∞—Å–ª–µ–¥–æ–≤–∞—Ç—å –ª–æ–∫–∞—Ü–∏—é –≤–∏—Ç—Ä–∏–Ω—ã
    defaultPrivacy: 'exact' | 'district' | 'area';
    allowCustomLocation: boolean;  // —Ä–∞–∑—Ä–µ—à–∏—Ç—å —Ç–æ–≤–∞—Ä–∞–º —Å–≤–æ—é –ª–æ–∫–∞—Ü–∏—é
  };
  
  // –í–∏–∑—É–∞–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
  mapIcon?: string;               // –∫–∞—Å—Ç–æ–º–Ω–∞—è –∏–∫–æ–Ω–∫–∞
  showProductCount: boolean;
  showRating: boolean;
  showWorkingStatus: boolean;
}

// –†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è –º–æ–¥–µ–ª—å —Ç–æ–≤–∞—Ä–∞
interface ProductGeoData {
  location?: {
    lat: number;
    lng: number;
    privacy: 'exact' | 'district' | 'area';
    address?: string;
    customAddress?: string;  // "–†–∞–π–æ–Ω –ó–µ–º—É–Ω" –≤–º–µ—Å—Ç–æ —Ç–æ—á–Ω–æ–≥–æ –∞–¥—Ä–µ—Å–∞
  };
  inheritFromStorefront: boolean;
}
```

### 2.2 –°–µ—Ä–≤–∏—Å–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   Map Service   ‚îÇ     ‚îÇStorefront Service‚îÇ    ‚îÇ Privacy Service ‚îÇ
‚îÇ                 ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ                  ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ                 ‚îÇ
‚îÇ - Clustering    ‚îÇ     ‚îÇ - Settings       ‚îÇ     ‚îÇ - Blur coords   ‚îÇ
‚îÇ - Filtering     ‚îÇ     ‚îÇ - Product rules  ‚îÇ     ‚îÇ - Address mask  ‚îÇ
‚îÇ - Rendering     ‚îÇ     ‚îÇ - Display logic  ‚îÇ     ‚îÇ - Access control‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## 3. –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö - –¥–æ–ø–æ–ª–Ω–µ–Ω–∏—è

### 3.1 –ù–æ–≤—ã–µ —Ç–∞–±–ª–∏—Ü—ã

```sql
-- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤–∏—Ç—Ä–∏–Ω –Ω–∞ –∫–∞—Ä—Ç–µ
CREATE TABLE storefront_map_settings (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    storefront_id UUID NOT NULL REFERENCES storefronts(id) ON DELETE CASCADE,
    display_location VARCHAR(20) DEFAULT 'exact',
    show_on_map BOOLEAN DEFAULT true,
    products_show_on_map BOOLEAN DEFAULT false,
    products_inherit_location BOOLEAN DEFAULT true,
    products_default_privacy VARCHAR(20) DEFAULT 'district',
    products_allow_custom_location BOOLEAN DEFAULT false,
    map_icon VARCHAR(100),
    show_product_count BOOLEAN DEFAULT true,
    show_rating BOOLEAN DEFAULT true,
    show_working_status BOOLEAN DEFAULT true,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW(),
    UNIQUE(storefront_id)
);

-- –ì–µ–æ–¥–∞–Ω–Ω—ã–µ —Ç–æ–≤–∞—Ä–æ–≤ –≤–∏—Ç—Ä–∏–Ω
CREATE TABLE storefront_product_geo (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    product_id UUID NOT NULL REFERENCES storefront_products(id) ON DELETE CASCADE,
    storefront_id UUID NOT NULL REFERENCES storefronts(id),
    location GEOGRAPHY(POINT, 4326),
    location_privacy VARCHAR(20) DEFAULT 'district',
    custom_address TEXT,
    inherit_from_storefront BOOLEAN DEFAULT true,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW(),
    UNIQUE(product_id)
);

-- –ò–Ω–¥–µ–∫—Å—ã
CREATE INDEX idx_storefront_product_geo_location 
    ON storefront_product_geo USING GIST(location);
CREATE INDEX idx_storefront_product_geo_storefront 
    ON storefront_product_geo(storefront_id);

-- –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ listings_geo –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –ø—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç–∏
ALTER TABLE listings_geo 
    ADD COLUMN location_privacy VARCHAR(20) DEFAULT 'exact',
    ADD COLUMN blurred_location GEOGRAPHY(POINT, 4326),
    ADD COLUMN custom_address TEXT;

-- –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ä–∞–∑–º—ã—Ç–∏—è –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç
CREATE OR REPLACE FUNCTION blur_coordinates(
    p_location GEOGRAPHY,
    p_privacy VARCHAR
) RETURNS GEOGRAPHY AS $$
DECLARE
    lat FLOAT;
    lng FLOAT;
    radius FLOAT;
    angle FLOAT;
    distance FLOAT;
BEGIN
    IF p_privacy = 'exact' THEN
        RETURN p_location;
    END IF;
    
    lat := ST_Y(p_location::geometry);
    lng := ST_X(p_location::geometry);
    
    -- –†–∞–¥–∏—É—Å —Ä–∞–∑–º—ã—Ç–∏—è
    radius := CASE p_privacy
        WHEN 'district' THEN 0.005  -- ~500–º
        WHEN 'area' THEN 0.02       -- ~2–∫–º
        ELSE 0
    END;
    
    -- –°–ª—É—á–∞–π–Ω–æ–µ —Å–º–µ—â–µ–Ω–∏–µ
    angle := random() * 2 * PI();
    distance := random() * radius;
    
    lat := lat + distance * cos(angle);
    lng := lng + distance * sin(angle);
    
    RETURN ST_SetSRID(ST_MakePoint(lng, lat), 4326)::geography;
END;
$$ LANGUAGE plpgsql;

-- –¢—Ä–∏–≥–≥–µ—Ä –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Ä–∞–∑–º—ã—Ç–∏—è
CREATE OR REPLACE FUNCTION update_blurred_location()
RETURNS TRIGGER AS $$
BEGIN
    NEW.blurred_location := blur_coordinates(NEW.location, NEW.location_privacy);
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trg_blur_listing_location
    BEFORE INSERT OR UPDATE ON listings_geo
    FOR EACH ROW
    EXECUTE FUNCTION update_blurred_location();
```

### 3.2 –ü—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è –¥–ª—è –∫–∞—Ä—Ç—ã

```sql
-- –û–±—ä–µ–¥–∏–Ω–µ–Ω–Ω–æ–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –¥–ª—è –∫–∞—Ä—Ç—ã
CREATE OR REPLACE VIEW map_items AS
SELECT 
    'listing' as item_type,
    l.id,
    l.title,
    CASE 
        WHEN lg.location_privacy = 'exact' THEN lg.location
        ELSE lg.blurred_location
    END as display_location,
    lg.location_privacy,
    lg.custom_address,
    l.price,
    l.category_id,
    NULL::UUID as storefront_id,
    l.created_at
FROM marketplace_listings l
JOIN listings_geo lg ON l.id = lg.listing_id
WHERE l.is_active = true

UNION ALL

SELECT 
    'storefront' as item_type,
    s.id,
    s.name as title,
    CASE 
        WHEN sms.display_location = 'exact' THEN 
            ST_SetSRID(ST_MakePoint(s.longitude, s.latitude), 4326)::geography
        ELSE 
            blur_coordinates(
                ST_SetSRID(ST_MakePoint(s.longitude, s.latitude), 4326)::geography,
                sms.display_location
            )
    END as display_location,
    sms.display_location as location_privacy,
    s.address as custom_address,
    NULL::DECIMAL as price,
    NULL::INT as category_id,
    s.id as storefront_id,
    s.created_at
FROM storefronts s
LEFT JOIN storefront_map_settings sms ON s.id = sms.storefront_id
WHERE s.is_active = true 
    AND COALESCE(sms.show_on_map, true) = true

UNION ALL

SELECT 
    'storefront_product' as item_type,
    sp.id,
    sp.name as title,
    CASE 
        WHEN spg.inherit_from_storefront THEN
            CASE 
                WHEN sms.display_location = 'exact' THEN 
                    ST_SetSRID(ST_MakePoint(s.longitude, s.latitude), 4326)::geography
                ELSE 
                    blur_coordinates(
                        ST_SetSRID(ST_MakePoint(s.longitude, s.latitude), 4326)::geography,
                        sms.display_location
                    )
            END
        ELSE
            CASE 
                WHEN spg.location_privacy = 'exact' THEN spg.location
                ELSE blur_coordinates(spg.location, spg.location_privacy)
            END
    END as display_location,
    COALESCE(spg.location_privacy, sms.products_default_privacy) as location_privacy,
    spg.custom_address,
    sp.price,
    sp.category_id,
    sp.storefront_id,
    sp.created_at
FROM storefront_products sp
JOIN storefronts s ON sp.storefront_id = s.id
LEFT JOIN storefront_product_geo spg ON sp.id = spg.product_id
LEFT JOIN storefront_map_settings sms ON s.id = sms.storefront_id
WHERE sp.is_active = true 
    AND s.is_active = true
    AND COALESCE(sms.products_show_on_map, false) = true;
```

---

## 4. API - –Ω–æ–≤—ã–µ endpoints

### 4.1 –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–∞—Ä—Ç—ã –¥–ª—è –≤–∏—Ç—Ä–∏–Ω

```yaml
# –ü–æ–ª—É—á–∏—Ç—å/–æ–±–Ω–æ–≤–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤–∏—Ç—Ä–∏–Ω—ã
GET/PUT /api/v1/storefronts/{id}/map-settings:
  requestBody:
    schema:
      $ref: '#/components/schemas/StorefrontMapSettings'

# –ú–∞—Å—Å–æ–≤–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≥–µ–æ–¥–∞–Ω–Ω—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤
POST /api/v1/storefronts/{id}/products/geo:
  requestBody:
    schema:
      type: object
      properties:
        action:
          type: string
          enum: [set_inherit, set_privacy, update_locations]
        privacy:
          type: string
          enum: [exact, district, area]
        products:
          type: array
          items:
            type: object
            properties:
              product_id: string
              location: 
                lat: number
                lng: number
              custom_address: string

# –ü–æ–ª—É—á–∏—Ç—å —ç–ª–µ–º–µ–Ω—Ç—ã –¥–ª—è –∫–∞—Ä—Ç—ã —Å —É—á–µ—Ç–æ–º –ø—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç–∏
POST /api/v1/gis/map/items:
  requestBody:
    schema:
      type: object
      properties:
        bounds:
          $ref: '#/components/schemas/Bounds'
        types:
          type: array
          items:
            enum: [listings, storefronts, storefront_products]
        filters:
          type: object
          properties:
            categories: array
            price_range: object
            only_exact_location: boolean
            storefront_id: string
```

### 4.2 –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π –ø–æ–∏—Å–∫

```yaml
# –ü–æ–∏—Å–∫ —Å —É—á–µ—Ç–æ–º —Ç–∏–ø–æ–≤ —ç–ª–µ–º–µ–Ω—Ç–æ–≤
POST /api/v1/gis/search/unified:
  requestBody:
    schema:
      type: object
      properties:
        center:
          $ref: '#/components/schemas/Point'
        radius: integer
        types:
          type: array
          items:
            enum: [listings, storefronts, storefront_products]
        group_by_storefront: boolean
        include_blurred: boolean
```

---

## 5. Frontend –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

### 5.1 –ö–æ–º–ø–æ–Ω–µ–Ω—Ç –Ω–∞—Å—Ç—Ä–æ–µ–∫ –∫–∞—Ä—Ç—ã –¥–ª—è –≤–∏—Ç—Ä–∏–Ω—ã

```typescript
// src/components/storefronts/settings/MapSettings.tsx
import { useState } from 'react';
import { Switch, RadioGroup, Alert } from '@/components/ui';

interface MapSettingsProps {
  storefront: Storefront;
  onSave: (settings: StorefrontMapSettings) => void;
}

export const MapSettings: React.FC<MapSettingsProps> = ({ 
  storefront, 
  onSave 
}) => {
  const [settings, setSettings] = useState<StorefrontMapSettings>(
    storefront.mapSettings || defaultSettings
  );

  return (
    <div className="space-y-6">
      <div className="bg-white p-6 rounded-lg shadow">
        <h3 className="text-lg font-semibold mb-4">
          –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤–∏—Ç—Ä–∏–Ω—ã –Ω–∞ –∫–∞—Ä—Ç–µ
        </h3>
        
        <div className="space-y-4">
          <Switch
            label="–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –≤–∏—Ç—Ä–∏–Ω—É –Ω–∞ –∫–∞—Ä—Ç–µ"
            checked={settings.showOnMap}
            onChange={(showOnMap) => setSettings({...settings, showOnMap})}
          />
          
          {settings.showOnMap && (
            <RadioGroup
              label="–¢–æ—á–Ω–æ—Å—Ç—å –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∞–¥—Ä–µ—Å–∞"
              value={settings.displayLocation}
              onChange={(displayLocation) => 
                setSettings({...settings, displayLocation})
              }
              options={[
                { value: 'exact', label: '–¢–æ—á–Ω—ã–π –∞–¥—Ä–µ—Å' },
                { value: 'district', label: '–¢–æ–ª—å–∫–æ —Ä–∞–π–æ–Ω (~500–º)' },
                { value: 'area', label: '–û–±–ª–∞—Å—Ç—å –≥–æ—Ä–æ–¥–∞ (~2–∫–º)' }
              ]}
            />
          )}
        </div>
      </div>

      <div className="bg-white p-6 rounded-lg shadow">
        <h3 className="text-lg font-semibold mb-4">
          –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–æ–≤ –Ω–∞ –∫–∞—Ä—Ç–µ
        </h3>
        
        <Alert type="info" className="mb-4">
          –ü–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è –∞–≥–µ–Ω—Ç—Å—Ç–≤ –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏, –ø—Ä–æ–∫–∞—Ç–æ–≤ –∏ —Å–µ—Ä–≤–∏—Å–æ–≤ 
          —Å —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–º–∏ —Ç–æ–≤–∞—Ä–∞–º–∏
        </Alert>
        
        <div className="space-y-4">
          <Switch
            label="–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å —Ç–æ–≤–∞—Ä—ã –æ—Ç–¥–µ–ª—å–Ω–æ –Ω–∞ –∫–∞—Ä—Ç–µ"
            checked={settings.productsDisplay.showOnMap}
            onChange={(showOnMap) => 
              setSettings({
                ...settings, 
                productsDisplay: {...settings.productsDisplay, showOnMap}
              })
            }
          />
          
          {settings.productsDisplay.showOnMap && (
            <>
              <Switch
                label="–†–∞–∑—Ä–µ—à–∏—Ç—å —Ç–æ–≤–∞—Ä–∞–º —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—É—é –ª–æ–∫–∞—Ü–∏—é"
                checked={settings.productsDisplay.allowCustomLocation}
                help="–ï—Å–ª–∏ –≤—ã–∫–ª—é—á–µ–Ω–æ, –≤—Å–µ —Ç–æ–≤–∞—Ä—ã –±—É–¥—É—Ç –ø–æ–∫–∞–∑–∞–Ω—ã –ø–æ –∞–¥—Ä–µ—Å—É –≤–∏—Ç—Ä–∏–Ω—ã"
              />
              
              <RadioGroup
                label="–ü—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç—å –ª–æ–∫–∞—Ü–∏–∏ —Ç–æ–≤–∞—Ä–æ–≤ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é"
                value={settings.productsDisplay.defaultPrivacy}
                options={[
                  { value: 'exact', label: '–¢–æ—á–Ω—ã–π –∞–¥—Ä–µ—Å' },
                  { value: 'district', label: '–†–∞–π–æ–Ω' },
                  { value: 'area', label: '–û–±–ª–∞—Å—Ç—å' }
                ]}
              />
            </>
          )}
        </div>
      </div>

      <div className="bg-white p-6 rounded-lg shadow">
        <h3 className="text-lg font-semibold mb-4">
          –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
        </h3>
        
        <div className="space-y-3">
          <Switch
            label="–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–≤–∞—Ä–æ–≤"
            checked={settings.showProductCount}
          />
          <Switch
            label="–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å —Ä–µ–π—Ç–∏–Ω–≥"
            checked={settings.showRating}
          />
          <Switch
            label="–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å —Å—Ç–∞—Ç—É—Å —Ä–∞–±–æ—Ç—ã (–æ—Ç–∫—Ä—ã—Ç–æ/–∑–∞–∫—Ä—ã—Ç–æ)"
            checked={settings.showWorkingStatus}
          />
        </div>
      </div>

      <button
        onClick={() => onSave(settings)}
        className="w-full btn btn-primary"
      >
        –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
      </button>
    </div>
  );
};
```

### 5.2 –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –∫–∞—Ä—Ç—ã

```typescript
// src/components/GIS/Map/UnifiedMap.tsx
import { useEffect, useState } from 'react';
import mapboxgl from 'mapbox-gl';
import { useMapItems } from '@/hooks/gis/useMapItems';

interface UnifiedMapProps {
  types?: ('listings' | 'storefronts' | 'storefront_products')[];
  onItemClick?: (item: MapItem) => void;
}

export const UnifiedMap: React.FC<UnifiedMapProps> = ({
  types = ['listings', 'storefronts', 'storefront_products'],
  onItemClick
}) => {
  const { items, isLoading } = useMapItems({ types });
  
  // –†–∞–∑–ª–∏—á–Ω—ã–µ —Å—Ç–∏–ª–∏ –º–∞—Ä–∫–µ—Ä–æ–≤
  const createMarker = (item: MapItem) => {
    const el = document.createElement('div');
    
    switch (item.type) {
      case 'storefront':
        el.className = 'marker-storefront';
        el.innerHTML = `
          <div class="storefront-marker">
            ${item.logo ? `<img src="${item.logo}" />` : 'üè™'}
            <span class="count">${item.productCount || 0}</span>
          </div>
        `;
        break;
        
      case 'storefront_product':
        el.className = 'marker-product';
        // –†–∞–∑–º—ã—Ç–∞—è –ª–æ–∫–∞—Ü–∏—è - –ø–æ–ª—É–ø—Ä–æ–∑—Ä–∞—á–Ω—ã–π –∫—Ä—É–≥
        if (item.locationPrivacy !== 'exact') {
          el.classList.add('blurred');
          el.style.opacity = '0.7';
        }
        break;
        
      case 'listing':
        el.className = 'marker-listing';
        if (item.locationPrivacy !== 'exact') {
          el.classList.add('blurred');
        }
        break;
    }
    
    return new mapboxgl.Marker(el)
      .setLngLat([item.location.lng, item.location.lat]);
  };
  
  // –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤ –ø–æ –≤–∏—Ç—Ä–∏–Ω–∞–º –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
  const groupItemsByStorefront = (items: MapItem[]) => {
    const groups = new Map<string, MapItem[]>();
    
    items.forEach(item => {
      if (item.storefrontId) {
        const group = groups.get(item.storefrontId) || [];
        group.push(item);
        groups.set(item.storefrontId, group);
      }
    });
    
    return groups;
  };
  
  // ... –æ—Å—Ç–∞–ª—å–Ω–∞—è –ª–æ–≥–∏–∫–∞ –∫–∞—Ä—Ç—ã
};
```

---

## 6. –ê–∫—Ç—É–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–ª–∞–Ω —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

### –§–∞–∑–∞ 1: –ë–∞–∑–æ–≤–∞—è –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ (2 –Ω–µ–¥–µ–ª–∏)

**–ù–µ–¥–µ–ª—è 1: –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –∏ API**
- [ ] –°–æ–∑–¥–∞—Ç—å —Ç–∞–±–ª–∏—Ü—ã –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–µ–∫ –≤–∏—Ç—Ä–∏–Ω –∏ –≥–µ–æ–¥–∞–Ω–Ω—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏–∏ —Ä–∞–∑–º—ã—Ç–∏—è –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç
- [ ] –°–æ–∑–¥–∞—Ç—å –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ map_items
- [ ] –ë–∞–∑–æ–≤—ã–µ API endpoints –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–µ–∫

**–ù–µ–¥–µ–ª—è 2: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π —Å–∏—Å—Ç–µ–º–æ–π**
- [ ] –û–±–Ω–æ–≤–∏—Ç—å –º–æ–¥–µ–ª–∏ –¥–∞–Ω–Ω—ã—Ö –≤ Go
- [ ] –†–∞—Å—à–∏—Ä–∏—Ç—å OpenSearch –º–∞–ø–ø–∏–Ω–≥–∏
- [ ] –î–æ–±–∞–≤–∏—Ç—å –ø–æ–¥–¥–µ—Ä–∂–∫—É –ø—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç–∏ –≤ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ endpoints
- [ ] –ù–∞–ø–∏—Å–∞—Ç—å —Ç–µ—Å—Ç—ã

### –§–∞–∑–∞ 2: Frontend –±–∞–∑–æ–≤—ã–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª (2 –Ω–µ–¥–µ–ª–∏)

**–ù–µ–¥–µ–ª—è 3: –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –Ω–∞—Å—Ç—Ä–æ–µ–∫**
- [ ] UI –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–µ–∫ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤–∏—Ç—Ä–∏–Ω—ã
- [ ] –§–æ—Ä–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≥–µ–æ–¥–∞–Ω–Ω—ã–º–∏ —Ç–æ–≤–∞—Ä–æ–≤
- [ ] –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å API

**–ù–µ–¥–µ–ª—è 4: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞—Ä—Ç—ã**
- [ ] –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤ –º–∞—Ä–∫–µ—Ä–æ–≤
- [ ] –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è —Ä–∞–∑–º—ã—Ç—ã—Ö –ª–æ–∫–∞—Ü–∏–π
- [ ] –§–∏–ª—å—Ç—Ä—ã –ø–æ —Ç–∏–ø–∞–º —ç–ª–µ–º–µ–Ω—Ç–æ–≤

### –§–∞–∑–∞ 3: –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª (3 –Ω–µ–¥–µ–ª–∏)

**–ù–µ–¥–µ–ª—è 5: –£–º–Ω–∞—è –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞**
- [ ] –ö–ª–∞—Å—Ç–µ—Ä–∏–∑–∞—Ü–∏—è —Å —É—á–µ—Ç–æ–º –≤–∏—Ç—Ä–∏–Ω
- [ ] –°–≤—è–∑—ã–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–æ–≤ —Å –≤–∏—Ç—Ä–∏–Ω–∞–º–∏ –≤–∏–∑—É–∞–ª—å–Ω–æ
- [ ] –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è

**–ù–µ–¥–µ–ª—è 6: –ü–æ–∏—Å–∫ –∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è**
- [ ] –£–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–æ–∏—Å–∫ –ø–æ –≤—Å–µ–º —Ç–∏–ø–∞–º
- [ ] –§–∏–ª—å—Ç—Ä—ã —Å —É—á–µ—Ç–æ–º –ø—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç–∏
- [ ] –ü–æ–∏—Å–∫ "—Ç–æ–ª—å–∫–æ —Å —Ç–æ—á–Ω—ã–º –∞–¥—Ä–µ—Å–æ–º"

**–ù–µ–¥–µ–ª—è 7: –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –∏ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è**
- [ ] –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –∫–∞—Ä—Ç—ã
- [ ] A/B —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞–∑–Ω—ã—Ö —Ä–µ–∂–∏–º–æ–≤
- [ ] –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

### –§–∞–∑–∞ 4: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –¥–æ—Å—Ç–∞–≤–∫–æ–π (2 –Ω–µ–¥–µ–ª–∏)

**–ù–µ–¥–µ–ª—è 8: –ó–æ–Ω—ã –¥–æ—Å—Ç–∞–≤–∫–∏ –¥–ª—è –≤–∏—Ç—Ä–∏–Ω**
- [ ] –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∑–æ–Ω —Å —É—á–µ—Ç–æ–º —Ç–∏–ø–∞ –≤–∏—Ç—Ä–∏–Ω—ã
- [ ] –†–∞—Å—á–µ—Ç –¥–æ—Å—Ç–∞–≤–∫–∏ –¥–ª—è —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤

**–ù–µ–¥–µ–ª—è 9: –§–∏–Ω–∞–ª–∏–∑–∞—Ü–∏—è**
- [ ] –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –¥–ª—è –ø—Ä–æ–¥–∞–≤—Ü–æ–≤
- [ ] –û–±—É—á–∞—é—â–∏–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã
- [ ] –ó–∞–ø—É—Å–∫ –≤ –ø—Ä–æ–¥–∞–∫—à–Ω

---

## üìä –ú–µ—Ç—Ä–∏–∫–∏ —É—Å–ø–µ—Ö–∞

### –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ
- –í—Ä–µ–º—è –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞—Ä—Ç—ã < 2 —Å–µ–∫
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ 10k+ –º–∞—Ä–∫–µ—Ä–æ–≤
- –¢–æ—á–Ω–æ—Å—Ç—å –≥–µ–æ–ø–æ–∏—Å–∫–∞ > 95%

### –ü—Ä–æ–¥—É–∫—Ç–æ–≤—ã–µ  
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∫–∞—Ä—Ç—ã –≤–∏—Ç—Ä–∏–Ω–∞–º–∏ > 60%
- –ö–æ–Ω–≤–µ—Ä—Å–∏—è –∏–∑ –∫–∞—Ä—Ç—ã +25%
- –£–¥–æ–≤–ª–µ—Ç–≤–æ—Ä–µ–Ω–Ω–æ—Å—Ç—å –ø—Ä–æ–¥–∞–≤—Ü–æ–≤ > 4.5/5

### –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å
- 0 —É—Ç–µ—á–µ–∫ —Ç–æ—á–Ω—ã—Ö –∞–¥—Ä–µ—Å–æ–≤ –ø—Ä–∏ —Ä–∞–∑–º—ã—Ç–∏–∏
- 100% —Å–æ–±–ª—é–¥–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –ø—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç–∏

---

**–ü–ª–∞–Ω –≥–æ—Ç–æ–≤ –∫ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏!** 

–û—Å–Ω–æ–≤–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è:
1. –ì–∏–±–∫–∞—è —Å–∏—Å—Ç–µ–º–∞ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤ –±–∏–∑–Ω–µ—Å–∞
2. –¢—Ä–µ—Ö—É—Ä–æ–≤–Ω–µ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞ –ø—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç–∏
3. –†–∞–∑–¥–µ–ª—å–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤–∏—Ç—Ä–∏–Ω–∞–º–∏ –∏ –∏—Ö —Ç–æ–≤–∞—Ä–∞–º–∏
4. –í–∏–∑—É–∞–ª—å–Ω–æ–µ —Ä–∞–∑–ª–∏—á–∏–µ —Ç–æ—á–Ω—ã—Ö –∏ —Ä–∞–∑–º—ã—Ç—ã—Ö –ª–æ–∫–∞—Ü–∏–π