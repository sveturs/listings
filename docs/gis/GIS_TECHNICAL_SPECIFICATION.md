# Техническое задание: GIS модуль для маркетплейса Sve Tu

## 1. Анализ текущего состояния

### 1.1 Существующая геолокационная инфраструктура

**База данных (PostgreSQL):**
- Таблица `marketplace_listings` содержит:
  - `latitude DECIMAL(10,8)` - широта
  - `longitude DECIMAL(11,8)` - долгота
  - `location VARCHAR(255)` - текстовое описание местоположения
  - `address_city VARCHAR(100)` - город
  - `address_country VARCHAR(100)` - страна
  - `show_on_map BOOLEAN NOT NULL DEFAULT true` - флаг отображения на карте

- Таблица `user_storefronts` содержит:
  - `latitude DECIMAL(10,8)` - широта витрины
  - `longitude DECIMAL(11,8)` - долгота витрины
  - `address VARCHAR(255)` - адрес
  - `city VARCHAR(100)` - город
  - `country VARCHAR(100)` - страна

- Таблица `users` содержит:
  - `city VARCHAR(100)` - город пользователя
  - `country VARCHAR(100)` - страна пользователя

**Frontend (React/TypeScript):**
- Контекст `CreateListingContext` поддерживает координаты
- Компоненты готовы для работы с latitude/longitude
- Есть обработка геоданных в формах создания объявлений

### 1.2 Недостающие компоненты

1. **Картографический интерфейс** - отсутствует компонент карты
2. **Геокодирование** - нет преобразования адресов в координаты
3. **Пространственный поиск** - нет поиска по расстоянию
4. **Кластеризация** - нет группировки близких объектов
5. **Геоаналитика** - нет анализа географических данных

## 2. Потребности Сербии в GIS для маркетплейса

### 2.1 Географические особенности Сербии

**Административное деление:**
- 145 муниципалитетов (општине)
- 24 города (градови)
- 2 автономные области (Воеводина и Косово)
- Разнообразная топография: равнины, горы, речные долины

**Транспортная инфраструктура:**
- Центральное положение Белграда как транспортного узла
- Речная логистика (Дунай, Сава, Тиса)
- Автодорожная сеть А-класса
- Железнодорожные коридоры X и VII

### 2.2 Социально-экономические факторы

**Распределение населения:**
- Белград: ~1.7 млн чел. (агломерация)
- Нови Сад: ~380 тыс. чел.
- Ниш: ~260 тыс. чел.
- Выраженная урбанизация севера и центра

**Экономические зоны:**
- Индустриальные парки Воеводины
- Туристические регионы (Златибор, Копаоник, Върњачка Бања)
- Приграничная торговля (Хорватия, Босния, Румыния)

### 2.3 Как GIS улучшит жизнь в Сербии

**Для покупателей:**
- Поиск товаров рядом с домом/работой
- Оптимизация маршрутов для покупок
- Информация о доступности общественного транспорта
- Сравнение цен по регионам

**Для продавцов:**
- Анализ локального спроса
- Оптимизация зон доставки
- Учет сезонных миграций (дачи, курорты)
- Координация с местными службами

**Для экономики:**
- Развитие региональных рынков
- Поддержка малого бизнеса в провинции
- Туристическая интеграция
- Логистическая оптимизация

## 3. Техническое задание на GIS модуль

### 3.1 Цели и задачи

**Основная цель:**
Создать интегрированный GIS модуль для маркетплейса Sve Tu, который улучшит пользовательский опыт, оптимизирует бизнес-процессы и будет учитывать специфику Сербии.

**Задачи:**
1. Реализовать интерактивную карту с объявлениями
2. Добавить пространственный поиск и фильтрацию
3. Интегрировать геокодирование и автокомплит адресов
4. Создать аналитические инструменты для продавцов
5. Оптимизировать логистические процессы

### 3.2 Функциональные требования

#### 3.2.1 Картографический интерфейс

**Основная карта:**
- Интерактивная карта на базе Leaflet или Google Maps
- Поддержка OpenStreetMap для Сербии
- Кластеризация объявлений при увеличении
- Фильтрация по категориям, цене, состоянию товара
- Информационные попапы с превью объявлений

**Специализированные карты:**
- Карта витрин (storefronts)
- Тепловые карты популярности товаров
- Карты плотности предложения по категориям
- Логистические карты (зоны доставки)

#### 3.2.2 Пространственный поиск

**Поиск по расстоянию:**
- Радиус поиска: 1, 5, 10, 25, 50 км
- Автоматическое определение местоположения пользователя
- Поиск вдоль маршрута (например, по дороге на работу)
- Поиск в административных границах (муниципалитет, регион)

**Геофильтры:**
- Поиск только в своем городе
- Поиск с учетом транспортной доступности
- Исключение определенных районов
- Приоритет местных продавцов

#### 3.2.3 Геокодирование и адреса

**Адресная система:**
- Интеграция с OpenStreetMap Nominatim
- Поддержка кириллических и латинских названий
- Автокомплит адресов при создании объявлений
- Валидация координат и адресов

**Административные единицы:**
- База данных муниципалитетов Сербии
- Справочник районов городов
- Интеграция с почтовыми индексами
- Поддержка местных названий (народные названия районов)

#### 3.2.4 Аналитика и отчеты

**Для продавцов:**
- Анализ спроса в радиусе расположения
- Карты конкуренции по категориям
- Оптимальные зоны для размещения объявлений
- Сезонные тренды по регионам

**Для администрации:**
- Географическое распределение пользователей
- Популярные торговые зоны
- Эффективность доставки по регионам
- Аналитика поведения пользователей

### 3.3 Технические требования

#### 3.3.1 Backend архитектура

**Новый модуль: internal/proj/gis/**
```
internal/proj/gis/
├── handler/
│   ├── map.go              # Обработчики карт
│   ├── geocoding.go        # Геокодирование
│   └── analytics.go        # Геоаналитика
├── service/
│   ├── spatial_search.go   # Пространственный поиск
│   ├── geocoding.go        # Сервис геокодирования
│   └── analytics.go        # Аналитические сервисы
├── repository/
│   ├── postgres/
│   │   ├── spatial.go      # Пространственные запросы
│   │   └── geocoding.go    # Кэш геокодирования
│   └── cache/
│       └── redis.go        # Кэш координат
└── types/
    ├── coordinates.go      # Типы координат
    ├── boundaries.go       # Административные границы
    └── spatial.go          # Пространственные типы
```

**Расширения базы данных:**
```sql
-- Добавить PostGIS расширение
CREATE EXTENSION IF NOT EXISTS postgis;

-- Новые таблицы
CREATE TABLE administrative_boundaries (
    id SERIAL PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    name_cyrillic VARCHAR(100),
    type VARCHAR(50), -- municipality, district, region
    parent_id INT REFERENCES administrative_boundaries(id),
    boundary GEOMETRY(POLYGON, 4326),
    center_point GEOMETRY(POINT, 4326),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE geocoding_cache (
    id SERIAL PRIMARY KEY,
    address_hash VARCHAR(64) UNIQUE,
    original_address TEXT,
    latitude DECIMAL(10,8),
    longitude DECIMAL(11,8),
    formatted_address TEXT,
    confidence_score FLOAT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Добавить пространственные индексы
CREATE INDEX idx_listings_location ON marketplace_listings USING GIST(ST_Point(longitude, latitude));
CREATE INDEX idx_storefronts_location ON user_storefronts USING GIST(ST_Point(longitude, latitude));
```

#### 3.3.2 Frontend компоненты

**Новые компоненты:**
```typescript
// src/components/GIS/
├── Map/
│   ├── InteractiveMap.tsx      # Основная карта
│   ├── ListingMap.tsx          # Карта для объявлений
│   ├── ClusterMarker.tsx       # Кластеризация
│   └── MapFilters.tsx          # Фильтры карты
├── Search/
│   ├── SpatialSearch.tsx       # Пространственный поиск
│   ├── AddressAutocomplete.tsx # Автокомплит адресов
│   └── RadiusSelector.tsx      # Выбор радиуса поиска
├── Analytics/
│   ├── HeatMap.tsx             # Тепловая карта
│   ├── DensityMap.tsx          # Карта плотности
│   └── GeoDashboard.tsx        # Гео-дашборд
└── Forms/
    ├── LocationPicker.tsx      # Выбор местоположения
    └── AddressForm.tsx         # Форма адреса
```

**Новые хуки:**
```typescript
// src/hooks/
├── useGeolocation.ts          # Геолокация пользователя
├── useGeocode.ts              # Геокодирование
├── useSpatialSearch.ts        # Пространственный поиск
└── useMapAnalytics.ts         # Карточная аналитика
```

#### 3.3.3 Интеграции

**Картографические сервисы:**
- OpenStreetMap (основная карта)
- Mapbox GL JS (продвинутая визуализация)
- Nominatim (геокодирование)
- Резервный: Google Maps API

**Геоданные Сербии:**
- OpenStreetMap данные Сербии
- Административные границы (GeoJSON)
- Данные общественного транспорта
- Почтовые индексы

### 3.4 Пользовательские сценарии

#### 3.4.1 Поиск товаров по карте

1. Пользователь открывает карту
2. Указывает желаемый радиус поиска (или используется геолокация)
3. Выбирает категории товаров
4. Просматривает кластеры объявлений
5. Кликает на маркер и видит детали
6. Переходит к просмотру объявления

#### 3.4.2 Создание объявления с геолокацией

1. Продавец создает объявление
2. Указывает адрес или отмечает место на карте
3. Система автоматически геокодирует адрес
4. Продавец подтверждает координаты
5. Система предлагает оптимальную зону доставки
6. Объявление публикуется с геоданными

#### 3.4.3 Анализ рынка для продавца

1. Продавец открывает аналитический дашборд
2. Выбирает свою категорию товаров
3. Просматривает тепловую карту спроса
4. Анализирует конкуренцию в радиусе
5. Получает рекомендации по ценообразованию
6. Корректирует стратегию продаж

### 3.5 Этапы реализации

#### Этап 1: Основная инфраструктура (2 недели)
- Настройка PostGIS
- Создание базовых таблиц
- Базовый GIS модуль в backend
- Простейший компонент карты

#### Этап 2: Интерактивная карта (2 недели)
- Полнофункциональная карта объявлений
- Кластеризация маркеров
- Базовые фильтры
- Попапы с информацией

#### Этап 3: Пространственный поиск (1 неделя)
- Поиск по радиусу
- Геолокация пользователя
- Фильтрация по расстоянию
- Интеграция с основным поиском

#### Этап 4: Геокодирование (1 неделя)
- Автокомплит адресов
- Валидация координат
- Кэширование результатов
- Обработка ошибок

#### Этап 5: Аналитика (1 неделя)
- Тепловые карты
- Геоаналитика для продавцов
- Административные отчеты
- Дашборды

#### Этап 6: Оптимизация (1 неделя)
- Производительность запросов
- Кэширование данных
- Мобильная адаптация
- Тестирование

### 3.6 Метрики успеха

**Пользовательские метрики:**
- Увеличение конверсии поиска на 15%
- Повышение времени на сайте на 25%
- Увеличение количества локальных сделок на 30%
- Улучшение рейтинга удовлетворенности на 0.5 балла

**Бизнес-метрики:**
- Рост количества объявлений с координатами до 90%
- Увеличение активности в регионах на 40%
- Снижение затрат на логистику на 20%
- Рост доходов от региональных продавцов на 35%

**Технические метрики:**
- Время отклика карты < 2 секунд
- Точность геокодирования > 95%
- Доступность сервиса > 99.5%
- Кэш-хит для геозапросов > 80%

### 3.7 Риски и митигация

**Технические риски:**
- Сложность PostGIS → Начать с простых решений
- Производительность → Использовать индексы и кэширование
- Мобильная производительность → Ленивая загрузка

**Пользовательские риски:**
- Сложность интерфейса → Итеративный дизайн с тестированием
- Приватность локации → Опциональная геолокация
- Медленная адаптация → Обучающие материалы

**Бизнес-риски:**
- Высокая стоимость картографических API → Использовать открытые решения
- Правовые ограничения → Соблюдение GDPR и местного законодательства
- Конкуренция → Фокус на локальные особенности

### 3.8 Заключение

Реализация GIS модуля для маркетплейса Sve Tu:
- Значительно улучшит пользовательский опыт
- Оптимизирует бизнес-процессы
- Учтет специфику сербского рынка
- Создаст конкурентное преимущество
- Поддержит развитие регональных рынков

Проект технически реализуем в течение 8 недель с использованием современных технологий и открытых стандартов.