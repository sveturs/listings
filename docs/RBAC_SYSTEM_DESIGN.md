# Система управления ролями и правами доступа (RBAC) для Sve Tu Marketplace

## Текущее состояние

### База данных
- ✅ Таблицы `roles`, `permissions`, `role_permissions`, `user_roles` уже созданы
- ✅ Базовые роли добавлены: super_admin, admin, moderator, vendor, user
- ✅ 29 permissions уже определены
- ❌ Связи между пользователями и ролями не настроены
- ❌ Backend API не использует роли
- ❌ Frontend не отображает роли

## Архитектура системы ролей

### Иерархия ролей для C2C/B2C маркетплейса

#### 1. Системные роли (System Roles)

##### Super Admin (super_admin)
- Полный доступ ко всем функциям системы
- Управление системными настройками
- Доступ к логам и мониторингу
- Управление всеми ролями и правами
- Техническое обслуживание

##### Admin (admin)
- Управление пользователями
- Управление категориями и атрибутами
- Настройка маркетплейса
- Просмотр финансовой статистики
- Управление контентом

#### 2. Модерационные роли (Moderation Roles)

##### Content Moderator (content_moderator)
- Модерация объявлений и товаров
- Проверка изображений и описаний
- Блокировка нарушающего контент
- Управление категориями товаров

##### Review Moderator (review_moderator)
- Модерация отзывов и рейтингов
- Удаление спама и оскорблений
- Разрешение споров по отзывам

##### Chat Moderator (chat_moderator)
- Мониторинг чатов между пользователями
- Блокировка спама и мошенников
- Разрешение конфликтов в чатах

##### Dispute Manager (dispute_manager)
- Разбор споров между покупателями и продавцами
- Принятие решений по возвратам
- Медиация конфликтов
- Работа с жалобами

#### 3. Бизнес роли (Business Roles)

##### Vendor Manager (vendor_manager)
- Управление витринами продавцов
- Проверка документов компаний
- Настройка комиссий и тарифов
- Поддержка корпоративных клиентов

##### Category Manager (category_manager)
- Управление деревом категорий
- Настройка атрибутов категорий
- SEO оптимизация категорий
- Анализ популярности категорий

##### Marketing Manager (marketing_manager)
- Управление акциями и скидками
- Настройка баннеров и рекламы
- Email рассылки
- Управление промо-кодами

##### Financial Manager (financial_manager)
- Просмотр финансовых транзакций
- Управление выплатами продавцам
- Финансовая отчетность
- Контроль комиссий

#### 4. Операционные роли (Operational Roles)

##### Warehouse Manager (warehouse_manager)
- Управление складскими остатками
- Приемка и отгрузка товаров
- Инвентаризация
- Управление складскими зонами

##### Warehouse Worker (warehouse_worker)
- Сборка заказов
- Упаковка товаров
- Перемещение товаров
- Сканирование штрих-кодов

##### Pickup Point Manager (pickup_manager)
- Управление пунктом выдачи
- Прием и выдача заказов
- Работа с возвратами
- Отчетность по пункту

##### Pickup Point Worker (pickup_worker)
- Выдача заказов клиентам
- Проверка документов
- Прием возвратов
- Консультация клиентов

##### Courier (courier)
- Доставка заказов
- Обновление статусов доставки
- Прием оплаты (если COD)
- Возврат товаров на склад

#### 5. Поддержка и юридические роли (Support & Legal Roles)

##### Customer Support L1 (support_l1)
- Ответы на базовые вопросы
- Помощь с навигацией
- Создание тикетов для L2
- Работа с FAQ

##### Customer Support L2 (support_l2)
- Решение сложных вопросов
- Работа с возвратами и обменами
- Эскалация на L3
- Работа с жалобами

##### Customer Support L3 (support_l3)
- Экспертная поддержка
- Работа с VIP клиентами
- Решение критических проблем
- Взаимодействие с разработкой

##### Legal Advisor (legal_advisor)
- Проверка юридических документов
- Разрешение правовых споров
- Работа с договорами
- Compliance контроль

##### Compliance Officer (compliance_officer)
- Контроль соответствия законодательству
- AML/KYC проверки
- Работа с регуляторами
- Аудит процессов

#### 6. Продавцы (Seller Roles)

##### Professional Vendor (professional_vendor)
- Управление витриной
- Массовая загрузка товаров
- Доступ к аналитике продаж
- API интеграции
- Управление персоналом витрины

##### Individual Seller (individual_seller)
- Создание объявлений
- Управление своими товарами
- Чат с покупателями
- Базовая статистика

##### Storefront Staff (storefront_staff)
- Управление товарами витрины
- Обработка заказов
- Ответы на вопросы
- Ограниченный доступ к настройкам

#### 7. Покупатели (Buyer Roles)

##### Verified Buyer (verified_buyer)
- Покупка товаров
- Оставление отзывов
- Участие в программе лояльности
- Приоритетная поддержка

##### Basic User (user)
- Просмотр товаров
- Добавление в избранное
- Базовые покупки
- Ограниченные возможности

##### VIP Customer (vip_customer)
- Эксклюзивные предложения
- Персональный менеджер
- Приоритетная доставка
- Расширенные гарантии

#### 8. Аналитические роли (Analytics Roles)

##### Data Analyst (data_analyst)
- Доступ к аналитическим дашбордам
- Экспорт данных
- Создание отчетов
- Анализ метрик

##### Business Analyst (business_analyst)
- Анализ бизнес-процессов
- Оптимизация воронок
- A/B тестирование
- Рекомендации по улучшению

## Система прав доступа (Permissions)

### Структура прав
Каждое право имеет формат: `resource:action`

### Основные категории прав:

#### Управление пользователями
- `users:view` - просмотр списка пользователей
- `users:create` - создание пользователей
- `users:edit` - редактирование пользователей
- `users:delete` - удаление пользователей
- `users:block` - блокировка пользователей
- `users:assign_role` - назначение ролей

#### Управление товарами/объявлениями
- `listings:view_all` - просмотр всех объявлений
- `listings:view_own` - просмотр своих объявлений
- `listings:create` - создание объявлений
- `listings:edit_all` - редактирование любых объявлений
- `listings:edit_own` - редактирование своих объявлений
- `listings:delete_all` - удаление любых объявлений
- `listings:delete_own` - удаление своих объявлений
- `listings:moderate` - модерация объявлений
- `listings:feature` - выделение объявлений

#### Управление витринами
- `storefronts:view_all` - просмотр всех витрин
- `storefronts:view_own` - просмотр своей витрины
- `storefronts:create` - создание витрины
- `storefronts:edit_all` - редактирование любой витрины
- `storefronts:edit_own` - редактирование своей витрины
- `storefronts:delete_all` - удаление любой витрины
- `storefronts:delete_own` - удаление своей витрины
- `storefronts:verify` - верификация витрин
- `storefronts:manage_staff` - управление персоналом витрины

#### Управление заказами
- `orders:view_all` - просмотр всех заказов
- `orders:view_own` - просмотр своих заказов
- `orders:process` - обработка заказов
- `orders:cancel` - отмена заказов
- `orders:refund` - возврат средств

#### Управление отзывами
- `reviews:view_all` - просмотр всех отзывов
- `reviews:create` - создание отзывов
- `reviews:moderate` - модерация отзывов
- `reviews:delete` - удаление отзывов
- `reviews:respond` - ответы на отзывы

#### Управление чатами
- `chats:view_all` - просмотр всех чатов
- `chats:view_own` - просмотр своих чатов
- `chats:moderate` - модерация чатов
- `chats:block_users` - блокировка пользователей в чатах

#### Управление категориями
- `categories:view` - просмотр категорий
- `categories:create` - создание категорий
- `categories:edit` - редактирование категорий
- `categories:delete` - удаление категорий
- `categories:manage_attributes` - управление атрибутами

#### Финансовые операции
- `finance:view_transactions` - просмотр транзакций
- `finance:view_reports` - просмотр отчетов
- `finance:manage_payouts` - управление выплатами
- `finance:set_commissions` - установка комиссий

#### Управление складом
- `warehouse:view_inventory` - просмотр остатков
- `warehouse:manage_inventory` - управление остатками
- `warehouse:receive_goods` - приемка товаров
- `warehouse:ship_goods` - отгрузка товаров

#### Системные настройки
- `system:view_logs` - просмотр логов
- `system:manage_settings` - управление настройками
- `system:manage_roles` - управление ролями
- `system:view_analytics` - просмотр аналитики
- `system:export_data` - экспорт данных

## План реализации

### Фаза 1: Базовая инфраструктура (текущая задача)
1. ✅ Создание таблиц в БД
2. ⏳ Создание миграции для расширения системы ролей
3. ⏳ Создание моделей в backend
4. ⏳ Создание middleware для проверки прав

### Фаза 2: Backend API
1. CRUD операции для ролей
2. CRUD операции для прав
3. API для назначения ролей пользователям
4. Интеграция с существующими endpoints

### Фаза 3: Frontend интерфейс
1. Страница управления ролями
2. Интерфейс назначения ролей пользователям
3. Отображение ролей в списке пользователей
4. Фильтрация по ролям

### Фаза 4: Интеграция с функционалом
1. Проверка прав в критических операциях
2. Условное отображение элементов UI
3. Ограничение доступа к страницам
4. Аудит действий пользователей

## Матрица ролей и прав (примеры)

| Роль | users:view | listings:moderate | orders:process | finance:view_reports |
|------|------------|------------------|----------------|---------------------|
| super_admin | ✅ | ✅ | ✅ | ✅ |
| admin | ✅ | ✅ | ✅ | ✅ |
| content_moderator | ❌ | ✅ | ❌ | ❌ |
| vendor_manager | ✅ | ❌ | ✅ | ✅ |
| professional_vendor | ❌ | ❌ | ✅ (own) | ✅ (own) |
| user | ❌ | ❌ | ❌ | ❌ |

## Безопасность

### Принципы
1. **Principle of Least Privilege** - минимально необходимые права
2. **Separation of Duties** - разделение обязанностей
3. **Defense in Depth** - многоуровневая защита
4. **Audit Trail** - логирование всех действий

### Реализация
1. Проверка прав на уровне API (backend)
2. Проверка прав на уровне UI (frontend)
3. Проверка прав на уровне БД (row-level security)
4. Регулярный аудит назначенных ролей

## Миграция существующих пользователей

### Стратегия
1. Все существующие пользователи получают роль `user`
2. Администраторы (где is_admin = true) получают роль `admin`
3. Продавцы с витринами получают роль `professional_vendor`
4. Остальные роли назначаются вручную через админ-панель

## Метрики успеха

1. **Безопасность**: 0 несанкционированных доступов
2. **Производительность**: <10ms на проверку прав
3. **Масштабируемость**: поддержка 100+ ролей и 1000+ прав
4. **Удобство**: 90% операций требуют <3 кликов
5. **Гибкость**: новые роли создаются за <5 минут