# Сессия: Реализация Backend API для сбора поведенческих событий

**Дата**: 2025-01-08
**Статус**: ✅ Завершено

## Что сделано

### 1. Создан модуль behavior_tracking в backend/internal/proj/

#### Структура модуля:
- `types.go` → перемещен в `internal/domain/behavior/types.go` для избежания циклической зависимости
- `handler/handler.go` - HTTP обработчики для API endpoints
- `service/interface.go` и `service/service.go` - бизнес-логика с батчевой обработкой событий
- `storage/postgres/interface.go` и `repository.go` - репозиторий для работы с БД
- `module.go` - регистрация роутов

#### Ключевые особенности реализации:
- Асинхронная батчевая обработка событий (буфер на 100 событий, флаш каждые 5 секунд)
- Автоматическая генерация session_id если не передан
- Rate limiting (100 запросов в секунду на IP)
- Валидация входящих данных с использованием go-playground/validator
- Использование pgx v5 для работы с PostgreSQL

### 2. Реализованы API endpoints

#### Публичные endpoints:
- `POST /api/v1/analytics/track` - прием событий
- `GET /api/v1/analytics/metrics/search` - метрики поиска
- `GET /api/v1/analytics/metrics/items` - метрики товаров  
- `GET /api/v1/analytics/sessions/:session_id/events` - события сессии

#### Защищенные endpoints (требуют авторизации):
- `GET /api/v1/analytics/users/:user_id/events` - события пользователя

#### Админские endpoints:
- `POST /api/v1/analytics/metrics/update` - принудительное обновление метрик

### 3. Типы событий

Реализована поддержка следующих типов событий:
- `search_performed` - выполнен поиск
- `result_clicked` - клик по результату поиска
- `item_viewed` - просмотр товара
- `item_purchased` - покупка товара
- `search_filter_applied` - применен фильтр поиска
- `search_sort_changed` - изменена сортировка
- `item_added_to_cart` - товар добавлен в корзину

### 4. Функциональность

- **Батчевая обработка**: События накапливаются в буфере и сохраняются пакетами для оптимизации производительности
- **Автоматический расчет метрик**: CTR, конверсия, средняя позиция клика
- **Rate limiting**: Защита от спама через golang.org/x/time/rate
- **Гибкие запросы метрик**: Поддержка фильтрации по периоду, пагинация, сортировка

### 5. Интеграция

- Модуль зарегистрирован в server.go
- Добавлены переводы ошибок в файлы локализации (en.json, ru.json, sr.json)
- Сгенерирована Swagger документация
- Код отформатирован и прошел линтинг

## Используемые таблицы БД

Модуль использует существующие таблицы из миграций:
- `user_behavior_events` - хранение всех событий
- `search_behavior_metrics` - агрегированные метрики поиска

## Технические детали

### Архитектурные решения:
1. Использован паттерн интерфейсов для изоляции слоев
2. Создан отдельный пакет `internal/interfaces` для общих интерфейсов во избежание циклических зависимостей
3. Типы вынесены в `internal/domain/behavior` для переиспользования

### Оптимизации:
1. Батчевая вставка событий через pgx.Batch
2. Асинхронная обработка с буферизацией
3. Индексы на часто используемых полях в БД

## Следующие шаги

Для полной интеграции поведенческой аналитики необходимо:
1. Добавить вызовы API трекинга событий во frontend
2. Создать dashboard для визуализации метрик
3. Настроить периодическое обновление агрегированных метрик (cron job)
4. Интегрировать метрики в алгоритмы ранжирования поиска