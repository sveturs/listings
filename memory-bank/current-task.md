# Текущая задача: Разработка улучшений для панели управления витринами

## Статус
В процессе реализации

## Ветка
`feature/storefront-dashboard-improvements`

## Выполненные шаги
1. ✅ Создана новая ветка для разработки
2. ✅ Изучена текущая реализация dashboard
3. ✅ Проанализирована структура компонентов и данных
4. ✅ Проверена мобильная версия
5. ✅ Составлен план улучшений (см. memory-bank/tasks/004-storefront-dashboard-improvements.md)

## Текущие проблемы
1. Все данные в dashboard захардкожены
2. Отсутствует интеграция с реальным API
3. Недостающие переводы в ru.json
4. Плохая адаптация таблицы заказов для мобильных устройств

## План реализации (Фаза 1)

### 1. Добавить недостающие переводы
- [ ] common.rating
- [ ] common.phone
- [ ] common.email  
- [ ] common.share
- [ ] products.inStock

### 2. Создать API endpoints для dashboard
- [ ] GET /api/v1/storefronts/{slug}/dashboard/stats
- [ ] GET /api/v1/storefronts/{slug}/dashboard/recent-orders
- [ ] GET /api/v1/storefronts/{slug}/dashboard/low-stock
- [ ] GET /api/v1/storefronts/{slug}/dashboard/notifications

### 3. Обновить Redux store
- [ ] Добавить actions для загрузки dashboard данных
- [ ] Добавить соответствующие reducers
- [ ] Добавить селекторы для dashboard данных

### 4. Рефакторинг компонента dashboard
- [ ] Подключить реальные данные вместо захардкоженных
- [ ] Добавить состояния загрузки
- [ ] Обработка ошибок

### 5. Улучшить мобильную версию
- [ ] Заменить таблицу на карточки для мобильных
- [ ] Оптимизировать расположение элементов

## Выполненная работа в текущей сессии

### 1. Добавлены недостающие переводы (✅)
- common.rating
- common.phone
- common.email
- common.share
- Добавлена секция products с переводами для products.inStock и других ключей

### 2. Созданы API endpoints для dashboard (✅)
- Создан новый файл `/backend/internal/proj/storefronts/handler/dashboard_handler.go`
- Добавлены endpoints:
  - GET /api/v1/storefronts/{slug}/dashboard/stats
  - GET /api/v1/storefronts/{slug}/dashboard/recent-orders
  - GET /api/v1/storefronts/{slug}/dashboard/low-stock
  - GET /api/v1/storefronts/{slug}/dashboard/notifications
- Обновлен module.go для регистрации новых роутов
- Swagger документация сгенерирована успешно

### 3. Обновлен Redux store (✅)
- Добавлены новые поля в состояние:
  - dashboardStats
  - recentOrders
  - lowStockProducts
  - dashboardNotifications
  - isLoadingDashboard
- Созданы async thunks:
  - fetchDashboardStats
  - fetchRecentOrders
  - fetchLowStockProducts
  - fetchDashboardNotifications
- Добавлены обработчики в extraReducers
- Созданы селекторы для dashboard данных

### 4. Завершен рефакторинг компонента dashboard (✅)
- Добавлены импорты новых actions и селекторов
- Добавлена загрузка данных dashboard при монтировании
- Обновлены статистические карточки для отображения реальных данных
- Обновлена таблица заказов для отображения данных из recentOrders
- Обновлена секция low stock products для отображения данных из lowStockProducts
- Обновлены уведомления для отображения данных из dashboardNotifications
- Добавлены все недостающие переводы в ru.json и en.json
- Исправлены ошибки с параметрами в apiClient
- Frontend успешно компилируется и форматирован

### 5. Реализовано получение реальных данных из БД (✅)
- Добавлены новые методы в StorefrontRepository:
  - GetDashboardStats - получение статистики (активные товары, заказы, сообщения)
  - GetRecentOrders - получение последних заказов с деталями
  - GetLowStockProducts - получение товаров с запасом ниже минимального
  - GetUnreadMessagesCount - подсчет непрочитанных сообщений
- Реализованы SQL запросы для получения реальных данных:
  - Статистика товаров с фильтрацией по активности
  - Заказы со статусами pending/confirmed
  - Товары с запасом ниже min_stock (по умолчанию 5)
  - Непрочитанные сообщения через связь с чатами
- Обновлен dashboard handler для использования репозитория
- Исправлены все ошибки компиляции и линтинга
- Backend успешно форматирован и прошел все проверки

## Что осталось сделать

### 1. Улучшить мобильную версию
- [ ] Заменить таблицу заказов на карточки для мобильных устройств
- [ ] Оптимизировать расположение элементов
- [ ] Добавить свайп для статистических карточек
- [ ] Адаптировать quick actions для мобильных экранов

### 2. Добавить реальные данные в backend
- [ ] Реализовать получение реальной статистики из БД в GetDashboardStats
- [ ] Реализовать получение последних заказов в GetRecentOrders
- [ ] Реализовать подсчет товаров с низким запасом в GetLowStockProducts
- [ ] Реализовать систему уведомлений в GetDashboardNotifications

### 3. Добавить обработку ошибок
- [ ] Добавить обработку ошибок загрузки данных
- [ ] Добавить retry механизм для failed requests
- [ ] Показывать информативные сообщения об ошибках

### 6. Реализована аналитика витрин (✅)
- Добавлен новый метод GetAnalyticsData в StorefrontRepository
- Реализована агрегация данных из существующих таблиц:
  - Подсчет заказов и выручки по дням
  - Топ-5 категорий по продажам
  - Топ-5 товаров по количеству продаж
- Обновлен handler для поддержки ISO формата дат от frontend
- Временно используются фиктивные данные для просмотров (будет интегрировано с системой трекинга)
- Backend успешно компилируется и прошел линтинг

## Примечания для следующей сессии
- Основной рефакторинг dashboard завершен успешно
- Dashboard endpoints теперь возвращают реальные данные из БД
- Analytics endpoint также возвращает реальные данные (кроме просмотров)
- Frontend полностью готов к работе с реальными данными из Redux
- Компонент dashboard теперь отображает:
  - Реальную статистику из dashboardStats
  - Заказы из recentOrders с правильным форматированием
  - Товары с низким запасом из lowStockProducts
  - Уведомления из dashboardNotifications с иконками и стилями
- Компонент аналитики теперь получает:
  - Реальные данные о заказах и выручке
  - Топ категории и товары
  - Правильные расчеты конверсии
- Добавлены все недостающие переводы в ru.json и en.json
- Frontend и backend успешно компилируются без ошибок

## Следующие приоритеты
1. Интегрировать систему трекинга просмотров для реальных данных о трафике
2. Добавить мобильную адаптацию (карточки вместо таблиц)
3. Добавить обработку ошибок и retry логику
4. Реализовать более продвинутую систему уведомлений для витрин