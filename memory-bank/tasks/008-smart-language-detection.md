# План: Умное определение языка для svetu.rs

## Цель
Реализовать интеллектуальное определение языка интерфейса с учетом предпочтений пользователя и контекста.

## Стратегия определения языка (по приоритету):

1. **Cookie с сохраненным выбором** (высший приоритет)
   - Если пользователь явно выбрал язык - всегда используем его выбор
   - Cookie name: `locale-preference`
   - Срок жизни: 1 год

2. **Accept-Language заголовок браузера**
   - Парсим заголовок и ищем поддерживаемые языки
   - Приоритеты: sr > ru > en
   - Учитываем q-values (веса предпочтений)

3. **Сербский по умолчанию**
   - Если ничего не подходит - показываем сербский
   - Логично для домена .rs

## План реализации:

### 1. Обновить middleware.ts
```typescript
// Добавить логику определения языка
// Проверка cookie
// Парсинг Accept-Language
// Установка дефолта
```

### 2. Создать утилиту для работы с языками
`src/utils/localeDetection.ts`:
- `detectLocale(request)` - основная функция определения
- `parseAcceptLanguage(header)` - парсер заголовка
- `saveLocalePreference(locale)` - сохранение в cookie

### 3. Обновить LanguageSwitcher
- Сохранять выбор в cookie при переключении
- Показывать индикатор автоопределенного языка

### 4. Добавить настройку в конфиг
`src/i18n/config.ts`:
- `enableAutoDetection: true`
- `cookieName: 'locale-preference'`
- `cookieMaxAge: 365 * 24 * 60 * 60`

### 5. SEO оптимизация
- Добавить `<link rel="alternate" hreflang="x">` теги
- Правильные canonical URLs
- Sitemap для каждого языка

## Техническая реализация:

### Парсинг Accept-Language
```typescript
// Пример: "sr-RS,sr;q=0.9,ru;q=0.8,en-US;q=0.7,en;q=0.6"
// Результат: ['sr', 'ru', 'en'] отсортированные по приоритету
```

### Cookie структура
```typescript
{
  name: 'locale-preference',
  value: 'sr' | 'ru' | 'en',
  maxAge: 31536000, // 1 год
  sameSite: 'lax',
  secure: true // для production
}
```

### Middleware логика
```typescript
1. Проверить cookie 'locale-preference'
2. Если нет - парсить Accept-Language
3. Найти первый поддерживаемый язык
4. Если не найден - использовать 'sr'
5. Перенаправить на /{locale}/...
```

## Дополнительные улучшения:

1. **Уведомление о языке**
   - При первом визите показать ненавязчивое уведомление
   - "Мы показываем сайт на сербском. Хотите изменить язык?"

2. **Аналитика**
   - Отслеживать какие языки выбирают
   - Какой процент меняет автоопределенный язык

3. **A/B тестирование**
   - Тестировать разные стратегии определения
   - Измерять bounce rate для разных подходов

## Примерная сложность: 
- 2-3 часа на базовую реализацию
- +1 час на тестирование
- +1 час на SEO оптимизацию

## Статус: ✅ ВЫПОЛНЕНО

### Что было реализовано:
1. ✅ Создана утилита `localeDetection.ts` с функциями определения языка
2. ✅ Обновлен `middleware.ts` для интеллектуального определения
3. ✅ `LanguageSwitcher` сохраняет выбор в cookie
4. ✅ Добавлены настройки в `i18n/config.ts`
5. ✅ Добавлены SEO теги в `layout.tsx`
6. ✅ Протестирована функциональность
7. ✅ Пройдены все проверки качества (format, lint, build)

### Ключевые изменения:
- Сербский установлен языком по умолчанию
- Cookie `locale-preference` хранит выбор пользователя на 1 год
- SEO теги hreflang и Open Graph для всех языков
- Автоматическое определение по Accept-Language заголовку

### Результаты тестирования:
- Определение языка работает корректно
- Сохранение в cookie функционирует
- SEO теги присутствуют в HTML
- Все тесты качества пройдены успешно

## Файлы для изменения:
1. `/src/middleware.ts` - основная логика
2. `/src/utils/localeDetection.ts` - новый файл
3. `/src/components/LanguageSwitcher.tsx` - сохранение в cookie
4. `/src/i18n/config.ts` - конфигурация
5. `/src/app/[locale]/layout.tsx` - SEO теги

## Тестирование:
1. Разные Accept-Language заголовки
2. Переключение языков и проверка cookie
3. Инкогнито режим
4. Разные браузеры
5. Мобильные устройства