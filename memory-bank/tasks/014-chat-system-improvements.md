# Задание на устранение недостатков системы чатов

## Резюме анализа

После детального анализа системы чатов на всех уровнях (БД, Backend, Frontend, MinIO) выявлены следующие ключевые аспекты:

### Сильные стороны:
- Хорошо спроектированная структура БД с оптимизированными индексами
- Чистая архитектура backend с разделением на слои
- WebSocket реализация для real-time обмена сообщениями
- Поддержка файловых вложений различных типов
- JWT аутентификация и базовая безопасность

### Основные недостатки:
1. **Безопасность файлов**: публичный доступ к файлам через прямые URL
2. **Отсутствие функций**: редактирование/удаление сообщений, поиск, реакции
3. **Производительность**: нет оптимизации изображений, превью для видео
4. **UX проблемы**: нет индикаторов загрузки, звуковых уведомлений
5. **Техдолг**: два разных frontend проекта с дублированием кода

## План устранения недостатков

### Фаза 1: Критические проблемы безопасности (1-2 недели)

#### 1.1 Приватный доступ к файлам
**Проблема**: Файлы чатов доступны публично через прямые URL
**Решение**:
- Реализовать presigned URL для MinIO
- Создать endpoint `/api/v1/marketplace/attachments/{id}/download`
- Добавить проверку прав доступа (только участники чата)
- Обновить nginx конфигурацию для блокировки прямого доступа

**Технические детали**:
```go
// Backend: новый метод в chat service
func (s *ChatService) GenerateAttachmentURL(ctx context.Context, userID, attachmentID int) (string, error) {
    // 1. Проверить что пользователь - участник чата
    // 2. Генерировать presigned URL с TTL 1 час
    // 3. Логировать доступ для аудита
}
```

#### 1.2 Антивирусная проверка
**Проблема**: Загружаемые файлы не проверяются на вирусы
**Решение**:
- Интегрировать ClamAV для сканирования файлов
- Добавить очередь для асинхронной проверки
- Блокировать доступ к файлам до завершения проверки

### Фаза 2: Улучшение функциональности (2-3 недели)

#### 2.1 Редактирование и удаление сообщений
**Реализация**:
- Добавить поля в БД: `edited_at`, `deleted_at`, `edit_history`
- Создать endpoints: `PUT /messages/{id}`, `DELETE /messages/{id}`
- Добавить WebSocket события: `message.edited`, `message.deleted`
- Обновить UI для отображения статусов

**SQL миграция**:
```sql
ALTER TABLE marketplace_messages 
ADD COLUMN edited_at TIMESTAMP,
ADD COLUMN deleted_at TIMESTAMP,
ADD COLUMN edit_history JSONB DEFAULT '[]'::jsonb;
```

#### 2.2 Поиск по сообщениям
**Реализация**:
- Создать полнотекстовый индекс в PostgreSQL
- Добавить endpoint: `GET /chats/{id}/search?q=...`
- Реализовать пагинацию результатов
- Добавить UI компонент поиска

#### 2.3 Типы сообщений и реакции
**Реализация**:
- Добавить enum типов: `text`, `image`, `video`, `document`, `system`
- Создать таблицу `message_reactions`
- Реализовать WebSocket события для реакций
- Обновить UI для отображения реакций

### Фаза 3: Оптимизация производительности (2-3 недели)

#### 3.1 Оптимизация изображений
**Реализация**:
- Интегрировать библиотеку для обработки изображений (например, imaging)
- Генерировать превью (150x150, 300x300, оригинал)
- Сжимать изображения при загрузке
- Поддержка WebP формата

#### 3.2 Превью для видео
**Реализация**:
- Интегрировать FFmpeg для генерации превью
- Создавать thumbnail из первого кадра
- Добавить метаданные (длительность, размер)

#### 3.3 Lazy loading и виртуализация
**Реализация**:
- Использовать react-window для виртуализации списка сообщений
- Загружать историю сообщений по мере прокрутки
- Кешировать сообщения в Redux

### Фаза 4: Улучшение UX (1-2 недели)

#### 4.1 Индикаторы загрузки
**Реализация**:
- Добавить прогресс-бар для загрузки файлов
- Использовать XMLHttpRequest для отслеживания прогресса
- Показывать размер и скорость загрузки

#### 4.2 Звуковые уведомления
**Реализация**:
- Добавить настройки звуков в профиль пользователя
- Воспроизводить звук при получении сообщения
- Учитывать фокус окна и активный чат

#### 4.3 Оффлайн поддержка
**Реализация**:
- Использовать IndexedDB для хранения сообщений
- Реализовать очередь отправки для оффлайн режима
- Синхронизация при восстановлении соединения

### Фаза 5: Миграция и унификация (3-4 недели)

#### 5.1 Миграция с hostel-frontend на svetu
**План**:
- Перенести недостающий функционал (распознавание телефонов)
- Мигрировать пользователей постепенно
- Сохранить обратную совместимость API

#### 5.2 Улучшения архитектуры
**Реализация**:
- Вынести общую логику в отдельные пакеты
- Создать единую библиотеку компонентов
- Документировать API через OpenAPI

## Приоритеты и метрики успеха

### Высокий приоритет:
1. Безопасность файлов (критично)
2. Редактирование/удаление сообщений
3. Оптимизация изображений

### Средний приоритет:
1. Поиск по сообщениям
2. Индикаторы загрузки
3. Звуковые уведомления

### Низкий приоритет:
1. Реакции на сообщения
2. Оффлайн поддержка
3. Расширенные типы сообщений

### Метрики успеха:
- 0 инцидентов безопасности с файлами
- Снижение размера изображений на 60-80%
- Увеличение вовлеченности пользователей на 30%
- Снижение нагрузки на сервер на 40%
- Повышение удовлетворенности пользователей (NPS)

## Технический стек для реализации

### Backend:
- **Обработка изображений**: `github.com/disintegration/imaging`
- **Антивирус**: ClamAV с Go биндингами
- **Очереди**: Redis + asynq для фоновых задач
- **Кеширование**: Redis для presigned URLs

### Frontend:
- **Виртуализация**: `react-window`
- **Оффлайн**: `workbox` для Service Workers
- **Состояние**: Redux Toolkit (уже используется)
- **UI**: DaisyUI компоненты

## Риски и митигация

### Риски:
1. **Миграция данных**: возможная потеря сообщений
   - **Митигация**: резервное копирование, постепенная миграция
   
2. **Производительность**: увеличение нагрузки от новых функций
   - **Митигация**: кеширование, оптимизация запросов
   
3. **Совместимость**: поломка существующих интеграций
   - **Митигация**: версионирование API, grace period

## Заключение

Система чатов имеет хорошую основу, но требует доработок в области безопасности, функциональности и производительности. Предложенный план позволит устранить критические проблемы и значительно улучшить пользовательский опыт.

Общее время реализации: 8-12 недель
Рекомендуемая команда: 2 backend + 2 frontend разработчика