# Задача 007: Реализация умного поиска категорий

## Дата: 2025-01-28
## Статус: ✅ ЗАВЕРШЕНО

## Описание задачи:

Пользователь выявил проблему масштабируемости системы категорий: "нам нужно в промпты прям для каждой подкатегории указывать аналогичные промпты? а категорий может быть пол тысячи а то и больше".

Была предложена и реализована система семантического поиска категорий на основе ключевых слов и similarity search.

## Выполненные шаги:

### 1. Документация и планирование
- Создал `memory-bank/combined-category-detection-approach.md` с детальным описанием подхода
- Обновил `CLAUDE.md` с ссылками на новую документацию

### 2. База данных
Создал миграции:
- `000166_create_category_keywords.up/down.sql` - таблица для хранения ключевых слов категорий с поддержкой:
  - Многоязычности (ru, en, sr)
  - Весов для приоритизации
  - Типов ключевых слов (main, synonym, brand, attribute)
  - Негативных ключевых слов для исключения
  - Статистики использования и успешности

- `000167_create_category_detection_stats.up/down.sql` - таблица для сбора статистики:
  - Детали каждого определения категории
  - Обратная связь от пользователей
  - Метрики производительности
  - Альтернативные категории

- `000168_seed_category_keywords.up/down.sql` - начальные данные для основных категорий

### 3. Backend реализация

#### Сервисы:
- `services/category_detector.go` - основная логика с комбинированным подходом:
  - Поиск по ключевым словам (60% веса)
  - Similarity search по похожим объявлениям (40% веса)
  - Параллельное выполнение для производительности
  - Сохранение статистики для анализа

#### Репозитории:
- `storage/postgres/category_keywords.go` - CRUD операции с ключевыми словами
- `storage/postgres/category_detection_stats.go` - работа со статистикой
- `storage/opensearch/repository.go` - добавлен метод FindSimilarListings

#### API:
- `handler/category_detector_handler.go` - HTTP handlers
- Интеграция в `handler/handler.go` с правильной инициализацией зависимостей

### 4. API Endpoints

```
POST /api/v1/marketplace/categories/detect
- Определение категории по семантическим данным
- Возвращает основную категорию и альтернативы с уровнем уверенности

PUT /api/v1/marketplace/categories/detect/:stats_id/confirm
- Подтверждение или корректировка выбора пользователем
- Используется для улучшения алгоритма

GET /api/v1/marketplace/categories/:category_id/keywords
- Получение ключевых слов для категории
- Поддержка фильтрации по языку
```

### 5. Frontend интеграция

#### AI промпты:
Обновлены промпты в `frontend/svetu/src/app/api/ai/analyze/prompts.ts`:
- Вместо прямого выбора категории AI теперь извлекает:
  - `domain` - общая область (automotive, electronics и т.д.)
  - `productType` - конкретный тип продукта (tire, smartphone и т.д.)
  - `keywords` - массив ключевых слов

#### Сервис определения категорий:
Создан `frontend/svetu/src/services/categoryDetector.ts`:
- Интеграция с новым API
- Обработка результатов определения
- Подтверждение выбора пользователем

#### Интеграция в create-listing-ai:
- Использование нового сервиса при обработке результатов AI
- Показ уровня уверенности пользователю
- Сохранение возможности ручного выбора категории

#### Переводы:
Добавлены переводы для всех языков (ru, en, sr):
- Сообщения об успешном определении
- Предупреждения о низкой уверенности

## Технические детали:

### Алгоритм определения категории:

1. **Извлечение ключевых слов**:
   - Из AI анализа (keywords)
   - Из заголовка и описания
   - Фильтрация стоп-слов

2. **Поиск по ключевым словам**:
   - Запрос в таблицу category_keywords
   - Учет весов и типов ключевых слов
   - Обработка негативных ключевых слов

3. **Similarity search**:
   - Использование OpenSearch more_like_this
   - Поиск похожих объявлений
   - Агрегация категорий найденных объявлений

4. **Комбинирование результатов**:
   - 60% вес для keyword matching
   - 40% вес для similarity search
   - Нормализация и ранжирование

5. **Сохранение статистики**:
   - Детали определения
   - Время обработки
   - Альтернативные варианты

## Преимущества реализованного решения:

1. **Масштабируемость**: Легко добавлять новые категории через ключевые слова
2. **Многоязычность**: Поддержка ru, en, sr из коробки
3. **Самообучение**: Система улучшается на основе обратной связи
4. **Гибкость**: Веса и приоритеты настраиваются
5. **Производительность**: Параллельное выполнение запросов
6. **Прозрачность**: Сохранение всех деталей для анализа

## Дальнейшие улучшения (опционально):

1. Добавить cron job для автоматического обновления весов
2. Реализовать ML модель на основе собранной статистики
3. Добавить кеширование популярных соответствий
4. Реализовать A/B тестирование разных алгоритмов
5. Добавить админ-панель для управления ключевыми словами

## Результат:

Система успешно реализована и интегрирована. Теперь определение категорий происходит на основе семантического анализа, что делает систему масштабируемой и не требует обновления промптов при добавлении новых категорий. При этом сохранена возможность прямого выбора категории пользователем.