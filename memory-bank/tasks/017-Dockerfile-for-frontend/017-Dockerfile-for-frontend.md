# 017 Dockerfile for frontend

## Задача
Создать Dockerfile для frontend-приложения с поддержкой runtime конфигурации через переменные окружения.

## Что было сделано

### 1. Docker инфраструктура

#### Создан многоэтапный Dockerfile
- **Stage 1 (deps)**: Установка всех зависимостей
- **Stage 2 (builder)**: Сборка приложения в standalone режиме
- **Stage 3 (runner)**: Минимальный production образ на Alpine Linux
- Работа от непривилегированного пользователя для безопасности
- Встроенный health check через `/api/health`

#### Создан .dockerignore
- Исключение ненужных файлов из образа (node_modules, тесты, логи)
- Сохранение необходимых конфигов (postcss, tailwind)

#### Создан docker-compose.yml
- Конфигурация для локального запуска
- Использование host network для доступа к backend
- Разделение переменных для клиента и сервера

#### Обновлен Makefile
- Добавлены команды для работы с Docker:
  - `make docker-build` - сборка локального образа
  - `make docker-build-prod` - сборка для production (linux/amd64)
  - `make docker-run` - запуск контейнера локально
  - `make docker-push` - публикация в Harbor registry
  - `make docker-health` - проверка здоровья контейнера

### 2. Runtime конфигурация

#### Внедрена система runtime переменных окружения
- Использование `next-runtime-env` для поддержки runtime конфигурации
- Переменные можно менять без пересборки образа
- Централизованное управление через `src/config/`

#### Создан API endpoint для health check (`/api/health`)
- Проверка доступности критичных сервисов (API, MinIO)
- Валидация конфигурации
- Возвращает детальную информацию о состоянии

#### Обновлена система конфигурации
- Поддержка разных URL для клиента и SSR запросов
- Валидация всех переменных через Zod
- Helper методы для работы с изображениями
- Автоматический парсинг разрешенных хостов

### 3. Обновления в коде

#### next.config.ts
- Добавлен `output: 'standalone'` для оптимизации размера образа
- Отключение ESLint при production сборке

#### postcss.config.mjs
- Исправлен синтаксис конфигурации для совместимости с Docker сборкой

#### Обновлены сервисы
- MarketplaceService теперь использует `internal: true` для SSR запросов
- Корректная работа в контейнерной среде

#### GitHub Actions
- Исправлены пути в workflow файлах (frontend/hostel-frontend → frontend/svetu)

#### Backend CORS
- Добавлен localhost:3002 в разрешенные origins

## Результат

Создана полноценная Docker инфраструктура для frontend приложения с:
- Оптимизированным размером образа (многоэтапная сборка)
- Runtime конфигурацией без пересборки
- Health checks для мониторинга
- Безопасностью (непривилегированный пользователь)
- Удобными командами для локальной разработки и деплоя

Приложение готово к развертыванию в различных окружениях (Docker, Kubernetes) с возможностью гибкой настройки через переменные окружения.