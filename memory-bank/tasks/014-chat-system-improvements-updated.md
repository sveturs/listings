# –ó–∞–¥–∞–Ω–∏–µ –Ω–∞ —É—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –Ω–µ–¥–æ—Å—Ç–∞—Ç–∫–æ–≤ —Å–∏—Å—Ç–µ–º—ã —á–∞—Ç–æ–≤ (–û–±–Ω–æ–≤–ª–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è)

## –†–µ–∑—é–º–µ –∞–Ω–∞–ª–∏–∑–∞

–ü–æ—Å–ª–µ –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ —Å–∏—Å—Ç–µ–º—ã —á–∞—Ç–æ–≤ –Ω–∞ –≤—Å–µ—Ö —É—Ä–æ–≤–Ω—è—Ö (–ë–î, Backend, Frontend –≤ svetu, MinIO) –≤—ã—è–≤–ª–µ–Ω—ã —Å–ª–µ–¥—É—é—â–∏–µ –∫–ª—é—á–µ–≤—ã–µ –∞—Å–ø–µ–∫—Ç—ã:

### –°–∏–ª—å–Ω—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã:
- **–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö**: –û—Ç–ª–∏—á–Ω–æ —Å–ø—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ —Å –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–º–∏ –∏–Ω–¥–µ–∫—Å–∞–º–∏
- **Backend**: –ß–∏—Å—Ç–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ–º –Ω–∞ —Å–ª–æ–∏, WebSocket –¥–ª—è real-time
- **Frontend (svetu)**: 
  - Modern stack: Next.js 15, TypeScript, Redux Toolkit
  - –ü–æ–ª–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–æ–≤ —Å –ø—Ä–æ–≥—Ä–µ—Å—Å–æ–º
  - WebSocket –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞–º–∏ –æ–Ω–ª–∞–π–Ω —Å—Ç–∞—Ç—É—Å–∞
  - –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –ø—Ä—è–º—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –º–µ–∂–¥—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏
  - –ò–Ω—Ç–µ—Ä–Ω–∞—Ü–∏–æ–Ω–∞–ª–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ next-intl
- **MinIO**: –û—Ä–≥–∞–Ω–∏–∑–æ–≤–∞–Ω–Ω–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ñ–∞–π–ª–æ–≤ —Å –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π

### –û—Å–Ω–æ–≤–Ω—ã–µ –Ω–µ–¥–æ—Å—Ç–∞—Ç–∫–∏:
1. **üî¥ –ö—Ä–∏—Ç–∏—á–Ω–æ - –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å —Ñ–∞–π–ª–æ–≤**: –ø—É–±–ª–∏—á–Ω—ã–π –¥–æ—Å—Ç—É–ø –∫ —Ñ–∞–π–ª–∞–º —á–µ—Ä–µ–∑ –ø—Ä—è–º—ã–µ URL
2. **–û—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª**:
   - –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ/—É–¥–∞–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π
   - –ü–æ–∏—Å–∫ –ø–æ –∏—Å—Ç–æ—Ä–∏–∏ —á–∞—Ç–æ–≤
   - –†–µ–∞–∫—Ü–∏–∏ –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
   - –†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ —Ç–µ–ª–µ—Ñ–æ–Ω–æ–≤/email (–±—ã–ª–æ –≤ —Å—Ç–∞—Ä–æ–º —Ñ—Ä–æ–Ω—Ç–µ)
   - –ó–≤—É–∫–æ–≤—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
3. **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å**:
   - –ù–µ—Ç –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
   - –û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –ø—Ä–µ–≤—å—é –¥–ª—è –≤–∏–¥–µ–æ
   - –ù–µ—Ç lazy loading –¥–ª—è —Å—Ç–∞—Ä—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
4. **UX –ø—Ä–æ–±–ª–µ–º—ã**:
   - –ù–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —á–µ—Ä–Ω–æ–≤–∏–∫–æ–≤
   - –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä "—Å–æ–æ–±—â–µ–Ω–∏–µ –¥–æ—Å—Ç–∞–≤–ª–µ–Ω–æ/–ø—Ä–æ—á–∏—Ç–∞–Ω–æ"
   - –ù–µ—Ç –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π –ø–æ –¥–∞—Ç–∞–º

## –ü–ª–∞–Ω —É—Å—Ç—Ä–∞–Ω–µ–Ω–∏—è –Ω–µ–¥–æ—Å—Ç–∞—Ç–∫–æ–≤

### –§–∞–∑–∞ 1: –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ (1-2 –Ω–µ–¥–µ–ª–∏)

#### 1.1 –ü—Ä–∏–≤–∞—Ç–Ω—ã–π –¥–æ—Å—Ç—É–ø –∫ —Ñ–∞–π–ª–∞–º
**–ü—Ä–æ–±–ª–µ–º–∞**: –§–∞–π–ª—ã —á–∞—Ç–æ–≤ –¥–æ—Å—Ç—É–ø–Ω—ã –ø—É–±–ª–∏—á–Ω–æ —á–µ—Ä–µ–∑ –ø—Ä—è–º—ã–µ URL
**–†–µ—à–µ–Ω–∏–µ**:
```go
// Backend: –Ω–æ–≤—ã–π endpoint –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞ –∫ —Ñ–∞–π–ª–∞–º
// POST /api/v1/marketplace/attachments/{id}/presigned-url
func (s *ChatService) GeneratePresignedURL(ctx context.Context, userID, attachmentID int) (string, error) {
    // 1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å - —É—á–∞—Å—Ç–Ω–∏–∫ —á–∞—Ç–∞
    attachment, err := s.storage.GetAttachment(ctx, attachmentID)
    if err != nil {
        return "", err
    }
    
    // 2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–æ—Å—Ç—É–ø
    hasAccess, err := s.storage.UserHasAccessToChat(ctx, userID, attachment.ChatID)
    if !hasAccess {
        return "", ErrAccessDenied
    }
    
    // 3. –ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å presigned URL —Å TTL 1 —á–∞—Å
    url, err := s.minioClient.PresignedGetObject(ctx, "chat-files", attachment.FilePath, time.Hour)
    
    // 4. –õ–æ–≥–∏—Ä–æ–≤–∞—Ç—å –¥–æ—Å—Ç—É–ø
    s.logger.Info("File access granted", "user_id", userID, "attachment_id", attachmentID)
    
    return url, err
}
```

**Frontend –∏–∑–º–µ–Ω–µ–Ω–∏—è**:
```typescript
// svetu: –æ–±–Ω–æ–≤–∏—Ç—å –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ñ–∞–π–ª–æ–≤
const FileAttachment: React.FC<{attachment: Attachment}> = ({attachment}) => {
  const [url, setUrl] = useState<string | null>(null);
  
  useEffect(() => {
    // –ü–æ–ª—É—á–∞–µ–º –±–µ–∑–æ–ø–∞—Å–Ω—ã–π URL –ø—Ä–∏ –º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏
    chatService.getAttachmentURL(attachment.id)
      .then(setUrl)
      .catch(console.error);
  }, [attachment.id]);
  
  if (!url) return <Skeleton />;
  
  return <img src={url} alt={attachment.name} />;
};
```

#### 1.2 –ê–Ω—Ç–∏–≤–∏—Ä—É—Å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è**:
- –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å ClamAV —á–µ—Ä–µ–∑ Docker
- –î–æ–±–∞–≤–∏—Ç—å –æ—á–µ—Ä–µ–¥—å –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ñ–∞–π–ª–æ–≤ (Redis + asynq)
- –ë–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –¥–æ—Å—Ç—É–ø –¥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è

### –§–∞–∑–∞ 2: –£–ª—É—á—à–µ–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏ (2-3 –Ω–µ–¥–µ–ª–∏)

#### 2.1 –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ —É–¥–∞–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π
**–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö**:
```sql
ALTER TABLE marketplace_messages 
ADD COLUMN edited_at TIMESTAMP,
ADD COLUMN deleted_at TIMESTAMP,
ADD COLUMN edit_history JSONB DEFAULT '[]'::jsonb,
ADD COLUMN original_content TEXT;

CREATE INDEX idx_messages_deleted_at ON marketplace_messages(deleted_at) 
WHERE deleted_at IS NULL;
```

**Backend API**:
```go
// PUT /api/v1/marketplace/messages/{id}
func (h *ChatHandler) EditMessage(c *fiber.Ctx) error {
    messageID := c.Params("id")
    userID := c.Locals("user_id").(int)
    
    var req EditMessageRequest
    if err := c.BodyParser(&req); err != nil {
        return err
    }
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —ç—Ç–æ –∞–≤—Ç–æ—Ä —Å–æ–æ–±—â–µ–Ω–∏—è
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏—Å—Ç–æ—Ä–∏—é –∏–∑–º–µ–Ω–µ–Ω–∏–π
    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º WebSocket —Å–æ–±—ã—Ç–∏–µ –≤—Å–µ–º —É—á–∞—Å—Ç–Ω–∏–∫–∞–º
}
```

**Frontend (svetu)**:
```typescript
// –î–æ–±–∞–≤–∏—Ç—å –≤ Redux slice
editMessage: (state, action) => {
  const {messageId, newContent} = action.payload;
  const message = state.messages[messageId];
  if (message) {
    message.content = newContent;
    message.edited_at = new Date().toISOString();
    message.edit_history.push({
      content: message.content,
      edited_at: message.edited_at
    });
  }
}
```

#### 2.2 –†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤ (–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –∏–∑ —Å—Ç–∞—Ä–æ–≥–æ —Ñ—Ä–æ–Ω—Ç–∞)
```typescript
// –£—Ç–∏–ª–∏—Ç–∞ –¥–ª—è —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è —Ç–µ–ª–µ—Ñ–æ–Ω–æ–≤ –∏ email
export const detectContacts = (text: string) => {
  // –ü–∞—Ç—Ç–µ—Ä–Ω –¥–ª—è —Ç–µ–ª–µ—Ñ–æ–Ω–æ–≤
  const phoneRegex = /(\+\d{1,3}[-.\s]?)?\(?\d{1,4}\)?[-.\s]?\d{1,4}[-.\s]?\d{1,9}/g;
  
  // –ü–∞—Ç—Ç–µ—Ä–Ω –¥–ª—è email
  const emailRegex = /[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}/g;
  
  const phones = text.match(phoneRegex) || [];
  const emails = text.match(emailRegex) || [];
  
  return {phones, emails};
};

// –ö–æ–º–ø–æ–Ω–µ–Ω—Ç —Å–æ–æ–±—â–µ–Ω–∏—è —Å –ø–æ–¥—Å–≤–µ—Ç–∫–æ–π –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤
const MessageContent: React.FC<{content: string}> = ({content}) => {
  const contacts = detectContacts(content);
  
  // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –∏ –¥–µ–ª–∞–µ–º –∫–ª–∏–∫–∞–±–µ–ª—å–Ω—ã–º–∏
  let processedContent = content;
  contacts.phones.forEach(phone => {
    processedContent = processedContent.replace(
      phone, 
      `<a href="tel:${phone}" class="text-primary">${phone}</a>`
    );
  });
  
  return <div dangerouslySetInnerHTML={{__html: processedContent}} />;
};
```

#### 2.3 –ü–æ–∏—Å–∫ –ø–æ —Å–æ–æ–±—â–µ–Ω–∏—è–º
**Backend**:
```sql
-- –î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª–Ω–æ—Ç–µ–∫—Å—Ç–æ–≤—ã–π –ø–æ–∏—Å–∫
ALTER TABLE marketplace_messages 
ADD COLUMN search_vector tsvector;

CREATE INDEX idx_messages_search ON marketplace_messages 
USING GIN(search_vector);

-- –¢—Ä–∏–≥–≥–µ—Ä –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è search_vector
CREATE TRIGGER update_messages_search 
BEFORE INSERT OR UPDATE ON marketplace_messages
FOR EACH ROW EXECUTE FUNCTION 
tsvector_update_trigger(search_vector, 'pg_catalog.english', content);
```

**Frontend –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –ø–æ–∏—Å–∫–∞**:
```typescript
const ChatSearch: React.FC = () => {
  const [query, setQuery] = useState('');
  const [results, setResults] = useState<Message[]>([]);
  
  const handleSearch = useDebouncedCallback(async (q: string) => {
    if (q.length < 3) return;
    
    const data = await chatService.searchMessages(chatId, q);
    setResults(data);
  }, 300);
  
  return (
    <div className="relative">
      <input 
        type="text"
        value={query}
        onChange={(e) => {
          setQuery(e.target.value);
          handleSearch(e.target.value);
        }}
        className="input input-bordered w-full"
        placeholder="–ü–æ–∏—Å–∫ –ø–æ —Å–æ–æ–±—â–µ–Ω–∏—è–º..."
      />
      {results.length > 0 && (
        <div className="absolute top-full mt-2 w-full bg-base-100 rounded-lg shadow-lg max-h-96 overflow-y-auto">
          {results.map(msg => (
            <SearchResult key={msg.id} message={msg} onClick={() => scrollToMessage(msg.id)} />
          ))}
        </div>
      )}
    </div>
  );
};
```

### –§–∞–∑–∞ 3: –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ (2-3 –Ω–µ–¥–µ–ª–∏)

#### 3.1 –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
**Backend —Å–µ—Ä–≤–∏—Å**:
```go
import "github.com/disintegration/imaging"

func (s *ImageService) ProcessChatImage(ctx context.Context, file io.Reader, filename string) error {
    img, err := imaging.Decode(file)
    if err != nil {
        return err
    }
    
    // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Ä–∞–∑–º–µ—Ä—ã
    sizes := map[string]int{
        "thumb": 150,
        "preview": 400,
        "full": 1200,
    }
    
    for sizeName, width := range sizes {
        resized := imaging.Resize(img, width, 0, imaging.Lanczos)
        
        // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≤ WebP –¥–ª—è —ç–∫–æ–Ω–æ–º–∏–∏ –º–µ—Å—Ç–∞
        path := fmt.Sprintf("%s_%s.webp", filename, sizeName)
        err = s.uploadToMinio(ctx, resized, path)
        if err != nil {
            return err
        }
    }
    
    return nil
}
```

#### 3.2 –í–∏—Ä—Ç—É–∞–ª–∏–∑–∞—Ü–∏—è —Å–ø–∏—Å–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π
```typescript
import { VariableSizeList } from 'react-window';

const VirtualizedChat: React.FC = () => {
  const messages = useAppSelector(selectChatMessages);
  const listRef = useRef<VariableSizeList>(null);
  
  // –ö–µ—à –≤—ã—Å–æ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π
  const rowHeights = useRef<{[key: string]: number}>({});
  
  const getRowHeight = (index: number) => {
    return rowHeights.current[messages[index].id] || 100;
  };
  
  const setRowHeight = (index: number, height: number) => {
    if (rowHeights.current[messages[index].id] !== height) {
      rowHeights.current[messages[index].id] = height;
      listRef.current?.resetAfterIndex(index);
    }
  };
  
  return (
    <VariableSizeList
      ref={listRef}
      height={600}
      itemCount={messages.length}
      itemSize={getRowHeight}
      width="100%"
      overscanCount={5}
    >
      {({index, style}) => (
        <div style={style}>
          <MessageRow 
            message={messages[index]} 
            onHeightChange={(height) => setRowHeight(index, height)}
          />
        </div>
      )}
    </VariableSizeList>
  );
};
```

### –§–∞–∑–∞ 4: –£–ª—É—á—à–µ–Ω–∏–µ UX (1-2 –Ω–µ–¥–µ–ª–∏)

#### 4.1 –ó–≤—É–∫–æ–≤—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
```typescript
// –î–æ–±–∞–≤–∏—Ç—å –≤ ChatContext
const playNotificationSound = useCallback(() => {
  if (!userSettings.soundEnabled) return;
  
  const audio = new Audio('/notification.mp3');
  audio.volume = 0.5;
  audio.play().catch(console.error);
}, [userSettings.soundEnabled]);

// –í –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–µ –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
useEffect(() => {
  const handleNewMessage = (message: Message) => {
    if (message.sender_id !== currentUserId && !document.hasFocus()) {
      playNotificationSound();
      
      // Push —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –µ—Å–ª–∏ —Ä–∞–∑—Ä–µ—à–µ–Ω–æ
      if (Notification.permission === 'granted') {
        new Notification(`–ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç ${message.sender_name}`, {
          body: message.content.substring(0, 100),
          icon: '/logo192.png',
        });
      }
    }
  };
  
  chatService.on('new_message', handleNewMessage);
  return () => chatService.off('new_message', handleNewMessage);
}, [currentUserId, playNotificationSound]);
```

#### 4.2 –°—Ç–∞—Ç—É—Å—ã –¥–æ—Å—Ç–∞–≤–∫–∏ –∏ –ø—Ä–æ—á—Ç–µ–Ω–∏—è
```typescript
// –ö–æ–º–ø–æ–Ω–µ–Ω—Ç —Å—Ç–∞—Ç—É—Å–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
const MessageStatus: React.FC<{message: Message}> = ({message}) => {
  if (message.sender_id !== currentUserId) return null;
  
  return (
    <div className="text-xs text-base-content/60 mt-1">
      {message.is_read ? (
        <span className="flex items-center gap-1">
          <CheckCheck className="w-4 h-4 text-primary" />
          {message.read_at && formatTime(message.read_at)}
        </span>
      ) : message.delivered_at ? (
        <span className="flex items-center gap-1">
          <Check className="w-4 h-4" />
          –î–æ—Å—Ç–∞–≤–ª–µ–Ω–æ
        </span>
      ) : (
        <span className="flex items-center gap-1">
          <Clock className="w-4 h-4" />
          –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è...
        </span>
      )}
    </div>
  );
};
```

#### 4.3 –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —á–µ—Ä–Ω–æ–≤–∏–∫–æ–≤
```typescript
// Hook –¥–ª—è –∞–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —á–µ—Ä–Ω–æ–≤–∏–∫–æ–≤
const useDraftMessage = (chatId: string) => {
  const [draft, setDraft] = useState('');
  const draftKey = `chat_draft_${chatId}`;
  
  // –ó–∞–≥—Ä—É–∂–∞–µ–º —á–µ—Ä–Ω–æ–≤–∏–∫ –ø—Ä–∏ –º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏
  useEffect(() => {
    const saved = localStorage.getItem(draftKey);
    if (saved) setDraft(saved);
  }, [chatId]);
  
  // –°–æ—Ö—Ä–∞–Ω—è–µ–º —á–µ—Ä–Ω–æ–≤–∏–∫ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏
  const updateDraft = useDebouncedCallback((text: string) => {
    if (text.trim()) {
      localStorage.setItem(draftKey, text);
    } else {
      localStorage.removeItem(draftKey);
    }
  }, 500);
  
  const clearDraft = () => {
    setDraft('');
    localStorage.removeItem(draftKey);
  };
  
  return {draft, setDraft: (text: string) => {
    setDraft(text);
    updateDraft(text);
  }, clearDraft};
};
```

### –§–∞–∑–∞ 5: –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è (2-3 –Ω–µ–¥–µ–ª–∏)

#### 5.1 –¢–∏–ø—ã —Å–æ–æ–±—â–µ–Ω–∏–π –∏ rich content
```typescript
enum MessageType {
  TEXT = 'text',
  IMAGE = 'image',
  VIDEO = 'video',
  DOCUMENT = 'document',
  VOICE = 'voice',
  LOCATION = 'location',
  PRODUCT = 'product', // –°—Å—ã–ª–∫–∞ –Ω–∞ —Ç–æ–≤–∞—Ä
  SYSTEM = 'system'
}

// –ö–æ–º–ø–æ–Ω–µ–Ω—Ç –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤ –∫–æ–Ω—Ç–µ–Ω—Ç–∞
const MessageContent: React.FC<{message: Message}> = ({message}) => {
  switch (message.type) {
    case MessageType.PRODUCT:
      return <ProductPreview productId={message.metadata.product_id} />;
      
    case MessageType.LOCATION:
      return <LocationMap coords={message.metadata.coordinates} />;
      
    case MessageType.VOICE:
      return <VoicePlayer url={message.content} duration={message.metadata.duration} />;
      
    default:
      return <TextMessage content={message.content} />;
  }
};
```

#### 5.2 –û—Ñ—Ñ–ª–∞–π–Ω –ø–æ–¥–¥–µ—Ä–∂–∫–∞ —Å Service Worker
```typescript
// service-worker.ts
import { precacheAndRoute } from 'workbox-precaching';
import { registerRoute } from 'workbox-routing';
import { StaleWhileRevalidate, NetworkFirst } from 'workbox-strategies';

// –ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç–∞—Ç–∏–∫–∏
precacheAndRoute(self.__WB_MANIFEST);

// –ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ API –∑–∞–ø—Ä–æ—Å–æ–≤ —á–∞—Ç–æ–≤
registerRoute(
  ({url}) => url.pathname.startsWith('/api/v1/marketplace/chat'),
  new NetworkFirst({
    cacheName: 'chat-cache',
    plugins: [
      {
        cacheWillUpdate: async ({response}) => {
          // –ö–µ—à–∏—Ä—É–µ–º —Ç–æ–ª—å–∫–æ —É—Å–ø–µ—à–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã
          if (response && response.status === 200) {
            return response;
          }
          return null;
        }
      }
    ]
  })
);

// –û—á–µ—Ä–µ–¥—å –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π –æ—Ñ—Ñ–ª–∞–π–Ω
const messageQueue = [];

self.addEventListener('fetch', (event) => {
  if (event.request.url.includes('/messages') && event.request.method === 'POST') {
    event.respondWith(
      fetch(event.request.clone()).catch(() => {
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –æ—á–µ—Ä–µ–¥—å –µ—Å–ª–∏ –æ—Ñ—Ñ–ª–∞–π–Ω
        return event.request.json().then(body => {
          messageQueue.push({
            url: event.request.url,
            body,
            headers: Object.fromEntries(event.request.headers)
          });
          
          // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Ñ–µ–π–∫–æ–≤—ã–π —É—Å–ø–µ—à–Ω—ã–π –æ—Ç–≤–µ—Ç
          return new Response(JSON.stringify({
            success: true,
            data: {...body, id: `temp_${Date.now()}`, pending: true}
          }));
        });
      })
    );
  }
});

// –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
self.addEventListener('sync', (event) => {
  if (event.tag === 'sync-messages') {
    event.waitUntil(
      Promise.all(
        messageQueue.map(req => 
          fetch(req.url, {
            method: 'POST',
            headers: req.headers,
            body: JSON.stringify(req.body)
          })
        )
      ).then(() => {
        messageQueue.length = 0;
      })
    );
  }
});
```

## –ú–µ—Ç—Ä–∏–∫–∏ —É—Å–ø–µ—Ö–∞

### –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:
- **0 –∏–Ω—Ü–∏–¥–µ–Ω—Ç–æ–≤** —Å –Ω–µ—Å–∞–Ω–∫—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–º –¥–æ—Å—Ç—É–ø–æ–º –∫ —Ñ–∞–π–ª–∞–º
- **100% —Ñ–∞–π–ª–æ–≤** –ø—Ä–æ–≤–µ—Ä–µ–Ω—ã –∞–Ω—Ç–∏–≤–∏—Ä—É—Å–æ–º –ø–µ—Ä–µ–¥ –¥–æ—Å—Ç—É–ø–æ–º

### –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:
- **60-80% —Å–Ω–∏–∂–µ–Ω–∏–µ** —Ä–∞–∑–º–µ—Ä–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π —á–µ—Ä–µ–∑ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—é
- **<100ms** –≤—Ä–µ–º—è –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
- **<2s** –≤—Ä–µ–º—è –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏ —á–∞—Ç–∞

### –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –æ–ø—ã—Ç:
- **95%+ —Å–æ–æ–±—â–µ–Ω–∏–π** –¥–æ—Å—Ç–∞–≤–ª—è—é—Ç—Å—è –≤ —Ç–µ—á–µ–Ω–∏–µ 1 —Å–µ–∫—É–Ω–¥—ã
- **30% —É–≤–µ–ª–∏—á–µ–Ω–∏–µ** –≤—Ä–µ–º–µ–Ω–∏ –≤ —á–∞—Ç–∞—Ö
- **50% —Å–Ω–∏–∂–µ–Ω–∏–µ** –∂–∞–ª–æ–± –Ω–∞ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å —á–∞—Ç–æ–≤

### –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –º–µ—Ç—Ä–∏–∫–∏:
- **90%+ –ø–æ–∫—Ä—ã—Ç–∏–µ** —Ç–µ—Å—Ç–∞–º–∏ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö —Ñ—É–Ω–∫—Ü–∏–π
- **0 –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö** —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—è—Ö
- **<5% CPU** –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø—Ä–∏ 1000 –∞–∫—Ç–∏–≤–Ω—ã—Ö —á–∞—Ç–∞—Ö

## –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

### –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ (Sprint 1):
1. ‚úÖ –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å —Ñ–∞–π–ª–æ–≤ —á–µ—Ä–µ–∑ presigned URLs
2. ‚úÖ –ë–∞–∑–æ–≤–∞—è –∞–Ω—Ç–∏–≤–∏—Ä—É—Å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞

### –í—ã—Å–æ–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç (Sprint 2-3):
1. –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ —É–¥–∞–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π
2. –†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤ 
3. –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
4. –ó–≤—É–∫–æ–≤—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è

### –°—Ä–µ–¥–Ω–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç (Sprint 4-5):
1. –ü–æ–∏—Å–∫ –ø–æ —Å–æ–æ–±—â–µ–Ω–∏—è–º
2. –í–∏—Ä—Ç—É–∞–ª–∏–∑–∞—Ü–∏—è –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
3. –°—Ç–∞—Ç—É—Å—ã –¥–æ—Å—Ç–∞–≤–∫–∏/–ø—Ä–æ—á—Ç–µ–Ω–∏—è
4. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —á–µ—Ä–Ω–æ–≤–∏–∫–æ–≤

### –ù–∏–∑–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç (Backlog):
1. Rich —Ç–∏–ø—ã —Å–æ–æ–±—â–µ–Ω–∏–π
2. –û—Ñ—Ñ–ª–∞–π–Ω –ø–æ–¥–¥–µ—Ä–∂–∫–∞
3. –ì–æ–ª–æ—Å–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
4. End-to-end —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ

## –¢–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π —Å—Ç–µ–∫

### Backend:
- **–û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π**: `github.com/disintegration/imaging`
- **–ê–Ω—Ç–∏–≤–∏—Ä—É—Å**: ClamAV + `github.com/dutchcoders/go-clamd`
- **–û—á–µ—Ä–µ–¥–∏ –∑–∞–¥–∞—á**: Redis + `github.com/hibiken/asynq`
- **–ü–æ–ª–Ω–æ—Ç–µ–∫—Å—Ç–æ–≤—ã–π –ø–æ–∏—Å–∫**: PostgreSQL FTS

### Frontend (svetu):
- **–í–∏—Ä—Ç—É–∞–ª–∏–∑–∞—Ü–∏—è**: `react-window`
- **Service Workers**: `workbox`
- **–°–æ—Å—Ç–æ—è–Ω–∏–µ**: Redux Toolkit (—É–∂–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è)
- **UI –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã**: DaisyUI + Tailwind CSS
- **WebSocket**: –Ω–∞—Ç–∏–≤–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è (—É–∂–µ –µ—Å—Ç—å)

## –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

–°–∏—Å—Ç–µ–º–∞ —á–∞—Ç–æ–≤ –≤ –Ω–æ–≤–æ–º —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–µ (svetu) –∏–º–µ–µ—Ç —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—É—é –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É –∏ —Ö–æ—Ä–æ—à—É—é –æ—Å–Ω–æ–≤—É. –û—Å–Ω–æ–≤–Ω—ã–µ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã:
1. –£—Å—Ç—Ä–∞–Ω–∏—Ç—å –∫—Ä–∏—Ç–∏—á–µ—Å–∫—É—é –ø—Ä–æ–±–ª–µ–º—É –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ —Å –ø—É–±–ª–∏—á–Ω—ã–º –¥–æ—Å—Ç—É–ø–æ–º –∫ —Ñ–∞–π–ª–∞–º
2. –î–æ–±–∞–≤–∏—Ç—å –±–∞–∑–æ–≤—ã–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª –∏–∑ —Å—Ç–∞—Ä–æ–≥–æ —Ñ—Ä–æ–Ω—Ç–∞ (—Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤)
3. –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å must-have —Ñ—É–Ω–∫—Ü–∏–∏ (—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ, –ø–æ–∏—Å–∫)
4. –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –¥–ª—è –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è

–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–Ω—ã–π –ø–ª–∞–Ω –ø–æ–∑–≤–æ–ª–∏—Ç —Å–æ–∑–¥–∞—Ç—å —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—É—é, –±–µ–∑–æ–ø–∞—Å–Ω—É—é –∏ —É–¥–æ–±–Ω—É—é —Å–∏—Å—Ç–µ–º—É —á–∞—Ç–æ–≤, —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â—É—é –ª—É—á—à–∏–º –ø—Ä–∞–∫—Ç–∏–∫–∞–º.

**–û–±—â–µ–µ –≤—Ä–µ–º—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏**: 8-12 –Ω–µ–¥–µ–ª—å
**–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º–∞—è –∫–æ–º–∞–Ω–¥–∞**: 1-2 backend + 1-2 frontend —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞