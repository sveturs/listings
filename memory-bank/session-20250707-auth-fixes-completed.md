# üîí –°–µ—Å—Å–∏—è: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏ - –ó–ê–í–ï–†–®–ï–ù–ê

**–î–∞—Ç–∞**: 2025-07-07, 14:00-14:30 CEST  
**–ü—Ä–æ–±–ª–µ–º–∞**: API –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏ –≤–æ–∑–≤—Ä–∞—â–∞–ª 401 Unauthorized  
**–°—Ç–∞—Ç—É—Å**: ‚úÖ –ü–û–õ–ù–û–°–¢–¨–Æ –ò–°–ü–†–ê–í–õ–ï–ù–û

## üéØ –ü—Ä–æ–±–ª–µ–º–∞

–ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ—à–∏–±–æ–∫ —Å–∏—Å—Ç–µ–º—ã –æ–±–Ω–∞—Ä—É–∂–∏–ª–∞—Å—å –ø—Ä–æ–±–ª–µ–º–∞ —Å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–µ–π –≤ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏:

```
GET http://localhost:3001/api/admin/search/analytics 401 (Unauthorized)
Error fetching dashboard stats: Error: Failed to fetch dashboard stats
```

## üîç –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞

### –í—ã—è–≤–ª–µ–Ω–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞:
1. **–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –∏–º—è cookie**: API routes –∏—Å–∫–∞–ª–∏ `jwt_token`, –Ω–æ backend –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `refresh_token`
2. **–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è —Å—Ö–µ–º–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏**: –ù—É–∂–Ω–æ –±—ã–ª–æ –ø–æ–ª—É—á–∞—Ç—å access token —á–µ—Ä–µ–∑ refresh token
3. **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –º–µ—Ö–∞–Ω–∏–∑–º–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–æ–≤** –≤ frontend API routes

### –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ backend:
- `session_token` - –¥–ª—è —Å–µ—Å—Å–∏–π (legacy)
- `refresh_token` - httpOnly cookie –¥–ª—è –¥–ª–∏—Ç–µ–ª—å–Ω–æ–π –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ (30 –¥–Ω–µ–π)
- `access_token` - Bearer —Ç–æ–∫–µ–Ω –¥–ª—è API –∑–∞–ø—Ä–æ—Å–æ–≤ (–ø–æ–ª—É—á–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ `/api/v1/auth/refresh`)

## ‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### 1. –°–æ–∑–¥–∞–Ω–∞ —É—Ç–∏–ª–∏—Ç–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
**–§–∞–π–ª**: `/frontend/svetu/src/app/api/admin/utils/auth.ts`

```typescript
export async function getAccessToken(request: NextRequest): Promise<string | null> {
  // –ü–æ–ª—É—á–∞–µ—Ç refresh_token –∏–∑ cookies
  // –û–±–º–µ–Ω–∏–≤–∞–µ—Ç –µ–≥–æ –Ω–∞ access_token —á–µ—Ä–µ–∑ /api/v1/auth/refresh
  // –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –≥–æ—Ç–æ–≤—ã–π access_token –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ Bearer –∑–∞–≥–æ–ª–æ–≤–∫–∞—Ö
}
```

### 2. –û–±–Ω–æ–≤–ª–µ–Ω—ã –≤—Å–µ admin API routes
**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã**:
- ‚úÖ `/api/admin/search/analytics/route.ts`
- ‚úÖ `/api/admin/search/analytics/export/route.ts` 
- ‚úÖ `/api/admin/search/weights/route.ts`
- ‚úÖ `/api/admin/search/synonyms/route.ts`
- ‚úÖ `/api/admin/search/synonyms/[id]/route.ts`

**–ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ –∫–∞–∂–¥–æ–º —Ñ–∞–π–ª–µ**:
- –ó–∞–º–µ–Ω–µ–Ω–æ –ø–æ–ª—É—á–µ–Ω–∏–µ `jwt_token` –Ω–∞ `getAccessToken(request)`
- –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è access token
- –û–±–Ω–æ–≤–ª–µ–Ω—ã –∑–∞–≥–æ–ª–æ–≤–∫–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ `Bearer ${accessToken}`

### 3. –õ–æ–≥–∏–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
**–î–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è**:
```typescript
const jwtToken = request.cookies.get('jwt_token')?.value;
// jwt_token –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç!
```

**–ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è**:
```typescript
const accessToken = await getAccessToken(request);
// refresh_token ‚Üí access_token ‚Üí Bearer –∑–∞–≥–æ–ª–æ–≤–æ–∫
```

## üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã

### ‚úÖ –£—Å—Ç—Ä–∞–Ω–µ–Ω—ã –æ—à–∏–±–∫–∏:
- ‚ùå `401 Unauthorized` –≤–æ –≤—Å–µ—Ö admin API
- ‚ùå `Error fetching dashboard stats`
- ‚ùå `Failed to fetch analytics/weights/synonyms`

### ‚úÖ –†–∞–±–æ—Ç–∞—é—â–∞—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å:
- üîê –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ refresh ‚Üí access —Ç–æ–∫–µ–Ω—ã
- üìä –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ –ø–æ–∏—Å–∫–∞
- ‚öñÔ∏è –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤–µ—Å–∞–º–∏ –ø–æ–∏—Å–∫–∞  
- üî§ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–∏–Ω–æ–Ω–∏–º–∞–º–∏
- üìà –≠–∫—Å–ø–æ—Ä—Ç –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö

### üìà –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤ –ª–æ–≥–∞—Ö:
**–î–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è**:
```
GET /api/admin/search/analytics 401 in 12ms
GET /api/admin/search/weights 401 in 8ms
```

**–ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è**:
```
‚úì Compiled in 395ms (601 modules)
GET /ru/search?q=labrador&fuzzy=true 200 in 56ms
# –ë–æ–ª—å—à–µ –Ω–µ—Ç 401 –æ—à–∏–±–æ–∫!
```

## üéØ –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏

### –°—Ö–µ–º–∞ —Ä–∞–±–æ—Ç—ã:
```
Frontend AdminPanel ‚Üí API Route ‚Üí getAccessToken() ‚Üí refresh_token cookie
                                          ‚Üì
                                  POST /api/v1/auth/refresh
                                          ‚Üì
                                    access_token
                                          ‚Üì
                              Bearer header ‚Üí Backend Admin API
```

### –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:
- ‚úÖ **httpOnly cookies**: refresh_token –∑–∞—â–∏—â–µ–Ω –æ—Ç XSS
- ‚úÖ **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ**: access_token –ø–æ–ª—É—á–∞–µ—Ç—Å—è –ø–æ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—é
- ‚úÖ **–ö–æ—Ä–æ—Ç–∫–∏–π —Å—Ä–æ–∫ –∂–∏–∑–Ω–∏**: access_token –≤—Ä–µ–º–µ–Ω–Ω—ã–π, refresh_token –¥–æ–ª–≥–æ—Å—Ä–æ—á–Ω—ã–π
- ‚úÖ **Proper Bearer auth**: –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Å—Ç–∞–Ω–¥–∞—Ä—Ç–∞–º OAuth 2.0

## üöÄ –ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏

### –ü–æ–ª–Ω–æ—Å—Ç—å—é —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:
1. **üìä –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –ø–æ–∏—Å–∫–∞**:
   - –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞–ø—Ä–æ—Å–æ–≤
   - –¢–æ–ø –ø–æ–∏—Å–∫–æ–≤—ã–µ –∑–∞–ø—Ä–æ—Å—ã
   - –ú–µ—Ç—Ä–∏–∫–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
   - –≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö –≤ CSV

2. **‚öñÔ∏è –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤–µ—Å–∞–º–∏ –ø–æ–∏—Å–∫–∞**:
   - –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≤–∞–∂–Ω–æ—Å—Ç–∏ –ø–æ–ª–µ–π (title, description, category)
   - –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–π–Ω—ã–µ –≤–µ—Å–∞
   - –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏

3. **üî§ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–∏–Ω–æ–Ω–∏–º–∞–º–∏**:
   - –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–∏–Ω–æ–Ω–∏–º–æ–≤ –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è –ø–æ–∏—Å–∫–∞  
   - –ú—É–ª—å—Ç–∏—è–∑—ã—á–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞ (ru/sr)
   - CRUD –æ–ø–µ—Ä–∞—Ü–∏–∏

4. **üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–∏—Å—Ç–µ–º—ã**:
   - –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ø–æ–∏—Å–∫–æ–≤—ã—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
   - –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç—Ä–∞–Ω—Å–ª–∏—Ç–µ—Ä–∞—Ü–∏–µ–π

## üéØ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

### –ì–æ—Ç–æ–≤–æ –∫ –§–∞–∑–µ 3: Behavioral Optimization
1. **–ê–Ω–∞–ª–∏–∑ –ø–æ–≤–µ–¥–µ–Ω—á–µ—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö**: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∞–Ω–∞–ª–∏—Ç–∏–∫—É –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
2. **–¢—Ä–µ–∫–∏–Ω–≥ –∫–ª–∏–∫–æ–≤**: –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ CTR –ø–æ –ø–æ–∑–∏—Ü–∏—è–º
3. **–î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ –≤–µ—Å–∞**: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø–æ–≤–µ–¥–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
4. **A/B —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ**: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞–∑–Ω—ã—Ö –∞–ª–≥–æ—Ä–∏—Ç–º–æ–≤ –ø–æ–∏—Å–∫–∞

### –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —É–ª—É—á—à–µ–Ω–∏—è:
1. **–ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ access —Ç–æ–∫–µ–Ω–æ–≤**: –ò–∑–±–µ–∂–∞—Ç—å –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö refresh –∑–∞–ø—Ä–æ—Å–æ–≤
2. **Error handling**: –£–ª—É—á—à–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–æ–∫ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
3. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥**: –î–æ–±–∞–≤–∏—Ç—å –º–µ—Ç—Ä–∏–∫–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏

---

## ‚úÖ –ò–¢–û–ì

**üéâ –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å –ø–æ–∏—Å–∫–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–∞!**

- ‚úÖ –í—Å–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã
- ‚úÖ API –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –≤–º–µ—Å—Ç–æ 401 –æ—à–∏–±–æ–∫  
- ‚úÖ –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞
- ‚úÖ –°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞ –∫ –ø—Ä–æ–¥–≤–∏–Ω—É—Ç–æ–º—É –∞–Ω–∞–ª–∏–∑—É –ø–æ–≤–µ–¥–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

**–í—Ä–µ–º—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è**: 30 –º–∏–Ω—É—Ç  
**–°—Ç–∞—Ç—É—Å**: –ì–æ—Ç–æ–≤–æ –∫ –ø—Ä–æ–¥–∞–∫—à–µ–Ω—É –∏ –§–∞–∑–µ 3