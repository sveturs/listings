# Miscellaneous Handlers

Дополнительные обработчики, не входящие в основные категории системы.

## 1. DocServer Handler

**Путь**: `/internal/proj/docserver/handler/`

### Назначение
Обработчик для предоставления документации системы через API. Позволяет администраторам получать доступ к markdown файлам документации.

### Основные эндпоинты

#### GET /api/v1/docs/files
- **Описание**: Получение иерархического списка markdown файлов
- **Требования**: Авторизация + права администратора
- **Безопасность**: Фильтрация скрытых и системных директорий
- **Ответ**: Структура файлов и папок с документацией

#### GET /api/v1/docs/content
- **Описание**: Получение содержимого конкретного markdown файла
- **Параметры**: `path` - путь к файлу относительно корня документации
- **Требования**: Авторизация + права администратора
- **Безопасность**: 
  - Защита от directory traversal атак
  - Доступ только к .md файлам
- **Ответ**: Содержимое markdown файла

### Особенности безопасности
- Строгая проверка путей для предотвращения доступа за пределы разрешенной директории
- Фильтрация системных и служебных директорий (node_modules, .git, etc.)
- Доступ только для администраторов

### Конфигурация
```go
type DocsConfig struct {
    RootPath string // Путь к корневой директории документации
}
```

## 2. Geocode Handler

**Путь**: `/internal/proj/geocode/handler/`

### Назначение
Обработчик для геокодирования - преобразования координат в адреса и поиска городов для автодополнения.

### Основные эндпоинты

#### GET /api/v1/geocode/reverse
- **Описание**: Обратное геокодирование - получение адреса по координатам
- **Параметры**: 
  - `lat` (float64) - широта
  - `lon` (float64) - долгота
- **Требования**: Нет (публичный эндпоинт)
- **Ответ**: Объект GeoLocation с адресом

#### GET /api/v1/geocode/cities
- **Описание**: Поиск городов для автодополнения
- **Параметры**:
  - `q` (string) - поисковый запрос (мин. 2 символа)
  - `limit` (int) - максимальное количество результатов (по умолчанию 10)
- **Требования**: Нет (публичный эндпоинт)
- **Ответ**: Массив объектов GeoLocation

### Интеграция
- Используется сервис геокодирования для работы с внешними API
- Результаты могут кешироваться для оптимизации

### Модель данных
```go
type GeoLocation struct {
    City      string
    Country   string
    Latitude  float64
    Longitude float64
    // другие поля...
}
```

## 3. Global Handler (Unified Search)

**Путь**: `/internal/proj/global/handler/`

### Назначение
Глобальный обработчик для унифицированного поиска по всем типам товаров в системе (marketplace и storefront).

### Основные эндпоинты

#### GET /api/v1/search
- **Описание**: Унифицированный поиск по всем типам товаров
- **Параметры**:
  - `query` - поисковый запрос
  - `product_types[]` - типы товаров ["marketplace", "storefront"]
  - `page` - номер страницы (по умолчанию 1)
  - `limit` - количество результатов (по умолчанию 20, макс 100)
  - `category_id` - фильтр по категории
  - `price_min`, `price_max` - фильтры по цене
  - `sort_by` - поле сортировки (relevance, price, date, popularity)
  - `sort_order` - порядок сортировки (asc, desc)
  - `storefront_id` - фильтр по конкретной витрине
  - `city` - фильтр по городу
  - `language` - язык (по умолчанию "ru")
- **Требования**: Нет (публичный эндпоинт)
- **Ответ**: Унифицированные результаты поиска

### Особенности реализации

#### Архитектура поиска
1. Параллельный поиск в разных источниках:
   - Marketplace (через OpenSearch)
   - Storefront (через OpenSearch) - в разработке
2. Объединение и сортировка результатов
3. Единая пагинация для всех результатов

#### Унифицированный формат данных
```go
type UnifiedSearchItem struct {
    ID          string  // Уникальный ID (ml_123 или sp_456)
    ProductType string  // "marketplace" или "storefront"
    ProductID   int
    Name        string
    Description string
    Price       float64
    Currency    string
    Images      []UnifiedProductImage
    Category    UnifiedCategoryInfo
    Location    *UnifiedLocationInfo
    Storefront  *UnifiedStorefrontInfo // Только для storefront товаров
    Score       float64
    Highlights  map[string][]string
}
```

#### Производительность
- Поддержка как JSON body, так и query параметров
- Ограничение результатов (макс 100 на страницу)
- Отслеживание времени выполнения (took_ms)
- Возможность фильтрации по типам товаров

### Интеграции
- OpenSearch для полнотекстового поиска
- Сервисы marketplace и storefront для получения данных
- Возможность расширения на другие типы товаров

## Архитектурные особенности

### Модульная структура
Все обработчики организованы по модулям в директории `/internal/proj/`:
- Каждый модуль имеет собственную структуру: `handler/`, `service/`, `storage/`
- Обработчики регистрируются через единый интерфейс `RouteRegistrar`

### Безопасность
- Middleware для аутентификации и авторизации
- Валидация входных данных
- Защита от common web vulnerabilities (directory traversal, injection)

### Масштабируемость
- Унифицированный поиск готов к добавлению новых типов товаров
- Модульная архитектура позволяет легко добавлять новые обработчики
- Использование интерфейсов для слабой связанности компонентов