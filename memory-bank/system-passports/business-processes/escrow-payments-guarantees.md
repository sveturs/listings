# –ü–∞—Å–ø–æ—Ä—Ç –±–∏–∑–Ω–µ—Å-–ø—Ä–æ—Ü–µ—Å—Å–∞: Escrow –ø–ª–∞—Ç–µ–∂–∏ –∏ –≥–∞—Ä–∞–Ω—Ç–∏–∏

## üéØ –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ –ø—Ä–æ—Ü–µ—Å—Å–∞

–û–±–µ—Å–ø–µ—á–µ–Ω–∏–µ –±–µ–∑–æ–ø–∞—Å–Ω—ã—Ö —Å–¥–µ–ª–æ–∫ –º–µ–∂–¥—É –ø–æ–∫—É–ø–∞—Ç–µ–ª—è–º–∏ –∏ –ø—Ä–æ–¥–∞–≤—Ü–∞–º–∏ —á–µ—Ä–µ–∑ —Å–∏—Å—Ç–µ–º—É —ç—Å–∫—Ä–æ—É-—Å—á–µ—Ç–æ–≤, –∫–æ—Ç–æ—Ä–∞—è —É–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Å—Ä–µ–¥—Å—Ç–≤–∞ –¥–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–∞, —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º –∞—Ä–±–∏—Ç—Ä–∞–∂–µ–º —Å–ø–æ—Ä–æ–≤ –∏ –∑–∞—â–∏—Ç–æ–π –∏–Ω—Ç–µ—Ä–µ—Å–æ–≤ –≤—Å–µ—Ö —Å—Ç–æ—Ä–æ–Ω.

## üîÑ –°—Ö–µ–º–∞ –ø—Ä–æ—Ü–µ—Å—Å–∞

### 1. **–°–æ–∑–¥–∞–Ω–∏–µ —ç—Å–∫—Ä–æ—É-—Å—á–µ—Ç–∞**
```mermaid
graph LR
    A[–£—Å–ø–µ—à–Ω–∞—è –æ–ø–ª–∞—Ç–∞] --> B[–°–æ–∑–¥–∞–Ω–∏–µ —ç—Å–∫—Ä–æ—É-—Å—á–µ—Ç–∞]
    B --> C[–ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ —Å—Ä–µ–¥—Å—Ç–≤]
    C --> D[–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø—Ä–æ–¥–∞–≤—Ü–∞]
    D --> E[–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø–æ–∫—É–ø–∞—Ç–µ–ª—è]
    E --> F[–ê–∫—Ç–∏–≤–∞—Ü–∏—è –∑–∞—â–∏—Ç—ã]
    F --> G[–°—Ç–∞—Ç—É—Å: funds_secured]
```

### 2. **–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —ç—Å–∫—Ä–æ—É-—Å—á–µ—Ç–æ–º**
```mermaid
graph TD
    A[–°—Ä–µ–¥—Å—Ç–≤–∞ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω—ã] --> B[–ü–µ—Ä–∏–æ–¥ –±–µ–∑–æ–ø–∞—Å–Ω–æ–π —Å–¥–µ–ª–∫–∏]
    B --> C{–î–µ–π—Å—Ç–≤–∏–µ –ø–æ–∫—É–ø–∞—Ç–µ–ª—è}
    C -->|–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ø–æ–ª—É—á–µ–Ω–∏—è| D[–û—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏–µ —Å—Ä–µ–¥—Å—Ç–≤]
    C -->|–û—Ç–∫—Ä—ã—Ç–∏–µ —Å–ø–æ—Ä–∞| E[–ê—Ä–±–∏—Ç—Ä–∞–∂]
    C -->|–ù–µ—Ç –¥–µ–π—Å—Ç–≤–∏–π| F[–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ç–∞–π–º–µ—Ä]
    
    D --> G[–ü–µ—Ä–µ–≤–æ–¥ –ø—Ä–æ–¥–∞–≤—Ü—É]
    E --> H[–†–∞—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ —Å–ø–æ—Ä–∞]
    F --> I{–¢–∞–π–º–∞—É—Ç –Ω–∞—Å—Ç—Ä–æ–µ–∫}
    
    H --> J{–†–µ—à–µ–Ω–∏–µ –∞—Ä–±–∏—Ç—Ä–∞}
    I -->|–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π| K[–ê–≤—Ç–æ–æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏–µ]
    I -->|–í—ã—Å–æ–∫–∏–π —Ä–∏—Å–∫| L[–ó–∞–ø—Ä–æ—Å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è]
    
    J -->|–í –ø–æ–ª—å–∑—É –ø–æ–∫—É–ø–∞—Ç–µ–ª—è| M[–í–æ–∑–≤—Ä–∞—Ç —Å—Ä–µ–¥—Å—Ç–≤]
    J -->|–í –ø–æ–ª—å–∑—É –ø—Ä–æ–¥–∞–≤—Ü–∞| G
    J -->|–ß–∞—Å—Ç–∏—á–Ω—ã–π –≤–æ–∑–≤—Ä–∞—Ç| N[–†–∞–∑–¥–µ–ª–µ–Ω–∏–µ —Å—Ä–µ–¥—Å—Ç–≤]
```

### 3. **–ê—Ä–±–∏—Ç—Ä–∞–∂ –∏ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ —Å–ø–æ—Ä–æ–≤**
```mermaid
graph TD
    A[–û—Ç–∫—Ä—ã—Ç–∏–µ —Å–ø–æ—Ä–∞] --> B[–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑]
    B --> C{–¢–∏–ø —Å–ø–æ—Ä–∞}
    C -->|–ü—Ä–æ—Å—Ç–æ–π| D[–ë—ã—Å—Ç—Ä–æ–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ]
    C -->|–°–ª–æ–∂–Ω—ã–π| E[–†—É—á–Ω–æ–π –∞—Ä–±–∏—Ç—Ä–∞–∂]
    C -->|–ú–æ—à–µ–Ω–Ω–∏—á–µ—Å—Ç–≤–æ| F[–†–∞—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏]
    
    D --> G[–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Ä–µ—à–µ–Ω–∏–µ]
    E --> H[–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ –∞—Ä–±–∏—Ç—Ä–∞]
    F --> I[–ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –∞–∫–∫–∞—É–Ω—Ç–æ–≤]
    
    H --> J[–°–±–æ—Ä –¥–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤]
    J --> K[–ê–Ω–∞–ª–∏–∑ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤]
    K --> L[–ü—Ä–∏–Ω—è—Ç–∏–µ —Ä–µ—à–µ–Ω–∏—è]
    L --> M[–ò—Å–ø–æ–ª–Ω–µ–Ω–∏–µ —Ä–µ—à–µ–Ω–∏—è]
    
    G --> N[–û—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏–µ/–≤–æ–∑–≤—Ä–∞—Ç —Å—Ä–µ–¥—Å—Ç–≤]
    M --> N
    I --> O[–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø—Ä–∞–≤–æ–æ—Ö—Ä–∞–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –æ—Ä–≥–∞–Ω–æ–≤]
```

### 4. **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏–µ —Å—Ä–µ–¥—Å—Ç–≤**
```mermaid
graph LR
    A[–¢–∞–π–º–µ—Ä —ç—Å–∫—Ä–æ—É] --> B[–ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Å–ª–æ–≤–∏–π]
    B --> C{–ï—Å—Ç—å —Å–ø–æ—Ä—ã?}
    C -->|–ù–µ—Ç| D[–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–π—Ç–∏–Ω–≥–∞ –ø—Ä–æ–¥–∞–≤—Ü–∞]
    C -->|–î–∞| E[–£–¥–µ—Ä–∂–∞–Ω–∏–µ –¥–æ —Ä–µ—à–µ–Ω–∏—è]
    
    D --> F{–†–µ–π—Ç–∏–Ω–≥ > 4.5?}
    F -->|–î–∞| G[–ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ–µ –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏–µ]
    F -->|–ù–µ—Ç| H[–û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø–æ–∫—É–ø–∞—Ç–µ–ª—é]
    
    H --> I[–û–∂–∏–¥–∞–Ω–∏–µ 48 —á–∞—Å–æ–≤]
    I --> J[–û—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏–µ –ø–æ —Ç–∞–π–º–∞—É—Ç—É]
```

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

### **Frontend –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã**
- **EscrowStatus** - –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä —Å—Ç–∞—Ç—É—Å–∞ —ç—Å–∫—Ä–æ—É-—Å—á–µ—Ç–∞
- **EscrowTimeline** - –≤—Ä–µ–º–µ–Ω–Ω–∞—è —à–∫–∞–ª–∞ —ç—Ç–∞–ø–æ–≤ —Å–¥–µ–ª–∫–∏
- **DisputeForm** - —Ñ–æ—Ä–º–∞ –æ—Ç–∫—Ä—ã—Ç–∏—è —Å–ø–æ—Ä–∞
- **EscrowActions** - –¥–µ–π—Å—Ç–≤–∏—è –ø–æ–∫—É–ø–∞—Ç–µ–ª—è (–ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å/—Å–ø–æ—Ä)
- **ArbitrageCenter** - —Ü–µ–Ω—Ç—Ä –∞—Ä–±–∏—Ç—Ä–∞–∂–∞ –¥–ª—è –º–æ–¥–µ—Ä–∞—Ç–æ—Ä–æ–≤
- **EscrowHistory** - –∏—Å—Ç–æ—Ä–∏—è –≤—Å–µ—Ö —ç—Å–∫—Ä–æ—É-—Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

### **Backend —Å–µ—Ä–≤–∏—Å—ã**
- **EscrowService** - –æ—Å–Ω–æ–≤–Ω–æ–π —Å–µ—Ä–≤–∏—Å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —ç—Å–∫—Ä–æ—É
- **DisputeService** - —Å–µ—Ä–≤–∏—Å –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–ø–æ—Ä–æ–≤
- **ArbitrageService** - —Å–µ—Ä–≤–∏—Å –∞—Ä–±–∏—Ç—Ä–∞–∂–∞
- **EscrowScheduler** - –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö –¥–µ–π—Å—Ç–≤–∏–π
- **RiskAssessmentService** - –æ—Ü–µ–Ω–∫–∞ —Ä–∏—Å–∫–æ–≤ —Å–¥–µ–ª–æ–∫
- **EscrowNotificationService** - —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø–æ —ç—Å–∫—Ä–æ—É

### **–ë–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö**
- **escrow_accounts** - –æ—Å–Ω–æ–≤–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ —ç—Å–∫—Ä–æ—É-—Å—á–µ—Ç–æ–≤
- **escrow_transactions** - —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –ø–æ —ç—Å–∫—Ä–æ—É-—Å—á–µ—Ç–∞–º
- **disputes** - —Å–ø–æ—Ä—ã –∏ –∏—Ö —Å—Ç–∞—Ç—É—Å—ã
- **arbitrage_cases** - –¥–µ–ª–∞ –∞—Ä–±–∏—Ç—Ä–∞–∂–∞
- **escrow_timers** - —Ç–∞–π–º–µ—Ä—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö –¥–µ–π—Å—Ç–≤–∏–π
- **risk_assessments** - –æ—Ü–µ–Ω–∫–∏ —Ä–∏—Å–∫–æ–≤ —Å–¥–µ–ª–æ–∫

## üîó –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏

### **EscrowService - –æ—Å–Ω–æ–≤–Ω–æ–π —Å–µ—Ä–≤–∏—Å**
```go
type EscrowService struct {
    repository    EscrowRepositoryInterface
    payment       PaymentServiceInterface
    notification  NotificationServiceInterface
    risk          RiskAssessmentServiceInterface
    scheduler     SchedulerInterface
    logger        logger.Logger
    config        *EscrowConfig
}

type EscrowConfig struct {
    DefaultHoldPeriod     time.Duration // 7 –¥–Ω–µ–π –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
    MaxHoldPeriod         time.Duration // 30 –¥–Ω–µ–π –º–∞–∫—Å–∏–º—É–º
    AutoReleaseThreshold  decimal.Decimal // –°—É–º–º–∞ –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏—è
    HighRiskHoldPeriod    time.Duration // 14 –¥–Ω–µ–π –¥–ª—è –≤—ã—Å–æ–∫–æ–≥–æ —Ä–∏—Å–∫–∞
    MinSellerRating       float64       // 4.0 –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π —Ä–µ–π—Ç–∏–Ω–≥ –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏—è
}

// –°–æ–∑–¥–∞–Ω–∏–µ —ç—Å–∫—Ä–æ—É-—Å—á–µ—Ç–∞
func (s *EscrowService) CreateEscrowAccount(ctx context.Context, req CreateEscrowRequest) (*EscrowAccount, error) {
    // 1. –í–∞–ª–∏–¥–∞—Ü–∏—è –ø–ª–∞—Ç–µ–∂–∞
    payment, err := s.payment.GetPayment(ctx, req.PaymentID)
    if err != nil {
        return nil, fmt.Errorf("failed to get payment: %w", err)
    }
    
    if payment.Status != "completed" {
        return nil, errors.New("escrow.paymentNotCompleted")
    }

    // 2. –û—Ü–µ–Ω–∫–∞ —Ä–∏—Å–∫–æ–≤
    riskLevel, err := s.risk.AssessTransactionRisk(ctx, RiskAssessmentRequest{
        BuyerID:     payment.UserID,
        SellerID:    payment.Listing.UserID,
        Amount:      payment.Amount,
        Category:    payment.Listing.Category,
        ListingAge:  time.Since(payment.Listing.CreatedAt),
    })
    if err != nil {
        s.logger.Warn("Risk assessment failed", "error", err)
        riskLevel = "medium" // –ë–µ–∑–æ–ø–∞—Å–Ω—ã–π fallback
    }

    // 3. –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–µ—Ä–∏–æ–¥–∞ —É–¥–µ—Ä–∂–∞–Ω–∏—è
    holdPeriod := s.calculateHoldPeriod(payment, riskLevel)
    releaseDate := time.Now().Add(holdPeriod)

    // 4. –°–æ–∑–¥–∞–Ω–∏–µ —ç—Å–∫—Ä–æ—É-—Å—á–µ—Ç–∞
    escrow := &models.EscrowAccount{
        PaymentID:         payment.ID,
        BuyerID:          payment.UserID,
        SellerID:         payment.Listing.UserID,
        ListingID:        payment.ListingID,
        Amount:           payment.Amount,
        Currency:         payment.Currency,
        Status:           "funds_secured",
        RiskLevel:        riskLevel,
        HoldPeriod:       holdPeriod,
        AutoReleaseDate:  releaseDate,
        CreatedAt:        time.Now(),
    }

    err = s.repository.CreateEscrowAccount(ctx, escrow)
    if err != nil {
        return nil, fmt.Errorf("failed to create escrow account: %w", err)
    }

    // 5. –ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏—è
    err = s.scheduler.ScheduleAutoRelease(ctx, ScheduleRequest{
        EscrowID:    escrow.ID,
        ReleaseDate: releaseDate,
        Action:      "auto_release",
    })
    if err != nil {
        s.logger.Error("Failed to schedule auto release", "escrow_id", escrow.ID, "error", err)
    }

    // 6. –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
    s.sendEscrowNotifications(ctx, escrow, "created")

    return escrow, nil
}

// –†–∞—Å—á–µ—Ç –ø–µ—Ä–∏–æ–¥–∞ —É–¥–µ—Ä–∂–∞–Ω–∏—è
func (s *EscrowService) calculateHoldPeriod(payment *models.Payment, riskLevel string) time.Duration {
    switch riskLevel {
    case "low":
        return 3 * 24 * time.Hour  // 3 –¥–Ω—è
    case "medium":
        return s.config.DefaultHoldPeriod // 7 –¥–Ω–µ–π
    case "high":
        return s.config.HighRiskHoldPeriod // 14 –¥–Ω–µ–π
    case "critical":
        return s.config.MaxHoldPeriod // 30 –¥–Ω–µ–π
    default:
        return s.config.DefaultHoldPeriod
    }
}
```

### **–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–∞**
```go
// –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ–∫—É–ø–∞—Ç–µ–ª–µ–º
func (s *EscrowService) ConfirmDelivery(ctx context.Context, req ConfirmDeliveryRequest) error {
    // 1. –ü–æ–ª—É—á–µ–Ω–∏–µ —ç—Å–∫—Ä–æ—É-—Å—á–µ—Ç–∞
    escrow, err := s.repository.GetEscrowByID(ctx, req.EscrowID)
    if err != nil {
        return fmt.Errorf("failed to get escrow: %w", err)
    }

    // 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞
    if escrow.BuyerID != req.UserID {
        return errors.New("escrow.accessDenied")
    }

    // 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞
    if escrow.Status != "funds_secured" {
        return errors.New("escrow.invalidStatus")
    }

    // 4. –°–æ–∑–¥–∞–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
    tx := &models.EscrowTransaction{
        EscrowID:    escrow.ID,
        Type:        "buyer_confirmation",
        Amount:      escrow.Amount,
        Status:      "pending",
        Metadata: map[string]interface{}{
            "confirmation_method": req.Method, // "manual" –∏–ª–∏ "automatic"
            "rating":             req.Rating,
            "review":             req.Review,
        },
        CreatedAt: time.Now(),
    }

    err = s.repository.CreateEscrowTransaction(ctx, tx)
    if err != nil {
        return fmt.Errorf("failed to create confirmation transaction: %w", err)
    }

    // 5. –û—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏–µ —Å—Ä–µ–¥—Å—Ç–≤
    err = s.releaseFunds(ctx, escrow.ID, "buyer_confirmed")
    if err != nil {
        return fmt.Errorf("failed to release funds: %w", err)
    }

    return nil
}

// –û—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏–µ —Å—Ä–µ–¥—Å—Ç–≤
func (s *EscrowService) releaseFunds(ctx context.Context, escrowID int64, reason string) error {
    // 1. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ —ç—Å–∫—Ä–æ—É
    err := s.repository.UpdateEscrowStatus(ctx, escrowID, "funds_released")
    if err != nil {
        return fmt.Errorf("failed to update escrow status: %w", err)
    }

    // 2. –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö —ç—Å–∫—Ä–æ—É
    escrow, err := s.repository.GetEscrowByID(ctx, escrowID)
    if err != nil {
        return fmt.Errorf("failed to get escrow: %w", err)
    }

    // 3. –†–∞—Å—á–µ—Ç —Å—É–º–º
    platformCommission := s.calculatePlatformCommission(escrow.Amount)
    sellerAmount := escrow.Amount.Sub(platformCommission)

    // 4. –ü–µ—Ä–µ–≤–æ–¥ —Å—Ä–µ–¥—Å—Ç–≤ –ø—Ä–æ–¥–∞–≤—Ü—É
    err = s.payment.TransferToSeller(ctx, TransferRequest{
        SellerID:  escrow.SellerID,
        Amount:    sellerAmount,
        Currency:  escrow.Currency,
        Reference: fmt.Sprintf("escrow-release-%d", escrowID),
        EscrowID:  escrowID,
    })
    if err != nil {
        // –û—Ç–∫–∞—Ç —Å—Ç–∞—Ç—É—Å–∞ –ø—Ä–∏ –æ—à–∏–±–∫–µ
        s.repository.UpdateEscrowStatus(ctx, escrowID, "funds_secured")
        return fmt.Errorf("failed to transfer to seller: %w", err)
    }

    // 5. –£—á–µ—Ç –∫–æ–º–∏—Å—Å–∏–∏ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã
    err = s.payment.RecordPlatformCommission(ctx, CommissionRequest{
        EscrowID:   escrowID,
        Amount:     platformCommission,
        Currency:   escrow.Currency,
        Type:       "marketplace_fee",
    })
    if err != nil {
        s.logger.Error("Failed to record platform commission", "escrow_id", escrowID, "error", err)
    }

    // 6. –°–æ–∑–¥–∞–Ω–∏–µ —Ñ–∏–Ω–∞–ª—å–Ω–æ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
    finalTx := &models.EscrowTransaction{
        EscrowID:  escrowID,
        Type:      "funds_released",
        Amount:    escrow.Amount,
        Status:    "completed",
        Metadata: map[string]interface{}{
            "reason":              reason,
            "seller_amount":       sellerAmount.String(),
            "platform_commission": platformCommission.String(),
            "released_at":         time.Now().UTC(),
        },
        CreatedAt: time.Now(),
    }

    err = s.repository.CreateEscrowTransaction(ctx, finalTx)
    if err != nil {
        s.logger.Error("Failed to create final transaction", "escrow_id", escrowID, "error", err)
    }

    // 7. –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
    s.sendEscrowNotifications(ctx, escrow, "funds_released")

    return nil
}
```

### **–°–∏—Å—Ç–µ–º–∞ —Å–ø–æ—Ä–æ–≤ –∏ –∞—Ä–±–∏—Ç—Ä–∞–∂–∞**
```go
// –û—Ç–∫—Ä—ã—Ç–∏–µ —Å–ø–æ—Ä–∞
func (s *DisputeService) OpenDispute(ctx context.Context, req OpenDisputeRequest) (*Dispute, error) {
    // 1. –í–∞–ª–∏–¥–∞—Ü–∏—è –∑–∞–ø—Ä–æ—Å–∞
    escrow, err := s.escrowRepo.GetEscrowByID(ctx, req.EscrowID)
    if err != nil {
        return nil, fmt.Errorf("failed to get escrow: %w", err)
    }

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ (—Ç–æ–ª—å–∫–æ –ø–æ–∫—É–ø–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –æ—Ç–∫—Ä—ã—Ç—å —Å–ø–æ—Ä)
    if escrow.BuyerID != req.UserID {
        return nil, errors.New("dispute.accessDenied")
    }

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ —ç—Å–∫—Ä–æ—É
    if escrow.Status != "funds_secured" {
        return nil, errors.New("dispute.invalidEscrowStatus")
    }

    // 2. –°–æ–∑–¥–∞–Ω–∏–µ —Å–ø–æ—Ä–∞
    dispute := &models.Dispute{
        EscrowID:     req.EscrowID,
        InitiatorID:  req.UserID,
        Type:         req.Type, // "not_received", "not_as_described", "damaged", "fraud"
        Title:        req.Title,
        Description:  req.Description,
        Status:       "open",
        Priority:     s.calculateDisputePriority(req.Type, escrow.Amount),
        CreatedAt:    time.Now(),
    }

    err = s.repository.CreateDispute(ctx, dispute)
    if err != nil {
        return nil, fmt.Errorf("failed to create dispute: %w", err)
    }

    // 3. –ó–∞–≥—Ä—É–∑–∫–∞ –¥–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤
    if len(req.Evidence) > 0 {
        for _, evidence := range req.Evidence {
            err = s.uploadEvidence(ctx, dispute.ID, evidence)
            if err != nil {
                s.logger.Error("Failed to upload evidence", "dispute_id", dispute.ID, "error", err)
            }
        }
    }

    // 4. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ —ç—Å–∫—Ä–æ—É
    err = s.escrowRepo.UpdateEscrowStatus(ctx, req.EscrowID, "disputed")
    if err != nil {
        s.logger.Error("Failed to update escrow status to disputed", "escrow_id", req.EscrowID, "error", err)
    }

    // 5. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞
    go s.preprocessDispute(context.Background(), dispute.ID)

    // 6. –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
    s.sendDisputeNotifications(ctx, dispute, "opened")

    return dispute, nil
}

// –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Å–ø–æ—Ä–∞
func (s *DisputeService) preprocessDispute(ctx context.Context, disputeID int64) {
    dispute, err := s.repository.GetDisputeByID(ctx, disputeID)
    if err != nil {
        s.logger.Error("Failed to get dispute for preprocessing", "dispute_id", disputeID, "error", err)
        return
    }

    // –ê–Ω–∞–ª–∏–∑ —Ç–∏–ø–∞ —Å–ø–æ—Ä–∞ –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è
    switch dispute.Type {
    case "not_received":
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞–Ω–Ω—ã—Ö –¥–æ—Å—Ç–∞–≤–∫–∏
        if s.checkDeliveryConfirmation(ctx, dispute.EscrowID) {
            s.autoResolveDispute(ctx, disputeID, "delivery_confirmed", "seller")
        }
    case "not_as_described":
        // –¢—Ä–µ–±—É–µ—Ç —Ä—É—á–Ω–æ–≥–æ –∞—Ä–±–∏—Ç—Ä–∞–∂–∞
        s.escalateToArbitrage(ctx, disputeID)
    case "damaged":
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–æ—Ç–æ –∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ –¥–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤
        if s.analyzeEvidencePhotos(ctx, disputeID) {
            s.autoResolveDispute(ctx, disputeID, "damage_confirmed", "buyer")
        }
    case "fraud":
        // –ù–µ–º–µ–¥–ª–µ–Ω–Ω–∞—è —ç—Å–∫–∞–ª–∞—Ü–∏—è –≤ —Å–ª—É–∂–±—É –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
        s.escalateToSecurity(ctx, disputeID)
    }
}

// –ê—Ä–±–∏—Ç—Ä–∞–∂ —Å–ø–æ—Ä–∞
func (s *ArbitrageService) ProcessArbitrage(ctx context.Context, req ArbitrageRequest) (*ArbitrageDecision, error) {
    // 1. –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ –∞—Ä–±–∏—Ç—Ä–∞
    arbitrator, err := s.assignArbitrator(ctx, req.DisputeID)
    if err != nil {
        return nil, fmt.Errorf("failed to assign arbitrator: %w", err)
    }

    // 2. –°–æ–∑–¥–∞–Ω–∏–µ –¥–µ–ª–∞ –∞—Ä–±–∏—Ç—Ä–∞–∂–∞
    case := &models.ArbitrageCase{
        DisputeID:     req.DisputeID,
        ArbitratorID:  arbitrator.ID,
        Status:        "assigned",
        Priority:      req.Priority,
        AssignedAt:    time.Now(),
        DueDate:       time.Now().Add(48 * time.Hour), // 48 —á–∞—Å–æ–≤ –Ω–∞ —Ä–µ—à–µ–Ω–∏–µ
    }

    err = s.repository.CreateArbitrageCase(ctx, case)
    if err != nil {
        return nil, fmt.Errorf("failed to create arbitrage case: %w", err)
    }

    // 3. –°–±–æ—Ä –≤—Å–µ—Ö –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ –¥–µ–ª–∞
    evidence, err := s.collectEvidenceForCase(ctx, req.DisputeID)
    if err != nil {
        s.logger.Error("Failed to collect evidence", "dispute_id", req.DisputeID, "error", err)
    }

    // 4. –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∞—Ä–±–∏—Ç—Ä–∞
    s.notifyArbitrator(ctx, arbitrator, case, evidence)

    return &ArbitrageDecision{
        CaseID:     case.ID,
        Status:     "in_progress",
        Arbitrator: arbitrator.Name,
        DueDate:    case.DueDate,
    }, nil
}
```

### **Frontend –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è**
```typescript
// Hook –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —ç—Å–∫—Ä–æ—É
export const useEscrowManagement = () => {
  const [escrowState, setEscrowState] = useState<EscrowState>({
    accounts: [],
    loading: false,
    error: null,
  });

  const confirmDelivery = async (escrowId: number, rating?: number, review?: string) => {
    setEscrowState(prev => ({ ...prev, loading: true }));

    try {
      const response = await fetch(`/api/v1/escrow/${escrowId}/confirm-delivery`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          rating,
          review,
          confirmation_method: 'manual',
        }),
      });

      const result = await response.json();
      
      if (!result.success) {
        throw new Error(result.error || 'Failed to confirm delivery');
      }

      // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è
      setEscrowState(prev => ({
        ...prev,
        loading: false,
        accounts: prev.accounts.map(acc => 
          acc.id === escrowId 
            ? { ...acc, status: 'funds_released', confirmed_at: new Date() }
            : acc
        ),
      }));

      toast.success('–ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ! –°—Ä–µ–¥—Å—Ç–≤–∞ –ø–µ—Ä–µ–≤–µ–¥–µ–Ω—ã –ø—Ä–æ–¥–∞–≤—Ü—É.');

    } catch (error) {
      setEscrowState(prev => ({ 
        ...prev, 
        loading: false, 
        error: error.message 
      }));
      toast.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–∏ –ø–æ–ª—É—á–µ–Ω–∏—è');
    }
  };

  const openDispute = async (escrowId: number, disputeData: DisputeData) => {
    setEscrowState(prev => ({ ...prev, loading: true }));

    try {
      const formData = new FormData();
      formData.append('escrow_id', escrowId.toString());
      formData.append('type', disputeData.type);
      formData.append('title', disputeData.title);
      formData.append('description', disputeData.description);

      // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ñ–∞–π–ª–æ–≤ –¥–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤
      disputeData.evidence.forEach((file, index) => {
        formData.append(`evidence_${index}`, file);
      });

      const response = await fetch('/api/v1/disputes/create', {
        method: 'POST',
        body: formData,
      });

      const result = await response.json();
      
      if (!result.success) {
        throw new Error(result.error || 'Failed to open dispute');
      }

      // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è
      setEscrowState(prev => ({
        ...prev,
        loading: false,
        accounts: prev.accounts.map(acc => 
          acc.id === escrowId 
            ? { ...acc, status: 'disputed', dispute_id: result.data.id }
            : acc
        ),
      }));

      toast.success('–°–ø–æ—Ä –æ—Ç–∫—Ä—ã—Ç. –ù–∞—à–∏ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç—ã —Ä–∞—Å—Å–º–æ—Ç—Ä—è—Ç –≤–∞—à–µ –æ–±—Ä–∞—â–µ–Ω–∏–µ.');

    } catch (error) {
      setEscrowState(prev => ({ 
        ...prev, 
        loading: false, 
        error: error.message 
      }));
      toast.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —Å–ø–æ—Ä–∞');
    }
  };

  return {
    escrowState,
    confirmDelivery,
    openDispute,
    refreshEscrowAccounts: () => fetchEscrowAccounts(),
  };
};

// –ö–æ–º–ø–æ–Ω–µ–Ω—Ç —Å—Ç–∞—Ç—É—Å–∞ —ç—Å–∫—Ä–æ—É
export const EscrowStatus: React.FC<{ escrowId: number }> = ({ escrowId }) => {
  const { data: escrow, loading, error } = useEscrowData(escrowId);
  const { confirmDelivery, openDispute } = useEscrowManagement();

  if (loading) return <div className="loading loading-spinner"></div>;
  if (error) return <div className="alert alert-error">{error}</div>;
  if (!escrow) return null;

  const getStatusInfo = () => {
    switch (escrow.status) {
      case 'funds_secured':
        return {
          icon: 'üîí',
          title: '–°—Ä–µ–¥—Å—Ç–≤–∞ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω—ã',
          description: '–î–µ–Ω—å–≥–∏ –Ω–∞—Ö–æ–¥—è—Ç—Å—è –ø–æ–¥ –∑–∞—â–∏—Ç–æ–π –¥–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–∞',
          color: 'text-info',
          bgColor: 'bg-info/10',
        };
      case 'disputed':
        return {
          icon: '‚öñÔ∏è',
          title: '–û—Ç–∫—Ä—ã—Ç —Å–ø–æ—Ä',
          description: '–í–µ–¥–µ—Ç—Å—è —Ä–∞–∑–±–∏—Ä–∞—Ç–µ–ª—å—Å—Ç–≤–æ –ø–æ —Å–ø–æ—Ä–Ω–æ–π —Å–∏—Ç—É–∞—Ü–∏–∏',
          color: 'text-warning',
          bgColor: 'bg-warning/10',
        };
      case 'funds_released':
        return {
          icon: '‚úÖ',
          title: '–°—Ä–µ–¥—Å—Ç–≤–∞ –ø–µ—Ä–µ–≤–µ–¥–µ–Ω—ã',
          description: '–î–µ–Ω—å–≥–∏ —É—Å–ø–µ—à–Ω–æ –ø–µ—Ä–µ–≤–µ–¥–µ–Ω—ã –ø—Ä–æ–¥–∞–≤—Ü—É',
          color: 'text-success',
          bgColor: 'bg-success/10',
        };
      default:
        return {
          icon: '‚ùì',
          title: '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Å—Ç–∞—Ç—É—Å',
          description: escrow.status,
          color: 'text-base-content',
          bgColor: 'bg-base-200',
        };
    }
  };

  const statusInfo = getStatusInfo();
  const timeRemaining = escrow.auto_release_date ? 
    Math.max(0, new Date(escrow.auto_release_date).getTime() - Date.now()) : 0;

  return (
    <div className={`card ${statusInfo.bgColor} shadow-sm`}>
      <div className="card-body">
        <div className="flex items-center gap-3">
          <span className="text-2xl">{statusInfo.icon}</span>
          <div className="flex-1">
            <h3 className={`font-semibold ${statusInfo.color}`}>
              {statusInfo.title}
            </h3>
            <p className="text-sm opacity-70">{statusInfo.description}</p>
          </div>
        </div>

        {escrow.status === 'funds_secured' && (
          <>
            <div className="divider my-2"></div>
            
            {timeRemaining > 0 && (
              <div className="text-sm opacity-70">
                –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏–µ —á–µ—Ä–µ–∑: {formatTimeRemaining(timeRemaining)}
              </div>
            )}

            <div className="flex gap-2 mt-3">
              <button 
                className="btn btn-success btn-sm flex-1"
                onClick={() => confirmDelivery(escrow.id)}
              >
                ‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –ø–æ–ª—É—á–µ–Ω–∏–µ
              </button>
              <button 
                className="btn btn-outline btn-warning btn-sm"
                onClick={() => openDispute(escrow.id, {})}
              >
                ‚öñÔ∏è –û—Ç–∫—Ä—ã—Ç—å —Å–ø–æ—Ä
              </button>
            </div>
          </>
        )}

        {escrow.status === 'disputed' && escrow.dispute && (
          <>
            <div className="divider my-2"></div>
            <div className="text-sm">
              <div className="font-medium">–°–ø–æ—Ä: {escrow.dispute.title}</div>
              <div className="opacity-70">–°—Ç–∞—Ç—É—Å: {escrow.dispute.status}</div>
              {escrow.dispute.arbitrator && (
                <div className="opacity-70">–ê—Ä–±–∏—Ç—Ä: {escrow.dispute.arbitrator}</div>
              )}
            </div>
          </>
        )}
      </div>
    </div>
  );
};
```

## üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –∏ –≤–∞–ª–∏–¥–∞—Ü–∏—è

### **–ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –º–æ—à–µ–Ω–Ω–∏—á–µ—Å—Ç–≤–∞**
```go
// –û—Ü–µ–Ω–∫–∞ —Ä–∏—Å–∫–æ–≤ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
func (s *RiskAssessmentService) AssessTransactionRisk(ctx context.Context, req RiskAssessmentRequest) (string, error) {
    var riskScore float64 = 0

    // 1. –ê–Ω–∞–ª–∏–∑ –∏—Å—Ç–æ—Ä–∏–∏ –ø—Ä–æ–¥–∞–≤—Ü–∞
    sellerHistory, err := s.repository.GetSellerHistory(ctx, req.SellerID)
    if err != nil {
        s.logger.Warn("Failed to get seller history", "seller_id", req.SellerID, "error", err)
        riskScore += 10 // –î–æ–±–∞–≤–ª—è–µ–º —Ä–∏—Å–∫ –∑–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –¥–∞–Ω–Ω—ã—Ö
    } else {
        // –†–µ–π—Ç–∏–Ω–≥ –ø—Ä–æ–¥–∞–≤—Ü–∞
        if sellerHistory.Rating < 3.0 {
            riskScore += 30
        } else if sellerHistory.Rating < 4.0 {
            riskScore += 15
        }

        // –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–ø–æ—Ä–æ–≤
        disputeRate := float64(sellerHistory.DisputeCount) / float64(sellerHistory.TotalSales)
        if disputeRate > 0.1 { // –ë–æ–ª–µ–µ 10% —Å–ø–æ—Ä–æ–≤
            riskScore += 25
        }

        // –ù–æ–≤—ã–π –∞–∫–∫–∞—É–Ω—Ç
        if sellerHistory.AccountAge < 30*24*time.Hour {
            riskScore += 20
        }
    }

    // 2. –ê–Ω–∞–ª–∏–∑ —Ç–æ–≤–∞—Ä–∞
    if req.Amount.GreaterThan(decimal.NewFromFloat(1000)) {
        riskScore += 15 // –í—ã—Å–æ–∫–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å
    }

    // –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –≤—ã—Å–æ–∫–æ–≥–æ —Ä–∏—Å–∫–∞
    highRiskCategories := []string{"electronics", "jewelry", "watches", "phones"}
    if contains(highRiskCategories, req.Category) {
        riskScore += 20
    }

    // 3. –ê–Ω–∞–ª–∏–∑ –ø–æ–∫—É–ø–∞—Ç–µ–ª—è
    buyerHistory, err := s.repository.GetBuyerHistory(ctx, req.BuyerID)
    if err == nil {
        // –ù–æ–≤—ã–π –ø–æ–∫—É–ø–∞—Ç–µ–ª—å
        if buyerHistory.AccountAge < 7*24*time.Hour {
            riskScore += 15
        }

        // –ß–∞—Å—Ç—ã–µ —Å–ø–æ—Ä—ã
        if buyerHistory.DisputeRate > 0.2 {
            riskScore += 25
        }
    }

    // 4. –í—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–∫—Ç–æ—Ä—ã
    if req.ListingAge < 1*time.Hour {
        riskScore += 10 // –°–ª–∏—à–∫–æ–º –±—ã—Å—Ç—Ä–∞—è –ø–æ–∫—É–ø–∫–∞
    }

    // 5. –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —É—Ä–æ–≤–Ω—è —Ä–∏—Å–∫–∞
    switch {
    case riskScore >= 80:
        return "critical", nil
    case riskScore >= 60:
        return "high", nil
    case riskScore >= 30:
        return "medium", nil
    default:
        return "low", nil
    }
}
```

### **–í–∞–ª–∏–¥–∞—Ü–∏—è –¥–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤**
```go
// –í–∞–ª–∏–¥–∞—Ü–∏—è –∑–∞–≥—Ä—É–∂–∞–µ–º—ã—Ö –¥–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤
func (s *DisputeService) validateEvidence(ctx context.Context, file *multipart.FileHeader) error {
    // 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑–º–µ—Ä–∞ —Ñ–∞–π–ª–∞
    if file.Size > 10*1024*1024 { // 10MB
        return errors.New("dispute.fileTooLarge")
    }

    // 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∏–ø–∞ —Ñ–∞–π–ª–∞
    allowedTypes := []string{
        "image/jpeg", "image/png", "image/gif",
        "application/pdf", "text/plain",
        "video/mp4", "video/avi", "video/mov",
    }

    contentType := file.Header.Get("Content-Type")
    if !contains(allowedTypes, contentType) {
        return errors.New("dispute.unsupportedFileType")
    }

    // 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –≤–∏—Ä—É—Å—ã (–∑–∞–≥–ª—É—à–∫–∞)
    if s.config.VirusScanEnabled {
        if err := s.virusScanner.ScanFile(file); err != nil {
            return errors.New("dispute.virusScanFailed")
        }
    }

    // 4. –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
    if strings.HasPrefix(contentType, "image/") {
        if err := s.validateImageMetadata(file); err != nil {
            return fmt.Errorf("dispute.invalidImageMetadata: %w", err)
        }
    }

    return nil
}

// –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑ —Ñ–æ—Ç–æ –¥–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤
func (s *DisputeService) analyzeEvidencePhotos(ctx context.Context, disputeID int64) bool {
    evidence, err := s.repository.GetDisputeEvidence(ctx, disputeID)
    if err != nil {
        return false
    }

    for _, file := range evidence {
        if strings.HasPrefix(file.ContentType, "image/") {
            // –ê–Ω–∞–ª–∏–∑ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –Ω–∞ –ø—Ä–µ–¥–º–µ—Ç –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–∏–π
            analysis, err := s.imageAnalyzer.AnalyzeDamage(file.Path)
            if err != nil {
                s.logger.Error("Image analysis failed", "file", file.Path, "error", err)
                continue
            }

            if analysis.DamageConfidence > 0.8 {
                return true // –í—ã—Å–æ–∫–∞—è –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–∏—è
            }
        }
    }

    return false
}
```

## üìä –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –∏ –º–µ—Ç—Ä–∏–∫–∏

### **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —ç—Å–∫—Ä–æ—É —Å–∏—Å—Ç–µ–º—ã**
```go
// –ú–µ—Ç—Ä–∏–∫–∏ —ç—Å–∫—Ä–æ—É —Å–∏—Å—Ç–µ–º—ã
type EscrowMetrics struct {
    TotalEscrowAccounts    int64           `json:"total_escrow_accounts"`
    ActiveEscrowAccounts   int64           `json:"active_escrow_accounts"`
    TotalEscrowAmount      decimal.Decimal `json:"total_escrow_amount"`
    AverageHoldTime        time.Duration   `json:"average_hold_time"`
    AutoReleaseRate        float64         `json:"auto_release_rate"`
    DisputeRate            float64         `json:"dispute_rate"`
    ArbitrageResolutionTime time.Duration  `json:"average_arbitrage_time"`
    FraudDetectionRate     float64         `json:"fraud_detection_rate"`
}

func (s *EscrowAnalyticsService) GenerateMetrics(ctx context.Context, period time.Duration) (*EscrowMetrics, error) {
    since := time.Now().Add(-period)
    
    // –ü–æ–ª—É—á–µ–Ω–∏–µ –±–∞–∑–æ–≤—ã—Ö –º–µ—Ç—Ä–∏–∫
    totalAccounts, err := s.repository.CountEscrowAccounts(ctx, since)
    if err != nil {
        return nil, err
    }

    activeAccounts, err := s.repository.CountActiveEscrowAccounts(ctx)
    if err != nil {
        return nil, err
    }

    totalAmount, err := s.repository.GetTotalEscrowAmount(ctx)
    if err != nil {
        return nil, err
    }

    // –†–∞—Å—á–µ—Ç –≤—Ä–µ–º–µ–Ω–∏ —É–¥–µ—Ä–∂–∞–Ω–∏—è
    avgHoldTime, err := s.repository.GetAverageHoldTime(ctx, since)
    if err != nil {
        return nil, err
    }

    // –†–∞—Å—á–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏—è
    autoReleased, err := s.repository.CountAutoReleasedAccounts(ctx, since)
    if err != nil {
        return nil, err
    }

    // –†–∞—Å—á–µ—Ç —Å–ø–æ—Ä–æ–≤
    disputes, err := s.repository.CountDisputes(ctx, since)
    if err != nil {
        return nil, err
    }

    // –í—Ä–µ–º—è —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –∞—Ä–±–∏—Ç—Ä–∞–∂–∞
    avgArbitrageTime, err := s.repository.GetAverageArbitrageTime(ctx, since)
    if err != nil {
        return nil, err
    }

    return &EscrowMetrics{
        TotalEscrowAccounts:     totalAccounts,
        ActiveEscrowAccounts:    activeAccounts,
        TotalEscrowAmount:       totalAmount,
        AverageHoldTime:         avgHoldTime,
        AutoReleaseRate:         float64(autoReleased) / float64(totalAccounts) * 100,
        DisputeRate:            float64(disputes) / float64(totalAccounts) * 100,
        ArbitrageResolutionTime: avgArbitrageTime,
    }, nil
}
```

### **Real-time —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è**
```typescript
// WebSocket —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –¥–ª—è —ç—Å–∫—Ä–æ—É
export const useEscrowNotifications = () => {
  const { socket } = useWebSocket();
  const [notifications, setNotifications] = useState<EscrowNotification[]>([]);

  useEffect(() => {
    if (!socket) return;

    const handleEscrowNotification = (data: EscrowNotification) => {
      setNotifications(prev => [data, ...prev.slice(0, 9)]); // –ü–æ—Å–ª–µ–¥–Ω–∏–µ 10 —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
      
      // –ü–æ–∫–∞–∑ toast —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
      switch (data.type) {
        case 'escrow_created':
          toast.info('–°–æ–∑–¥–∞–Ω —ç—Å–∫—Ä–æ—É-—Å—á–µ—Ç –¥–ª—è –∑–∞—â–∏—Ç—ã –≤–∞—à–µ–π –ø–æ–∫—É–ø–∫–∏');
          break;
        case 'auto_release_warning':
          toast.warning('–°—Ä–µ–¥—Å—Ç–≤–∞ –±—É–¥—É—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ–≤–µ–¥–µ–Ω—ã –ø—Ä–æ–¥–∞–≤—Ü—É —á–µ—Ä–µ–∑ 24 —á–∞—Å–∞');
          break;
        case 'funds_released':
          toast.success('–°—Ä–µ–¥—Å—Ç–≤–∞ –ø–µ—Ä–µ–≤–µ–¥–µ–Ω—ã –ø—Ä–æ–¥–∞–≤—Ü—É');
          break;
        case 'dispute_opened':
          toast.info('–û—Ç–∫—Ä—ã—Ç —Å–ø–æ—Ä –ø–æ –≤–∞—à–µ–π –ø–æ–∫—É–ø–∫–µ');
          break;
        case 'dispute_resolved':
          toast.success('–°–ø–æ—Ä —Ä–∞–∑—Ä–µ—à–µ–Ω');
          break;
      }
    };

    socket.on('escrow_notification', handleEscrowNotification);

    return () => {
      socket.off('escrow_notification', handleEscrowNotification);
    };
  }, [socket]);

  return { notifications };
};
```

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### **Unit —Ç–µ—Å—Ç—ã —ç—Å–∫—Ä–æ—É —Å–µ—Ä–≤–∏—Å–∞**
```go
func TestEscrowService_CreateEscrowAccount(t *testing.T) {
    tests := []struct {
        name          string
        request       CreateEscrowRequest
        mockSetup     func(*MockEscrowRepository, *MockPaymentService)
        expectedError string
    }{
        {
            name: "successful_escrow_creation",
            request: CreateEscrowRequest{
                PaymentID: 1,
            },
            mockSetup: func(repo *MockEscrowRepository, payment *MockPaymentService) {
                payment.EXPECT().GetPayment(gomock.Any(), int64(1)).Return(&models.Payment{
                    ID:     1,
                    UserID: 1,
                    Amount: decimal.NewFromFloat(100.00),
                    Status: "completed",
                    Listing: &models.MarketplaceListing{
                        UserID: 2,
                        Category: "electronics",
                        CreatedAt: time.Now().Add(-1 * time.Hour),
                    },
                }, nil)
                
                repo.EXPECT().CreateEscrowAccount(gomock.Any(), gomock.Any()).Return(nil)
            },
        },
        {
            name: "payment_not_completed",
            request: CreateEscrowRequest{
                PaymentID: 1,
            },
            mockSetup: func(repo *MockEscrowRepository, payment *MockPaymentService) {
                payment.EXPECT().GetPayment(gomock.Any(), int64(1)).Return(&models.Payment{
                    Status: "pending",
                }, nil)
            },
            expectedError: "escrow.paymentNotCompleted",
        },
    }

    for _, tt := range tests {
        t.Run(tt.name, func(t *testing.T) {
            // Test implementation
        })
    }
}
```

### **Integration —Ç–µ—Å—Ç—ã**
```typescript
// E2E —Ç–µ—Å—Ç —ç—Å–∫—Ä–æ—É –ø—Ä–æ—Ü–µ—Å—Å–∞
describe('Escrow Process Integration', () => {
  it('should create escrow account after successful payment', async () => {
    // 1. –°–æ–∑–¥–∞–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö
    const buyer = await createTestUser('buyer@example.com');
    const seller = await createTestUser('seller@example.com');
    const listing = await createTestListing(seller.id);

    // 2. –õ–æ–≥–∏–Ω –ø–æ–∫—É–ø–∞—Ç–µ–ª—è
    await loginUser(buyer.email);

    // 3. –ü–æ–∫—É–ø–∫–∞ —Ç–æ–≤–∞—Ä–∞
    const paymentResponse = await purchaseItem(listing.id, 'stripe');
    expect(paymentResponse.success).toBe(true);

    // 4. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —ç—Å–∫—Ä–æ—É-—Å—á–µ—Ç–∞
    const escrowResponse = await fetch(`/api/v1/escrow/by-payment/${paymentResponse.data.id}`);
    const escrow = await escrowResponse.json();
    
    expect(escrow.success).toBe(true);
    expect(escrow.data.status).toBe('funds_secured');
    expect(escrow.data.buyer_id).toBe(buyer.id);
    expect(escrow.data.seller_id).toBe(seller.id);
  });

  it('should handle dispute flow correctly', async () => {
    // 1. –°–æ–∑–¥–∞–Ω–∏–µ —ç—Å–∫—Ä–æ—É-—Å—á–µ—Ç–∞
    const escrow = await createTestEscrow();

    // 2. –õ–æ–≥–∏–Ω –ø–æ–∫—É–ø–∞—Ç–µ–ª—è
    await loginUser(escrow.buyer.email);

    // 3. –û—Ç–∫—Ä—ã—Ç–∏–µ —Å–ø–æ—Ä–∞
    await page.goto(`/escrow/${escrow.id}`);
    await page.click('[data-testid="open-dispute-button"]');
    
    // 4. –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ —Ñ–æ—Ä–º—ã —Å–ø–æ—Ä–∞
    await page.selectOption('[name="dispute_type"]', 'not_received');
    await page.fill('[name="title"]', '–¢–æ–≤–∞—Ä –Ω–µ –ø–æ–ª—É—á–µ–Ω');
    await page.fill('[name="description"]', '–ü—Ä–æ—à–ª–æ 2 –Ω–µ–¥–µ–ª–∏, —Ç–æ–≤–∞—Ä –Ω–µ –¥–æ—Å—Ç–∞–≤–ª–µ–Ω');
    
    // 5. –ó–∞–≥—Ä—É–∑–∫–∞ –¥–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤
    await page.setInputFiles('[name="evidence"]', './test-evidence.jpg');
    
    // 6. –ü–æ–¥–∞—á–∞ —Å–ø–æ—Ä–∞
    await page.click('[data-testid="submit-dispute"]');
    
    // 7. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Å–ø–æ—Ä–∞
    await expect(page.locator('[data-testid="dispute-created"]')).toBeVisible();
    
    // 8. –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ —ç—Å–∫—Ä–æ—É
    const updatedEscrow = await fetch(`/api/v1/escrow/${escrow.id}`);
    const escrowData = await updatedEscrow.json();
    expect(escrowData.data.status).toBe('disputed');
  });
});
```

## üìà –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –∞–ª–µ—Ä—Ç—ã

### **Prometheus –º–µ—Ç—Ä–∏–∫–∏**
```go
var (
    EscrowAccountsTotal = prometheus.NewGaugeVec(
        prometheus.GaugeOpts{
            Name: "escrow_accounts_total",
            Help: "Total number of escrow accounts",
        },
        []string{"status"},
    )
    
    EscrowAmountTotal = prometheus.NewGaugeVec(
        prometheus.GaugeOpts{
            Name: "escrow_amount_total",
            Help: "Total amount in escrow",
        },
        []string{"currency"},
    )
    
    DisputeResolutionTime = prometheus.NewHistogramVec(
        prometheus.HistogramOpts{
            Name: "dispute_resolution_duration_hours",
            Help: "Time to resolve disputes",
            Buckets: []float64{1, 6, 12, 24, 48, 96, 168}, // –î–æ –Ω–µ–¥–µ–ª–∏
        },
        []string{"dispute_type", "resolution_method"},
    )
)
```

### **–ê–ª–µ—Ä—Ç—ã –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞**
```yaml
# escrow-alerts.yml
groups:
  - name: escrow_alerts
    rules:
      - alert: HighDisputeRate
        expr: (rate(disputes_total[1h]) / rate(escrow_accounts_total[1h])) > 0.1
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High dispute rate detected"
          description: "Dispute rate is {{ $value | humanizePercentage }} in the last hour"
      
      - alert: EscrowAmountThreshold
        expr: sum(escrow_amount_total) > 100000
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "High escrow amount threshold reached"
          description: "Total escrow amount is {{ $value }} EUR"
      
      - alert: LongPendingDisputes
        expr: count(dispute_resolution_duration_hours > 48) > 5
        for: 1m
        labels:
          severity: warning
        annotations:
          summary: "Too many long-pending disputes"
          description: "{{ $value }} disputes are pending for more than 48 hours"
```

---

## üìã –ö–æ–Ω—Ç—Ä–æ–ª—å–Ω–∞—è –∫–∞—Ä—Ç–∞ –ø—Ä–æ—Ü–µ—Å—Å–∞

### ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
- [x] –°–æ–∑–¥–∞–Ω–∏–µ –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —ç—Å–∫—Ä–æ—É-—Å—á–µ—Ç–∞–º–∏
- [x] –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ç–∞–π–º–µ—Ä—ã –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏—è —Å—Ä–µ–¥—Å—Ç–≤
- [x] –°–∏—Å—Ç–µ–º–∞ —Å–ø–æ—Ä–æ–≤ —Å –¥–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤–∞–º–∏
- [x] –ê—Ä–±–∏—Ç—Ä–∞–∂ –∏ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤
- [x] –û—Ü–µ–Ω–∫–∞ —Ä–∏—Å–∫–æ–≤ –∏ –∞–¥–∞–ø—Ç–∏–≤–Ω—ã–µ —Å—Ä–æ–∫–∏ —É–¥–µ—Ä–∂–∞–Ω–∏—è
- [x] Real-time —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –¥–ª—è –≤—Å–µ—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
- [x] –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è –¥–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤
- [x] –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ –º–æ—à–µ–Ω–Ω–∏—á–µ—Å—Ç–≤–∞
- [x] –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –ø–ª–∞—Ç–µ–∂–Ω—ã–º–∏ —Å–∏—Å—Ç–µ–º–∞–º–∏

### üîÑ –ü—Ä–æ—Ü–µ—Å—Å—ã –Ω–∞ –¥–æ—Ä–∞–±–æ—Ç–∫–µ
- [ ] Machine Learning –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è —Å–ø–æ—Ä–æ–≤
- [ ] –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –∫—É—Ä—å–µ—Ä—Å–∫–∏–º–∏ —Å–ª—É–∂–±–∞–º–∏ –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –¥–æ—Å—Ç–∞–≤–∫–∏
- [ ] –°–∏—Å—Ç–µ–º–∞ —Ä–µ–ø—É—Ç–∞—Ü–∏–∏ –∞—Ä–±–∏—Ç—Ä–æ–≤
- [ ] –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å—Ç—Ä–∞—Ö–æ–≤–∞–Ω–∏–µ –≤—ã—Å–æ–∫–æ—Ä–∏—Å–∫–æ–≤—ã—Ö —Å–¥–µ–ª–æ–∫
- [ ] –ë–ª–æ–∫—á–µ–π–Ω –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –¥–ª—è –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç–∏

### üìä –ú–µ—Ç—Ä–∏–∫–∏ —É—Å–ø–µ—Ö–∞
- **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏–µ**: > 85%
- **–í—Ä–µ–º—è —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è —Å–ø–æ—Ä–æ–≤**: < 48 —á–∞—Å–æ–≤
- **–£—Ä–æ–≤–µ–Ω—å –º–æ—à–µ–Ω–Ω–∏—á–µ—Å—Ç–≤–∞**: < 0.1%
- **–£–¥–æ–≤–ª–µ—Ç–≤–æ—Ä–µ–Ω–Ω–æ—Å—Ç—å –∞—Ä–±–∏—Ç—Ä–∞–∂–µ–º**: > 4.5/5
- **–î–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å —Å–∏—Å—Ç–µ–º—ã**: > 99.95%