# –ü–∞—Å–ø–æ—Ä—Ç –±–∏–∑–Ω–µ—Å-–ø—Ä–æ—Ü–µ—Å—Å–∞: –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–æ–º –∏ –≤—ã–≤–æ–¥—ã

## üéØ –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ –ø—Ä–æ—Ü–µ—Å—Å–∞

–û–±–µ—Å–ø–µ—á–µ–Ω–∏–µ –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–º–∏ –±–∞–ª–∞–Ω—Å–∞–º–∏ –Ω–∞ –ø–ª–∞—Ç—Ñ–æ—Ä–º–µ Sve Tu —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è —Å—á–µ—Ç–∞, –≤—ã–≤–æ–¥–∞ —Å—Ä–µ–¥—Å—Ç–≤, –º—É–ª—å—Ç–∏-–≤–∞–ª—é—Ç–Ω–æ—Å—Ç–∏ –∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∫–æ–º–∏—Å—Å–∏–π —Å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–µ–π KYC –ø—Ä–æ—Ü–µ–¥—É—Ä.

## üîÑ –°—Ö–µ–º–∞ –ø—Ä–æ—Ü–µ—Å—Å–∞

### 1. **–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞**
```mermaid
graph LR
    A[–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–ø—Ä–æ—Å –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è] --> B[–í—ã–±–æ—Ä –º–µ—Ç–æ–¥–∞ –æ–ø–ª–∞—Ç—ã]
    B --> C[–í–∞–ª–∏–¥–∞—Ü–∏—è –ª–∏–º–∏—Ç–æ–≤]
    C --> D[–†–∞—Å—á–µ—Ç –∫–æ–º–∏—Å—Å–∏–π]
    D --> E[–°–æ–∑–¥–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞]
    E --> F[–ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞ Gateway]
    F --> G[–û–±—Ä–∞–±–æ—Ç–∫–∞ webhook]
    G --> H[–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞]
```

### 2. **–í—ã–≤–æ–¥ —Å—Ä–µ–¥—Å—Ç–≤**
```mermaid
graph TD
    A[–ó–∞–ø—Ä–æ—Å –Ω–∞ –≤—ã–≤–æ–¥] --> B[KYC –ø—Ä–æ–≤–µ—Ä–∫–∞]
    B --> C{–í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è –ø—Ä–æ–π–¥–µ–Ω–∞?}
    C -->|–ù–µ—Ç| D[–ó–∞–ø—Ä–æ—Å –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤]
    C -->|–î–∞| E[–í–∞–ª–∏–¥–∞—Ü–∏—è –∑–∞–ø—Ä–æ—Å–∞]
    E --> F[–ü—Ä–æ–≤–µ—Ä–∫–∞ –±–∞–ª–∞–Ω—Å–∞]
    F --> G[–ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ —Å—Ä–µ–¥—Å—Ç–≤]
    G --> H[–°–æ–∑–¥–∞–Ω–∏–µ –∑–∞—è–≤–∫–∏ –Ω–∞ –≤—ã–≤–æ–¥]
    H --> I[–û–±—Ä–∞–±–æ—Ç–∫–∞ –±–∞–Ω–∫–æ–º]
    I --> J{–°—Ç–∞—Ç—É—Å –ø–µ—Ä–µ–≤–æ–¥–∞}
    J -->|–£—Å–ø–µ—à–Ω–æ| K[–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞]
    J -->|–û—à–∏–±–∫–∞| L[–†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ —Å—Ä–µ–¥—Å—Ç–≤]
    D --> M[–û–∂–∏–¥–∞–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤]
    M --> N[–ü–æ–≤—Ç–æ—Ä–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞]
```

### 3. **–ú—É–ª—å—Ç–∏-–≤–∞–ª—é—Ç–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ**
```mermaid
graph TD
    A[–û–ø–µ—Ä–∞—Ü–∏—è —Å –±–∞–ª–∞–Ω—Å–æ–º] --> B{–í–∞–ª—é—Ç–∞ –æ–ø–µ—Ä–∞—Ü–∏–∏}
    B -->|–û—Å–Ω–æ–≤–Ω–∞—è –≤–∞–ª—é—Ç–∞| C[–ü—Ä—è–º–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è]
    B -->|–î—Ä—É–≥–∞—è –≤–∞–ª—é—Ç–∞| D[–ü–æ–ª—É—á–µ–Ω–∏–µ –∫—É—Ä—Å–∞]
    D --> E[–ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è]
    E --> F[–ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –∫–æ–º–∏—Å—Å–∏–∏ –∑–∞ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—é]
    F --> G[–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞]
    C --> G
    G --> H[–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏]
```

### 4. **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –æ—Ç –ø—Ä–æ–¥–∞–∂**
```mermaid
graph LR
    A[–ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –ø—Ä–æ–¥–∞–∂–∏] --> B[–û—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏–µ —ç—Å–∫—Ä–æ—É]
    B --> C[–†–∞—Å—á–µ—Ç —Å—É–º–º—ã –ø—Ä–æ–¥–∞–≤—Ü—É]
    C --> D[–£–¥–µ—Ä–∂–∞–Ω–∏–µ –∫–æ–º–∏—Å—Å–∏–∏ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã]
    D --> E[–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞ –ø—Ä–æ–¥–∞–≤—Ü–∞]
    E --> F[–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏–∏]
    F --> G[–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏]
```

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

### **Frontend –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã**
- **BalanceWidget** - –≤–∏–¥–∂–µ—Ç –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ç–µ–∫—É—â–µ–≥–æ –±–∞–ª–∞–Ω—Å–∞
- **DepositForm** - —Ñ–æ—Ä–º–∞ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞
- **WithdrawForm** - —Ñ–æ—Ä–º–∞ –≤—ã–≤–æ–¥–∞ —Å—Ä–µ–¥—Å—Ç–≤
- **TransactionHistory** - –∏—Å—Ç–æ—Ä–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π –ø–æ –±–∞–ª–∞–Ω—Å—É
- **CurrencyConverter** - –∫–æ–Ω–≤–µ—Ä—Ç–µ—Ä –≤–∞–ª—é—Ç
- **KYCVerificationForm** - —Ñ–æ—Ä–º–∞ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏ –¥–ª—è –≤—ã–≤–æ–¥–æ–≤
- **PaymentMethodSelector** - –≤—ã–±–æ—Ä –º–µ—Ç–æ–¥–æ–≤ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è/–≤—ã–≤–æ–¥–∞

### **Backend —Å–µ—Ä–≤–∏—Å—ã**
- **BalanceService** - –æ—Å–Ω–æ–≤–Ω–æ–π —Å–µ—Ä–≤–∏—Å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞–º–∏
- **WithdrawalService** - —Å–µ—Ä–≤–∏—Å –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤—ã–≤–æ–¥–æ–≤
- **DepositService** - —Å–µ—Ä–≤–∏—Å –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–π
- **CurrencyService** - —Å–µ—Ä–≤–∏—Å —Ä–∞–±–æ—Ç—ã —Å –≤–∞–ª—é—Ç–∞–º–∏ –∏ –∫—É—Ä—Å–∞–º–∏
- **KYCService** - —Å–µ—Ä–≤–∏—Å –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- **FeeCalculatorService** - —Ä–∞—Å—á–µ—Ç –∫–æ–º–∏—Å—Å–∏–π
- **BankIntegrationService** - –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –±–∞–Ω–∫–æ–≤—Å–∫–∏–º–∏ API

### **–ë–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö**
- **user_balances** - –æ—Å–Ω–æ–≤–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ –±–∞–ª–∞–Ω—Å–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- **balance_transactions** - –≤—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –ø–æ –±–∞–ª–∞–Ω—Å–∞–º
- **withdrawal_requests** - –∑–∞—è–≤–∫–∏ –Ω–∞ –≤—ã–≤–æ–¥ —Å—Ä–µ–¥—Å—Ç–≤
- **deposit_transactions** - —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è
- **currency_rates** - –∫—É—Ä—Å—ã –≤–∞–ª—é—Ç
- **kyc_verifications** - –¥–∞–Ω–Ω—ã–µ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏ KYC
- **payment_methods** - –¥–æ—Å—Ç—É–ø–Ω—ã–µ –º–µ—Ç–æ–¥—ã –ø–ª–∞—Ç–µ–∂–µ–π

## üîó –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏

### **BalanceService - –æ—Å–Ω–æ–≤–Ω–æ–π —Å–µ—Ä–≤–∏—Å**
```go
type BalanceService struct {
    repository      BalanceRepositoryInterface
    currency        CurrencyServiceInterface
    kyc            KYCServiceInterface
    notification   NotificationServiceInterface
    payment        PaymentServiceInterface
    logger         logger.Logger
    config         *BalanceConfig
}

type BalanceConfig struct {
    DefaultCurrency          string          // "RSD"
    MinimumWithdrawal       decimal.Decimal // 10.00
    MaximumWithdrawal       decimal.Decimal // 10000.00
    WithdrawalFeePercentage decimal.Decimal // 2.5%
    WithdrawalFixedFee      decimal.Decimal // 1.00
    KYCRequiredForAmount    decimal.Decimal // 1000.00
    SupportedCurrencies     []string        // ["RSD", "EUR", "USD"]
    ExchangeFeePercentage   decimal.Decimal // 0.5%
}

// –ü–æ–ª—É—á–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
func (s *BalanceService) GetUserBalance(ctx context.Context, userID int) (*UserBalance, error) {
    balance, err := s.repository.GetBalance(ctx, userID)
    if err != nil {
        // –°–æ–∑–¥–∞–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞ –µ—Å–ª–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
        if errors.Is(err, ErrBalanceNotFound) {
            balance, err = s.createInitialBalance(ctx, userID)
            if err != nil {
                return nil, fmt.Errorf("failed to create initial balance: %w", err)
            }
        } else {
            return nil, fmt.Errorf("failed to get balance: %w", err)
        }
    }

    // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Å—Ä–µ–¥—Å—Ç–≤–∞—Ö
    frozenAmount, err := s.repository.GetFrozenAmount(ctx, userID)
    if err != nil {
        s.logger.Warn("Failed to get frozen amount", "user_id", userID, "error", err)
        frozenAmount = decimal.Zero
    }

    // –ü–æ–ª—É—á–µ–Ω–∏–µ –∫—É—Ä—Å–æ–≤ –¥–ª—è –¥—Ä—É–≥–∏—Ö –≤–∞–ª—é—Ç
    exchangeRates, err := s.currency.GetCurrentRates(ctx, s.config.SupportedCurrencies)
    if err != nil {
        s.logger.Warn("Failed to get exchange rates", "error", err)
        exchangeRates = make(map[string]decimal.Decimal)
    }

    return &UserBalance{
        UserID:          balance.UserID,
        PrimaryBalance:  balance.Amount,
        FrozenBalance:   frozenAmount,
        Currency:        balance.Currency,
        ExchangeRates:   exchangeRates,
        LastUpdated:     balance.UpdatedAt,
    }, nil
}

// –ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞
func (s *BalanceService) CreateDeposit(ctx context.Context, req DepositRequest) (*DepositResult, error) {
    // 1. –í–∞–ª–∏–¥–∞—Ü–∏—è –∑–∞–ø—Ä–æ—Å–∞
    if err := s.validateDepositRequest(req); err != nil {
        return nil, fmt.Errorf("validation failed: %w", err)
    }

    // 2. –ü–æ–ª—É—á–µ–Ω–∏–µ –º–µ—Ç–æ–¥–∞ –æ–ø–ª–∞—Ç—ã
    paymentMethod, err := s.repository.GetPaymentMethod(ctx, req.PaymentMethod)
    if err != nil {
        return nil, fmt.Errorf("invalid payment method: %w", err)
    }

    // 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏–º–∏—Ç–æ–≤
    if req.Amount.LessThan(paymentMethod.MinimumAmount) {
        return nil, errors.New("deposit.amountTooLow")
    }
    if paymentMethod.MaximumAmount.GreaterThan(decimal.Zero) && req.Amount.GreaterThan(paymentMethod.MaximumAmount) {
        return nil, errors.New("deposit.amountTooHigh")
    }

    // 4. –†–∞—Å—á–µ—Ç –∫–æ–º–∏—Å—Å–∏–π
    fee := s.calculateDepositFee(req.Amount, paymentMethod)
    totalAmount := req.Amount.Add(fee)

    // 5. –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –≤–∞–ª—é—Ç—ã –µ—Å–ª–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ
    var convertedAmount decimal.Decimal
    if req.Currency != s.config.DefaultCurrency {
        rate, err := s.currency.GetExchangeRate(ctx, req.Currency, s.config.DefaultCurrency)
        if err != nil {
            return nil, fmt.Errorf("failed to get exchange rate: %w", err)
        }
        convertedAmount = req.Amount.Mul(rate)
    } else {
        convertedAmount = req.Amount
    }

    // 6. –°–æ–∑–¥–∞–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –¥–µ–ø–æ–∑–∏—Ç–∞
    deposit := &models.DepositTransaction{
        UserID:          req.UserID,
        Amount:          req.Amount,
        ConvertedAmount: convertedAmount,
        Currency:        req.Currency,
        PaymentMethod:   req.PaymentMethod,
        Fee:             fee,
        TotalAmount:     totalAmount,
        Status:          "pending",
        Reference:       s.generateReference("DEP"),
        CreatedAt:       time.Now(),
    }

    err = s.repository.CreateDepositTransaction(ctx, deposit)
    if err != nil {
        return nil, fmt.Errorf("failed to create deposit transaction: %w", err)
    }

    // 7. –°–æ–∑–¥–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞ —á–µ—Ä–µ–∑ payment gateway
    paymentResult, err := s.payment.CreatePayment(ctx, PaymentRequest{
        Amount:      totalAmount,
        Currency:    req.Currency,
        Method:      req.PaymentMethod,
        Reference:   deposit.Reference,
        Description: fmt.Sprintf("Balance deposit for user %d", req.UserID),
        ReturnURL:   req.ReturnURL,
        UserID:      req.UserID,
    })
    if err != nil {
        s.repository.UpdateDepositStatus(ctx, deposit.ID, "failed")
        return nil, fmt.Errorf("failed to create payment: %w", err)
    }

    // 8. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ —Å –¥–∞–Ω–Ω—ã–º–∏ –ø–ª–∞—Ç–µ–∂–∞
    err = s.repository.UpdateDepositPaymentData(ctx, deposit.ID, paymentResult.TransactionID, paymentResult.GatewayUUID)
    if err != nil {
        s.logger.Error("Failed to update deposit payment data", "deposit_id", deposit.ID, "error", err)
    }

    return &DepositResult{
        DepositID:      deposit.ID,
        Reference:      deposit.Reference,
        Amount:         req.Amount,
        Fee:            fee,
        TotalAmount:    totalAmount,
        Currency:       req.Currency,
        PaymentID:      paymentResult.TransactionID,
        RedirectURL:    paymentResult.RedirectURL,
        Status:         "pending",
    }, nil
}
```

### **WithdrawalService - —Å–µ—Ä–≤–∏—Å –≤—ã–≤–æ–¥–æ–≤**
```go
// –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞—è–≤–∫–∏ –Ω–∞ –≤—ã–≤–æ–¥
func (s *WithdrawalService) CreateWithdrawalRequest(ctx context.Context, req WithdrawalRequest) (*WithdrawalResult, error) {
    // 1. KYC –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–ª—è –∫—Ä—É–ø–Ω—ã—Ö —Å—É–º–º
    if req.Amount.GreaterThanOrEqual(s.config.KYCRequiredForAmount) {
        kycStatus, err := s.kyc.GetVerificationStatus(ctx, req.UserID)
        if err != nil {
            return nil, fmt.Errorf("failed to check KYC status: %w", err)
        }
        
        if kycStatus != "verified" {
            return nil, errors.New("withdrawal.kycRequired")
        }
    }

    // 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–∞–ª–∞–Ω—Å–∞
    balance, err := s.balanceRepo.GetBalance(ctx, req.UserID)
    if err != nil {
        return nil, fmt.Errorf("failed to get balance: %w", err)
    }

    // 3. –†–∞—Å—á–µ—Ç –∫–æ–º–∏—Å—Å–∏–∏
    fee := s.calculateWithdrawalFee(req.Amount)
    totalRequired := req.Amount.Add(fee)

    if balance.Amount.LessThan(totalRequired) {
        return nil, errors.New("withdrawal.insufficientFunds")
    }

    // 4. –í–∞–ª–∏–¥–∞—Ü–∏—è –±–∞–Ω–∫–æ–≤—Å–∫–∏—Ö —Ä–µ–∫–≤–∏–∑–∏—Ç–æ–≤
    if err := s.validateBankDetails(req.BankDetails); err != nil {
        return nil, fmt.Errorf("invalid bank details: %w", err)
    }

    // 5. –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ —Å—Ä–µ–¥—Å—Ç–≤
    tx, err := s.repository.BeginTx(ctx, nil)
    if err != nil {
        return nil, fmt.Errorf("failed to begin transaction: %w", err)
    }
    defer tx.Rollback()

    err = s.repository.FreezeBalance(ctx, tx, req.UserID, totalRequired)
    if err != nil {
        return nil, fmt.Errorf("failed to freeze balance: %w", err)
    }

    // 6. –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞—è–≤–∫–∏ –Ω–∞ –≤—ã–≤–æ–¥
    withdrawal := &models.WithdrawalRequest{
        UserID:         req.UserID,
        Amount:         req.Amount,
        Currency:       req.Currency,
        Fee:            fee,
        TotalAmount:    totalRequired,
        BankDetails:    req.BankDetails,
        Status:         "pending",
        Reference:      s.generateReference("WDR"),
        RequestedAt:    time.Now(),
        ProcessAfter:   time.Now().Add(1 * time.Hour), // –ó–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
    }

    err = s.repository.CreateWithdrawalRequest(ctx, tx, withdrawal)
    if err != nil {
        return nil, fmt.Errorf("failed to create withdrawal request: %w", err)
    }

    if err := tx.Commit(); err != nil {
        return nil, fmt.Errorf("failed to commit transaction: %w", err)
    }

    // 7. –ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏
    err = s.scheduler.ScheduleWithdrawalProcessing(ctx, withdrawal.ID, withdrawal.ProcessAfter)
    if err != nil {
        s.logger.Error("Failed to schedule withdrawal processing", "withdrawal_id", withdrawal.ID, "error", err)
    }

    // 8. –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
    s.sendWithdrawalNotifications(ctx, withdrawal, "requested")

    return &WithdrawalResult{
        WithdrawalID: withdrawal.ID,
        Reference:    withdrawal.Reference,
        Amount:       req.Amount,
        Fee:          fee,
        TotalAmount:  totalRequired,
        Status:       "pending",
        EstimatedProcessingTime: "1-3 business days",
    }, nil
}

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–≤–æ–¥–∞ —Å—Ä–µ–¥—Å—Ç–≤
func (s *WithdrawalService) ProcessWithdrawal(ctx context.Context, withdrawalID int64) error {
    // 1. –ü–æ–ª—É—á–µ–Ω–∏–µ –∑–∞—è–≤–∫–∏
    withdrawal, err := s.repository.GetWithdrawalRequest(ctx, withdrawalID)
    if err != nil {
        return fmt.Errorf("failed to get withdrawal request: %w", err)
    }

    if withdrawal.Status != "pending" {
        return fmt.Errorf("withdrawal already processed with status: %s", withdrawal.Status)
    }

    // 2. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É
    err = s.repository.UpdateWithdrawalStatus(ctx, withdrawalID, "processing")
    if err != nil {
        return fmt.Errorf("failed to update status to processing: %w", err)
    }

    // 3. –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –±–∞–Ω–∫–æ–≤—Å–∫–æ–≥–æ –ø–µ—Ä–µ–≤–æ–¥–∞
    transferResult, err := s.bank.ExecuteTransfer(ctx, BankTransferRequest{
        Amount:         withdrawal.Amount,
        Currency:       withdrawal.Currency,
        RecipientIBAN:  withdrawal.BankDetails.IBAN,
        RecipientName:  withdrawal.BankDetails.AccountHolder,
        RecipientBank:  withdrawal.BankDetails.BankName,
        Reference:      withdrawal.Reference,
        Description:    fmt.Sprintf("Withdrawal from Sve Tu Platform - %s", withdrawal.Reference),
    })

    if err != nil {
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–∫–∏ –±–∞–Ω–∫–æ–≤—Å–∫–æ–≥–æ –ø–µ—Ä–µ–≤–æ–¥–∞
        s.repository.UpdateWithdrawalStatus(ctx, withdrawalID, "failed")
        s.repository.UnfreezeBalance(ctx, withdrawal.UserID, withdrawal.TotalAmount)
        
        s.logger.Error("Bank transfer failed", 
            "withdrawal_id", withdrawalID, 
            "user_id", withdrawal.UserID,
            "amount", withdrawal.Amount.String(),
            "error", err)
        
        s.sendWithdrawalNotifications(ctx, withdrawal, "failed")
        return fmt.Errorf("bank transfer failed: %w", err)
    }

    // 4. –£—Å–ø–µ—à–Ω–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ
    tx, err := s.repository.BeginTx(ctx, nil)
    if err != nil {
        return fmt.Errorf("failed to begin completion transaction: %w", err)
    }
    defer tx.Rollback()

    // –°–ø–∏—Å–∞–Ω–∏–µ —Å—Ä–µ–¥—Å—Ç–≤ —Å –±–∞–ª–∞–Ω—Å–∞
    err = s.repository.DeductBalance(ctx, tx, withdrawal.UserID, withdrawal.TotalAmount)
    if err != nil {
        return fmt.Errorf("failed to deduct balance: %w", err)
    }

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞
    err = s.repository.UpdateWithdrawalStatusWithDetails(ctx, tx, withdrawalID, "completed", map[string]interface{}{
        "bank_reference":   transferResult.Reference,
        "bank_transaction": transferResult.TransactionID,
        "processed_at":     time.Now().UTC(),
    })
    if err != nil {
        return fmt.Errorf("failed to update withdrawal status: %w", err)
    }

    // –°–æ–∑–¥–∞–Ω–∏–µ —Ñ–∏–Ω–∞–ª—å–Ω–æ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –±–∞–ª–∞–Ω—Å–∞
    err = s.repository.CreateBalanceTransaction(ctx, tx, &models.BalanceTransaction{
        UserID:        withdrawal.UserID,
        Type:          "withdrawal",
        Amount:        withdrawal.Amount.Neg(), // –û—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–∞—è —Å—É–º–º–∞
        Fee:           withdrawal.Fee.Neg(),
        Currency:      withdrawal.Currency,
        Reference:     withdrawal.Reference,
        Status:        "completed",
        ProcessedAt:   time.Now(),
    })
    if err != nil {
        return fmt.Errorf("failed to create balance transaction: %w", err)
    }

    if err := tx.Commit(); err != nil {
        return fmt.Errorf("failed to commit completion transaction: %w", err)
    }

    // 5. –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ–± —É—Å–ø–µ—à–Ω–æ–º –≤—ã–≤–æ–¥–µ
    s.sendWithdrawalNotifications(ctx, withdrawal, "completed")

    return nil
}
```

### **CurrencyService - —Ä–∞–±–æ—Ç–∞ —Å –≤–∞–ª—é—Ç–∞–º–∏**
```go
// –°–µ—Ä–≤–∏—Å —Ä–∞–±–æ—Ç—ã —Å –≤–∞–ª—é—Ç–∞–º–∏ –∏ –∫—É—Ä—Å–∞–º–∏
func (s *CurrencyService) GetExchangeRate(ctx context.Context, fromCurrency, toCurrency string) (decimal.Decimal, error) {
    // –ï—Å–ª–∏ –≤–∞–ª—é—Ç—ã –æ–¥–∏–Ω–∞–∫–æ–≤—ã–µ
    if fromCurrency == toCurrency {
        return decimal.NewFromFloat(1.0), nil
    }

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–µ—à–∞
    cacheKey := fmt.Sprintf("exchange_rate:%s:%s", fromCurrency, toCurrency)
    if cached, err := s.cache.Get(ctx, cacheKey); err == nil {
        if rate, err := decimal.NewFromString(string(cached)); err == nil {
            return rate, nil
        }
    }

    // –ü–æ–ª—É—á–µ–Ω–∏–µ –∫—É—Ä—Å–∞ –∏–∑ –±–∞–∑—ã
    rate, err := s.repository.GetLatestExchangeRate(ctx, fromCurrency, toCurrency)
    if err != nil {
        return decimal.Zero, fmt.Errorf("failed to get exchange rate: %w", err)
    }

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç–∏ –∫—É—Ä—Å–∞ (–Ω–µ —Å—Ç–∞—Ä—à–µ 1 —á–∞—Å–∞)
    if time.Since(rate.UpdatedAt) > time.Hour {
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫—É—Ä—Å–∞ –∏–∑ –≤–Ω–µ—à–Ω–µ–≥–æ API
        newRate, err := s.updateExchangeRateFromAPI(ctx, fromCurrency, toCurrency)
        if err != nil {
            s.logger.Warn("Failed to update exchange rate from API", 
                "from", fromCurrency, "to", toCurrency, "error", err)
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç–∞—Ä—ã–π –∫—É—Ä—Å –µ—Å–ª–∏ –Ω–æ–≤—ã–π –ø–æ–ª—É—á–∏—Ç—å –Ω–µ —É–¥–∞–ª–æ—Å—å
        } else {
            rate.Rate = newRate
        }
    }

    // –ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ 30 –º–∏–Ω—É—Ç
    s.cache.Set(ctx, cacheKey, rate.Rate.String(), 30*time.Minute)

    return rate.Rate, nil
}

// –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è —Å—É–º–º—ã –º–µ–∂–¥—É –≤–∞–ª—é—Ç–∞–º–∏
func (s *CurrencyService) ConvertAmount(ctx context.Context, amount decimal.Decimal, fromCurrency, toCurrency string) (*ConversionResult, error) {
    if fromCurrency == toCurrency {
        return &ConversionResult{
            OriginalAmount:  amount,
            ConvertedAmount: amount,
            ExchangeRate:    decimal.NewFromFloat(1.0),
            Fee:             decimal.Zero,
            FromCurrency:    fromCurrency,
            ToCurrency:      toCurrency,
        }, nil
    }

    // –ü–æ–ª—É—á–µ–Ω–∏–µ –∫—É—Ä—Å–∞
    rate, err := s.GetExchangeRate(ctx, fromCurrency, toCurrency)
    if err != nil {
        return nil, fmt.Errorf("failed to get exchange rate: %w", err)
    }

    // –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è
    convertedAmount := amount.Mul(rate)

    // –†–∞—Å—á–µ—Ç –∫–æ–º–∏—Å—Å–∏–∏ –∑–∞ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—é
    fee := convertedAmount.Mul(s.config.ExchangeFeePercentage).Div(decimal.NewFromFloat(100))

    return &ConversionResult{
        OriginalAmount:  amount,
        ConvertedAmount: convertedAmount,
        AmountAfterFee:  convertedAmount.Sub(fee),
        ExchangeRate:    rate,
        Fee:             fee,
        FromCurrency:    fromCurrency,
        ToCurrency:      toCurrency,
        ConvertedAt:     time.Now(),
    }, nil
}
```

### **Frontend –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è**
```typescript
// Hook –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–æ–º
export const useBalanceManagement = () => {
  const [balanceState, setBalanceState] = useState<BalanceState>({
    balances: {},
    transactions: [],
    loading: false,
    error: null,
  });

  const fetchBalance = async (currency?: string) => {
    setBalanceState(prev => ({ ...prev, loading: true }));

    try {
      const url = currency ? `/api/v1/balance?currency=${currency}` : '/api/v1/balance';
      const response = await fetch(url);
      const result = await response.json();

      if (!result.success) {
        throw new Error(result.error || 'Failed to fetch balance');
      }

      setBalanceState(prev => ({
        ...prev,
        balances: result.data,
        loading: false,
      }));

    } catch (error) {
      setBalanceState(prev => ({ 
        ...prev, 
        loading: false, 
        error: error.message 
      }));
    }
  };

  const depositFunds = async (depositData: DepositRequest) => {
    setBalanceState(prev => ({ ...prev, loading: true }));

    try {
      const response = await fetch('/api/v1/balance/deposit', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          amount: depositData.amount,
          currency: depositData.currency,
          payment_method: depositData.paymentMethod,
          return_url: `${window.location.origin}/balance/deposit/success`,
        }),
      });

      const result = await response.json();
      
      if (!result.success) {
        throw new Error(result.error || 'Deposit creation failed');
      }

      // –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞ payment gateway
      if (result.data.redirect_url) {
        window.location.href = result.data.redirect_url;
      }

      return result.data;

    } catch (error) {
      setBalanceState(prev => ({ 
        ...prev, 
        loading: false, 
        error: error.message 
      }));
      throw error;
    }
  };

  const withdrawFunds = async (withdrawalData: WithdrawalRequest) => {
    setBalanceState(prev => ({ ...prev, loading: true }));

    try {
      const response = await fetch('/api/v1/balance/withdraw', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(withdrawalData),
      });

      const result = await response.json();
      
      if (!result.success) {
        throw new Error(result.error || 'Withdrawal request failed');
      }

      setBalanceState(prev => ({ 
        ...prev, 
        loading: false 
      }));

      toast.success('–ó–∞—è–≤–∫–∞ –Ω–∞ –≤—ã–≤–æ–¥ —Å—Ä–µ–¥—Å—Ç–≤ —Å–æ–∑–¥–∞–Ω–∞! –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–π–º–µ—Ç 1-3 —Ä–∞–±–æ—á–∏—Ö –¥–Ω—è.');
      
      return result.data;

    } catch (error) {
      setBalanceState(prev => ({ 
        ...prev, 
        loading: false, 
        error: error.message 
      }));
      throw error;
    }
  };

  return {
    balanceState,
    fetchBalance,
    depositFunds,
    withdrawFunds,
    refreshTransactions: () => fetchTransactionHistory(),
  };
};

// –ö–æ–º–ø–æ–Ω–µ–Ω—Ç –±–∞–ª–∞–Ω—Å–∞
export const BalanceWidget: React.FC<{ showActions?: boolean }> = ({ showActions = true }) => {
  const { balanceState, fetchBalance } = useBalanceManagement();
  const [selectedCurrency, setSelectedCurrency] = useState('RSD');

  useEffect(() => {
    fetchBalance();
  }, []);

  const balance = balanceState.balances[selectedCurrency];

  if (balanceState.loading && !balance) {
    return <div className="loading loading-spinner"></div>;
  }

  if (balanceState.error) {
    return (
      <div className="alert alert-error">
        <span>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –±–∞–ª–∞–Ω—Å–∞: {balanceState.error}</span>
      </div>
    );
  }

  return (
    <div className="card bg-gradient-to-r from-primary to-secondary text-primary-content shadow-lg">
      <div className="card-body">
        <div className="flex justify-between items-start">
          <div>
            <p className="text-sm opacity-80">–î–æ—Å—Ç—É–ø–Ω—ã–π –±–∞–ª–∞–Ω—Å</p>
            <h2 className="text-3xl font-bold">
              {balance?.primary_balance?.toFixed(2) || '0.00'} {selectedCurrency}
            </h2>
            {balance?.frozen_balance > 0 && (
              <p className="text-sm opacity-80">
                –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ: {balance.frozen_balance.toFixed(2)} {selectedCurrency}
              </p>
            )}
          </div>
          
          <select 
            className="select select-sm bg-primary-content text-primary"
            value={selectedCurrency}
            onChange={(e) => setSelectedCurrency(e.target.value)}
          >
            <option value="RSD">RSD</option>
            <option value="EUR">EUR</option>
            <option value="USD">USD</option>
          </select>
        </div>

        {showActions && (
          <div className="card-actions justify-center mt-4">
            <button className="btn btn-primary btn-outline btn-sm">
              üí≥ –ü–æ–ø–æ–ª–Ω–∏—Ç—å
            </button>
            <button className="btn btn-primary btn-outline btn-sm">
              üí∏ –í—ã–≤–µ—Å—Ç–∏
            </button>
          </div>
        )}

        {/* –ö—É—Ä—Å—ã –¥—Ä—É–≥–∏—Ö –≤–∞–ª—é—Ç */}
        {balance?.exchange_rates && Object.keys(balance.exchange_rates).length > 0 && (
          <div className="mt-3 text-xs opacity-70">
            <p>–ü—Ä–∏–º–µ—Ä–Ω–æ –≤ –¥—Ä—É–≥–∏—Ö –≤–∞–ª—é—Ç–∞—Ö:</p>
            <div className="flex gap-3">
              {Object.entries(balance.exchange_rates).map(([currency, rate]) => (
                currency !== selectedCurrency && (
                  <span key={currency}>
                    {(balance.primary_balance * rate).toFixed(2)} {currency}
                  </span>
                )
              ))}
            </div>
          </div>
        )}
      </div>
    </div>
  );
};

// –§–æ—Ä–º–∞ –≤—ã–≤–æ–¥–∞ —Å—Ä–µ–¥—Å—Ç–≤
export const WithdrawForm: React.FC = () => {
  const { withdrawFunds } = useBalanceManagement();
  const [formData, setFormData] = useState<WithdrawalFormData>({
    amount: '',
    currency: 'RSD',
    bankDetails: {
      iban: '',
      accountHolder: '',
      bankName: '',
      swiftCode: '',
    },
  });
  const [loading, setLoading] = useState(false);

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    setLoading(true);

    try {
      await withdrawFunds({
        amount: parseFloat(formData.amount),
        currency: formData.currency,
        bank_details: formData.bankDetails,
      });

      // –°–±—Ä–æ—Å —Ñ–æ—Ä–º—ã –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏
      setFormData({
        amount: '',
        currency: 'RSD',
        bankDetails: {
          iban: '',
          accountHolder: '',
          bankName: '',
          swiftCode: '',
        },
      });

    } catch (error) {
      toast.error(`–û—à–∏–±–∫–∞: ${error.message}`);
    } finally {
      setLoading(false);
    }
  };

  return (
    <form onSubmit={handleSubmit} className="space-y-4">
      <div className="form-control">
        <label className="label">–°—É–º–º–∞ –≤—ã–≤–æ–¥–∞</label>
        <div className="input-group">
          <input
            type="number"
            className="input input-bordered flex-1"
            placeholder="100.00"
            value={formData.amount}
            onChange={(e) => setFormData(prev => ({ ...prev, amount: e.target.value }))}
            min="10"
            step="0.01"
            required
          />
          <select 
            className="select select-bordered"
            value={formData.currency}
            onChange={(e) => setFormData(prev => ({ ...prev, currency: e.target.value }))}
          >
            <option value="RSD">RSD</option>
            <option value="EUR">EUR</option>
            <option value="USD">USD</option>
          </select>
        </div>
      </div>

      <div className="form-control">
        <label className="label">IBAN –ø–æ–ª—É—á–∞—Ç–µ–ª—è</label>
        <input
          type="text"
          className="input input-bordered"
          placeholder="RS35 2600 0560 1001 6113 79"
          value={formData.bankDetails.iban}
          onChange={(e) => setFormData(prev => ({ 
            ...prev, 
            bankDetails: { ...prev.bankDetails, iban: e.target.value }
          }))}
          required
        />
      </div>

      <div className="form-control">
        <label className="label">–ò–º—è –≤–ª–∞–¥–µ–ª—å—Ü–∞ —Å—á–µ—Ç–∞</label>
        <input
          type="text"
          className="input input-bordered"
          placeholder="Petar Petroviƒá"
          value={formData.bankDetails.accountHolder}
          onChange={(e) => setFormData(prev => ({ 
            ...prev, 
            bankDetails: { ...prev.bankDetails, accountHolder: e.target.value }
          }))}
          required
        />
      </div>

      <div className="form-control">
        <label className="label">–ù–∞–∑–≤–∞–Ω–∏–µ –±–∞–Ω–∫–∞</label>
        <input
          type="text"
          className="input input-bordered"
          placeholder="Banca Intesa"
          value={formData.bankDetails.bankName}
          onChange={(e) => setFormData(prev => ({ 
            ...prev, 
            bankDetails: { ...prev.bankDetails, bankName: e.target.value }
          }))}
          required
        />
      </div>

      <div className="alert alert-info">
        <div className="flex-1">
          <p className="text-sm">
            ‚Ä¢ –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—É–º–º–∞ –≤—ã–≤–æ–¥–∞: 10.00 {formData.currency}<br/>
            ‚Ä¢ –ö–æ–º–∏—Å—Å–∏—è: 2.5% + 1.00 {formData.currency}<br/>
            ‚Ä¢ –í—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏: 1-3 —Ä–∞–±–æ—á–∏—Ö –¥–Ω—è<br/>
            ‚Ä¢ –î–ª—è —Å—É–º–º —Å–≤—ã—à–µ 1000 {formData.currency} —Ç—Ä–µ–±—É–µ—Ç—Å—è –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è KYC
          </p>
        </div>
      </div>

      <button 
        type="submit" 
        className={`btn btn-primary w-full ${loading ? 'loading' : ''}`}
        disabled={loading}
      >
        {loading ? '–û–±—Ä–∞–±–æ—Ç–∫–∞...' : '–ü–æ–¥–∞—Ç—å –∑–∞—è–≤–∫—É –Ω–∞ –≤—ã–≤–æ–¥'}
      </button>
    </form>
  );
};
```

## üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –∏ –≤–∞–ª–∏–¥–∞—Ü–∏—è

### **KYC –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è**
```go
// –°–µ—Ä–≤–∏—Å –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏ KYC
func (s *KYCService) RequiresVerification(ctx context.Context, userID int, amount decimal.Decimal) (bool, error) {
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏–º–∏—Ç–æ–≤ –±–µ–∑ KYC
    if amount.LessThan(s.config.KYCRequiredForAmount) {
        return false, nil
    }

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏
    verification, err := s.repository.GetKYCVerification(ctx, userID)
    if err != nil {
        if errors.Is(err, ErrKYCNotFound) {
            return true, nil // –¢—Ä–µ–±—É–µ—Ç—Å—è –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è
        }
        return false, fmt.Errorf("failed to check KYC status: %w", err)
    }

    return verification.Status != "verified", nil
}

// –í–∞–ª–∏–¥–∞—Ü–∏—è –±–∞–Ω–∫–æ–≤—Å–∫–∏—Ö —Ä–µ–∫–≤–∏–∑–∏—Ç–æ–≤
func (s *WithdrawalService) validateBankDetails(details BankDetails) error {
    // IBAN –≤–∞–ª–∏–¥–∞—Ü–∏—è
    if !s.isValidIBAN(details.IBAN) {
        return errors.New("withdrawal.invalidIBAN")
    }

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–º–µ–Ω–∏ –≤–ª–∞–¥–µ–ª—å—Ü–∞ —Å—á–µ—Ç–∞
    if len(details.AccountHolder) < 2 {
        return errors.New("withdrawal.invalidAccountHolder")
    }

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–∑–≤–∞–Ω–∏—è –±–∞–Ω–∫–∞
    if len(details.BankName) < 3 {
        return errors.New("withdrawal.invalidBankName")
    }

    // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–ª—è –º–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω—ã—Ö –ø–µ—Ä–µ–≤–æ–¥–æ–≤
    if s.isInternationalTransfer(details.IBAN) {
        if details.SwiftCode == "" {
            return errors.New("withdrawal.swiftCodeRequired")
        }
        if !s.isValidSwiftCode(details.SwiftCode) {
            return errors.New("withdrawal.invalidSwiftCode")
        }
    }

    return nil
}

// –ó–∞—â–∏—Ç–∞ –æ—Ç –æ—Ç–º—ã–≤–∞–Ω–∏—è –¥–µ–Ω–µ–≥
func (s *BalanceService) checkAntiMoneyLaundering(ctx context.Context, userID int, amount decimal.Decimal, operation string) error {
    // –ü–æ–ª—É—á–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ –æ–ø–µ—Ä–∞—Ü–∏–π –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 30 –¥–Ω–µ–π
    history, err := s.repository.GetUserTransactionHistory(ctx, userID, 30*24*time.Hour)
    if err != nil {
        return fmt.Errorf("failed to get transaction history: %w", err)
    }

    var totalDeposits, totalWithdrawals decimal.Decimal
    for _, tx := range history {
        if tx.Type == "deposit" {
            totalDeposits = totalDeposits.Add(tx.Amount)
        } else if tx.Type == "withdrawal" {
            totalWithdrawals = totalWithdrawals.Add(tx.Amount)
        }
    }

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—É—é –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å
    monthlyLimit := decimal.NewFromFloat(50000) // 50,000 RSD –≤ –º–µ—Å—è—Ü
    
    switch operation {
    case "deposit":
        if totalDeposits.Add(amount).GreaterThan(monthlyLimit) {
            return errors.New("aml.monthlyDepositLimitExceeded")
        }
    case "withdrawal":
        if totalWithdrawals.Add(amount).GreaterThan(monthlyLimit) {
            return errors.New("aml.monthlyWithdrawalLimitExceeded")
        }
    }

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —á–∞—Å—Ç—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ (–≤–æ–∑–º–æ–∂–Ω–∞—è –Ω–∞–∫—Ä—É—Ç–∫–∞)
    recentOps := 0
    for _, tx := range history {
        if time.Since(tx.CreatedAt) < 24*time.Hour && tx.Type == operation {
            recentOps++
        }
    }

    if recentOps >= 10 {
        return errors.New("aml.tooManyRecentOperations")
    }

    return nil
}
```

## üìä –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –∏ –º–µ—Ç—Ä–∏–∫–∏

### **–§–∏–Ω–∞–Ω—Å–æ–≤–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞**
```go
// –ú–µ—Ç—Ä–∏–∫–∏ –±–∞–ª–∞–Ω—Å–æ–≤ –∏ –æ–ø–µ—Ä–∞—Ü–∏–π
type BalanceMetrics struct {
    TotalUserBalances     decimal.Decimal `json:"total_user_balances"`
    TotalFrozenFunds      decimal.Decimal `json:"total_frozen_funds"`
    DailyDeposits         decimal.Decimal `json:"daily_deposits"`
    DailyWithdrawals      decimal.Decimal `json:"daily_withdrawals"`
    AverageDepositAmount  decimal.Decimal `json:"average_deposit_amount"`
    AverageWithdrawalAmount decimal.Decimal `json:"average_withdrawal_amount"`
    ConversionRate        float64         `json:"conversion_rate"`
    PopularCurrencies     map[string]int  `json:"popular_currencies"`
    WithdrawalSuccessRate float64         `json:"withdrawal_success_rate"`
}

func (s *BalanceAnalyticsService) GenerateMetrics(ctx context.Context, period time.Duration) (*BalanceMetrics, error) {
    since := time.Now().Add(-period)
    
    // –û–±—â–∏–µ –±–∞–ª–∞–Ω—Å—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    totalBalances, err := s.repository.GetTotalUserBalances(ctx)
    if err != nil {
        return nil, err
    }

    totalFrozen, err := s.repository.GetTotalFrozenFunds(ctx)
    if err != nil {
        return nil, err
    }

    // –î–µ–ø–æ–∑–∏—Ç—ã –∑–∞ –ø–µ—Ä–∏–æ–¥
    dailyDeposits, err := s.repository.GetTotalDeposits(ctx, since)
    if err != nil {
        return nil, err
    }

    // –í—ã–≤–æ–¥—ã –∑–∞ –ø–µ—Ä–∏–æ–¥
    dailyWithdrawals, err := s.repository.GetTotalWithdrawals(ctx, since)
    if err != nil {
        return nil, err
    }

    // –°—Ä–µ–¥–Ω–∏–µ —Å—É–º–º—ã
    avgDeposit, err := s.repository.GetAverageDepositAmount(ctx, since)
    if err != nil {
        return nil, err
    }

    avgWithdrawal, err := s.repository.GetAverageWithdrawalAmount(ctx, since)
    if err != nil {
        return nil, err
    }

    // –ü–æ–ø—É–ª—è—Ä–Ω—ã–µ –≤–∞–ª—é—Ç—ã
    currencyStats, err := s.repository.GetCurrencyStats(ctx, since)
    if err != nil {
        return nil, err
    }

    // –£—Å–ø–µ—à–Ω–æ—Å—Ç—å –≤—ã–≤–æ–¥–æ–≤
    successRate, err := s.repository.GetWithdrawalSuccessRate(ctx, since)
    if err != nil {
        return nil, err
    }

    return &BalanceMetrics{
        TotalUserBalances:       totalBalances,
        TotalFrozenFunds:        totalFrozen,
        DailyDeposits:          dailyDeposits,
        DailyWithdrawals:       dailyWithdrawals,
        AverageDepositAmount:   avgDeposit,
        AverageWithdrawalAmount: avgWithdrawal,
        PopularCurrencies:      currencyStats,
        WithdrawalSuccessRate:  successRate,
    }, nil
}
```

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### **Unit —Ç–µ—Å—Ç—ã**
```go
func TestBalanceService_CreateWithdrawal(t *testing.T) {
    tests := []struct {
        name           string
        request        WithdrawalRequest
        mockSetup      func(*MockBalanceRepository, *MockKYCService)
        expectedResult *WithdrawalResult
        expectedError  string
    }{
        {
            name: "successful_withdrawal_under_kyc_limit",
            request: WithdrawalRequest{
                UserID:   1,
                Amount:   decimal.NewFromFloat(500.00),
                Currency: "RSD",
                BankDetails: BankDetails{
                    IBAN:          "RS35260005601001611379",
                    AccountHolder: "Petar Petrovic",
                    BankName:      "Banca Intesa",
                },
            },
            mockSetup: func(repo *MockBalanceRepository, kyc *MockKYCService) {
                repo.EXPECT().GetBalance(gomock.Any(), 1).Return(&models.Balance{
                    UserID: 1,
                    Amount: decimal.NewFromFloat(1000.00),
                }, nil)
                repo.EXPECT().FreezeBalance(gomock.Any(), gomock.Any(), 1, gomock.Any()).Return(nil)
                repo.EXPECT().CreateWithdrawalRequest(gomock.Any(), gomock.Any(), gomock.Any()).Return(nil)
            },
            expectedResult: &WithdrawalResult{
                Amount:   decimal.NewFromFloat(500.00),
                Fee:      decimal.NewFromFloat(13.50), // 2.5% + 1.00
                Status:   "pending",
            },
        },
        {
            name: "kyc_required_for_large_amount",
            request: WithdrawalRequest{
                UserID:   1,
                Amount:   decimal.NewFromFloat(1500.00),
                Currency: "RSD",
            },
            mockSetup: func(repo *MockBalanceRepository, kyc *MockKYCService) {
                kyc.EXPECT().GetVerificationStatus(gomock.Any(), 1).Return("pending", nil)
            },
            expectedError: "withdrawal.kycRequired",
        },
    }

    for _, tt := range tests {
        t.Run(tt.name, func(t *testing.T) {
            // Test implementation
        })
    }
}
```

### **Integration —Ç–µ—Å—Ç—ã**
```typescript
describe('Balance Management Integration', () => {
  it('should complete deposit flow successfully', async () => {
    const user = await createTestUser();
    await loginUser(user.email);

    // –ò–Ω–∏—Ü–∏–∞—Ü–∏—è –¥–µ–ø–æ–∑–∏—Ç–∞
    const depositResult = await createDeposit({
      amount: 100.00,
      currency: 'RSD',
      paymentMethod: 'stripe',
    });

    expect(depositResult.success).toBe(true);
    expect(depositResult.data.amount).toBe(100.00);

    // –°–∏–º—É–ª—è—Ü–∏—è —É—Å–ø–µ—à–Ω–æ–≥–æ –ø–ª–∞—Ç–µ–∂–∞
    await mockSuccessfulPayment(depositResult.data.payment_id);

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞
    await waitFor(async () => {
      const balance = await fetchUserBalance();
      expect(balance.data.primary_balance).toBe(100.00);
    });
  });

  it('should handle withdrawal with KYC requirement', async () => {
    const user = await createTestUser();
    await setUserBalance(user.id, 2000.00);
    await loginUser(user.email);

    // –ü–æ–ø—ã—Ç–∫–∞ –±–æ–ª—å—à–æ–≥–æ –≤—ã–≤–æ–¥–∞ –±–µ–∑ KYC
    const withdrawalResult = await createWithdrawal({
      amount: 1500.00,
      currency: 'RSD',
      bankDetails: testBankDetails,
    });

    expect(withdrawalResult.success).toBe(false);
    expect(withdrawalResult.error).toContain('kycRequired');

    // –ü—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏–µ KYC
    await completeKYCVerification(user.id);

    // –ü–æ–≤—Ç–æ—Ä–Ω–∞—è –ø–æ–ø—ã—Ç–∫–∞ –≤—ã–≤–æ–¥–∞
    const secondAttempt = await createWithdrawal({
      amount: 1500.00,
      currency: 'RSD',
      bankDetails: testBankDetails,
    });

    expect(secondAttempt.success).toBe(true);
    expect(secondAttempt.data.status).toBe('pending');
  });
});
```

## üìà –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –∞–ª–µ—Ä—Ç—ã

### **–ê–ª–µ—Ä—Ç—ã –¥–ª—è –±–∞–ª–∞–Ω—Å–æ–≤**
```yaml
# balance-alerts.yml
groups:
  - name: balance_alerts
    rules:
      - alert: LowPlatformLiquidity
        expr: sum(user_balances_total) > platform_reserve_funds * 0.8
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "Platform liquidity is running low"
          description: "User balances are {{ $value }}% of platform reserves"
      
      - alert: HighWithdrawalFailureRate
        expr: (rate(withdrawal_requests_failed_total[1h]) / rate(withdrawal_requests_total[1h])) > 0.1
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "High withdrawal failure rate"
          description: "{{ $value | humanizePercentage }} of withdrawals are failing"
      
      - alert: SuspiciousBalanceActivity
        expr: rate(balance_transactions_total{type="deposit"}[1h]) > 100
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Unusually high deposit activity"
          description: "{{ $value }} deposits per hour detected"
```

---

## üìã –ö–æ–Ω—Ç—Ä–æ–ª—å–Ω–∞—è –∫–∞—Ä—Ç–∞ –ø—Ä–æ—Ü–µ—Å—Å–∞

### ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
- [x] –ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞ —á–µ—Ä–µ–∑ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ payment gateway
- [x] –í—ã–≤–æ–¥ —Å—Ä–µ–¥—Å—Ç–≤ —Å KYC –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–µ–π
- [x] –ú—É–ª—å—Ç–∏-–≤–∞–ª—é—Ç–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞ —Å –∞–≤—Ç–æ–∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–µ–π
- [x] –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –æ—Ç –ø—Ä–æ–¥–∞–∂
- [x] –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞/—Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ —Å—Ä–µ–¥—Å—Ç–≤ –¥–ª—è —ç—Å–∫—Ä–æ—É
- [x] –°–∏—Å—Ç–µ–º–∞ –∫–æ–º–∏—Å—Å–∏–π –∏ —Ä–∞—Å—á–µ—Ç–æ–≤
- [x] AML –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏ –ª–∏–º–∏—Ç—ã
- [x] Real-time –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–æ–≤
- [x] –î–µ—Ç–∞–ª—å–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π

### üîÑ –ü—Ä–æ—Ü–µ—Å—Å—ã –Ω–∞ –¥–æ—Ä–∞–±–æ—Ç–∫–µ
- [ ] –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–º–∏ –±–∞–Ω–∫–∞–º–∏
- [ ] –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –º–æ—à–µ–Ω–Ω–∏—á–µ—Å–∫–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
- [ ] –ö—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç–Ω—ã–µ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è –∏ –≤—ã–≤–æ–¥—ã
- [ ] –°–∏—Å—Ç–µ–º–∞ –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏ —Å –∫–µ—à–±—ç–∫–æ–º
- [ ] P2P –ø–µ—Ä–µ–≤–æ–¥—ã –º–µ–∂–¥—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏

### üìä –ú–µ—Ç—Ä–∏–∫–∏ —É—Å–ø–µ—Ö–∞
- **–£—Å–ø–µ—à–Ω–æ—Å—Ç—å –¥–µ–ø–æ–∑–∏—Ç–æ–≤**: > 98%
- **–í—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤—ã–≤–æ–¥–æ–≤**: < 3 —Ä–∞–±–æ—á–∏—Ö –¥–Ω—è
- **KYC –∫–æ–Ω–≤–µ—Ä—Å–∏—è**: > 80%
- **–¢–æ—á–Ω–æ—Å—Ç—å –∫—É—Ä—Å–æ–≤ –≤–∞–ª—é—Ç**: ¬±0.1%
- **–î–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å —Å–∏—Å—Ç–µ–º—ã**: > 99.9%