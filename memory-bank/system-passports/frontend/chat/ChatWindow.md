# –ü–∞—Å–ø–æ—Ä—Ç –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞: ChatWindow

## üìã –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
- **–ü—É—Ç—å**: `/frontend/svetu/src/components/Chat/ChatWindow.tsx`
- **–†–æ–ª—å**: –û—Å–Ω–æ–≤–Ω–æ–µ –æ–∫–Ω–æ —á–∞—Ç–∞ –¥–ª—è –æ–±–º–µ–Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏
- **–¢–∏–ø**: Client Component
- **–†–∞–∑–º–µ—Ä**: 601 —Å—Ç—Ä–æ–∫–∞

## üéØ –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ
–ì–ª–∞–≤–Ω—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —á–∞—Ç–æ–º, –≤–∫–ª—é—á–∞—è:
- –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏–π —Å –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π
- –û—Ç–ø—Ä–∞–≤–∫—É –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π —á–µ—Ä–µ–∑ MessageInput
- –ò–Ω–¥–∏–∫–∞—Ü–∏—é –ø–µ—á–∞—Ç–∞–Ω–∏—è –∏ –æ–Ω–ª–∞–π–Ω-—Å—Ç–∞—Ç—É—Å–∞
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫—É—é –ø—Ä–æ–∫—Ä—É—Ç–∫—É –∏ –∑–∞–≥—Ä—É–∑–∫—É —Å—Ç–∞—Ä—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
- –ü–æ–¥–¥–µ—Ä–∂–∫—É –Ω–æ–≤—ã—Ö —á–∞—Ç–æ–≤ (–ø–æ —Ç–æ–≤–∞—Ä—É –∏–ª–∏ –∫–æ–Ω—Ç–∞–∫—Ç—É)
- –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞ –≤ –∫–æ–Ω—Ç–∞–∫—Ç—ã

## üîß –°—Ç—Ä—É–∫—Ç—É—Ä–∞ Props
```typescript
interface ChatWindowProps {
  chat?: MarketplaceChat;        // –°—É—â–µ—Å—Ç–≤—É—é—â–∏–π —á–∞—Ç
  initialListingId?: number;      // ID —Ç–æ–≤–∞—Ä–∞ –¥–ª—è –Ω–æ–≤–æ–≥–æ —á–∞—Ç–∞
  initialSellerId?: number;       // ID –ø—Ä–æ–¥–∞–≤—Ü–∞ –¥–ª—è –Ω–æ–≤–æ–≥–æ —á–∞—Ç–∞
  initialContactId?: number;      // ID –∫–æ–Ω—Ç–∞–∫—Ç–∞ –¥–ª—è –ø—Ä—è–º–æ–≥–æ —á–∞—Ç–∞
  onBack?: () => void;           // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ "–ù–∞–∑–∞–¥"
  showBackButton?: boolean;       // –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –∫–Ω–æ–ø–∫—É "–ù–∞–∑–∞–¥"
}
```

## üîó –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∏ —Å–≤—è–∑–∏

### –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:
- `@/hooks/useChat` - —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —á–∞—Ç–∞–º–∏ –∏ —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏
- `@/contexts/AuthContext` - –∫–æ–Ω—Ç–µ–∫—Å—Ç –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
- `@/types/chat` - —Ç–∏–ø—ã –¥–ª—è —á–∞—Ç–æ–≤
- `@/config` - –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –¥–ª—è URL –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
- `@/services/contacts` - —Å–µ—Ä–≤–∏—Å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –∫–æ–Ω—Ç–∞–∫—Ç–∞–º–∏
- `@/utils/timeUtils` - —É—Ç–∏–ª–∏—Ç—ã –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏
- `./MessageItem` - –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –æ—Ç–¥–µ–ª—å–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
- `./MessageInput` - –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –≤–≤–æ–¥–∞ —Å–æ–æ–±—â–µ–Ω–∏—è

### –í–Ω–µ—à–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:
- `next-intl` - –∏–Ω—Ç–µ—Ä–Ω–∞—Ü–∏–æ–Ω–∞–ª–∏–∑–∞—Ü–∏—è (useTranslations, useParams)
- `next/image` - –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
- `next/link` - –Ω–∞–≤–∏–≥–∞—Ü–∏—è
- React hooks: `useState`, `useEffect`, `useRef`, `useMemo`

### –ò—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ API/Hooks:
```typescript
const {
  messages,              // –û–±—ä–µ–∫—Ç —Å–æ –≤—Å–µ–º–∏ —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏ –ø–æ —á–∞—Ç–∞–º
  isLoading,            // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π
  hasMoreMessages,      // –ï—Å—Ç—å –ª–∏ –µ—â–µ —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏
  messagesLoaded,       // –§–ª–∞–≥–∏ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ —á–∞—Ç–∞–º
  loadMessages,         // –§—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π
  markMessagesAsRead,   // –ü–æ–º–µ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö
  typingUsers,          // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏, –∫–æ—Ç–æ—Ä—ã–µ –ø–µ—á–∞—Ç–∞—é—Ç
  onlineUsers,          // –°–ø–∏—Å–æ–∫ –æ–Ω–ª–∞–π–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
  userLastSeen,         // –í—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –≤–∏–∑–∏—Ç–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
} = useChat();
```

## üß† –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º

### –õ–æ–∫–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ:
```typescript
const [isAtBottom, setIsAtBottom] = useState(true);        // –ù–∞—Ö–æ–¥–∏–º—Å—è –≤–Ω–∏–∑—É —Å–ø–∏—Å–∫–∞
const [isNewChat] = useState(!chat && ...);                // –≠—Ç–æ –Ω–æ–≤—ã–π —á–∞—Ç
const [isContactChat] = useState(...);                     // –≠—Ç–æ –ø—Ä—è–º–æ–π —á–∞—Ç —Å –∫–æ–Ω—Ç–∞–∫—Ç–æ–º
const [listingInfo, setListingInfo] = useState(null);      // –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç–æ–≤–∞—Ä–µ
const [isLoadingOldMessages, setIsLoadingOldMessages] = useState(false);  // –ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ä—ã—Ö
const [isAddingContact, setIsAddingContact] = useState(false);           // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ç–∞–∫—Ç–∞
const [isInitialLoad, setIsInitialLoad] = useState(true);               // –ü–µ—Ä–≤–∞—è –∑–∞–≥—Ä—É–∑–∫–∞
```

### –ú–µ–º–æ–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è:
- `chatMessages` - —Å–æ–æ–±—â–µ–Ω–∏—è —Ç–µ–∫—É—â–µ–≥–æ —á–∞—Ç–∞
- `hasMore` - –µ—Å—Ç—å –ª–∏ –µ—â–µ —Å–æ–æ–±—â–µ–Ω–∏—è
- `typingInThisChat` - –∫—Ç–æ –ø–µ—á–∞—Ç–∞–µ—Ç –≤ —ç—Ç–æ–º —á–∞—Ç–µ
- `isOtherUserOnline` - –æ–Ω–ª–∞–π–Ω –ª–∏ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫

## üíº –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞

### 1. –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π:
- –ü—Ä–∏ —Å–º–µ–Ω–µ —á–∞—Ç–∞ —Å –æ—Ç–º–µ–Ω–æ–π –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ (AbortController)
- –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–ª–∞–≥–∞ messagesLoaded –¥–ª—è –∏–∑–±–µ–∂–∞–Ω–∏—è –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –∑–∞–≥—Ä—É–∑–æ–∫
- –ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–∞–º–∏ –ø–æ 20 —Å–æ–æ–±—â–µ–Ω–∏–π

### 2. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–∫—Ä—É—Ç–∫–∞:
- –ü—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —á–∞—Ç–∞ - –∫ –ø–æ—Å–ª–µ–¥–Ω–µ–º—É —Å–æ–æ–±—â–µ–Ω–∏—é
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç MutationObserver –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è DOM
- –ù–µ—Å–∫–æ–ª—å–∫–æ –ø–æ–ø—ã—Ç–æ–∫ –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ (50, 150, 300, 500–º—Å)
- –û—Ç–∫–ª—é—á–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ 600–º—Å

### 3. –ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ä—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π:
- –ü—Ä–∏ —Å–∫—Ä–æ–ª–ª–µ –≤–≤–µ—Ä—Ö (scrollTop < 100)
- –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–æ–∑–∏—Ü–∏–∏ —Å–∫—Ä–æ–ª–ª–∞ –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏
- –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ —á–µ—Ä–µ–∑ isLoadingOldMessages

### 4. –ü–æ–º–µ—Ç–∫–∞ –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ:
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–ª—è –≤—Å–µ—Ö –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –ø–æ–ª—É—á–∞—Ç–µ–ª—è
- –í—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å–ø–∏—Å–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π

### 5. –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤ –∫–æ–Ω—Ç–∞–∫—Ç—ã:
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –∏ –Ω–∞–ª–∏—á–∏—è —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞
- –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —Ç–∏–ø–æ–≤ –æ—à–∏–±–æ–∫ —Å –ª–æ–∫–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–º–∏ —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏
- –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∑–∞–º–µ—Ç–∫–∏ —Å –Ω–∞–∑–≤–∞–Ω–∏–µ–º —Ç–æ–≤–∞—Ä–∞

### 6. –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ –º–∞—Ä–∫–µ—Ä—ã —á–∞—Ç–æ–≤:
- `__DIRECT_MESSAGE__` - –ø—Ä—è–º–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
- `__DELETED_LISTING__` - —É–¥–∞–ª–µ–Ω–Ω–æ–µ –æ–±—ä—è–≤–ª–µ–Ω–∏–µ

## üé® UI —Å—Ç—Ä—É–∫—Ç—É—Ä–∞

### –û—Å–Ω–æ–≤–Ω—ã–µ —Å–µ–∫—Ü–∏–∏:

1. **–ó–∞–≥–æ–ª–æ–≤–æ–∫ —á–∞—Ç–∞** (p-3 sm:p-4):
   - –ö–Ω–æ–ø–∫–∞ "–ù–∞–∑–∞–¥" (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
   - –ê–≤–∞—Ç–∞—Ä —Ç–æ–≤–∞—Ä–∞ –∏–ª–∏ –∏–∫–æ–Ω–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
   - –ù–∞–∑–≤–∞–Ω–∏–µ —á–∞—Ç–∞ –∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–µ
   - –û–Ω–ª–∞–π–Ω-—Å—Ç–∞—Ç—É—Å –∏ –≤—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –≤–∏–∑–∏—Ç–∞
   - –ö–Ω–æ–ø–∫–∏: —Å—Å—ã–ª–∫–∞ –Ω–∞ —Ç–æ–≤–∞—Ä, –¥–æ–±–∞–≤–∏—Ç—å –≤ –∫–æ–Ω—Ç–∞–∫—Ç—ã

2. **–û–±–ª–∞—Å—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–π** (flex-1 overflow-y-auto):
   - –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ä—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
   - –°–ø–∏—Å–æ–∫ —Å–æ–æ–±—â–µ–Ω–∏–π —á–µ—Ä–µ–∑ MessageItem
   - –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø–µ—á–∞—Ç–∞–Ω–∏—è
   - –ü–∞—Ç—Ç–µ—Ä–Ω —Ñ–æ–Ω–∞ chat-pattern-hexagon

3. **–ö–Ω–æ–ø–∫–∞ –ø—Ä–æ–∫—Ä—É—Ç–∫–∏** (absolute):
   - –ü–æ—è–≤–ª—è–µ—Ç—Å—è –∫–æ–≥–¥–∞ –Ω–µ –≤–Ω–∏–∑—É —Å–ø–∏—Å–∫–∞
   - –ü–æ–∑–∏—Ü–∏—è: bottom-16 right-2

4. **–ü–æ–ª–µ –≤–≤–æ–¥–∞** (flex-shrink-0):
   - –ö–æ–º–ø–æ–Ω–µ–Ω—Ç MessageInput

### –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å:
- –†–∞–∑–º–µ—Ä—ã –∫–Ω–æ–ø–æ–∫: btn-xs sm:btn-sm
- –û—Ç—Å—Ç—É–ø—ã: p-2 sm:p-4 lg:px-8
- –†–∞–∑–º–µ—Ä—ã –∏–∫–æ–Ω–æ–∫: w-4 h-4 sm:w-5 sm:h-5

## üîÑ –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

```tsx
// –°—É—â–µ—Å—Ç–≤—É—é—â–∏–π —á–∞—Ç
<ChatWindow 
  chat={selectedChat}
  showBackButton={true}
  onBack={() => setSelectedChat(null)}
/>

// –ù–æ–≤—ã–π —á–∞—Ç —Å —Ç–æ–≤–∞—Ä–æ–º
<ChatWindow 
  initialListingId={123}
  initialSellerId={456}
  showBackButton={true}
  onBack={() => router.back()}
/>

// –ü—Ä—è–º–æ–π —á–∞—Ç —Å –∫–æ–Ω—Ç–∞–∫—Ç–æ–º
<ChatWindow 
  initialContactId={789}
  showBackButton={false}
/>
```

## üêõ –ò–∑–≤–µ—Å—Ç–Ω—ã–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏

1. **–û—Ç–ª–∞–¥–æ—á–Ω—ã–µ –ª–æ–≥–∏**: –ü—Ä–∏—Å—É—Ç—Å—Ç–≤—É—é—Ç console.log –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏ –∑–∞–≥—Ä—É–∑–∫–∏ –∏ —Å–∫—Ä–æ–ª–ª–∞

2. **–ó–∞–≥—Ä—É–∑–∫–∞ —Ç–æ–≤–∞—Ä–∞**: –î–ª—è –Ω–æ–≤—ã—Ö —á–∞—Ç–æ–≤ –∑–∞–≥—Ä—É–∂–∞–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç–æ–≤–∞—Ä–µ —á–µ—Ä–µ–∑ API

3. **–ü—Ä–æ–∫—Ä—É—Ç–∫–∞**: –°–ª–æ–∂–Ω–∞—è –ª–æ–≥–∏–∫–∞ —Å –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–º–∏ —Ç–∞–π–º–∞—É—Ç–∞–º–∏ –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏

4. **–¢–∏–ø–∏–∑–∞—Ü–∏—è**: –ò—Å–ø–æ–ª—å–∑—É–µ—Ç type assertion –¥–ª—è next-intl –≤ getLastSeenText

5. **Alerts**: –ò—Å–ø–æ–ª—å–∑—É–µ—Ç browser alerts –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π (–Ω–µ toast)

6. **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å**: 
   - –ú–µ–º–æ–∏–∑–∞—Ü–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π –∏ —Å–æ—Å—Ç–æ—è–Ω–∏–π
   - –û—Ç–º–µ–Ω–∞ –∑–∞–ø—Ä–æ—Å–æ–≤ –ø—Ä–∏ —Ä–∞–∑–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏
   - –î–µ–±–∞—É–Ω—Å–∏–Ω–≥ —á–µ—Ä–µ–∑ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∑–∞–≥—Ä—É–∑–∫–∏