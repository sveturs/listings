# Паспорт таблицы: reviews

## Общая информация
- **Название**: reviews
- **Схема**: public
- **Описание**: Основная таблица для хранения отзывов пользователей о различных объектах системы (объявления, продавцы, услуги)
- **Тип данных**: Пользовательский контент (UGC)
- **Примерный размер**: 10K-100K записей
- **Частота обновления**: Высокая (ежедневно новые отзывы)

## Структура таблицы

### Основные поля

| Поле | Тип | Обязательность | Описание | Ограничения |
|------|-----|----------------|----------|-------------|
| id | SERIAL | PRIMARY KEY | Уникальный идентификатор отзыва | Автоинкремент |
| user_id | INT | NOT NULL | ID пользователя, оставившего отзыв | FK -> users(id) ON DELETE CASCADE |
| entity_type | VARCHAR(50) | NOT NULL | Тип объекта отзыва | 'listing', 'user', 'service' |
| entity_id | INT | NOT NULL | ID объекта отзыва | Зависит от entity_type |
| rating | INT | NOT NULL | Рейтинг от 1 до 5 | CHECK (rating >= 1 AND rating <= 5) |
| comment | TEXT | NULL | Текст отзыва | - |
| pros | TEXT | NULL | Достоинства | - |
| cons | TEXT | NULL | Недостатки | - |
| photos | TEXT[] | NULL | Массив URL фотографий | PostgreSQL array |
| likes_count | INT | DEFAULT 0 | Количество лайков | >= 0 |
| helpful_votes | INT | DEFAULT 0 | Количество голосов "полезно" | >= 0 |
| not_helpful_votes | INT | DEFAULT 0 | Количество голосов "не полезно" | >= 0 |
| is_verified_purchase | BOOLEAN | DEFAULT false | Подтвержденная покупка | - |
| status | VARCHAR(20) | DEFAULT 'published' | Статус отзыва | CHECK IN ('draft', 'published', 'hidden', 'deleted') |
| original_language | VARCHAR(2) | DEFAULT 'en' | Язык оригинала | ISO 639-1 |
| created_at | TIMESTAMP | DEFAULT NOW() | Дата создания | - |
| updated_at | TIMESTAMP | DEFAULT NOW() | Дата обновления | Обновляется триггером |

### Дополнительные поля (из миграции 000046)

| Поле | Тип | Обязательность | Описание |
|------|-----|----------------|----------|
| seller_confirmed | BOOLEAN | DEFAULT false | Подтверждение продавцом |
| has_active_dispute | BOOLEAN | DEFAULT false | Наличие активного спора |

## Индексы

| Название | Поля | Тип | Описание |
|----------|------|-----|----------|
| reviews_pkey | id | PRIMARY KEY | Первичный ключ |
| idx_reviews_entity | entity_type, entity_id | INDEX | Поиск отзывов по объекту |
| idx_reviews_user | user_id | INDEX | Отзывы пользователя |
| idx_reviews_rating | rating | INDEX | Фильтрация по рейтингу |
| idx_reviews_status | status | INDEX | Фильтрация по статусу |
| idx_reviews_user_entity_unique | user_id, entity_type, entity_id | UNIQUE WHERE status != 'deleted' | Защита от дублей |
| idx_reviews_seller_confirmed | seller_confirmed | INDEX WHERE seller_confirmed = true | Подтвержденные отзывы |
| idx_reviews_has_dispute | has_active_dispute | INDEX WHERE has_active_dispute = true | Отзывы со спорами |

## Связи

### Внешние ключи (Foreign Keys)

| Поле | Ссылается на | Действие при удалении |
|------|--------------|----------------------|
| user_id | users(id) | CASCADE |

### Обратные связи (таблицы, ссылающиеся на reviews)

| Таблица | Поле | Описание |
|---------|------|----------|
| review_responses | review_id | Ответы на отзывы |
| review_votes | review_id | Голоса за полезность |
| review_confirmations | review_id | Подтверждения продавцов |
| review_disputes | review_id | Споры по отзывам |
| translations | entity_id (при entity_type='review') | Переводы отзывов |

## Триггеры

| Название | Событие | Функция | Описание |
|----------|---------|---------|----------|
| update_reviews_updated_at | BEFORE UPDATE | update_updated_at_column() | Обновление поля updated_at |

## Бизнес-логика

### Основные операции
1. **Создание отзыва**: Пользователь может оставить отзыв с рейтингом и комментарием
2. **Модерация**: Администраторы могут скрывать неподходящие отзывы (status = 'hidden')
3. **Голосование**: Пользователи могут отмечать отзывы как полезные/бесполезные
4. **Верификация**: Система может подтверждать покупку (is_verified_purchase)
5. **Споры**: Продавцы могут оспаривать отзывы через систему споров

### Ограничения и правила
- Один пользователь = один отзыв на объект (уникальный индекс)
- Рейтинг обязателен (1-5 звезд)
- Удаленные отзывы (status='deleted') не учитываются в уникальности
- Фотографии хранятся как массив URL в MinIO

### Интеграции
- **Уведомления**: При новом отзыве отправляется уведомление владельцу объекта
- **Переводы**: Отзывы могут быть переведены через таблицу translations
- **Поиск**: Отзывы индексируются в OpenSearch для полнотекстового поиска
- **Статистика**: Агрегированные данные используются для рейтингов объектов

## Безопасность

### Права доступа
- **Создание**: Только авторизованные пользователи
- **Чтение**: Публичный доступ для published отзывов
- **Обновление**: Только автор в течение 24 часов
- **Удаление**: Soft delete через status='deleted'

### Защита от спама
- Rate limiting на уровне API
- Уникальный индекс предотвращает множественные отзывы
- Модерация подозрительного контента

## Производительность

### Оптимизации
- Индексы на все поля фильтрации
- Партиционирование по entity_type при росте данных
- Кеширование агрегированных рейтингов
- Асинхронная обработка фотографий

### Мониторинг
- Среднее время отклика на запросы отзывов
- Количество новых отзывов в день
- Процент отзывов со спорами
- Использование дискового пространства для фотографий

## Изменения и миграции

### История изменений
1. **000001_create_tables.up.sql**: Создание базовой структуры
2. **000046_add_review_constraints_and_tables.up.sql**: 
   - Добавлены поля seller_confirmed, has_active_dispute
   - Создан уникальный индекс для защиты от спама
   - Добавлены таблицы для споров и подтверждений

### Планируемые изменения
- Добавление поддержки видео-отзывов
- Расширение системы верификации покупок
- Интеграция с внешними системами отзывов
- ML-модерация контента