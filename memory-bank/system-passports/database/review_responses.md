# Паспорт таблицы: review_responses

## Общая информация
- **Название**: review_responses
- **Схема**: public
- **Описание**: Таблица для хранения ответов на отзывы (обычно от продавцов или представителей компании)
- **Тип данных**: Пользовательский контент, коммуникации
- **Примерный размер**: 5K-50K записей
- **Частота обновления**: Средняя (несколько ответов в день)

## Структура таблицы

### Поля

| Поле | Тип | Обязательность | Описание | Ограничения |
|------|-----|----------------|----------|-------------|
| id | SERIAL | PRIMARY KEY | Уникальный идентификатор ответа | Автоинкремент |
| review_id | INT | NOT NULL | ID отзыва, на который дан ответ | FK -> reviews(id) ON DELETE CASCADE |
| user_id | INT | NOT NULL | ID пользователя, давшего ответ | FK -> users(id) ON DELETE CASCADE |
| response | TEXT | NOT NULL | Текст ответа | Не может быть пустым |
| created_at | TIMESTAMP | DEFAULT NOW() | Дата создания ответа | - |
| updated_at | TIMESTAMP | DEFAULT NOW() | Дата последнего обновления | Обновляется триггером |

## Индексы

| Название | Поля | Тип | Описание |
|----------|------|-----|----------|
| review_responses_pkey | id | PRIMARY KEY | Первичный ключ |
| review_responses_review_id_fkey | review_id | FOREIGN KEY | Связь с отзывом |
| review_responses_user_id_fkey | user_id | FOREIGN KEY | Связь с пользователем |

### Рекомендуемые индексы (отсутствуют в текущей схеме)
- INDEX на review_id для быстрого поиска ответов на конкретный отзыв
- INDEX на user_id для поиска всех ответов пользователя
- UNIQUE INDEX на (review_id, user_id) для предотвращения дублей

## Связи

### Внешние ключи (Foreign Keys)

| Поле | Ссылается на | Действие при удалении | Описание |
|------|--------------|----------------------|----------|
| review_id | reviews(id) | CASCADE | При удалении отзыва удаляются все ответы |
| user_id | users(id) | CASCADE | При удалении пользователя удаляются его ответы |

### Обратные связи
- Нет таблиц, напрямую ссылающихся на review_responses

## Триггеры

| Название | Событие | Функция | Описание |
|----------|---------|---------|----------|
| update_review_responses_updated_at | BEFORE UPDATE | update_updated_at_column() | Автоматическое обновление поля updated_at |

## Бизнес-логика

### Основные операции
1. **Создание ответа**: Продавец или официальный представитель отвечает на отзыв
2. **Редактирование**: Автор может редактировать свой ответ
3. **Удаление**: Soft delete или полное удаление через CASCADE

### Ограничения и правила
- Один пользователь может оставить только один ответ на отзыв
- Ответ не может быть пустым (response NOT NULL)
- Обычно право отвечать есть только у:
  - Владельца объекта отзыва (продавца)
  - Администраторов системы
  - Официальных представителей компании

### Типичные сценарии использования
1. **Ответ продавца на негативный отзыв**: Объяснение ситуации, извинения, предложение решения
2. **Благодарность за положительный отзыв**: Поддержание лояльности клиентов
3. **Официальный ответ поддержки**: Решение спорных ситуаций
4. **Уточняющие вопросы**: Запрос дополнительной информации о проблеме

## Безопасность

### Права доступа
- **Создание**: 
  - Владелец объекта отзыва (entity)
  - Администраторы системы
  - Верифицированные представители
- **Чтение**: Публичный доступ
- **Обновление**: Только автор ответа в течение ограниченного времени
- **Удаление**: Администраторы или автор

### Защита от злоупотреблений
- Rate limiting на создание ответов
- Проверка прав на ответ (связь с объектом отзыва)
- Модерация контента
- Ограничение на количество ответов от одного пользователя

## Производительность

### Текущие проблемы
- Отсутствие индекса на review_id замедляет загрузку ответов
- Нет ограничения на количество ответов на один отзыв

### Рекомендации по оптимизации
1. Добавить составной индекс (review_id, created_at) для сортировки
2. Рассмотреть ограничение на количество ответов
3. Кешировать количество ответов в таблице reviews
4. Добавить пагинацию для отзывов с большим количеством ответов

## Интеграции

### Связанные системы
- **Уведомления**: При новом ответе отправляется уведомление автору отзыва
- **Email**: Дублирование важных ответов на email
- **Telegram**: Уведомления через бота
- **Модерация**: Проверка ответов на спам и неприемлемый контент

### API endpoints
- GET /api/reviews/{reviewId}/responses - Получить все ответы на отзыв
- POST /api/reviews/{reviewId}/responses - Создать новый ответ
- PUT /api/review-responses/{id} - Обновить ответ
- DELETE /api/review-responses/{id} - Удалить ответ

## Мониторинг и метрики

### Ключевые показатели
- Процент отзывов с ответами
- Среднее время ответа на отзыв
- Количество ответов в день
- Длина текста ответов

### Алерты
- Большое количество неотвеченных негативных отзывов
- Подозрительная активность (массовые ответы)
- Долгое время ответа на критические отзывы

## Изменения и миграции

### История изменений
1. **000001_create_tables.up.sql**: Создание базовой структуры таблицы

### Планируемые улучшения
- Добавление поля для типа ответа (официальный/неофициальный)
- Система шаблонов для типовых ответов
- Поддержка форматирования текста (Markdown)
- История изменений ответов
- Возможность прикрепления файлов к ответам