# –ü–∞—Å–ø–æ—Ä—Ç —Ç–∞–±–ª–∏—Ü—ã: listing_views

## üéØ –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ
–°–∏—Å—Ç–µ–º–∞ —É—á—ë—Ç–∞ –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤ –æ–±—ä—è–≤–ª–µ–Ω–∏–π –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å–∞. –í–µ–¥—ë—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∫—Ç–æ –∏ –∫–æ–≥–¥–∞ –ø—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞–ª –æ–±—ä—è–≤–ª–µ–Ω–∏—è, –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –Ω–∞–∫—Ä—É—Ç–∫—É –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤.

## üìä –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ç–∞–±–ª–∏—Ü—ã

### –ö–æ–ª–æ–Ω–∫–∏
```sql
id              SERIAL PRIMARY KEY          -- –£–Ω–∏–∫–∞–ª—å–Ω—ã–π ID –ø—Ä–æ—Å–º–æ—Ç—Ä–∞
listing_id      INTEGER NOT NULL            -- ID –æ–±—ä—è–≤–ª–µ–Ω–∏—è (FK -> marketplace_listings.id)
user_id         INTEGER                     -- ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (FK -> users.id), NULL –¥–ª—è –∞–Ω–æ–Ω–∏–º–æ–≤
ip_hash         VARCHAR(255)                -- –•–µ—à IP-–∞–¥—Ä–µ—Å–∞ –¥–ª—è –∞–Ω–æ–Ω–∏–º–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
view_time       TIMESTAMP WITHOUT TIME ZONE -- –í—Ä–µ–º—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é NOW())
```

### –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è
- **FOREIGN KEY**: `listing_id` ‚Üí `marketplace_listings(id)` CASCADE DELETE
- **FOREIGN KEY**: `user_id` ‚Üí `users(id)` CASCADE DELETE  
- **UNIQUE**: `(listing_id, user_id)` - –æ–¥–∏–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –ø—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å –æ–±—ä—è–≤–ª–µ–Ω–∏–µ —Ç–æ–ª—å–∫–æ —Ä–∞–∑
- **CHECK**: `(user_id IS NOT NULL OR ip_hash IS NOT NULL)` - –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ª–∏–±–æ user_id, –ª–∏–±–æ ip_hash

### –ò–Ω–¥–µ–∫—Å—ã
```sql
idx_listing_views_listing_user  -- (listing_id, user_id) - –ø–æ–∏—Å–∫ –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
idx_listing_views_listing_ip    -- (listing_id, ip_hash) - –ø–æ–∏—Å–∫ –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤ –ø–æ IP
idx_listing_views_time          -- (view_time) - –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã
```

## üîÑ –°–≤—è–∑–∏ —Å –¥—Ä—É–≥–∏–º–∏ —Ç–∞–±–ª–∏—Ü–∞–º–∏

### –í—Ö–æ–¥—è—â–∏–µ —Å–≤—è–∑–∏
- `marketplace_listings.id` ‚Üê `listing_views.listing_id` (–º–Ω–æ–≥–æ –∫ –æ–¥–Ω–æ–º—É)
- `users.id` ‚Üê `listing_views.user_id` (–º–Ω–æ–≥–æ –∫ –æ–¥–Ω–æ–º—É, –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

### –ò—Å—Ö–æ–¥—è—â–∏–µ —Å–≤—è–∑–∏
–ù–µ—Ç –ø—Ä—è–º—ã—Ö –∏—Å—Ö–æ–¥—è—â–∏—Ö —Å–≤—è–∑–µ–π.

## üìà –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞

### –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
1. **–£–Ω–∏–∫–∞–ª—å–Ω—ã–π –ø–æ–¥—Å—á—ë—Ç –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤**
   - –û–¥–∏–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å = –æ–¥–∏–Ω –ø—Ä–æ—Å–º–æ—Ç—Ä –Ω–∞ –æ–±—ä—è–≤–ª–µ–Ω–∏–µ
   - –î–ª—è –∞–Ω–æ–Ω–∏–º–æ–≤ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è IP-–∞–¥—Ä–µ—Å

2. **–ò–Ω–∫—Ä–µ–º–µ–Ω—Ç —Å—á—ë—Ç—á–∏–∫–∞**
   - –ü—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –∑–∞–ø–∏—Å–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç—Å—è `marketplace_listings.views_count`
   - –í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –≤ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏

3. **–î–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è**
   - –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –ø–µ—Ä–µ–¥ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ–º
   - –ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–µ: –ø–æ `user_id`
   - –ê–Ω–æ–Ω–∏–º—ã: –ø–æ `ip_hash` —Å —É—Å–ª–æ–≤–∏–µ–º `user_id IS NULL`

### –ê–ª–≥–æ—Ä–∏—Ç–º –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞
```go
// 1. –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä–∞
if userID > 0 {
    // –ü—Ä–æ–≤–µ—Ä–∫–∞: SELECT EXISTS FROM listing_views WHERE listing_id = ? AND user_id = ?
} else if ipHash != "" {
    // –ü—Ä–æ–≤–µ—Ä–∫–∞: SELECT EXISTS FROM listing_views WHERE listing_id = ? AND ip_hash = ? AND user_id IS NULL
}

// 2. –ï—Å–ª–∏ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –Ω–µ—Ç
if !viewExists {
    tx.Begin()
    // –£–≤–µ–ª–∏—á–∏—Ç—å marketplace_listings.views_count += 1
    // –î–æ–±–∞–≤–∏—Ç—å –∑–∞–ø–∏—Å—å –≤ listing_views
    tx.Commit()
}
```

## üíæ –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –≤ –∫–æ–¥–µ

### Backend —Ñ–∞–π–ª—ã
- `backend/internal/storage/postgres/db.go:712` - —Ñ—É–Ω–∫—Ü–∏—è `IncrementViewsCount()`

### –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ
```go
// –£–≤–µ–ª–∏—á–µ–Ω–∏–µ –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –æ–±—ä—è–≤–ª–µ–Ω–∏—è
func (db *Database) IncrementViewsCount(ctx context.Context, id int) error
```

## üîç –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Ä–∞–±–æ—Ç—ã

### –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- **–ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–µ**: `user_id` –∏–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
- **–ê–Ω–æ–Ω–∏–º–Ω—ã–µ**: `ip_address` –∏–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞, —Ö–µ—à–∏—Ä—É–µ—Ç—Å—è –≤ `ip_hash`

### –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –Ω–∞–∫—Ä—É—Ç–∫–∏
- –£–Ω–∏–∫–∞–ª—å–Ω–æ–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –Ω–∞ –ø–∞—Ä—É `(listing_id, user_id)`
- –î–ª—è –∞–Ω–æ–Ω–∏–º–æ–≤: –ø—Ä–æ–≤–µ—Ä–∫–∞ `listing_id + ip_hash + user_id IS NULL`

### –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
- –ò–Ω–¥–µ–∫—Å—ã –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω—ã –¥–ª—è —á–∞—Å—Ç—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ EXISTS –¥–ª—è –±—ã—Å—Ç—Ä–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤

## üìã –ü—Ä–∏–º–µ—Ä—ã –∑–∞–ø—Ä–æ—Å–æ–≤

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º
```sql
SELECT EXISTS (
    SELECT 1 FROM listing_views 
    WHERE listing_id = $1 AND user_id = $2
);
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∞–Ω–æ–Ω–∏–º–æ–º
```sql
SELECT EXISTS (
    SELECT 1 FROM listing_views 
    WHERE listing_id = $1 AND ip_hash = $2 AND user_id IS NULL
);
```

### –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞
```sql
-- –î–ª—è –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω–æ–≥–æ
INSERT INTO listing_views (listing_id, user_id, view_time)
VALUES ($1, $2, NOW());

-- –î–ª—è –∞–Ω–æ–Ω–∏–º–∞  
INSERT INTO listing_views (listing_id, ip_hash, view_time, user_id)
VALUES ($1, $2, NOW(), NULL);
```

## üé® –î–∏–∞–≥—Ä–∞–º–º–∞ —Å–≤—è–∑–µ–π

```
users(id) -----> listing_views(user_id) [0:M, optional]
                       |
marketplace_listings(id) -----> listing_views(listing_id) [1:M]
```

## üìù –ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π
- **000027_create_listing_views.up.sql** - —Å–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã –∏ –∏–Ω–¥–µ–∫—Å–æ–≤

## üîó –°–≤—è–∑–∞–Ω–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
- [marketplace_listings.md](marketplace_listings.md) - –æ—Å–Ω–æ–≤–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ –æ–±—ä—è–≤–ª–µ–Ω–∏–π
- [users.md](users.md) - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Å–∏—Å—Ç–µ–º—ã