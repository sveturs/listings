# Паспорт таблицы: review_votes

## Общая информация
- **Название**: review_votes
- **Схема**: public
- **Описание**: Таблица для хранения голосов пользователей за полезность отзывов
- **Тип данных**: Пользовательские действия, голосования
- **Примерный размер**: 50K-500K записей
- **Частота обновления**: Высокая (сотни голосов в день)

## Структура таблицы

### Поля

| Поле | Тип | Обязательность | Описание | Ограничения |
|------|-----|----------------|----------|-------------|
| review_id | INT | NOT NULL | ID отзыва, за который голосуют | FK -> reviews(id) ON DELETE CASCADE |
| user_id | INT | NOT NULL | ID пользователя, который голосует | FK -> users(id) ON DELETE CASCADE |
| vote_type | VARCHAR(20) | NOT NULL | Тип голоса | CHECK IN ('helpful', 'not_helpful') |
| created_at | TIMESTAMP | DEFAULT NOW() | Дата и время голосования | - |

### Составной первичный ключ
- **PRIMARY KEY**: (review_id, user_id)
- Обеспечивает уникальность: один пользователь = один голос за отзыв

## Индексы

| Название | Поля | Тип | Описание |
|----------|------|-----|----------|
| review_votes_pkey | (review_id, user_id) | PRIMARY KEY | Составной первичный ключ |
| review_votes_review_id_fkey | review_id | FOREIGN KEY | Связь с отзывом |
| review_votes_user_id_fkey | user_id | FOREIGN KEY | Связь с пользователем |

### Рекомендуемые индексы (отсутствуют)
- INDEX на user_id для поиска всех голосов пользователя
- INDEX на (review_id, vote_type) для подсчета голосов по типу
- INDEX на created_at для анализа активности по времени

## Связи

### Внешние ключи (Foreign Keys)

| Поле | Ссылается на | Действие при удалении | Описание |
|------|--------------|----------------------|----------|
| review_id | reviews(id) | CASCADE | При удалении отзыва удаляются все голоса |
| user_id | users(id) | CASCADE | При удалении пользователя удаляются его голоса |

### Связь с другими таблицами
- **reviews**: Таблица отзывов содержит агрегированные счетчики:
  - helpful_votes - количество голосов "полезно"
  - not_helpful_votes - количество голосов "не полезно"

## Бизнес-логика

### Основные операции
1. **Голосование**: Пользователь отмечает отзыв как полезный или бесполезный
2. **Изменение голоса**: Пользователь может изменить свой голос
3. **Отмена голоса**: Удаление записи из таблицы
4. **Подсчет голосов**: Агрегация для отображения рейтинга отзыва

### Ограничения и правила
- Один пользователь может проголосовать за отзыв только один раз
- Нельзя голосовать за свои собственные отзывы (проверка на уровне API)
- При изменении голоса старый удаляется, новый создается
- Голоса анонимны для других пользователей

### Типы голосов
- **helpful** - отзыв полезен, информативен, помогает принять решение
- **not_helpful** - отзыв бесполезен, не информативен, вводит в заблуждение

## Безопасность

### Права доступа
- **Создание**: Только авторизованные пользователи
- **Чтение**: 
  - Агрегированные данные - публичный доступ
  - Детальная информация - только администраторы
- **Обновление**: Через удаление старого и создание нового голоса
- **Удаление**: Только свой голос или администратор

### Защита от манипуляций
- Rate limiting на голосование
- Защита от накрутки через множественные аккаунты
- Мониторинг подозрительной активности
- Невозможность голосовать за свои отзывы

## Производительность

### Оптимизации
- Денормализация: счетчики в таблице reviews
- Асинхронное обновление счетчиков
- Кеширование результатов голосования
- Пакетная обработка голосов

### Проблемы масштабирования
- При большом количестве голосов подсчет "на лету" становится медленным
- Необходимость в периодической синхронизации счетчиков
- Возможные race conditions при одновременных голосах

## Интеграции

### Обновление счетчиков
При каждом голосе необходимо обновлять поля в таблице reviews:
```sql
-- При голосе "helpful"
UPDATE reviews 
SET helpful_votes = helpful_votes + 1 
WHERE id = :review_id;

-- При голосе "not_helpful"
UPDATE reviews 
SET not_helpful_votes = not_helpful_votes + 1 
WHERE id = :review_id;
```

### Уведомления
- Уведомление автору отзыва при достижении определенного количества голосов
- Бейджи и достижения за полезные отзывы

### Алгоритмы ранжирования
Голоса используются для:
- Сортировки отзывов по полезности
- Расчета репутации пользователей
- Выявления качественных отзывов для промо

## Мониторинг и метрики

### Ключевые показатели
- Общее количество голосов в день
- Соотношение helpful/not_helpful
- Процент отзывов с голосами
- Среднее количество голосов на отзыв

### Аномалии для отслеживания
- Массовое голосование от одного IP
- Резкий рост голосов за конкретный отзыв
- Систематическое голосование против отзывов конкурентов

## Изменения и миграции

### История изменений
1. **000001_create_tables.up.sql**: Создание базовой структуры таблицы

### Планируемые улучшения
- Добавление веса голоса на основе репутации пользователя
- Сохранение истории изменения голосов
- Добавление причины голоса "not_helpful"
- Интеграция с системой модерации для автоскрытия отзывов
- A/B тестирование различных UI для голосования