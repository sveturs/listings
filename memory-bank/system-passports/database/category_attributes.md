# Паспорт таблицы: category_attributes

## Общая информация
- **Название**: category_attributes
- **Схема**: public
- **Описание**: Основная таблица для определения атрибутов (характеристик) товаров по категориям
- **Тип данных**: Мета-данные, конфигурация системы
- **Примерный размер**: 500-1000 записей
- **Частота обновления**: Низкая (настройка администраторами)

## Структура таблицы

### Поля

| Поле | Тип | Обязательность | Описание | Ограничения |
|------|-----|----------------|----------|-------------|
| id | SERIAL | PRIMARY KEY | Уникальный идентификатор атрибута | Автоинкремент |
| name | VARCHAR(100) | NOT NULL | Системное имя атрибута (ключ) | Уникальное, snake_case |
| display_name | VARCHAR(255) | NOT NULL | Отображаемое имя для пользователей | Локализуется через translations |
| attribute_type | VARCHAR(50) | NOT NULL | Тип атрибута | 'text', 'number', 'select', 'boolean', etc. |
| options | JSONB | NULL | Варианты выбора, диапазоны значений | Структура зависит от типа |
| validation_rules | JSONB | NULL | Правила валидации значений | min, max, required, pattern, etc. |
| is_searchable | BOOLEAN | DEFAULT true | Участвует в полнотекстовом поиске | - |
| is_filterable | BOOLEAN | DEFAULT true | Доступен в фильтрах | - |
| is_required | BOOLEAN | DEFAULT false | Глобальный флаг обязательности | Переопределяется в mapping |
| sort_order | INT | DEFAULT 0 | Порядок отображения в формах | Меньше = раньше |
| created_at | TIMESTAMP | DEFAULT NOW() | Дата создания атрибута | - |

### Дополнительные поля (из последующих миграций)

| Поле | Тип | Описание | Миграция |
|------|-----|----------|----------|
| icon | VARCHAR(100) | Иконка для атрибута | 000044 |
| display_settings | JSONB | Настройки отображения | 000045 |
| custom_component_id | INT | Связь с кастомным UI компонентом | 000032 |

## Типы атрибутов

### Основные типы (attribute_type)

| Тип | Описание | Пример options | Пример validation_rules |
|-----|----------|----------------|------------------------|
| text | Текстовое поле | `null` | `{"maxLength": 255}` |
| number | Числовое поле | `{"min": 0, "max": 1000, "step": 0.1}` | `{"required": true}` |
| select | Выпадающий список | `{"values": ["Option1", "Option2"]}` | - |
| boolean | Флаг да/нет | `null` | - |
| multiselect | Множественный выбор | `{"values": [...], "maxItems": 3}` | - |
| range | Диапазон значений | `{"min": 0, "max": 100}` | - |

### Примеры конфигурации

```json
// Для автомобилей - марка
{
  "name": "make",
  "attribute_type": "select",
  "options": {
    "values": ["Audi", "BMW", "Mercedes", "Toyota", "Honda"]
  },
  "validation_rules": {
    "required": true
  }
}

// Для недвижимости - площадь
{
  "name": "area", 
  "attribute_type": "number",
  "options": {
    "min": 1,
    "max": 10000,
    "step": 0.1,
    "unit": "m²"
  },
  "validation_rules": {
    "required": true,
    "min": 1
  }
}
```

## Индексы

| Название | Поля | Тип | Описание |
|----------|------|-----|----------|
| category_attributes_pkey | id | PRIMARY KEY | Первичный ключ |
| category_attributes_name_key | name | UNIQUE | Уникальность системного имени |

### Рекомендуемые индексы (могут отсутствовать)
- INDEX на (attribute_type) для фильтрации по типу
- INDEX на (is_searchable, is_filterable) для системных запросов
- INDEX на sort_order для сортировки

## Связи

### Обратные связи (таблицы, ссылающиеся на category_attributes)

| Таблица | Поле | Описание |
|---------|------|----------|
| category_attribute_mapping | attribute_id | Связь атрибутов с категориями |
| listing_attribute_values | attribute_id | Значения атрибутов для объявлений |
| attribute_group_items | attribute_id | Группировка атрибутов |
| custom_ui_component_usage | entity_id | Кастомные UI компоненты |
| translations | entity_id (при entity_type='attribute') | Переводы названий |

## Бизнес-логика

### Основные операции
1. **Создание атрибута**: Администратор создает новый тип характеристики
2. **Привязка к категориям**: Через category_attribute_mapping атрибут связывается с категориями
3. **Заполнение значений**: Пользователи указывают значения в listing_attribute_values
4. **Поиск и фильтрация**: Система использует атрибуты для поиска товаров

### Жизненный цикл атрибута
1. Создание атрибута администратором
2. Настройка options и validation_rules
3. Привязка к категориям товаров
4. Добавление переводов на разные языки
5. Использование в объявлениях пользователями

### Особенности по типам категорий

#### Автомобили (category_id = 2000)
- Обязательные: make, model, year
- Специфичные: engine_capacity, fuel_type, transmission
- Числовые: mileage, power, year

#### Недвижимость (category_id = 1000) 
- Обязательные: property_type, area
- Специфичные: rooms, floor, building_type
- Boolean: has_balcony, has_elevator, has_parking

#### Электроника (категории 3xxx)
- Обязательные: brand, model
- Специфичные: memory, ram, screen_size
- Технические: cpu, gpu, os

## Локализация

### Система переводов
- Названия атрибутов хранятся в таблице `translations`
- Поддержка языков: en, ru, sr
- Автоматические переводы при создании атрибута

### Пример переводов
```sql
-- Английский
entity_type='attribute', entity_id=1, language='en', field_name='display_name', translated_text='Make'

-- Русский  
entity_type='attribute', entity_id=1, language='ru', field_name='display_name', translated_text='Марка'

-- Сербский
entity_type='attribute', entity_id=1, language='sr', field_name='display_name', translated_text='Marka'
```

## Интеграции

### Frontend
- Динамическая генерация форм создания/редактирования объявлений
- Автоматические фильтры на странице поиска
- Валидация значений на основе rules

### Backend
- API endpoints для CRUD операций с атрибутами
- Валидация значений атрибутов при создании объявлений
- Построение поисковых запросов

### OpenSearch
- Индексирование значений атрибутов для быстрого поиска
- Фасетная навигация по атрибутам
- Полнотекстовый поиск по searchable атрибутам

## Безопасность

### Права доступа
- **Создание/Обновление**: Только администраторы
- **Чтение**: Публичный доступ через API
- **Удаление**: Только супер-администраторы (CASCADE влияет на данные)

### Валидация
- Проверка корректности JSON в options и validation_rules
- Ограничения на типы атрибутов
- Защита от SQL-инъекций в значениях

## Производительность

### Оптимизации
- Кеширование конфигурации атрибутов
- Минимизация JOIN-ов при получении значений
- Индексирование часто используемых полей

### Проблемы масштабирования
- При большом количестве атрибутов замедляются формы
- JSON поля могут расти до больших размеров
- Сложность валидации растет экспоненциально

## Мониторинг и метрики

### Ключевые показатели
- Количество атрибутов по типам
- Процент заполненности атрибутов в объявлениях
- Использование атрибутов в поиске и фильтрах
- Скорость валидации значений

### Алерты
- Аномально большие JSON в options
- Ошибки валидации при создании объявлений
- Медленные запросы с участием атрибутов

## Изменения и миграции

### История изменений
1. **000011_create_category_attributes.up.sql**: Создание базовой структуры
2. **000044_add_icon_to_category_attributes.up.sql**: Добавление иконок
3. **000045_add_display_settings_to_attributes.up.sql**: Настройки отображения
4. **000032_add_custom_component_to_category_attributes.up.sql**: Кастомные компоненты

### Планируемые улучшения
- Версионирование атрибутов для изменения без потери данных
- Продвинутая валидация с условными правилами
- A/B тестирование различных наборов атрибутов
- Автоматическое извлечение атрибутов из описаний товаров (ML)
- Система рекомендаций атрибутов на основе категории