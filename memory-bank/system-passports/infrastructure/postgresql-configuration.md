# üìã –ü–∞—Å–ø–æ—Ä—Ç PostgreSQL Configuration

## üè∑Ô∏è –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
- **–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –û—Å–Ω–æ–≤–Ω–∞—è —Ä–µ–ª—è—Ü–∏–æ–Ω–Ω–∞—è –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è Sve Tu Platform
- **–¢–∏–ø –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞:** –ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ / Relational Database
- **–°—Ç–∞—Ç—É—Å:** –ê–∫—Ç–∏–≤–Ω—ã–π, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ production
- **–í–µ—Ä—Å–∏—è:** PostgreSQL 15
- **–°—Ö–µ–º–∞:** `hostel_db`

## üéØ –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ
PostgreSQL —Å–ª—É–∂–∏—Ç –≥–ª–∞–≤–Ω—ã–º —Ö—Ä–∞–Ω–∏–ª–∏—â–µ–º –¥–∞–Ω–Ω—ã—Ö –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã, –æ–±–µ—Å–ø–µ—á–∏–≤–∞—è ACID —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏, —Å–ª–æ–∂–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã, –ø–æ–ª–Ω—É—é –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö –∏ –ø–æ–¥–¥–µ—Ä–∂–∫—É JSON –¥–ª—è –≥–∏–±–∫–∏—Ö —Å—Ö–µ–º –¥–∞–Ω–Ω—ã—Ö.

## üê≥ Docker –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

### Development Environment
```yaml
# docker-compose.yml
services:
  db:
    image: postgres:15
    container_name: hostel_db
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: password
      POSTGRES_DB: hostel_db
    ports:
      - \"5432:5432\"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: [\"CMD\", \"pg_isready\", \"-U\", \"postgres\"]\n      interval: 10s\n      timeout: 5s\n      retries: 5\n    stop_grace_period: 10s\n    stop_signal: SIGINT\n    networks:\n      - hostel_network\n```\n\n### Production Environment\n```yaml\n# docker-compose.prod.yml\nservices:\n  db:\n    image: harbor.svetu.rs/svetu/db/postgres:15\n    container_name: postgres\n    environment:\n      POSTGRES_USER: postgres\n      POSTGRES_PASSWORD: c9XWc7Cm\n      POSTGRES_DB: hostel_db\n      PGDATA: /var/lib/postgresql/data/pgdata\n    volumes:\n      - db_data:/var/lib/postgresql/data\n    restart: unless-stopped\n    healthcheck:\n      test: [\"CMD\", \"pg_isready\", \"-U\", \"postgres\"]\n      interval: 10s\n      timeout: 5s\n      retries: 5\n    networks:\n      - hostel_network\n```\n\n### Volumes\n```yaml\n# Development\nvolumes:\n  postgres_data:\n    # Docker managed volume\n\n# Production  \nvolumes:\n  db_data:\n    # Docker managed volume\n  # –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è bind mount:\n  # /opt/hostel-data/postgres:/var/lib/postgresql/data\n```\n\n## üîó –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è\n\n### –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è\n```bash\n# Development\nDATABASE_URL=postgres://postgres:password@localhost:5432/hostel_db?sslmode=disable\nPOSTGRES_USER=postgres\nPOSTGRES_PASSWORD=password\nPOSTGRES_DB=hostel_db\n\n# Production\nDATABASE_URL=postgres://postgres:c9XWc7Cm@db:5432/hostel_db?sslmode=disable\nPOSTGRES_USER=postgres\nPOSTGRES_PASSWORD=c9XWc7Cm\nPOSTGRES_DB=hostel_db\nPGDATA=/var/lib/postgresql/data/pgdata\n```\n\n### Go Connection Pool (pgxpool)\n```go\n// backend/internal/storage/postgres/db.go\ntype Database struct {\n    pool *pgxpool.Pool\n}\n\nfunc NewDatabase(dbURL string) (*Database, error) {\n    pool, err := pgxpool.New(context.Background(), dbURL)\n    if err != nil {\n        return nil, fmt.Errorf(\"—Å–æ–∑–¥–∞–Ω–∏–µ –ø—É–ª–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π: %w\", err)\n    }\n    \n    return &Database{pool: pool}, nil\n}\n\n// –î–µ—Ñ–æ–ª—Ç–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è pgxpool:\n// MaxConns: 4 (–º–∞–∫—Å–∏–º—É–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π)\n// MinConns: 0 (–º–∏–Ω–∏–º—É–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π)\n// MaxConnLifetime: 1 —á–∞—Å\n// MaxConnIdleTime: 30 –º–∏–Ω—É—Ç\n// HealthCheckPeriod: 1 –º–∏–Ω—É—Ç–∞\n```\n\n### –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –¥–ª—è Production\n```go\n// –£–ª—É—á—à–µ–Ω–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è connection pool\nconfig, err := pgxpool.ParseConfig(databaseURL)\nif err != nil {\n    return nil, err\n}\n\n// Production –Ω–∞—Å—Ç—Ä–æ–π–∫–∏\nconfig.MaxConns = 20                      // –£–≤–µ–ª–∏—á–∏—Ç—å –¥–ª—è –Ω–∞–≥—Ä—É–∑–∫–∏\nconfig.MinConns = 5                       // –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å –º–∏–Ω–∏–º—É–º\nconfig.MaxConnLifetime = 2 * time.Hour    // –í—Ä–µ–º—è –∂–∏–∑–Ω–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è\nconfig.MaxConnIdleTime = 15 * time.Minute // –í—Ä–µ–º—è –ø—Ä–æ—Å—Ç–æ—è\nconfig.HealthCheckPeriod = time.Minute    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è\n\npool, err := pgxpool.NewWithConfig(context.Background(), config)\n```\n\n## üóÑÔ∏è –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö\n\n### –û—Å–Ω–æ–≤–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã\n\n#### 1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –∏ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è\n```sql\n-- users: –û—Å–Ω–æ–≤–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π\nCREATE TABLE users (\n    id SERIAL PRIMARY KEY,\n    name VARCHAR(255) NOT NULL,\n    email VARCHAR(255) UNIQUE,\n    google_id VARCHAR(255) UNIQUE,\n    picture_url TEXT,\n    phone VARCHAR(20),\n    account_status VARCHAR(50) DEFAULT 'active',\n    settings JSONB DEFAULT '{}',\n    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP\n);\n\n-- refresh_tokens: JWT refresh —Ç–æ–∫–µ–Ω—ã\nCREATE TABLE refresh_tokens (\n    id SERIAL PRIMARY KEY,\n    user_id INTEGER REFERENCES users(id) ON DELETE CASCADE,\n    token_hash VARCHAR(255) NOT NULL,\n    expires_at TIMESTAMP NOT NULL,\n    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP\n);\n```\n\n#### 2. –ú–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å\n```sql\n-- marketplace_categories: –ò–µ—Ä–∞—Ä—Ö–∏—á–µ—Å–∫–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏\nCREATE TABLE marketplace_categories (\n    id SERIAL PRIMARY KEY,\n    name VARCHAR(255) NOT NULL,\n    slug VARCHAR(255) UNIQUE NOT NULL,\n    parent_id INTEGER REFERENCES marketplace_categories(id),\n    icon VARCHAR(255),\n    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP\n);\n\n-- marketplace_listings: –û–±—ä—è–≤–ª–µ–Ω–∏—è\nCREATE TABLE marketplace_listings (\n    id SERIAL PRIMARY KEY,\n    user_id INTEGER REFERENCES users(id) ON DELETE CASCADE,\n    category_id INTEGER REFERENCES marketplace_categories(id),\n    title VARCHAR(255) NOT NULL,\n    description TEXT,\n    price DECIMAL(10,2),\n    old_price DECIMAL(10,2),\n    condition VARCHAR(50),\n    status VARCHAR(50) DEFAULT 'draft',\n    location VARCHAR(255),\n    coordinates POINT,\n    views_count INTEGER DEFAULT 0,\n    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP\n);\n\n-- marketplace_images: –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –æ–±—ä—è–≤–ª–µ–Ω–∏–π\nCREATE TABLE marketplace_images (\n    id SERIAL PRIMARY KEY,\n    listing_id INTEGER REFERENCES marketplace_listings(id) ON DELETE CASCADE,\n    file_path VARCHAR(500) NOT NULL,\n    storage_type VARCHAR(50) DEFAULT 'minio',\n    public_url TEXT,\n    is_main BOOLEAN DEFAULT false,\n    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP\n);\n```\n\n#### 3. –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ –∞—Ç—Ä–∏–±—É—Ç—ã\n```sql\n-- category_attributes: –ê—Ç—Ä–∏–±—É—Ç—ã –∫–∞—Ç–µ–≥–æ—Ä–∏–π\nCREATE TABLE category_attributes (\n    id SERIAL PRIMARY KEY,\n    name VARCHAR(255) NOT NULL,\n    display_name VARCHAR(255),\n    attribute_type VARCHAR(50), -- text, number, boolean, select\n    required BOOLEAN DEFAULT false,\n    options JSONB -- –î–ª—è select —Ç–∏–ø–æ–≤\n);\n\n-- listing_attribute_values: –ó–Ω–∞—á–µ–Ω–∏—è –∞—Ç—Ä–∏–±—É—Ç–æ–≤ –¥–ª—è –æ–±—ä—è–≤–ª–µ–Ω–∏–π\nCREATE TABLE listing_attribute_values (\n    id SERIAL PRIMARY KEY,\n    listing_id INTEGER REFERENCES marketplace_listings(id) ON DELETE CASCADE,\n    attribute_id INTEGER REFERENCES category_attributes(id),\n    text_value TEXT,\n    numeric_value DECIMAL(15,4),\n    boolean_value BOOLEAN,\n    json_value JSONB\n);\n```\n\n#### 4. –ß–∞—Ç—ã –∏ —Å–æ–æ–±—â–µ–Ω–∏—è\n```sql\n-- marketplace_chats: –ß–∞—Ç—ã –º–µ–∂–¥—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏\nCREATE TABLE marketplace_chats (\n    id SERIAL PRIMARY KEY,\n    listing_id INTEGER REFERENCES marketplace_listings(id),\n    buyer_id INTEGER REFERENCES users(id),\n    seller_id INTEGER REFERENCES users(id),\n    last_message_at TIMESTAMP,\n    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP\n);\n\n-- marketplace_messages: –°–æ–æ–±—â–µ–Ω–∏—è –≤ —á–∞—Ç–∞—Ö\nCREATE TABLE marketplace_messages (\n    id SERIAL PRIMARY KEY,\n    chat_id INTEGER REFERENCES marketplace_chats(id) ON DELETE CASCADE,\n    sender_id INTEGER REFERENCES users(id),\n    content TEXT NOT NULL,\n    message_type VARCHAR(50) DEFAULT 'text',\n    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP\n);\n\n-- marketplace_chat_attachments: –í–ª–æ–∂–µ–Ω–∏—è –≤ —Å–æ–æ–±—â–µ–Ω–∏—è—Ö\nCREATE TABLE marketplace_chat_attachments (\n    id SERIAL PRIMARY KEY,\n    message_id INTEGER REFERENCES marketplace_messages(id) ON DELETE CASCADE,\n    file_path VARCHAR(500) NOT NULL,\n    file_name VARCHAR(255),\n    file_size INTEGER,\n    file_type VARCHAR(100)\n);\n```\n\n#### 5. –û—Ç–∑—ã–≤—ã –∏ —Ä–µ–π—Ç–∏–Ω–≥–∏\n```sql\n-- reviews: –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –æ—Ç–∑—ã–≤–æ–≤\nCREATE TABLE reviews (\n    id SERIAL PRIMARY KEY,\n    user_id INTEGER REFERENCES users(id),\n    entity_type VARCHAR(50) NOT NULL, -- 'user', 'storefront', 'listing'\n    entity_id INTEGER NOT NULL,\n    rating INTEGER CHECK (rating >= 1 AND rating <= 5),\n    comment TEXT,\n    photos JSONB, -- –ú–∞—Å—Å–∏–≤ –ø—É—Ç–µ–π –∫ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è–º\n    status VARCHAR(50) DEFAULT 'published',\n    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP\n);\n\n-- review_votes: –ì–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ –∑–∞ –æ—Ç–∑—ã–≤—ã\nCREATE TABLE review_votes (\n    id SERIAL PRIMARY KEY,\n    review_id INTEGER REFERENCES reviews(id) ON DELETE CASCADE,\n    user_id INTEGER REFERENCES users(id),\n    vote_type VARCHAR(10) CHECK (vote_type IN ('like', 'dislike')),\n    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n    UNIQUE(review_id, user_id)\n);\n```\n\n#### 6. –í–∏—Ç—Ä–∏–Ω—ã (Storefronts)\n```sql\n-- storefronts: –í–∏—Ç—Ä–∏–Ω—ã –º–∞–≥–∞–∑–∏–Ω–æ–≤\nCREATE TABLE storefronts (\n    id SERIAL PRIMARY KEY,\n    user_id INTEGER REFERENCES users(id) ON DELETE CASCADE,\n    slug VARCHAR(255) UNIQUE NOT NULL,\n    name VARCHAR(255) NOT NULL,\n    description TEXT,\n    configuration JSONB DEFAULT '{}', -- –ì–∏–±–∫–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è\n    is_active BOOLEAN DEFAULT true,\n    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP\n);\n\n-- storefront_products: –¢–æ–≤–∞—Ä—ã –≤–∏—Ç—Ä–∏–Ω\nCREATE TABLE storefront_products (\n    id SERIAL PRIMARY KEY,\n    storefront_id INTEGER REFERENCES storefronts(id) ON DELETE CASCADE,\n    name VARCHAR(255) NOT NULL,\n    description TEXT,\n    price DECIMAL(10,2),\n    sku VARCHAR(100),\n    inventory_data JSONB, -- –î–∞–Ω–Ω—ã–µ –∏–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü–∏–∏\n    is_active BOOLEAN DEFAULT true,\n    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP\n);\n```\n\n#### 7. –ü–µ—Ä–µ–≤–æ–¥—ã –∏ –ª–æ–∫–∞–ª–∏–∑–∞—Ü–∏—è\n```sql\n-- translations: –ú—É–ª—å—Ç–∏—è–∑—ã—á–Ω—ã–µ –ø–µ—Ä–µ–≤–æ–¥—ã\nCREATE TABLE translations (\n    id SERIAL PRIMARY KEY,\n    entity_type VARCHAR(50) NOT NULL, -- 'category', 'attribute', etc.\n    entity_id INTEGER NOT NULL,\n    language VARCHAR(5) NOT NULL, -- 'en', 'ru', 'sr'\n    field_name VARCHAR(100) NOT NULL, -- 'name', 'description'\n    translated_text TEXT NOT NULL,\n    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n    UNIQUE(entity_type, entity_id, language, field_name)\n);\n```\n\n#### 8. –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è\n```sql\n-- notifications: –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π\nCREATE TABLE notifications (\n    id SERIAL PRIMARY KEY,\n    user_id INTEGER REFERENCES users(id) ON DELETE CASCADE,\n    type VARCHAR(50) NOT NULL,\n    title VARCHAR(255),\n    message TEXT,\n    data JSONB, -- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ\n    is_read BOOLEAN DEFAULT false,\n    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP\n);\n\n-- notification_settings: –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π\nCREATE TABLE notification_settings (\n    id SERIAL PRIMARY KEY,\n    user_id INTEGER REFERENCES users(id) ON DELETE CASCADE,\n    notification_type VARCHAR(50),\n    email_enabled BOOLEAN DEFAULT true,\n    push_enabled BOOLEAN DEFAULT true,\n    telegram_enabled BOOLEAN DEFAULT false\n);\n```\n\n## üìä –ò–Ω–¥–µ–∫—Å—ã –∏ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è\n\n### –û—Å–Ω–æ–≤–Ω—ã–µ –∏–Ω–¥–µ–∫—Å—ã\n```sql\n-- –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –ø–æ–∏—Å–∫–∞\nCREATE INDEX idx_marketplace_listings_status ON marketplace_listings(status);\nCREATE INDEX idx_marketplace_listings_user ON marketplace_listings(user_id);\nCREATE INDEX idx_marketplace_listings_category ON marketplace_listings(category_id);\nCREATE INDEX idx_marketplace_listings_created ON marketplace_listings(created_at DESC);\n\n-- –û—Ç–∑—ã–≤—ã –∏ —Ä–µ–π—Ç–∏–Ω–≥–∏\nCREATE INDEX idx_reviews_entity ON reviews(entity_type, entity_id);\nCREATE INDEX idx_reviews_user ON reviews(user_id);\nCREATE INDEX idx_reviews_rating ON reviews(rating);\nCREATE INDEX idx_reviews_status ON reviews(status);\n\n-- –ü–µ—Ä–µ–≤–æ–¥—ã\nCREATE INDEX idx_translations_lookup ON translations(entity_type, entity_id, language);\n\n-- –ß–∞—Ç—ã\nCREATE INDEX idx_marketplace_chats_buyer ON marketplace_chats(buyer_id);\nCREATE INDEX idx_marketplace_chats_seller ON marketplace_chats(seller_id);\nCREATE INDEX idx_marketplace_messages_chat ON marketplace_messages(chat_id);\nCREATE INDEX idx_marketplace_messages_created ON marketplace_messages(created_at DESC);\n\n-- –ê—Ç—Ä–∏–±—É—Ç—ã (–¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏)\nCREATE INDEX idx_attr_name_text_val \nON listing_attribute_values (attribute_id, text_value) \nWHERE text_value IS NOT NULL;\n\nCREATE INDEX idx_attr_name_num_val \nON listing_attribute_values (attribute_id, numeric_value) \nWHERE numeric_value IS NOT NULL;\n\nCREATE INDEX idx_attr_name_bool_val \nON listing_attribute_values (attribute_id, boolean_value) \nWHERE boolean_value IS NOT NULL;\n```\n\n### –°–æ—Å—Ç–∞–≤–Ω—ã–µ –∏–Ω–¥–µ–∫—Å—ã\n```sql\n-- –î–ª—è —Å–ª–æ–∂–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤\nCREATE INDEX idx_listings_status_category ON marketplace_listings(status, category_id);\nCREATE INDEX idx_listings_user_status ON marketplace_listings(user_id, status);\n\n-- –î–ª—è –∞–≥—Ä–µ–≥–∞—Ü–∏–∏ —Ä–µ–π—Ç–∏–Ω–≥–æ–≤\nCREATE INDEX idx_reviews_entity_status_rating \nON reviews(entity_type, entity_id, status, rating);\n```\n\n### JSONB –∏–Ω–¥–µ–∫—Å—ã\n```sql\n-- –î–ª—è –ø–æ–∏—Å–∫–∞ –≤ JSONB –ø–æ–ª—è—Ö\nCREATE INDEX idx_users_settings_gin ON users USING GIN (settings);\nCREATE INDEX idx_storefronts_config_gin ON storefronts USING GIN (configuration);\nCREATE INDEX idx_reviews_photos_gin ON reviews USING GIN (photos);\n```\n\n## üîß –§—É–Ω–∫—Ü–∏–∏ –∏ —Ç—Ä–∏–≥–≥–µ—Ä—ã\n\n### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ updated_at\n```sql\nCREATE OR REPLACE FUNCTION update_updated_at_column()\nRETURNS TRIGGER AS $$\nBEGIN\n    NEW.updated_at = CURRENT_TIMESTAMP;\n    RETURN NEW;\nEND;\n$$ LANGUAGE plpgsql;\n\n-- –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –∫ —Ç–∞–±–ª–∏—Ü–∞–º\nCREATE TRIGGER update_users_updated_at\n    BEFORE UPDATE ON users\n    FOR EACH ROW\n    EXECUTE FUNCTION update_updated_at_column();\n\nCREATE TRIGGER update_listings_updated_at\n    BEFORE UPDATE ON marketplace_listings\n    FOR EACH ROW\n    EXECUTE FUNCTION update_updated_at_column();\n\nCREATE TRIGGER update_storefronts_updated_at\n    BEFORE UPDATE ON storefronts\n    FOR EACH ROW\n    EXECUTE FUNCTION update_updated_at_column();\n```\n\n### –§—É–Ω–∫—Ü–∏—è —Ä–∞—Å—á–µ—Ç–∞ —Ä–µ–π—Ç–∏–Ω–≥–∞\n```sql\nCREATE OR REPLACE FUNCTION calculate_entity_rating(\n    p_entity_type VARCHAR, \n    p_entity_id INT\n)\nRETURNS NUMERIC AS $$\nDECLARE\n    avg_rating NUMERIC;\nBEGIN\n    SELECT COALESCE(AVG(rating)::NUMERIC(3,2), 0)\n    INTO avg_rating\n    FROM reviews\n    WHERE entity_type = p_entity_type \n    AND entity_id = p_entity_id \n    AND status = 'published';\n    \n    RETURN avg_rating;\nEND;\n$$ LANGUAGE plpgsql;\n```\n\n### –ú–∞—Ç–µ—Ä–∏–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è\n```sql\n-- –ê–≥—Ä–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ä–µ–π—Ç–∏–Ω–≥–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π\nCREATE MATERIALIZED VIEW user_ratings AS\nSELECT \n    entity_id as user_id,\n    AVG(rating)::NUMERIC(3,2) as average_rating,\n    COUNT(*) as review_count\nFROM reviews \nWHERE entity_type = 'user' AND status = 'published'\nGROUP BY entity_id;\n\nCREATE UNIQUE INDEX idx_user_ratings_user_id ON user_ratings(user_id);\n\n-- –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ä–µ–π—Ç–∏–Ω–≥–æ–≤\nCREATE MATERIALIZED VIEW user_rating_distribution AS\nSELECT \n    entity_id as user_id,\n    rating,\n    COUNT(*) as count\nFROM reviews \nWHERE entity_type = 'user' AND status = 'published'\nGROUP BY entity_id, rating;\n```\n\n## üîÑ –°–∏—Å—Ç–µ–º–∞ –º–∏–≥—Ä–∞—Ü–∏–π\n\n### Migration Tool\n```yaml\n# docker-compose.yml\nmigrate:\n  image: migrate/migrate\n  container_name: hostel_migrate\n  depends_on:\n    - db\n  volumes:\n    - ./backend/migrations:/migrations\n  command: [\n    \"-path\", \"/migrations\",\n    \"-database\", \"postgres://postgres:password@db:5432/hostel_db?sslmode=disable\",\n    \"up\"\n  ]\n  networks:\n    - hostel_network\n```\n\n### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –º–∏–≥—Ä–∞—Ü–∏–π\n```bash\n# backend/migrations/\n000001_initial_schema.up.sql\n000001_initial_schema.down.sql\n000002_add_users_table.up.sql\n000002_add_users_table.down.sql\n...\n000062_latest_changes.up.sql\n000062_latest_changes.down.sql\n```\n\n### –ö–æ–º–∞–Ω–¥—ã –º–∏–≥—Ä–∞—Ü–∏–π\n```bash\n# –ü—Ä–∏–º–µ–Ω–∏—Ç—å –≤—Å–µ –º–∏–≥—Ä–∞—Ü–∏–∏\ndocker-compose run --rm migrate up\n\n# –û—Ç–∫–∞—Ç–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω—é—é –º–∏–≥—Ä–∞—Ü–∏—é  \ndocker-compose run --rm migrate down 1\n\n# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å\ndocker-compose run --rm migrate version\n\n# –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤–µ—Ä—Å–∏—é\ndocker-compose run --rm migrate force 62\n```\n\n## üíæ Backup –∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ\n\n### –¢–µ–∫—É—â–∏–µ –ø—Ä–æ—Ü–µ–¥—É—Ä—ã\n```bash\n# –°–∫—Ä–∏–ø—Ç —Å–±—Ä–æ—Å–∞ –±–∞–∑—ã (–í–ù–ò–ú–ê–ù–ò–ï: —É–¥–∞–ª—è–µ—Ç –≤—Å–µ –¥–∞–Ω–Ω—ã–µ!)\n#!/bin/bash\n# scripts/reset_production_db.sh\n\nssh root@svetu.rs \"cd /opt/hostel-booking-system && docker exec postgres psql -U postgres -c 'DROP DATABASE IF EXISTS hostel_db;'\"\nssh root@svetu.rs \"cd /opt/hostel-booking-system && docker exec postgres psql -U postgres -c 'CREATE DATABASE hostel_db;'\"\nssh root@svetu.rs \"cd /opt/hostel-booking-system && docker compose run --rm migrate\"\n```\n\n### –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ –ø—Ä–æ—Ü–µ–¥—É—Ä—ã backup\n```bash\n# –ï–∂–µ–¥–Ω–µ–≤–Ω—ã–π backup\n#!/bin/bash\n# scripts/backup_postgres.sh\n\nBACKUP_DIR=\"/opt/hostel-data/backups/postgres\"\nDATE=$(date +%Y%m%d_%H%M%S)\nBACKUP_FILE=\"$BACKUP_DIR/hostel_db_$DATE.sql\"\n\n# –°–æ–∑–¥–∞–Ω–∏–µ backup\ndocker exec postgres pg_dump -U postgres -d hostel_db > \"$BACKUP_FILE\"\n\n# –°–∂–∞—Ç–∏–µ\ngzip \"$BACKUP_FILE\"\n\n# –£–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä—ã—Ö backup'–æ–≤ (—Å—Ç–∞—Ä—à–µ 30 –¥–Ω–µ–π)\nfind \"$BACKUP_DIR\" -name \"*.sql.gz\" -mtime +30 -delete\n\necho \"Backup created: $BACKUP_FILE.gz\"\n```\n\n### –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–∑ backup\n```bash\n#!/bin/bash\n# scripts/restore_postgres.sh\n\nBACKUP_FILE=\"$1\"\n\nif [ -z \"$BACKUP_FILE\" ]; then\n    echo \"Usage: $0 <backup_file.sql.gz>\"\n    exit 1\nfi\n\n# –†–∞—Å–ø–∞–∫–æ–≤–∫–∞ –∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ\ngunzip -c \"$BACKUP_FILE\" | docker exec -i postgres psql -U postgres -d hostel_db\n\necho \"Database restored from: $BACKUP_FILE\"\n```\n\n### Cron –∑–∞–¥–∞—á–∞ –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ backup\n```bash\n# /etc/cron.d/postgres-backup\n# –ï–∂–µ–¥–Ω–µ–≤–Ω–æ –≤ 2:00 AM\n0 2 * * * root /opt/hostel-booking-system/scripts/backup_postgres.sh\n\n# –ï–∂–µ–Ω–µ–¥–µ–ª—å–Ω—ã–π –ø–æ–ª–Ω—ã–π backup –≤ –≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ –≤ 1:00 AM\n0 1 * * 0 root /opt/hostel-booking-system/scripts/full_backup_postgres.sh\n```\n\n## üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å\n\n### Health Checks\n```yaml\nhealthcheck:\n  test: [\"CMD\", \"pg_isready\", \"-U\", \"postgres\"]\n  interval: 10s\n  timeout: 5s\n  retries: 5\n```\n\n### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞\n```bash\n# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è\ndocker exec postgres pg_isready -U postgres\n\n# –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π\ndocker exec postgres psql -U postgres -c \"SELECT * FROM pg_stat_activity;\"\n\n# –†–∞–∑–º–µ—Ä –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö\ndocker exec postgres psql -U postgres -c \"SELECT pg_size_pretty(pg_database_size('hostel_db'));\"\n\n# –†–∞–∑–º–µ—Ä—ã —Ç–∞–±–ª–∏—Ü\ndocker exec postgres psql -U postgres -d hostel_db -c \"SELECT schemaname, tablename, pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) as size FROM pg_tables ORDER BY pg_total_relation_size(schemaname||'.'||tablename) DESC LIMIT 10;\"\n```\n\n### –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ –º–µ—Ç—Ä–∏–∫–∏\n```sql\n-- –í–∫–ª—é—á–∏—Ç—å pg_stat_statements –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –∑–∞–ø—Ä–æ—Å–æ–≤\nCREATE EXTENSION IF NOT EXISTS pg_stat_statements;\n\n-- –ú–µ–¥–ª–µ–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã\nSELECT \n    query,\n    calls,\n    total_time,\n    mean_time,\n    (total_time/calls) as avg_time_ms\nFROM pg_stat_statements \nORDER BY total_time DESC \nLIMIT 10;\n\n-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏–Ω–¥–µ–∫—Å–æ–≤\nSELECT \n    schemaname,\n    tablename,\n    indexname,\n    idx_scan,\n    idx_tup_read,\n    idx_tup_fetch\nFROM pg_stat_user_indexes \nORDER BY idx_scan DESC;\n```\n\n### –û—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–π –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥\n**–ù–µ–æ–±—Ö–æ–¥–∏–º–æ –¥–æ–±–∞–≤–∏—Ç—å:**\n1. **Prometheus PostgreSQL Exporter** –¥–ª—è –º–µ—Ç—Ä–∏–∫\n2. **Grafana Dashboard** –¥–ª—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏\n3. **–ê–ª–µ—Ä—Ç—ã** –Ω–∞ –≤—ã—Å–æ–∫—É—é –Ω–∞–≥—Ä—É–∑–∫—É, –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏, —Ä–∞–∑–º–µ—Ä –ë–î\n4. **Log aggregation** –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –º–µ–¥–ª–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤\n\n## üõ°Ô∏è –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å\n\n### –¢–µ–∫—É—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏\n```bash\n# SSL –æ—Ç–∫–ª—é—á–µ–Ω (–ù–ï –†–ï–ö–û–ú–ï–ù–î–£–ï–¢–°–Ø –¥–ª—è production)\nsslmode=disable\n\n# –û–¥–∏–Ω —Å—É–ø–µ—Ä–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å\nPOSTGRES_USER=postgres\nPOSTGRES_PASSWORD=c9XWc7Cm  # Production –ø–∞—Ä–æ–ª—å\n```\n\n### –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ —É–ª—É—á—à–µ–Ω–∏—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏\n```sql\n-- –°–æ–∑–¥–∞—Ç—å –æ—Ç–¥–µ–ª—å–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è\nCREATE USER app_user WITH PASSWORD 'secure_app_password';\n\n-- –û–≥—Ä–∞–Ω–∏—á–∏—Ç—å –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞\nGRANT CONNECT ON DATABASE hostel_db TO app_user;\nGRANT USAGE ON SCHEMA public TO app_user;\nGRANT SELECT, INSERT, UPDATE, DELETE ON ALL TABLES IN SCHEMA public TO app_user;\nGRANT USAGE, SELECT ON ALL SEQUENCES IN SCHEMA public TO app_user;\n\n-- –î–ª—è –Ω–æ–≤—ã—Ö —Ç–∞–±–ª–∏—Ü\nALTER DEFAULT PRIVILEGES IN SCHEMA public \nGRANT SELECT, INSERT, UPDATE, DELETE ON TABLES TO app_user;\n\nALTER DEFAULT PRIVILEGES IN SCHEMA public \nGRANT USAGE, SELECT ON SEQUENCES TO app_user;\n```\n\n### SSL –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è\n```bash\n# –í–∫–ª—é—á–∏—Ç—å SSL –≤ production\nDATABASE_URL=postgres://app_user:secure_password@db:5432/hostel_db?sslmode=require\n\n# PostgreSQL –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è\nssl = on\nssl_cert_file = '/etc/ssl/certs/server.crt'\nssl_key_file = '/etc/ssl/private/server.key'\n```\n\n## üöÄ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –¥—Ä—É–≥–∏–º–∏ —Å–∏—Å—Ç–µ–º–∞–º–∏\n\n### OpenSearch —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è\n```go\n// –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –æ–±—ä—è–≤–ª–µ–Ω–∏–π —Å OpenSearch\nfunc (s *MarketplaceService) CreateListing(ctx context.Context, req CreateListingRequest) (*Listing, error) {\n    // 1. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ PostgreSQL\n    listing, err := s.storage.CreateListing(ctx, req)\n    if err != nil {\n        return nil, err\n    }\n    \n    // 2. –ò–Ω–¥–µ–∫—Å–∞—Ü–∏—è –≤ OpenSearch\n    if err := s.searchStorage.IndexListing(ctx, listing); err != nil {\n        // –õ–æ–≥–∏—Ä—É–µ–º –æ—à–∏–±–∫—É, –Ω–æ –Ω–µ –ø—Ä–µ—Ä—ã–≤–∞–µ–º –æ–ø–µ—Ä–∞—Ü–∏—é\n        log.Error().Err(err).Msg(\"Failed to index listing in OpenSearch\")\n    }\n    \n    return listing, nil\n}\n```\n\n### MinIO –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ\n```sql\n-- –°–≤—è–∑—å —Å —Ñ–∞–π–ª–∞–º–∏ –≤ MinIO\nSELECT \n    l.id,\n    l.title,\n    mi.file_path,\n    mi.public_url\nFROM marketplace_listings l\nJOIN marketplace_images mi ON l.id = mi.listing_id\nWHERE l.status = 'published';\n```\n\n### WebSocket —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è\n```go\n// –¢—Ä–∏–≥–≥–µ—Ä —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏–π\nfunc (s *ChatService) SendMessage(ctx context.Context, req SendMessageRequest) error {\n    // 1. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ PostgreSQL\n    message, err := s.storage.CreateMessage(ctx, req)\n    if err != nil {\n        return err\n    }\n    \n    // 2. WebSocket —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ\n    notification := &Notification{\n        Type: \"new_message\",\n        Data: message,\n    }\n    s.wsManager.SendToUser(message.RecipientID, notification)\n    \n    return nil\n}\n```\n\n## üîß –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏\n\n### 1. Connection Pooling\n```go\n// –£–ª—É—á—à–µ–Ω–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –¥–ª—è –≤—ã—Å–æ–∫–æ–π –Ω–∞–≥—Ä—É–∑–∫–∏\nconfig.MaxConns = 50                      // –î–ª—è production\nconfig.MinConns = 10                      // –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å –º–∏–Ω–∏–º—É–º\nconfig.MaxConnLifetime = 4 * time.Hour    // –†–æ—Ç–∞—Ü–∏—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π\nconfig.MaxConnIdleTime = 10 * time.Minute // –ë—ã—Å—Ç—Ä–æ–µ –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏–µ\n```\n\n### 2. –ü–∞—Ä—Ç–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ\n```sql\n-- –ü–∞—Ä—Ç–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –±–æ–ª—å—à–∏—Ö —Ç–∞–±–ª–∏—Ü –ø–æ –≤—Ä–µ–º–µ–Ω–∏\nCREATE TABLE marketplace_messages_partitioned (\n    LIKE marketplace_messages INCLUDING ALL\n) PARTITION BY RANGE (created_at);\n\n-- –ü–∞—Ä—Ç–∏—Ü–∏–∏ –ø–æ –º–µ—Å—è—Ü–∞–º\nCREATE TABLE marketplace_messages_2024_01 \nPARTITION OF marketplace_messages_partitioned\nFOR VALUES FROM ('2024-01-01') TO ('2024-02-01');\n```\n\n### 3. Read Replicas\n```yaml\n# –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π read-only —ç–∫–∑–µ–º–ø–ª—è—Ä\ndb-read:\n  image: postgres:15\n  environment:\n    POSTGRES_USER: postgres\n    POSTGRES_PASSWORD: c9XWc7Cm\n    POSTGRES_DB: hostel_db\n  command: |\n    postgres \n    -c wal_level=replica \n    -c max_wal_senders=3 \n    -c max_replication_slots=3\n```\n\n### 4. –ê–≤—Ç–æ–≤–∞–∫—É—É–º\n```sql\n-- –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∞–≤—Ç–æ–≤–∞–∫—É—É–º–∞ –¥–ª—è –±–æ–ª—å—à–∏—Ö —Ç–∞–±–ª–∏—Ü\nALTER TABLE marketplace_messages SET (\n    autovacuum_vacuum_scale_factor = 0.1,\n    autovacuum_analyze_scale_factor = 0.05\n);\n```\n\n---\n**–ü–∞—Å–ø–æ—Ä—Ç —Å–æ–∑–¥–∞–Ω:** 2025-06-29  \n**–ö–æ–º–ø–æ–Ω–µ–Ω—Ç:** PostgreSQL Configuration  \n**–°—Ç–∞—Ç—É—Å:** –ê–∫—Ç–∏–≤–Ω—ã–π –≤ production