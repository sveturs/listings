# –ê–Ω–∞–ª–∏–∑ —Ç–µ–∫—É—â–µ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –≥–µ–æ–ø–æ–∏—Å–∫–∞ –≤ –ø—Ä–æ–µ–∫—Ç–µ

**–î–∞—Ç–∞ –∞–Ω–∞–ª–∏–∑–∞:** 2025-07-12  
**–ü—Ä–æ–µ–∫—Ç:** Sve Tu Platform - Marketplace

## üìä –ö—Ä–∞—Ç–∫–æ–µ —Ä–µ–∑—é–º–µ

–ü—Ä–æ–µ–∫—Ç –∏–º–µ–µ—Ç –±–∞–∑–æ–≤—É—é –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—É –¥–ª—è –≥–µ–æ–ø–æ–∏—Å–∫–∞, –Ω–æ –Ω—É–∂–¥–∞–µ—Ç—Å—è –≤ –¥–æ—Ä–∞–±–æ—Ç–∫–µ –¥–ª—è –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞ –≤ —Ä–∞–¥–∏—É—Å–µ –æ—Ç —Ç–æ—á–∫–∏.

### ‚úÖ –ß—Ç–æ —É–∂–µ –µ—Å—Ç—å:
- ‚úÖ –ü–æ–ª–Ω–∞—è –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ PostGIS —Å geography —Ç–∏–ø–∞–º–∏
- ‚úÖ –¢–∞–±–ª–∏—Ü–∞ `listings_geo` —Å –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–µ–Ω–Ω—ã–º–∏ –∏–Ω–¥–µ–∫—Å–∞–º–∏  
- ‚úÖ –°–µ—Ä–≤–∏—Å `SpatialService` —Å –º–µ—Ç–æ–¥–∞–º–∏ —Ä–∞–¥–∏—É—Å–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞
- ‚úÖ OpenSearch —Å –±–∞–∑–æ–≤—ã–º–∏ –º–∞–ø–ø–∏–Ω–≥–∞–º–∏ (–±–µ–∑ geo_point)
- ‚úÖ Frontend –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –∫–∞—Ä—Ç –Ω–∞ Leaflet
- ‚úÖ –•—É–∫–∏ –¥–ª—è –≥–µ–æ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è –∏ –ø–æ–∏—Å–∫–∞ –∞–¥—Ä–µ—Å–æ–≤

### ‚ùå –ß—Ç–æ –Ω—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å:
- ‚ùå Geo_point –º–∞–ø–ø–∏–Ω–≥ –≤ OpenSearch –¥–ª—è —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–≥–æ –≥–µ–æ–ø–æ–∏—Å–∫–∞
- ‚ùå API endpoints –¥–ª—è —Ä–∞–¥–∏—É—Å–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞
- ‚ùå Frontend –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –¥–ª—è –≤–≤–æ–¥–∞ –ª–æ–∫–∞—Ü–∏–∏ –∏ —Ä–∞–¥–∏—É—Å–∞
- ‚ùå –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è PostGIS –∏ OpenSearch –¥–ª—è –≥–µ–æ–ø–æ–∏—Å–∫–∞

---

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ Backend

### 1. –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö PostGIS

**–¢–∞–±–ª–∏—Ü–∞ `listings_geo`:**
```sql
-- –û—Å–Ω–æ–≤–Ω—ã–µ –ø–æ–ª—è
listing_id BIGINT NOT NULL
location geography(Point, 4326) NOT NULL -- ‚úÖ –ì–æ—Ç–æ–≤–æ
geohash VARCHAR(12) NOT NULL
is_precise BOOLEAN NOT NULL DEFAULT true
blur_radius NUMERIC(10, 2) DEFAULT 0

-- Phase 2 —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è  
address_components JSONB
geocoding_confidence NUMERIC(3, 2) DEFAULT 0.0
location_privacy VARCHAR(20) DEFAULT 'exact'
blurred_location geography(Point, 4326)
formatted_address TEXT
```

**–ò–Ω–¥–µ–∫—Å—ã:**
- ‚úÖ `idx_listings_geo_location` (GIST –¥–ª—è geography)
- ‚úÖ `idx_listings_geo_geohash` (–¥–ª—è proximity searches)
- ‚úÖ Composite –∏–Ω–¥–µ–∫—Å—ã –¥–ª—è –∫–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤

### 2. –°–µ—Ä–≤–∏—Å GIS

**–§–∞–π–ª:** `backend/internal/proj/gis/service/spatial_service.go`

**–ì–æ—Ç–æ–≤—ã–µ –º–µ—Ç–æ–¥—ã:**
- ‚úÖ `SearchListings(params SearchParams)` - –ø–æ–∏—Å–∫ —Å –≥–µ–æ—Ñ–∏–ª—å—Ç—Ä–∞–º–∏
- ‚úÖ `GetNearbyListings(center Point, radiusKm float64)` - –ø–æ–∏—Å–∫ –≤ —Ä–∞–¥–∏—É—Å–µ
- ‚úÖ `GetListingsInBounds(bounds Bounds)` - –ø–æ–∏—Å–∫ –≤ –≥—Ä–∞–Ω–∏—Ü–∞—Ö
- ‚úÖ `CalculateDistance(from, to Point)` - —Ä–∞—Å—á–µ—Ç —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—è

**–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã:**
```go
type SearchParams struct {
    Center      *Point   `json:"center,omitempty"`
    RadiusKm    float64  `json:"radius_km,omitempty"`
    Bounds      *Bounds  `json:"bounds,omitempty"`
    Categories  []string `json:"categories,omitempty"`
    MinPrice    *float64 `json:"min_price,omitempty"`
    MaxPrice    *float64 `json:"max_price,omitempty"`
    SortBy      string   `json:"sort_by,omitempty"` // distance, price, created_at
    Limit       int      `json:"limit,omitempty"`
    Offset      int      `json:"offset,omitempty"`
}
```

### 3. –†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π PostGIS

**–§–∞–π–ª:** `backend/internal/proj/gis/repository/postgis_repo.go`

**SQL –∑–∞–ø—Ä–æ—Å—ã –¥–ª—è –≥–µ–æ–ø–æ–∏—Å–∫–∞:**
```sql
-- –†–∞–¥–∏—É—Å–Ω—ã–π –ø–æ–∏—Å–∫ (–≥–æ—Ç–æ–≤)
ST_DWithin(lg.location::geography, 
           ST_SetSRID(ST_MakePoint($lng, $lat), 4326)::geography, 
           $radius_meters)

-- –ü–æ–∏—Å–∫ –≤ –≥—Ä–∞–Ω–∏—Ü–∞—Ö (–≥–æ—Ç–æ–≤)  
lg.location && ST_MakeEnvelope($west, $south, $east, $north, 4326)

-- –†–∞—Å—á–µ—Ç —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—è (–≥–æ—Ç–æ–≤)
ST_Distance(lg.location::geography,
            ST_SetSRID(ST_MakePoint($lng, $lat), 4326)::geography) as distance
```

---

## üîç OpenSearch

### –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
- ‚úÖ –û—Å–Ω–æ–≤–Ω—ã–µ –º–∞–ø–ø–∏–Ω–≥–∏ –¥–ª—è listings —Å—É—â–µ—Å—Ç–≤—É—é—Ç
- ‚ùå **–ù–ï–¢** geo_point –ø–æ–ª—è –¥–ª—è –≥–µ–æ–ø–æ–∏—Å–∫–∞  
- ‚ùå **–ù–ï–¢** geo_distance –∏ geo_bounding_box –∑–∞–ø—Ä–æ—Å–æ–≤

### –ß—Ç–æ –Ω—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å

**1. –û–±–Ω–æ–≤–∏—Ç—å mapping:**
```json
{
  "mappings": {
    "properties": {
      "location": {
        "type": "geo_point"
      },
      "listing_id": {
        "type": "integer"
      }
    }
  }
}
```

**2. –ì–µ–æ–ø–æ–∏—Å–∫ –∑–∞–ø—Ä–æ—Å—ã:**
```json
// –ü–æ–∏—Å–∫ –≤ —Ä–∞–¥–∏—É—Å–µ
{
  "query": {
    "bool": {
      "filter": {
        "geo_distance": {
          "distance": "5km",
          "location": {
            "lat": 44.7866,
            "lon": 20.4489
          }
        }
      }
    }
  }
}
```

---

## üé® Frontend

### 1. –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –∫–∞—Ä—Ç (–≥–æ—Ç–æ–≤—ã)

**–§–∞–π–ª—ã:**
- ‚úÖ `StorefrontMap.tsx` - –±–∞–∑–æ–≤–∞—è –∫–∞—Ä—Ç–∞ —Å –º–∞—Ä–∫–µ—Ä–∞–º–∏
- ‚úÖ `InteractiveMap.tsx` - –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∞—è –∫–∞—Ä—Ç–∞
- ‚úÖ `MapControls.tsx` - –∫–æ–Ω—Ç—Ä–æ–ª—ã –∫–∞—Ä—Ç—ã

**–ë–∏–±–ª–∏–æ—Ç–µ–∫–∏:**
- ‚úÖ Leaflet –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∫–∞—Ä—Ç
- ‚úÖ react-leaflet –¥–ª—è React –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏

### 2. –•—É–∫–∏ –≥–µ–æ–ø–æ–∏—Å–∫–∞ (–≥–æ—Ç–æ–≤—ã)

**–§–∞–π–ª:** `src/components/GIS/hooks/useGeoSearch.ts`

**–ì–æ—Ç–æ–≤—ã–µ —Ö—É–∫–∏:**
- ‚úÖ `useGeoSearch()` - –ø–æ–∏—Å–∫ –∞–¥—Ä–µ—Å–æ–≤
- ‚úÖ `useGeocoding()` - –≥–µ–æ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ
- ‚úÖ `useRouteCalculation()` - —Ä–∞—Å—á–µ—Ç –º–∞—Ä—à—Ä—É—Ç–æ–≤

### 3. –ß—Ç–æ –Ω—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å

**–ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –¥–ª—è —Ä–∞–¥–∏—É—Å–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞:**
- ‚ùå `RadiusSelector` - –≤—ã–±–æ—Ä —Ä–∞–¥–∏—É—Å–∞ –ø–æ–∏—Å–∫–∞
- ‚ùå `LocationPicker` - –≤—ã–±–æ—Ä —Ü–µ–Ω—Ç—Ä–∞ –ø–æ–∏—Å–∫–∞
- ‚ùå `GeoSearchFilters` - –≥–µ–æ—Ñ–∏–ª—å—Ç—Ä—ã –≤ –ø–æ–∏—Å–∫–µ

---

## üîó API Endpoints

### –¢–µ–∫—É—â–∏–µ endpoints
**–í —Ñ–∞–π–ª–µ:** `backend/internal/proj/marketplace/handler/search.go`

- ‚úÖ `/api/v1/marketplace/search` - –æ—Å–Ω–æ–≤–Ω–æ–π –ø–æ–∏—Å–∫
- ‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ `view_mode=map` (–ª–∏–º–∏—Ç 5000)

### –ù–µ–¥–æ—Å—Ç–∞—é—â–∏–µ endpoints

**–ù—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å:**
```
POST /api/v1/gis/search/radius
POST /api/v1/gis/search/bounds  
GET  /api/v1/gis/nearby
```

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è —Ä–∞–¥–∏—É—Å–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞:**
```json
{
  "center": {
    "lat": 44.7866,
    "lng": 20.4489
  },
  "radius_km": 5,
  "categories": ["–Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç—å"],
  "price_min": 100,
  "price_max": 1000,
  "limit": 50,
  "sort_by": "distance"
}
```

---

## üèÜ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –¥–æ—Ä–∞–±–æ—Ç–∫–µ

### –§–∞–∑–∞ 1: –ë–∞–∑–æ–≤—ã–π —Ä–∞–¥–∏—É—Å–Ω—ã–π –ø–æ–∏—Å–∫ (1-2 –¥–Ω—è)

1. **Backend:**
   - ‚úÖ –°–æ–∑–¥–∞—Ç—å handlers –¥–ª—è `/api/v1/gis/search/radius`
   - ‚úÖ –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å SpatialService –≤ marketplace handlers
   - ‚úÖ –î–æ–±–∞–≤–∏—Ç—å geo_point –º–∞–ø–ø–∏–Ω–≥ –≤ OpenSearch

2. **Frontend:**
   - ‚úÖ –ö–æ–º–ø–æ–Ω–µ–Ω—Ç –≤—ã–±–æ—Ä–∞ —Ä–∞–¥–∏—É—Å–∞ –∏ —Ü–µ–Ω—Ç—Ä–∞ –ø–æ–∏—Å–∫–∞
   - ‚úÖ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º–∏ –∫–∞—Ä—Ç–∞–º–∏
   - ‚úÖ –•—É–∫–∏ –¥–ª—è —Ä–∞–¥–∏—É—Å–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞

### –§–∞–∑–∞ 2: –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∏ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è (2-3 –¥–Ω—è)

1. **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:**
   - ‚úÖ –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –≥–µ–æ–ø–æ–∏—Å–∫–∞
   - ‚úÖ –ò–Ω–¥–µ–∫—Å—ã –¥–ª—è –ø–æ–ø—É–ª—è—Ä–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
   - ‚úÖ –ü–∞–≥–∏–Ω–∞—Ü–∏—è –¥–ª—è –±–æ–ª—å—à–∏—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤

2. **UX —É–ª—É—á—à–µ–Ω–∏—è:**
   - ‚úÖ –ê–≤—Ç–æ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–π –ª–æ–∫–∞—Ü–∏–∏
   - ‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ –ø–æ–∏—Å–∫–æ–≤
   - ‚úÖ –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –ø–æ–ø—É–ª—è—Ä–Ω—ã—Ö –º–µ—Å—Ç

### –§–∞–∑–∞ 3: –ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ (3-5 –¥–Ω–µ–π)

1. **–°–ª–æ–∂–Ω—ã–µ –≥–µ–æ–∑–∞–ø—Ä–æ—Å—ã:**
   - ‚úÖ –ü–æ–∏—Å–∫ –ø–æ –ø—Ä–æ–∏–∑–≤–æ–ª—å–Ω—ã–º –ø–æ–ª–∏–≥–æ–Ω–∞–º
   - ‚úÖ Multi-point —Ä–∞–¥–∏—É—Å–Ω—ã–π –ø–æ–∏—Å–∫
   - ‚úÖ –ú–∞—Ä—à—Ä—É—Ç–Ω–æ–µ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ

2. **–ê–Ω–∞–ª–∏—Ç–∏–∫–∞:**
   - ‚úÖ –¢–µ–ø–ª–æ–≤—ã–µ –∫–∞—Ä—Ç—ã –ø–æ–ø—É–ª—è—Ä–Ω–æ—Å—Ç–∏
   - ‚úÖ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –≥–µ–æ–∑–∞–ø—Ä–æ—Å–∞–º
   - ‚úÖ A/B —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≥–µ–æ–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–≤

---

## üîß –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è

### –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:
- **PostGIS:** < 100ms –¥–ª—è —Ä–∞–¥–∏—É—Å–∞ –¥–æ 50–∫–º, –¥–æ 10–ö –æ–±—ä—è–≤–ª–µ–Ω–∏–π
- **OpenSearch:** < 50ms –¥–ª—è geo_distance –∑–∞–ø—Ä–æ—Å–æ–≤
- **Frontend:** –†–µ–Ω–¥–µ—Ä –∫–∞—Ä—Ç—ã < 500ms, –¥–æ 1000 –º–∞—Ä–∫–µ—Ä–æ–≤

### –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å:
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –¥–æ 100–ö –æ–±—ä—è–≤–ª–µ–Ω–∏–π —Å –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º–∏
- –î–æ 1000 –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –≥–µ–æ–ø–æ–∏—Å–∫–æ–≤  
- –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–ø—É–ª—è—Ä–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤

---

## üìù –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

**–ü—Ä–æ–µ–∫—Ç –∏–º–µ–µ—Ç —Ö–æ—Ä–æ—à—É—é –æ—Å–Ω–æ–≤—É –¥–ª—è –≥–µ–æ–ø–æ–∏—Å–∫–∞, –Ω–æ —Ç—Ä–µ–±—É–µ—Ç –¥–æ—Ä–∞–±–æ—Ç–∫–∏ –¥–ª—è production-ready —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏.**

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 1:** –î–æ–±–∞–≤–∏—Ç—å geo_point –≤ OpenSearch –∏ API endpoints  
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 2:** Frontend –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –¥–ª—è —Ä–∞–¥–∏—É—Å–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞  
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 3:** –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –∏ UX

**–û—Ü–µ–Ω–∫–∞ —Ç—Ä—É–¥–æ–∑–∞—Ç—Ä–∞—Ç:** 5-10 –¥–Ω–µ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ –¥–ª—è –ø–æ–ª–Ω–æ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏