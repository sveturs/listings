# Полный отчет о системе отзывов

## Обзор системы

Система отзывов в проекте представляет собой комплексное решение для сбора, хранения и отображения отзывов пользователей о различных сущностях (объявления, витрины, пользователи).

## 1. Архитектура базы данных

### 1.1 Основные таблицы

#### Таблица `reviews`
```sql
- id: SERIAL PRIMARY KEY
- user_id: INT (автор отзыва)
- entity_type: VARCHAR(50) (тип сущности: listing, user, storefront)
- entity_id: INT (ID сущности)
- entity_origin_type: VARCHAR(50) (сохраняется при удалении объявления)
- entity_origin_id: INT (сохраняется при удалении объявления)
- rating: INT (1-5)
- comment: TEXT
- pros: TEXT (преимущества)
- cons: TEXT (недостатки)
- photos: TEXT[] (массив фотографий)
- likes_count: INT
- helpful_votes: INT
- not_helpful_votes: INT
- is_verified_purchase: BOOLEAN
- status: VARCHAR(20) (draft, published, hidden)
- original_language: VARCHAR(2)
- created_at: TIMESTAMP
- updated_at: TIMESTAMP
```

#### Таблица `review_responses`
```sql
- id: SERIAL PRIMARY KEY
- review_id: INT (связь с отзывом)
- user_id: INT (автор ответа)
- response: TEXT
- created_at: TIMESTAMP
- updated_at: TIMESTAMP
```

#### Таблица `review_votes`
```sql
- review_id: INT
- user_id: INT
- vote_type: VARCHAR(20) (helpful, not_helpful)
- created_at: TIMESTAMP
- PRIMARY KEY (review_id, user_id)
```

### 1.2 Материализованные представления

#### `user_rating_summary`
- Агрегированные данные о рейтинге пользователей
- Автоматически обновляется триггерами

#### `storefront_rating_summary`
- Агрегированные данные о рейтинге витрин
- Автоматически обновляется триггерами

### 1.3 Особенности реализации

- Триггер `preserve_review_origin()` сохраняет информацию о происхождении отзыва при удалении объявления
- Автоматическое обновление материализованных представлений при изменении отзывов
- Поддержка каскадного удаления

## 2. API Endpoints

### 2.1 Публичные эндпоинты (без авторизации)
- `GET /api/v1/public/storefronts/:id/reviews` - отзывы витрины
- `GET /api/v1/public/storefronts/:id/rating` - рейтинг витрины
- `GET /api/v1/entity/:type/:id/rating` - рейтинг любой сущности
- `GET /api/v1/entity/:type/:id/stats` - статистика отзывов
- `GET /api/v1/reviews` - список отзывов с фильтрацией
- `GET /api/v1/reviews/:id` - детали конкретного отзыва
- `GET /api/v1/reviews/stats` - общая статистика

### 2.2 Защищенные эндпоинты (требуют JWT токен)
- `POST /api/v1/reviews` - создание отзыва
- `PUT /api/v1/reviews/:id` - обновление отзыва (только автор)
- `DELETE /api/v1/reviews/:id` - удаление отзыва (только автор)
- `POST /api/v1/reviews/:id/vote` - голосование за отзыв
- `POST /api/v1/reviews/:id/response` - ответ на отзыв
- `POST /api/v1/reviews/:id/photos` - загрузка фотографий к отзыву
- `GET /api/v1/users/:id/reviews` - отзывы пользователя
- `GET /api/v1/users/:id/rating` - рейтинг пользователя
- `GET /api/v1/storefronts/:id/reviews` - отзывы витрины (авторизованный)
- `GET /api/v1/storefronts/:id/rating` - рейтинг витрины (авторизованный)

### 2.3 Параметры фильтрации для GET /api/v1/reviews
- `entity_type` - тип сущности
- `entity_id` - ID сущности
- `user_id` - ID пользователя
- `min_rating` - минимальный рейтинг
- `max_rating` - максимальный рейтинг
- `status` - статус отзыва (по умолчанию: published)
- `sort_by` - поле сортировки (date, rating, helpful)
- `sort_order` - порядок сортировки (asc, desc)
- `page` - номер страницы
- `limit` - количество на странице

## 3. Бизнес-логика

### 3.1 Создание отзыва
1. Санитизация текста от XSS атак
2. Автоматическое определение языка отзыва
3. Модерация текста (проверка на недопустимый контент)
4. Автоматический перевод на все поддерживаемые языки (en, ru, sr)
5. Сохранение в базе данных
6. Обновление рейтинга в OpenSearch
7. Отправка уведомления владельцу объявления

### 3.2 Система голосования
- Пользователь может проголосовать "полезно" или "не полезно"
- Один голос от пользователя на отзыв
- Автоматическое обновление счетчиков
- Уведомление автору отзыва о голосах

### 3.3 Система ответов
- Владелец объявления может отвечать на отзывы
- Неограниченное количество ответов
- Уведомление автору отзыва об ответе

### 3.4 Верификация покупки
- Система поддерживает флаг `is_verified_purchase`
- В текущей реализации всегда возвращает `true` (TODO: реализовать проверку)

## 4. Интеграция с другими системами

### 4.1 OpenSearch
- При создании отзыва автоматически обновляется рейтинг объявления в поисковом индексе
- В структуре `MarketplaceListing` есть поля:
  - `AverageRating` - средний рейтинг
  - `ReviewCount` - количество отзывов
- Метод `UpdateEntityRatingInSearch` пересчитывает и обновляет эти значения

### 4.2 Система переводов
- Автоматическая модерация текста через Translation Service
- Перевод отзывов на языки: en, ru, sr
- Сохранение переводов в таблице `translations`
- Поддержка мультиязычных ответов в API

### 4.3 Система уведомлений
Отправляются уведомления типов:
- `new_review` - новый отзыв на объявление
- `review_vote` - голос за отзыв
- `review_response` - ответ на отзыв

### 4.4 Система изображений
- Поддержка загрузки фотографий к отзыву
- Хранение в MinIO
- Массив путей к файлам в поле `photos`

## 5. Безопасность

### 5.1 Защита от атак
- XSS санитизация через `utils.SanitizeText`
- CSRF защита на всех мутирующих эндпоинтах
- SQL injection защита через параметризованные запросы

### 5.2 Авторизация
- JWT токены для защищенных эндпоинтов
- Проверка прав при обновлении/удалении (только автор)
- Middleware для проверки аутентификации

## 6. Производительность

### 6.1 Оптимизации базы данных
- Индексы на часто используемых полях
- Материализованные представления для агрегированных данных
- CTE (Common Table Expressions) для сложных запросов

### 6.2 Кеширование
- Рейтинги хранятся в материализованных представлениях
- Автоматическое обновление через триггеры

## 7. Статистика и аналитика

### 7.1 Доступная статистика
- Общее количество отзывов
- Средний рейтинг
- Распределение оценок (1-5 звезд)
- Количество верифицированных покупок
- Количество отзывов с фотографиями

### 7.2 Методы получения
- `GetReviewStats` - статистика по сущности
- `GetUserRatingSummary` - сводка по пользователю
- `GetStorefrontRatingSummary` - сводка по витрине

## 8. Особенности реализации

### 8.1 Сохранение данных при удалении объявлений
- При удалении объявления отзывы не удаляются
- Сохраняется информация о происхождении в полях `entity_origin_type` и `entity_origin_id`
- Отзывы остаются доступными в истории пользователя

### 8.2 Модульность
- Отдельный модуль reviews с собственными handler, service, storage
- Интеграция через глобальный сервис
- Четкое разделение ответственности между слоями

### 8.3 Расширяемость
- Поддержка различных типов сущностей (listing, user, storefront, room, car)
- Легко добавить новые типы голосования
- Возможность добавления дополнительных полей

## 9. TODO и планы развития

1. Реализовать реальную проверку верифицированных покупок
2. Добавить модерацию отзывов администратором
3. Реализовать систему жалоб на отзывы
4. Добавить возможность редактирования ответов
5. Реализовать push-уведомления
6. Добавить экспорт статистики
7. Реализовать систему бейджей для активных рецензентов

## 10. Типы данных для Frontend

Frontend получает типизированные интерфейсы через автогенерацию:
- `Review` - полная модель отзыва
- `CreateReviewRequest` - запрос на создание
- `ReviewStats` - статистика
- `ReviewsListResponse` - пагинированный ответ
- `ReviewMessageResponse` - ответ об операции