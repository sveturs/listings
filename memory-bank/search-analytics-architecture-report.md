# Отчет: Архитектура системы поиска и аналитики
**Дата**: 2025-01-08
**Статус**: Система готова к реализации Фазы 3

## 1. Структура базы данных

### Основные таблицы для поиска и логирования:

#### search_logs
- **Назначение**: Детальное логирование каждого поискового запроса
- **Ключевые поля**:
  - user_id, session_id - идентификация пользователя/сессии
  - query_text - текст запроса
  - filters (JSONB) - примененные фильтры
  - results_count - количество результатов
  - response_time_ms - время ответа
  - location (JSONB) - геолокация
  - user_agent, ip_address - данные клиента
  - created_at - временная метка

#### search_analytics
- **Назначение**: Агрегированная аналитика по часам
- **Ключевые поля**:
  - date, hour - временной период
  - query_text - поисковый запрос
  - search_count - количество поисков
  - unique_users_count, unique_sessions_count - уникальные пользователи/сессии
  - avg_results_count, avg_response_time_ms - средние показатели
  - zero_results_count - поиски без результатов
  - click_through_rate, conversion_rate - метрики эффективности

#### search_result_clicks
- **Назначение**: Отслеживание кликов по результатам поиска
- **Ключевые поля**:
  - search_log_id - связь с конкретным поиском
  - listing_id - ID объявления
  - position - позиция в результатах
  - clicked_at - время клика

#### search_trending_queries
- **Назначение**: Популярные поисковые запросы
- **Ключевые поля**:
  - query_text - текст запроса
  - trend_score - показатель популярности
  - search_count_24h/7d/30d - счетчики по периодам

#### search_weights
- **Назначение**: Веса полей для поисковой релевантности
- **Поля**: title (3.0), description (1.5), category (2.0), location (1.2), tags (1.0)

#### search_synonyms_config
- **Назначение**: Синонимы для улучшения поиска
- **Пример**: квартира → [апартаменты, жилье, комната]

#### search_config
- **Назначение**: Общие настройки поиска
- **Параметры**: min_search_length, fuzzy_enabled, synonyms_enabled и др.

## 2. Backend архитектура

### Основные компоненты:

#### /internal/proj/search_admin/
- **handler/handler.go**: HTTP обработчики для админки поиска
  - Управление весами (CRUD)
  - Управление синонимами
  - Настройки поиска
  - Аналитика с пагинацией
- **service/service.go**: Бизнес-логика управления поиском
- **module.go**: Регистрация модуля

#### /internal/proj/searchlogs/
- **service/service.go**: Сервис логирования поиска
  - Асинхронная обработка через каналы
  - Батчевая вставка (по 100 записей)
  - Автоматическая агрегация
- **storage/postgres.go**: Репозиторий для работы с БД
- **types/types.go**: Структуры данных

#### /internal/proj/global/handler/unified_search.go
- Единый обработчик поиска для marketplace и storefront
- Интегрированное логирование поисковых запросов
- Поддержка фильтров, сортировки, пагинации

#### /internal/storage/postgres/search_analytics_repository.go
- Методы для получения аналитики
- Поддержка пагинации (offset/limit)
- Агрегированные запросы

### Особенности реализации:
1. **Асинхронное логирование**: Не блокирует основной поток поиска
2. **Батчевая обработка**: Оптимизация записи в БД
3. **Глубокое копирование**: Предотвращение гонки данных
4. **Автоматическая агрегация**: Обновление статистики в фоне

## 3. Frontend архитектура

### Компоненты админ-панели (/app/[locale]/admin/search/):

#### SearchDashboard.tsx
- Главная страница с табами
- Интеграция всех компонентов управления

#### SearchAnalytics.tsx
- Визуализация метрик поиска
- Топ запросы и запросы без результатов
- Пагинация с выбором количества элементов (25-500)
- Экспорт данных в CSV

#### SearchWeights.tsx
- Управление весами полей
- Слайдеры для настройки (0-100%)
- Конвертация в диапазон 0-10 для backend

#### SynonymManager.tsx
- CRUD операции для синонимов
- Группировка по языкам

#### TransliterationConfig.tsx
- Правила транслитерации
- Кириллица ↔ Латиница

#### SearchConfig.tsx
- Общие настройки поиска
- Переключатели функций

### Компоненты поиска:

#### SearchBar.tsx (/components/SearchBar/)
- Интегрированное логирование поисков
- Поддержка debounce для оптимизации

#### SearchPage.tsx (/app/[locale]/search/)
- Отображение результатов
- Готов к интеграции трекинга кликов

### Вспомогательные компоненты:
- **Pagination.tsx**: Универсальный компонент пагинации
- **AdminGuard.tsx**: Защита админских роутов

## 4. Текущие метрики и данные

### Что уже собирается:
1. **Поисковые запросы**: Текст, фильтры, результаты
2. **Производительность**: Время ответа, количество результатов
3. **Контекст пользователя**: User-agent, IP, устройство
4. **Временные метки**: Для анализа по периодам
5. **Категории и локации**: Для сегментации

### Агрегированные метрики:
- Общее количество поисков
- Уникальные запросы
- Среднее время ответа
- Процент поисков без результатов
- CTR (пока заглушка, нужны клики)

## 5. Готовность к Фазе 3

### Что уже есть:
✅ Инфраструктура логирования
✅ Сбор базовых метрик
✅ Админ-панель для мониторинга
✅ API для управления конфигурацией
✅ Асинхронная обработка данных
✅ Пагинация для больших объемов

### Что нужно добавить для Фазы 3:

#### 1. Таблицы для поведенческого трекинга:
- **user_behavior_events**: События (клики, просмотры, скролл)
- **search_behavior_metrics**: Агрегированные поведенческие метрики
- **ab_tests**: A/B тестирование конфигураций
- **ab_test_assignments**: Распределение пользователей по тестам

#### 2. Backend компоненты:
- **BehaviorTrackingService**: Сбор и обработка событий
- **DynamicWeightOptimizer**: Автоматическая корректировка весов
- **PersonalizationEngine**: Персонализация результатов
- **ABTestingManager**: Управление A/B тестами

#### 3. Frontend компоненты:
- **useBehaviorTracking hook**: Отправка событий
- **BehaviorDashboard**: Визуализация поведения
- **ClickHeatmap**: Тепловые карты кликов
- **ConversionFunnel**: Воронки конверсии

#### 4. Интеграции:
- Трекинг кликов в SearchResults
- Время на странице в ListingPage
- Конверсии в ContactForm
- Навигация в CategoryBrowse

## 6. Рекомендации

### Приоритеты:
1. **Сначала**: Создать таблицы и API для сбора событий
2. **Затем**: Интегрировать базовый трекинг кликов
3. **После**: Добавить визуализацию и анализ
4. **В конце**: Реализовать автоматическую оптимизацию

### Важные моменты:
- Использовать существующую асинхронную архитектуру
- Следовать паттернам батчевой обработки
- Обеспечить совместимость с текущим логированием
- Минимизировать влияние на производительность

### Риски:
- **Объем данных**: Планировать партиционирование
- **Производительность**: Использовать индексы и кэширование
- **Приватность**: Анонимизация и GDPR compliance

## Заключение

Система поиска и аналитики полностью готова к реализации Фазы 3. Инфраструктура логирования работает стабильно, админ-панель предоставляет необходимые инструменты управления, а архитектура позволяет легко добавить поведенческий трекинг без значительных изменений в существующем коде.

Рекомендуется начать с создания таблиц для событий и базового API, затем постепенно добавлять функциональность трекинга и оптимизации.