# OpenSearch Blue-Green Reindexing Tool

Ğ˜Ğ½ÑÑ‚Ñ€ÑƒĞ¼ĞµĞ½Ñ‚ Ğ´Ğ»Ñ Ğ¿ĞµÑ€ĞµĞ¸Ğ½Ğ´ĞµĞºÑĞ°Ñ†Ğ¸Ğ¸ OpenSearch Ñ Ğ½ÑƒĞ»ĞµĞ²Ñ‹Ğ¼ downtime Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒÑ ÑÑ‚Ñ€Ğ°Ñ‚ĞµĞ³Ğ¸Ñ Blue-Green deployment.

## Ğ§Ñ‚Ğ¾ Ñ‚Ğ°ĞºĞ¾Ğµ Blue-Green Reindexing?

Blue-Green deployment - ÑÑ‚Ğ¾ ÑÑ‚Ñ€Ğ°Ñ‚ĞµĞ³Ğ¸Ñ zero-downtime Ğ¿ĞµÑ€ĞµĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ñ Ğ¼ĞµĞ¶Ğ´Ñƒ Ğ´Ğ²ÑƒĞ¼Ñ Ğ²ĞµÑ€ÑĞ¸ÑĞ¼Ğ¸ Ğ¸Ğ½Ğ´ĞµĞºÑĞ°:

```
marketplace_listings_v1 â† Ñ‚ĞµĞºÑƒÑ‰Ğ¸Ğ¹ (alias: marketplace_listings)
marketplace_listings_v2 â† Ğ½Ğ¾Ğ²Ñ‹Ğ¹ (ÑĞ¾Ğ·Ğ´Ğ°ĞµÑ‚ÑÑ, Ğ·Ğ°Ğ¿Ğ¾Ğ»Ğ½ÑĞµÑ‚ÑÑ, Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ÑĞµÑ‚ÑÑ)
```

ĞŸĞ¾ÑĞ»Ğµ ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾Ğ¹ Ğ¿ĞµÑ€ĞµĞ¸Ğ½Ğ´ĞµĞºÑĞ°Ñ†Ğ¸Ğ¸:
```
marketplace_listings_v1 â† ÑÑ‚Ğ°Ñ€Ñ‹Ğ¹ (ÑĞ¾Ñ…Ñ€Ğ°Ğ½ÑĞµÑ‚ÑÑ 24Ñ‡ Ğ´Ğ»Ñ rollback)
marketplace_listings_v2 â† Ñ‚ĞµĞºÑƒÑ‰Ğ¸Ğ¹ (alias: marketplace_listings) âœ…
```

### ĞŸÑ€ĞµĞ¸Ğ¼ÑƒÑ‰ĞµÑÑ‚Ğ²Ğ°

- âœ… **Zero downtime** - Ğ¿Ğ¾Ğ¸ÑĞº Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°ĞµÑ‚ Ğ²Ğ¾ Ğ²Ñ€ĞµĞ¼Ñ Ğ¿ĞµÑ€ĞµĞ¸Ğ½Ğ´ĞµĞºÑĞ°Ñ†Ğ¸Ğ¸
- âœ… **Atomic switch** - Ğ¼Ğ³Ğ½Ğ¾Ğ²ĞµĞ½Ğ½Ğ¾Ğµ Ğ¿ĞµÑ€ĞµĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ğµ Ñ‡ĞµÑ€ĞµĞ· alias
- âœ… **Rollback** - Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‚ Ğº ÑÑ‚Ğ°Ñ€Ğ¾Ğ¹ Ğ²ĞµÑ€ÑĞ¸Ğ¸ Ğ·Ğ° ÑĞµĞºÑƒĞ½Ğ´Ñ‹
- âœ… **Verification** - Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ¿ĞµÑ€ĞµĞ´ Ğ¿ĞµÑ€ĞµĞºĞ»ÑÑ‡ĞµĞ½Ğ¸ĞµĞ¼

## Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ°

```bash
cd /p/github.com/vondi-global/listings
go build -o bin/reindex ./cmd/reindex/
```

## Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ

### 1. ĞŸĞ¾Ğ»Ğ½Ğ°Ñ Ğ¿ĞµÑ€ĞµĞ¸Ğ½Ğ´ĞµĞºÑĞ°Ñ†Ğ¸Ñ (Blue-Green)

```bash
# Ğ¡ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ°Ğ¼Ğ¸ Ğ¿Ğ¾ ÑƒĞ¼Ğ¾Ğ»Ñ‡Ğ°Ğ½Ğ¸Ñ (batch size 500)
./bin/reindex

# Ğ¡ ĞºĞ°ÑÑ‚Ğ¾Ğ¼Ğ½Ñ‹Ğ¼ batch size
./bin/reindex --batch 1000
```

**Ğ§Ñ‚Ğ¾ Ğ¿Ñ€Ğ¾Ğ¸ÑÑ…Ğ¾Ğ´Ğ¸Ñ‚:**
1. ĞĞ¿Ñ€ĞµĞ´ĞµĞ»ÑĞµÑ‚ÑÑ Ñ‚ĞµĞºÑƒÑ‰Ğ°Ñ Ğ²ĞµÑ€ÑĞ¸Ñ Ğ¸Ğ½Ğ´ĞµĞºÑĞ° (v1 Ğ¸Ğ»Ğ¸ v2)
2. Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµÑ‚ÑÑ Ğ½Ğ¾Ğ²Ñ‹Ğ¹ Ğ¸Ğ½Ğ´ĞµĞºÑ Ğ¿Ñ€Ğ¾Ñ‚Ğ¸Ğ²Ğ¾Ğ¿Ğ¾Ğ»Ğ¾Ğ¶Ğ½Ğ¾Ğ¹ Ğ²ĞµÑ€ÑĞ¸Ğ¸
3. Ğ’Ñ‹Ğ¿Ğ¾Ğ»Ğ½ÑĞµÑ‚ÑÑ Ğ¿ĞµÑ€ĞµĞ¸Ğ½Ğ´ĞµĞºÑĞ°Ñ†Ğ¸Ñ (server-side Reindex API)
4. ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµÑ‚ÑÑ ĞºĞ¾Ñ€Ñ€ĞµĞºÑ‚Ğ½Ğ¾ÑÑ‚ÑŒ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…
5. Atomic Ğ¿ĞµÑ€ĞµĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ğµ alias
6. Ğ¡Ñ‚Ğ°Ñ€Ñ‹Ğ¹ Ğ¸Ğ½Ğ´ĞµĞºÑ ÑĞ¾Ñ…Ñ€Ğ°Ğ½ÑĞµÑ‚ÑÑ 24 Ñ‡Ğ°ÑĞ°

### 2. Ğ’ĞµÑ€Ğ¸Ñ„Ğ¸ĞºĞ°Ñ†Ğ¸Ñ Ñ‚ĞµĞºÑƒÑ‰ĞµĞ³Ğ¾ Ğ¸Ğ½Ğ´ĞµĞºÑĞ°

```bash
./bin/reindex --verify
```

ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµÑ‚:
- âœ… ĞšĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ğ¾Ğ² (ÑÑ€Ğ°Ğ²Ğ½ĞµĞ½Ğ¸Ğµ Ñ Ğ‘Ğ”)
- âœ… ĞŸĞ¾ĞºÑ€Ñ‹Ñ‚Ğ¸Ğµ ĞºÑ€Ğ¸Ñ‚Ğ¸Ñ‡Ğ½Ñ‹Ñ… Ğ¿Ğ¾Ğ»ĞµĞ¹ (title, price, category_id, status)
- âœ… Ğ¢ĞµÑÑ‚Ğ¾Ğ²Ñ‹Ğµ Ğ¿Ğ¾Ğ¸ÑĞºĞ¾Ğ²Ñ‹Ğµ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑÑ‹

**ĞŸÑ€Ğ¸Ğ¼ĞµÑ€ Ğ²Ñ‹Ğ²Ğ¾Ğ´Ğ°:**

```
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“Š VERIFICATION RESULTS
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
Index:          marketplace_listings_v1
Valid:          true
Total Docs:     1523
Expected Docs:  1520
Mismatch Count: 0

Field Coverage:
  âœ… title: 100.00%
  âœ… price: 100.00%
  âœ… category_id: 99.87%
  âœ… status: 100.00%
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
```

### 3. Rollback Ğº Ğ¿Ñ€ĞµĞ´Ñ‹Ğ´ÑƒÑ‰ĞµĞ¹ Ğ²ĞµÑ€ÑĞ¸Ğ¸

```bash
# ĞÑ‚ĞºĞ°Ñ‚Ğ¸Ñ‚ÑŒÑÑ Ğ½Ğ° v1
./bin/reindex --rollback v1

# ĞÑ‚ĞºĞ°Ñ‚Ğ¸Ñ‚ÑŒÑÑ Ğ½Ğ° v2
./bin/reindex --rollback v2
```

**Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞ¹ ĞµÑĞ»Ğ¸:**
- âŒ ĞŸĞ¾ÑĞ»Ğµ Ğ¿ĞµÑ€ĞµĞ¸Ğ½Ğ´ĞµĞºÑĞ°Ñ†Ğ¸Ğ¸ Ğ¾Ğ±Ğ½Ğ°Ñ€ÑƒĞ¶ĞµĞ½Ñ‹ Ğ¿Ñ€Ğ¾Ğ±Ğ»ĞµĞ¼Ñ‹
- âŒ ĞĞ¾Ğ²Ñ‹Ğµ Ğ¼Ğ°Ğ¿Ğ¿Ğ¸Ğ½Ğ³Ğ¸ Ğ²Ñ‹Ğ·Ñ‹Ğ²Ğ°ÑÑ‚ Ğ¾ÑˆĞ¸Ğ±ĞºĞ¸ Ğ¿Ğ¾Ğ¸ÑĞºĞ°
- âœ… Rollback Ğ·Ğ°Ğ½Ğ¸Ğ¼Ğ°ĞµÑ‚ ÑĞµĞºÑƒĞ½Ğ´Ñ‹ (Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ¿ĞµÑ€ĞµĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ğµ alias)

## ĞšĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ñ

ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸ Ğ±ĞµÑ€ÑƒÑ‚ÑÑ Ğ¸Ğ· `.env` Ñ„Ğ°Ğ¹Ğ»Ğ°:

```bash
# Database
VONDILISTINGS_DB_HOST=localhost
VONDILISTINGS_DB_PORT=35434
VONDILISTINGS_DB_USER=listings_user
VONDILISTINGS_DB_PASSWORD=listings_secret
VONDILISTINGS_DB_NAME=listings_dev_db

# OpenSearch
VONDILISTINGS_OPENSEARCH_ADDRESSES=http://localhost:9200
VONDILISTINGS_OPENSEARCH_USERNAME=admin
VONDILISTINGS_OPENSEARCH_PASSWORD=admin
VONDILISTINGS_OPENSEARCH_INDEX=marketplace_listings
```

## ĞĞ»Ğ³Ğ¾Ñ€Ğ¸Ñ‚Ğ¼ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‹

### Blue-Green Reindex Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. GetCurrentIndexVersion()        â”‚
â”‚    marketplace_listings â†’ v1       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. Create new index                 â”‚
â”‚    marketplace_listings_v2          â”‚
â”‚    (with latest mappings)           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. Reindex data                     â”‚
â”‚    v1 â†’ v2 (OpenSearch Reindex API) â”‚
â”‚    Or DB â†’ v2 (if v1 not exists)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. Verify results                   â”‚
â”‚    - Document count                 â”‚
â”‚    - Field coverage                 â”‚
â”‚    - Test queries                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. Atomic alias switch              â”‚
â”‚    marketplace_listings: v1 â†’ v2    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 6. Success!                         â”‚
â”‚    v1 kept for 24h rollback         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Verification Checks

**1. Document Count**
- Ğ¡Ñ€Ğ°Ğ²Ğ½Ğ¸Ğ²Ğ°ĞµÑ‚ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ğ¾Ğ² Ğ² Ğ¸Ğ½Ğ´ĞµĞºÑĞµ Ñ Ğ‘Ğ”
- Ğ”Ğ¾Ğ¿ÑƒÑĞº: 95% (Ğ´Ğ»Ñ ÑƒÑ‡ĞµÑ‚Ğ° Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ğ¾Ğ² Ğ² Ğ¿Ñ€Ğ¾Ñ†ĞµÑÑĞµ)

**2. Field Coverage**
- ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµÑ‚ Ğ¿Ğ¾ĞºÑ€Ñ‹Ñ‚Ğ¸Ğµ ĞºÑ€Ğ¸Ñ‚Ğ¸Ñ‡Ğ½Ñ‹Ñ… Ğ¿Ğ¾Ğ»ĞµĞ¹
- ĞŸĞ¾Ñ€Ğ¾Ğ³: 99% Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ğ¾Ğ² Ğ´Ğ¾Ğ»Ğ¶Ğ½Ñ‹ Ğ¸Ğ¼ĞµÑ‚ÑŒ Ğ¿Ğ¾Ğ»Ğµ

**3. Test Queries**
- Ğ’Ñ‹Ğ¿Ğ¾Ğ»Ğ½ÑĞµÑ‚ Ñ‚ĞµÑÑ‚Ğ¾Ğ²Ñ‹Ğµ Ğ¿Ğ¾Ğ¸ÑĞºĞ¸: "telefon", "patike", "auto"
- ĞŸÑ€ĞµĞ´ÑƒĞ¿Ñ€ĞµĞ¶Ğ´ĞµĞ½Ğ¸Ğµ ĞµÑĞ»Ğ¸ 0 Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ğ¾Ğ²

## Troubleshooting

### ĞÑˆĞ¸Ğ±ĞºĞ°: "verification failed"

```bash
# ĞŸÑ€Ğ¾Ğ²ĞµÑ€Ğ¸Ñ‚ÑŒ Ğ¸Ğ½Ğ´ĞµĞºÑ Ğ²Ñ€ÑƒÑ‡Ğ½ÑƒÑ
curl -X GET "localhost:9200/marketplace_listings_v2/_count" | jq .

# ĞŸÑ€Ğ¾Ğ²ĞµÑ€Ğ¸Ñ‚ÑŒ Ğ¼Ğ°Ğ¿Ğ¿Ğ¸Ğ½Ğ³Ğ¸
curl -X GET "localhost:9200/marketplace_listings_v2/_mapping" | jq .

# ĞŸÑ€Ğ¾Ğ²ĞµÑ€Ğ¸Ñ‚ÑŒ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ğ² Ğ‘Ğ”
psql "postgres://listings_user:listings_secret@localhost:35434/listings_dev_db" \
  -c "SELECT COUNT(*) FROM listings WHERE status='active' AND visibility='public';"
```

### ĞÑˆĞ¸Ğ±ĞºĞ°: "failed to create index"

Ğ’Ğ¾Ğ·Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ Ğ¸Ğ½Ğ´ĞµĞºÑ ÑƒĞ¶Ğµ ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒĞµÑ‚. Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚Ğµ Ğ²Ñ€ÑƒÑ‡Ğ½ÑƒÑ:

```bash
curl -X DELETE "localhost:9200/marketplace_listings_v2"
```

### ĞŸĞµÑ€ĞµĞ¸Ğ½Ğ´ĞµĞºÑĞ°Ñ†Ğ¸Ñ Ğ·Ğ°Ğ²Ğ¸ÑĞ»Ğ°

```bash
# ĞŸÑ€Ğ¾Ğ²ĞµÑ€Ğ¸Ñ‚ÑŒ ÑÑ‚Ğ°Ñ‚ÑƒÑ Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ¸ reindex
curl -X GET "localhost:9200/_tasks?detailed=true&actions=indices:data/write/reindex" | jq .

# ĞÑ‚Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ Ğ·Ğ°Ğ´Ğ°Ñ‡Ñƒ (ĞµÑĞ»Ğ¸ Ğ½ÑƒĞ¶Ğ½Ğ¾)
curl -X POST "localhost:9200/_tasks/<task_id>/_cancel"
```

## Best Practices

### ĞšĞ¾Ğ³Ğ´Ğ° Ğ·Ğ°Ğ¿ÑƒÑĞºĞ°Ñ‚ÑŒ Ğ¿ĞµÑ€ĞµĞ¸Ğ½Ğ´ĞµĞºÑĞ°Ñ†Ğ¸Ñ

âœ… **ĞÑƒĞ¶Ğ½Ğ° Ğ¿ĞµÑ€ĞµĞ¸Ğ½Ğ´ĞµĞºÑĞ°Ñ†Ğ¸Ñ:**
- Ğ˜Ğ·Ğ¼ĞµĞ½Ğ¸Ğ»Ğ¸ÑÑŒ Ğ¼Ğ°Ğ¿Ğ¿Ğ¸Ğ½Ğ³Ğ¸ (Ğ½Ğ¾Ğ²Ñ‹Ğµ Ğ¿Ğ¾Ğ»Ñ, Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ‚Ğ¾Ñ€Ñ‹)
- ĞĞ±Ğ½Ğ¾Ğ²Ğ¸Ğ»Ğ¸ÑÑŒ Ğ¿ĞµÑ€ĞµĞ²Ğ¾Ğ´Ñ‹/Ñ‚Ñ€Ğ°Ğ½ÑĞ»Ğ¸Ñ‚ĞµÑ€Ğ°Ñ†Ğ¸Ğ¸
- Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ğ»Ğ¸ÑÑŒ Ğ½Ğ¾Ğ²Ñ‹Ğµ ÑĞ¸Ğ½Ğ¾Ğ½Ğ¸Ğ¼Ñ‹
- Ğ˜Ğ·Ğ¼ĞµĞ½Ğ¸Ğ»Ğ°ÑÑŒ ÑÑ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ğ° Ğ²Ğ°Ñ€Ğ¸Ğ°Ğ½Ñ‚Ğ¾Ğ²/Ğ°Ñ‚Ñ€Ğ¸Ğ±ÑƒÑ‚Ğ¾Ğ²

âŒ **ĞĞ• Ğ½ÑƒĞ¶Ğ½Ğ° Ğ¿ĞµÑ€ĞµĞ¸Ğ½Ğ´ĞµĞºÑĞ°Ñ†Ğ¸Ñ:**
- Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ğ»Ğ¾ÑÑŒ Ğ½ĞµÑĞºĞ¾Ğ»ÑŒĞºĞ¾ Ğ½Ğ¾Ğ²Ñ‹Ñ… Ğ»Ğ¸ÑÑ‚Ğ¸Ğ½Ğ³Ğ¾Ğ² (Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞ¹ real-time indexing)
- ĞĞ±Ğ½Ğ¾Ğ²Ğ¸Ğ»Ğ°ÑÑŒ Ñ†ĞµĞ½Ğ°/ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ (real-time update)

### Timing

- **Dev:** ĞœĞ¾Ğ¶Ğ½Ğ¾ Ğ² Ğ»ÑĞ±Ğ¾Ğµ Ğ²Ñ€ĞµĞ¼Ñ
- **Prod:** Ğ›ÑƒÑ‡ÑˆĞµ Ğ² low-traffic Ñ‡Ğ°ÑÑ‹ (2-5 AM)
- **Rollback window:** 24 Ñ‡Ğ°ÑĞ° Ğ¿Ğ¾ÑĞ»Ğµ Ğ¿ĞµÑ€ĞµĞ¸Ğ½Ğ´ĞµĞºÑĞ°Ñ†Ğ¸Ğ¸

### ĞœĞ¾Ğ½Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ğ½Ğ³

```bash
# ĞŸÑ€Ğ¾Ğ²ĞµÑ€Ğ¸Ñ‚ÑŒ Ñ€Ğ°Ğ·Ğ¼ĞµÑ€ Ğ¸Ğ½Ğ´ĞµĞºÑĞ¾Ğ²
curl -X GET "localhost:9200/_cat/indices/marketplace_listings_*?v&h=index,docs.count,store.size"

# ĞŸÑ€Ğ¾Ğ²ĞµÑ€Ğ¸Ñ‚ÑŒ alias
curl -X GET "localhost:9200/_cat/aliases/marketplace_listings?v"

# ĞŸÑ€Ğ¾Ğ²ĞµÑ€Ğ¸Ñ‚ÑŒ Ğ·Ğ´Ğ¾Ñ€Ğ¾Ğ²ÑŒĞµ
curl -X GET "localhost:9200/_cluster/health?pretty"
```

## ĞŸÑ€Ğ¸Ğ¼ĞµÑ€Ñ‹

### ĞŸĞ¾Ğ»Ğ½Ğ°Ñ Ğ¿ĞµÑ€ĞµĞ¸Ğ½Ğ´ĞµĞºÑĞ°Ñ†Ğ¸Ñ Ñ Ğ²ĞµÑ€Ğ¸Ñ„Ğ¸ĞºĞ°Ñ†Ğ¸ĞµĞ¹

```bash
# 1. Ğ—Ğ°Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚ÑŒ Ğ¿ĞµÑ€ĞµĞ¸Ğ½Ğ´ĞµĞºÑĞ°Ñ†Ğ¸Ñ
./bin/reindex --batch 1000

# 2. ĞŸÑ€Ğ¾Ğ²ĞµÑ€Ğ¸Ñ‚ÑŒ Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚
./bin/reindex --verify

# 3. Ğ•ÑĞ»Ğ¸ Ğ²ÑÑ‘ Ğ¾Ğº - Ğ¿Ñ€Ğ¾Ğ´Ğ¾Ğ»Ğ¶Ğ°Ñ‚ÑŒ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñƒ
# 4. Ğ•ÑĞ»Ğ¸ Ğ¿Ñ€Ğ¾Ğ±Ğ»ĞµĞ¼Ñ‹ - rollback
./bin/reindex --rollback v1
```

### ĞŸĞµÑ€Ğ²Ğ¸Ñ‡Ğ½Ğ°Ñ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ° (initial setup)

Ğ•ÑĞ»Ğ¸ Ğ¸Ğ½Ğ´ĞµĞºÑÑ‹ Ğ²Ğ¾Ğ¾Ğ±Ñ‰Ğµ Ğ½Ğµ ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒÑÑ‚:

```bash
# Ğ¡Ğ¾Ğ·Ğ´Ğ°ÑÑ‚ marketplace_listings_v1 Ğ¸ Ğ·Ğ°Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ Ğ¸Ğ· Ğ‘Ğ”
./bin/reindex
```

### ĞĞ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ¼Ğ°Ğ¿Ğ¿Ğ¸Ğ½Ğ³Ğ¾Ğ²

ĞŸĞ¾ÑĞ»Ğµ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ñ `internal/repository/opensearch/mappings.go`:

```bash
# 1. Ğ—Ğ°ĞºĞ¾Ğ¼Ğ¼Ğ¸Ñ‚Ğ¸Ñ‚ÑŒ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ñ
git add internal/repository/opensearch/mappings.go
git commit -m "feat: add new field to OpenSearch mapping"

# 2. ĞŸĞµÑ€ĞµÑĞ¾Ğ±Ñ€Ğ°Ñ‚ÑŒ
go build -o bin/reindex ./cmd/reindex/

# 3. Ğ—Ğ°Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚ÑŒ blue-green reindex
./bin/reindex

# ĞĞ¾Ğ²Ñ‹Ğ¹ Ğ¸Ğ½Ğ´ĞµĞºÑ Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ½Ñ‹Ğµ Ğ¼Ğ°Ğ¿Ğ¿Ğ¸Ğ½Ğ³Ğ¸
```

## ĞÑ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚ÑƒÑ€Ğ°

```
cmd/reindex/
â””â”€â”€ main.go                    # CLI tool

internal/
â”œâ”€â”€ reindexer/
â”‚   â””â”€â”€ manager.go            # ReindexManager (Blue-Green logic)
â”œâ”€â”€ indexer/
â”‚   â””â”€â”€ listing_indexer.go    # ListingIndexer (DB â†’ OpenSearch)
â””â”€â”€ repository/opensearch/
    â”œâ”€â”€ client.go             # OpenSearch client
    â””â”€â”€ mappings.go           # Index mappings
```

## Ğ¡Ğ¼. Ñ‚Ğ°ĞºĞ¶Ğµ

- [OpenSearch Reindex API](https://opensearch.org/docs/latest/api-reference/document-apis/reindex/)
- [Blue-Green Deployment](https://martinfowler.com/bliki/BlueGreenDeployment.html)
- [Index Aliases](https://opensearch.org/docs/latest/opensearch/index-alias/)
