// Компонент-контейнер для отзывов, который можно переиспользовать
const ReviewsSection = ({ 
    entityType,
    entityId,
    entityTitle,
    currentUserId,
    canAddReview = true
}) => {
    const [reviews, setReviews] = useState([]);
    const [loading, setLoading] = useState(true);
    const [showReviewForm, setShowReviewForm] = useState(false);
    const [stats, setStats] = useState({
        averageRating: 0,
        totalReviews: 0,
        ratingDistribution: {
            1: 0, 2: 0, 3: 0, 4: 0, 5: 0
        }
    });

    useEffect(() => {
        fetchReviews();
        fetchStats();
    }, [entityId, entityType]);

    const fetchReviews = async () => {
        try {
            const response = await axios.get('/api/v1/reviews', {
                params: {
                    entity_type: entityType,
                    entity_id: entityId
                }
            });
            setReviews(response.data.data);
        } catch (error) {
            console.error('Error fetching reviews:', error);
        } finally {
            setLoading(false);
        }
    };

    const fetchStats = async () => {
        try {
            const response = await axios.get(`/api/v1/reviews/stats`, {
                params: {
                    entity_type: entityType,
                    entity_id: entityId
                }
            });
            setStats(response.data);
        } catch (error) {
            console.error('Error fetching review stats:', error);
        }
    };

    const handleSubmitReview = async (reviewData) => {
        try {
            await axios.post('/api/v1/reviews', {
                ...reviewData,
                entity_type: entityType,
                entity_id: entityId
            });
            fetchReviews();
            fetchStats();
            setShowReviewForm(false);
        } catch (error) {
            console.error('Error submitting review:', error);
        }
    };

    const handleVote = async (reviewId, voteType) => {
        try {
            await axios.post(`/api/v1/reviews/${reviewId}/vote`, { vote_type: voteType });
            fetchReviews();
        } catch (error) {
            console.error('Error voting for review:', error);
        }
    };

    return (
        <Box>
            {/* Шапка с общей статистикой */}
            <Stack direction="row" spacing={4} alignItems="center" sx={{ mb: 4 }}>
                <Box textAlign="center">
                    <Typography variant="h3" fontWeight="bold">
                        {stats.averageRating.toFixed(1)}
                    </Typography>
                    <Rating value={stats.averageRating} readOnly precision={0.1} />
                    <Typography color="text.secondary">
                        {stats.totalReviews} отзывов
                    </Typography>
                </Box>
                <Box flex={1}>
                    {Object.entries(stats.ratingDistribution).reverse().map(([rating, count]) => (
                        <Stack key={rating} direction="row" spacing={2} alignItems="center">
                            <Typography component="span" minWidth={20}>{rating}</Typography>
                            <LinearProgress
                                variant="determinate"
                                value={(count / stats.totalReviews) * 100}
                                sx={{ flex: 1, height: 8, borderRadius: 1 }}
                            />
                            <Typography component="span" minWidth={40}>
                                {count}
                            </Typography>
                        </Stack>
                    ))}
                </Box>
                {canAddReview && (
                    <Button
                        variant="contained"
                        onClick={() => setShowReviewForm(true)}
                        startIcon={<PencilLine />}
                    >
                        Написать отзыв
                    </Button>
                )}
            </Stack>

            {/* Форма добавления отзыва */}
            <Dialog
                open={showReviewForm}
                onClose={() => setShowReviewForm(false)}
                maxWidth="md"
                fullWidth
            >
                <DialogTitle>
                    Отзыв о {entityTitle}
                </DialogTitle>
                <DialogContent>
                    <ReviewForm onSubmit={handleSubmitReview} />
                </DialogContent>
            </Dialog>

            {/* Список отзывов */}
            {loading ? (
                <CircularProgress />
            ) : (
                <Stack spacing={2}>
                    {reviews.map(review => (
                        <ReviewCard
                            key={review.id}
                            review={review}
                            onVote={handleVote}
                            currentUserId={currentUserId}
                        />
                    ))}
                </Stack>
            )}
        </Box>
    );
};

// Пример использования в компоненте маркетплейса
const MarketplaceListingDetails = ({ listing }) => {
    return (
        <Box>
            {/* Основная информация о товаре */}
            <ListingInfo listing={listing} />
            
            {/* Секция отзывов */}
<ReviewsSection
    entityType="listing"
    entityId={parseInt(id)}
    entityTitle={listing.title}
    canReview={user && user.id !== listing.user_id}
/>
        </Box>
    );
};

// Пример использования в компоненте отеля
const RoomDetails = ({ room }) => {
    return (
        <Box>
            {/* Информация о номере */}
            <RoomInfo room={room} />
            
            {/* Секция отзывов */}
            <ReviewsSection
                entityType="room"
                entityId={room.id}
                entityTitle={`${room.name} в ${room.hotel_name}`}
                canAddReview={room.has_completed_stay} // Проверяем, был ли завершен период проживания
            />
        </Box>
    );
};

// Пример использования в компоненте аренды авто
const CarDetails = ({ car }) => {
    return (
        <Box>
            {/* Информация об автомобиле */}
            <CarInfo car={car} />
            
            {/* Секция отзывов */}
            <ReviewsSection
                entityType="car"
                entityId={car.id}
                entityTitle={`${car.make} ${car.model}`}
                canAddReview={car.has_completed_rental} // Проверяем, была ли завершена аренда
            />
        </Box>
    );
};
//модуль для добавления отзывов и рейтинга