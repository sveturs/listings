# Исправление функционала лупы для вертикальных изображений - Финальное решение

## Дата: 08.06.2025

## Проблема

При наведении курсора на вертикальные изображения лупа показывала неправильную область:

- Для горизонтальных фото всё работало корректно
- Для вертикальных фото область увеличения смещалась относительно курсора
- При наведении на пустое пространство слева/справа от вертикального фото лупа всё равно показывала увеличение

## Причина

Расчет позиции курсора производился относительно всего контейнера, а не относительно самого изображения. Для вертикальных изображений с `object-contain` изображение центрируется и не занимает всю ширину контейнера.

## Успешное решение: Математический расчет размеров изображения

### Ключевые изменения в `ImageGallery.tsx`:

1. **Добавлено состояние для хранения естественных размеров изображения:**

```typescript
const [imageNaturalDimensions, setImageNaturalDimensions] = useState({
  width: 0,
  height: 0,
});
```

2. **Добавлен эффект для загрузки размеров при смене изображения:**

```typescript
useEffect(() => {
  const currentImage = images[selectedIndex];
  if (!currentImage || currentImage.id === 0 || currentImage.is_video) {
    return;
  }

  const img = new window.Image();
  img.onload = () => {
    setImageNaturalDimensions({
      width: img.naturalWidth,
      height: img.naturalHeight,
    });
  };
  img.src = config.buildImageUrl(currentImage.public_url);
}, [selectedIndex, images]);
```

3. **Переработана функция handleMouseMove:**

- Рассчитываем реальные размеры отображаемого изображения на основе `object-contain`
- Определяем отступы изображения от краев контейнера
- Проверяем, находится ли курсор над изображением
- Рассчитываем позицию относительно изображения, а не контейнера

### Алгоритм расчета:

1. Получаем соотношение сторон изображения и контейнера
2. Определяем, ограничено ли изображение по ширине или по высоте
3. Рассчитываем реальные размеры и отступы изображения
4. Проверяем, находится ли курсор над изображением
5. Если да - рассчитываем позицию зума относительно изображения

## Результат

- ✅ Лупа корректно работает как для горизонтальных, так и для вертикальных изображений
- ✅ При наведении на пустое пространство вокруг вертикальных фото лупа не показывается
- ✅ Увеличенная область точно соответствует позиции курсора
- ✅ Код прошел все проверки: lint, build, format

## Тестирование

Создана тестовая HTML страница `/frontend/svetu/test-zoom.html` для проверки алгоритма расчета позиции на вертикальных и горизонтальных изображениях.

## Примечание

Первая попытка с использованием `querySelector('img')` и `getBoundingClientRect()` не сработала, вероятно из-за особенностей работы Next.js Image компонента. Математический подход оказался более надежным и универсальным.
