# Migration 20251111230000: Unify Table Names

## Цель
Унификация названий таблиц - удаление legacy префиксов `c2c_` и `b2c_`, приведение к единому стилю именования.

## Что делает UP миграция

### 1. Удаление ненужных таблиц
- ❌ **DROP** `b2c_product_variants` (0 records, пустая таблица)
- ❌ **DROP** `c2c_categories_backup_20251110` (backup таблица)

### 2. Переименование c2c_favorites → listing_favorites
- ✅ Таблица переименована
- ✅ Все индексы переименованы (6 индексов)
- ✅ Primary key переименован
- ✅ Foreign key constraint переименован
- ✅ Связь с `listings` сохранена

### 3. Переименование c2c_categories → categories
- ✅ Таблица переименована
- ✅ Sequence переименован (`c2c_categories_id_seq` → `categories_id_seq`)
- ✅ Primary key переименован
- ✅ Unique constraint переименован
- ✅ Все индексы переименованы (8 индексов)
- ✅ Self-referencing FK сохранён (`parent_id` → `id`)
- ✅ Check constraint переименован
- ✅ FK из `listings.category_id` сохранён

### 4. Добавление CHECK constraint
- ✅ `listings.source_type` CHECK constraint добавлен
- ✅ Допустимые значения: `'c2c'`, `'b2c'`, `'storefront'`
- ✅ Idempotent (проверка существования перед добавлением)

## Что делает DOWN миграция

### Откатывает все изменения:
1. ❌ Удаляет `listings_source_type_check` constraint
2. ❌ `categories` → `c2c_categories` (с индексами, constraints)
3. ❌ `listing_favorites` → `c2c_favorites` (с индексами, constraints)

### ⚠️ Что НЕ восстанавливается:
- **b2c_product_variants** (была пустой)
- **c2c_categories_backup_20251110** (был backup)

Если нужно восстановить - использовать database backup.

## Применение миграции

### UP (применить):
```bash
cd /p/github.com/sveturs/listings
./migrator up
```

### DOWN (откатить):
```bash
cd /p/github.com/sveturs/listings
./migrator down
```

### Проверка результата:
```sql
-- Проверить новые таблицы
SELECT tablename FROM pg_tables 
WHERE schemaname = 'public' 
AND tablename IN ('listing_favorites', 'categories');

-- Проверить что старые удалены
SELECT tablename FROM pg_tables 
WHERE schemaname = 'public' 
AND tablename IN ('c2c_favorites', 'c2c_categories', 'b2c_product_variants');

-- Проверить CHECK constraint
SELECT conname FROM pg_constraint 
WHERE conrelid = 'listings'::regclass 
AND conname = 'listings_source_type_check';
```

## Безопасность

### ✅ Миграция безопасна:
- Использует `IF EXISTS` для всех DROP/ALTER операций
- Idempotent (можно запускать повторно)
- Сохраняет все данные (только переименования)
- Сохраняет все FK, indexes, constraints
- Проверяет существование constraint перед добавлением

### ⚠️ Внимание:
- При откате (DOWN) не восстанавливаются удалённые пустые таблицы
- Используйте database backup если нужно полное восстановление

## Влияние на код

### Backend (Go):
После миграции нужно обновить:
- Репозитории: `c2c_favorites` → `listing_favorites`
- Модели: `c2c_categories` → `categories`
- SQL запросы с явными именами таблиц

### Не требуется изменений:
- ORM запросы через struct tags (обновить только tags)
- gRPC proto (независимо от названий таблиц)

## Статистика изменений

| Операция | Количество |
|----------|-----------|
| Удалено таблиц | 2 |
| Переименовано таблиц | 2 |
| Переименовано индексов | 14 |
| Переименовано constraints | 5 |
| Переименовано sequences | 1 |
| Добавлено constraints | 1 |

## Timeline

- **Created:** 2025-11-11 23:00:00
- **Migration ID:** 20251111230000
- **Status:** ✅ Ready to apply
