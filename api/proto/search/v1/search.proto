syntax = "proto3";

package search.v1;

import "google/protobuf/timestamp.proto";
import "api/proto/search/v1/common.proto";
import "api/proto/search/v1/facets.proto";
import "api/proto/search/v1/filters.proto";
import "api/proto/search/v1/suggestions.proto";
import "api/proto/search/v1/popular.proto";

option go_package = "github.com/vondi-global/listings/api/proto/search/v1;searchv1";

// SearchService provides search functionality for marketplace listings
service SearchService {
  // SearchListings searches for listings based on query text and filters
  // Phase 21.1 - Basic full-text search
  rpc SearchListings(SearchListingsRequest) returns (SearchListingsResponse);

  // GetSearchFacets returns aggregations for filter UI
  // Phase 21.2 - Returns category counts, price ranges, attribute values, etc.
  rpc GetSearchFacets(GetSearchFacetsRequest) returns (GetSearchFacetsResponse);

  // SearchWithFilters performs advanced search with filters, sorting, and facets
  // Phase 21.2 - Enhanced search with price, attributes, location, sorting
  rpc SearchWithFilters(SearchWithFiltersRequest) returns (SearchWithFiltersResponse);

  // GetSuggestions provides autocomplete suggestions
  // Phase 21.2 - Uses completion suggester for fast prefix matching
  rpc GetSuggestions(GetSuggestionsRequest) returns (GetSuggestionsResponse);

  // GetPopularSearches returns trending search queries
  // Phase 21.2 - Popular queries by time range for search suggestions UI
  rpc GetPopularSearches(GetPopularSearchesRequest) returns (GetPopularSearchesResponse);

  // GetTrendingSearches returns trending search queries from analytics
  // Phase 28 - Search Analytics - Real trending queries from search_queries table
  rpc GetTrendingSearches(GetTrendingSearchesRequest) returns (TrendingSearchesResponse);

  // GetSearchHistory returns user's personal search history
  // Phase 28 - Search Analytics - Personal search history for authenticated or anonymous users
  rpc GetSearchHistory(GetSearchHistoryRequest) returns (SearchHistoryResponse);
}

// SearchListingsRequest contains search parameters
message SearchListingsRequest {
  // Search query text (optional - can search without query)
  string query = 1;

  // Filter by category ID (optional, UUID string)
  string category_id = 2;

  // Results per page (1-100, default: 20)
  int32 limit = 3;

  // Pagination offset (default: 0)
  int32 offset = 4;

  // Use Redis cache for results (default: true)
  bool use_cache = 5;
}

// SearchListingsResponse contains search results
message SearchListingsResponse {
  // List of matching listings
  repeated Listing listings = 1;

  // Total number of matching documents
  int64 total = 2;

  // Search duration in milliseconds
  int32 took_ms = 3;

  // Whether result was served from cache
  bool cached = 4;
}

// Listing and ListingImage are now defined in common.proto

// ============================================================================
// Phase 28: Search Analytics - Trending Searches
// ============================================================================

// GetTrendingSearchesRequest contains parameters for trending searches
message GetTrendingSearchesRequest {
  // Filter by category ID (optional, UUID string, empty = all categories)
  string category_id = 1;

  // Max results (default: 10, max: 50)
  int32 limit = 2;

  // Period in days (default: 7, max: 30)
  int32 days = 3;
}

// TrendingSearchesResponse contains trending search results
message TrendingSearchesResponse {
  // List of trending searches
  repeated TrendingSearch searches = 1;
}

// TrendingSearch represents a single trending search query
message TrendingSearch {
  // Search query text
  string query_text = 1;

  // Number of times this query was searched
  int32 search_count = 2;

  // Timestamp of the last search
  google.protobuf.Timestamp last_searched = 3;
}

// ============================================================================
// Phase 28: Search Analytics - Personal Search History
// ============================================================================

// GetSearchHistoryRequest contains parameters for user's search history
message GetSearchHistoryRequest {
  // User ID (for authenticated users)
  optional int64 user_id = 1;

  // Session ID (for anonymous users)
  optional string session_id = 2;

  // Max results (default: 50, max: 100)
  int32 limit = 3;
}

// SearchHistoryResponse contains user's search history
message SearchHistoryResponse {
  // List of search history entries
  repeated SearchHistoryEntry entries = 1;
}

// SearchHistoryEntry represents a single search from user's history
message SearchHistoryEntry {
  // Search query text
  string query_text = 1;

  // Category ID (optional, UUID string)
  string category_id = 2;

  // Number of results returned for this search
  int32 results_count = 3;

  // Listing ID that was clicked (optional)
  optional int64 clicked_listing_id = 4;

  // When this search was performed
  google.protobuf.Timestamp searched_at = 5;
}
