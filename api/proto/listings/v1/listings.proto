syntax = "proto3";

package listings.v1;

import "google/protobuf/empty.proto";

option go_package = "github.com/sveturs/listings/api/proto/listings/v1;listingsv1";

// ListingsService provides RPC methods for managing marketplace listings
service ListingsService {
  // === Core Listing Operations ===

  // GetListing retrieves a single listing by ID
  rpc GetListing(GetListingRequest) returns (GetListingResponse);

  // CreateListing creates a new listing
  rpc CreateListing(CreateListingRequest) returns (CreateListingResponse);

  // UpdateListing updates an existing listing
  rpc UpdateListing(UpdateListingRequest) returns (UpdateListingResponse);

  // DeleteListing soft-deletes a listing
  rpc DeleteListing(DeleteListingRequest) returns (DeleteListingResponse);

  // SearchListings performs full-text search on listings
  rpc SearchListings(SearchListingsRequest) returns (SearchListingsResponse);

  // ListListings returns a paginated list of listings
  rpc ListListings(ListListingsRequest) returns (ListListingsResponse);

  // === Image Management (HIGH PRIORITY) ===

  // GetListingImage retrieves a single image by ID
  rpc GetListingImage(ImageIDRequest) returns (ImageResponse);

  // DeleteListingImage removes an image from a listing
  rpc DeleteListingImage(ImageIDRequest) returns (google.protobuf.Empty);

  // AddListingImage adds a new image to a listing
  rpc AddListingImage(AddImageRequest) returns (ImageResponse);

  // GetListingImages retrieves all images for a listing
  rpc GetListingImages(ListingIDRequest) returns (ImagesResponse);

  // === Category Management (HIGH PRIORITY) ===

  // GetRootCategories retrieves all top-level categories (no parent)
  rpc GetRootCategories(google.protobuf.Empty) returns (CategoriesResponse);

  // GetAllCategories retrieves all categories in the system
  rpc GetAllCategories(google.protobuf.Empty) returns (CategoriesResponse);

  // GetPopularCategories retrieves most popular categories by listing count
  rpc GetPopularCategories(PopularCategoriesRequest) returns (CategoriesResponse);

  // GetCategory retrieves a single category by ID
  rpc GetCategory(CategoryIDRequest) returns (CategoryResponse);

  // GetCategoryTree retrieves category hierarchy starting from a node
  rpc GetCategoryTree(CategoryIDRequest) returns (CategoryTreeResponse);

  // === Favorites Management (MEDIUM PRIORITY) ===

  // GetFavoritedUsers retrieves list of user IDs who favorited a listing
  rpc GetFavoritedUsers(ListingIDRequest) returns (UserIDsResponse);

  // === Variants Management (MEDIUM PRIORITY) ===

  // CreateVariants creates multiple variants for a listing
  rpc CreateVariants(CreateVariantsRequest) returns (google.protobuf.Empty);

  // GetVariants retrieves all variants for a listing
  rpc GetVariants(ListingIDRequest) returns (VariantsResponse);

  // UpdateVariant updates a specific variant
  rpc UpdateVariant(UpdateVariantRequest) returns (google.protobuf.Empty);

  // DeleteVariant removes a variant from a listing
  rpc DeleteVariant(VariantIDRequest) returns (google.protobuf.Empty);

  // === Reindexing Support (MEDIUM PRIORITY) ===

  // GetListingsForReindex retrieves listings that need reindexing
  rpc GetListingsForReindex(ReindexRequest) returns (ListingsResponse);

  // ResetReindexFlags resets reindex flags for specified listings
  rpc ResetReindexFlags(ResetFlagsRequest) returns (google.protobuf.Empty);

  // SyncDiscounts synchronizes discount information across listings
  rpc SyncDiscounts(google.protobuf.Empty) returns (google.protobuf.Empty);
}

// ============================================================================
// Core Entity Messages
// ============================================================================

// Listing represents a marketplace listing
message Listing {
  int64 id = 1;
  string uuid = 2;
  int64 user_id = 3;
  optional int64 storefront_id = 4;
  string title = 5;
  optional string description = 6;
  double price = 7;
  string currency = 8;
  int64 category_id = 9;
  string status = 10;
  string visibility = 11;
  int32 quantity = 12;
  optional string sku = 13;
  int32 views_count = 14;
  int32 favorites_count = 15;
  string created_at = 16;
  string updated_at = 17;
  optional string published_at = 18;
  optional string deleted_at = 19;
  bool is_deleted = 20;

  // Relations
  repeated ListingImage images = 21;
  repeated ListingAttribute attributes = 22;
  repeated string tags = 23;
  optional ListingLocation location = 24;
  repeated ListingVariant variants = 25;
}

// ListingImage represents an image associated with a listing
message ListingImage {
  int64 id = 1;
  int64 listing_id = 2;
  string url = 3;
  optional string storage_path = 4;
  optional string thumbnail_url = 5;
  int32 display_order = 6;
  bool is_primary = 7;
  optional int32 width = 8;
  optional int32 height = 9;
  optional int64 file_size = 10;
  optional string mime_type = 11;
  string created_at = 12;
  string updated_at = 13;
}

// ListingAttribute represents flexible key-value attributes
message ListingAttribute {
  int64 id = 1;
  int64 listing_id = 2;
  string attribute_key = 3;
  string attribute_value = 4;
  string created_at = 5;
}

// ListingLocation represents geographic location
message ListingLocation {
  int64 id = 1;
  int64 listing_id = 2;
  optional string country = 3;
  optional string city = 4;
  optional string postal_code = 5;
  optional string address_line1 = 6;
  optional string address_line2 = 7;
  optional double latitude = 8;
  optional double longitude = 9;
  string created_at = 10;
  string updated_at = 11;
}

// ListingVariant represents a product variant
message ListingVariant {
  int64 id = 1;
  int64 listing_id = 2;
  string sku = 3;
  optional double price = 4;
  optional int32 stock = 5;
  map<string, string> attributes = 6;
  optional string image_url = 7;
  bool is_active = 8;
  optional string created_at = 9;
  optional string updated_at = 10;
}

// Category represents a marketplace category
message Category {
  int64 id = 1;
  string name = 2;
  string slug = 3;
  optional int64 parent_id = 4;
  optional string icon = 5;
  optional string description = 6;
  bool is_active = 7;
  int32 listing_count = 8;
  int32 sort_order = 9;
  int32 level = 10;
  map<string, string> translations = 11;
  bool has_custom_ui = 12;
  optional string custom_ui_component = 13;
  string created_at = 14;
}

// CategoryTreeNode represents a category with its children
message CategoryTreeNode {
  int64 id = 1;
  string name = 2;
  string slug = 3;
  optional string icon = 4;
  optional int64 parent_id = 5;
  int32 level = 6;
  string path = 7;
  int32 listing_count = 8;
  int32 children_count = 9;
  repeated CategoryTreeNode children = 10;
  map<string, string> translations = 11;
  bool has_custom_ui = 12;
  optional string custom_ui_component = 13;
  string created_at = 14;
}

// ============================================================================
// Request/Response Messages - Core Listing Operations
// ============================================================================

// GetListing messages
message GetListingRequest {
  int64 id = 1;
}

message GetListingResponse {
  Listing listing = 1;
}

// CreateListing messages
message CreateListingRequest {
  int64 user_id = 1;
  optional int64 storefront_id = 2;
  string title = 3;
  optional string description = 4;
  double price = 5;
  string currency = 6;
  int64 category_id = 7;
  int32 quantity = 8;
  optional string sku = 9;
}

message CreateListingResponse {
  Listing listing = 1;
}

// UpdateListing messages
message UpdateListingRequest {
  int64 id = 1;
  int64 user_id = 2; // Required for ownership check
  optional string title = 3;
  optional string description = 4;
  optional double price = 5;
  optional int32 quantity = 6;
  optional string status = 7;
}

message UpdateListingResponse {
  Listing listing = 1;
}

// DeleteListing messages
message DeleteListingRequest {
  int64 id = 1;
  int64 user_id = 2; // Required for ownership check
}

message DeleteListingResponse {
  bool success = 1;
}

// SearchListings messages
message SearchListingsRequest {
  string query = 1;
  optional int64 category_id = 2;
  optional double min_price = 3;
  optional double max_price = 4;
  int32 limit = 5;
  int32 offset = 6;
}

message SearchListingsResponse {
  repeated Listing listings = 1;
  int32 total = 2;
}

// ListListings messages
message ListListingsRequest {
  optional int64 user_id = 1;
  optional int64 storefront_id = 2;
  optional int64 category_id = 3;
  optional string status = 4;
  optional double min_price = 5;
  optional double max_price = 6;
  int32 limit = 7;
  int32 offset = 8;
}

message ListListingsResponse {
  repeated Listing listings = 1;
  int32 total = 2;
}

// ============================================================================
// Request/Response Messages - Image Management
// ============================================================================

// ImageIDRequest requests an image by ID
message ImageIDRequest {
  int64 image_id = 1;
}

// ImageResponse returns a single image
message ImageResponse {
  ListingImage image = 1;
}

// AddImageRequest adds a new image to a listing
message AddImageRequest {
  int64 listing_id = 1;
  string url = 2;
  optional string storage_path = 3;
  optional string thumbnail_url = 4;
  int32 display_order = 5;
  bool is_primary = 6;
  optional int32 width = 7;
  optional int32 height = 8;
  optional int64 file_size = 9;
  optional string mime_type = 10;
}

// ListingIDRequest requests data by listing ID
message ListingIDRequest {
  int64 listing_id = 1;
}

// ImagesResponse returns multiple images
message ImagesResponse {
  repeated ListingImage images = 1;
}

// ============================================================================
// Request/Response Messages - Category Management
// ============================================================================

// PopularCategoriesRequest requests popular categories
message PopularCategoriesRequest {
  int32 limit = 1; // Maximum number of categories to return
}

// CategoriesResponse returns multiple categories
message CategoriesResponse {
  repeated Category categories = 1;
}

// CategoryIDRequest requests a category by ID
message CategoryIDRequest {
  int64 category_id = 1;
}

// CategoryResponse returns a single category
message CategoryResponse {
  Category category = 1;
}

// CategoryTreeResponse returns category tree
message CategoryTreeResponse {
  CategoryTreeNode tree = 1;
}

// ============================================================================
// Request/Response Messages - Favorites Management
// ============================================================================

// UserIDsResponse returns list of user IDs
message UserIDsResponse {
  repeated int64 user_ids = 1;
}

// ============================================================================
// Request/Response Messages - Variants Management
// ============================================================================

// CreateVariantsRequest creates multiple variants
message CreateVariantsRequest {
  int64 listing_id = 1;
  repeated VariantInput variants = 2;
}

// VariantInput represents input data for creating a variant
message VariantInput {
  string sku = 1;
  optional double price = 2;
  optional int32 stock = 3;
  map<string, string> attributes = 4;
  optional string image_url = 5;
  bool is_active = 6;
}

// VariantsResponse returns multiple variants
message VariantsResponse {
  repeated ListingVariant variants = 1;
}

// UpdateVariantRequest updates a variant
message UpdateVariantRequest {
  int64 variant_id = 1;
  optional string sku = 2;
  optional double price = 3;
  optional int32 stock = 4;
  optional string image_url = 5;
  optional bool is_active = 6;
  map<string, string> attributes = 7;
}

// VariantIDRequest requests a variant by ID
message VariantIDRequest {
  int64 variant_id = 1;
}

// ============================================================================
// Request/Response Messages - Reindexing Support
// ============================================================================

// ReindexRequest requests listings for reindexing
message ReindexRequest {
  int32 batch_size = 1;
  optional int64 last_id = 2; // For cursor-based pagination
}

// ListingsResponse returns multiple listings
message ListingsResponse {
  repeated Listing listings = 1;
  int32 total = 2;
  optional int64 next_cursor = 3; // Next cursor for pagination
}

// ResetFlagsRequest resets reindex flags
message ResetFlagsRequest {
  repeated int64 listing_ids = 1;
}
