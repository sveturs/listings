syntax = "proto3";

package listingssvc.v1;

import "google/protobuf/empty.proto";
import "google/protobuf/struct.proto";
import "google/protobuf/timestamp.proto";

option go_package = "github.com/vondi-global/listings/api/proto/listings/v1;listingssvcv1";

// ============================================================================
// ENUMS - Order Management
// ============================================================================

// OrderStatus represents the current state of an order
// Flow: pending → confirmed → accepted → processing → shipped → delivered
enum OrderStatus {
  ORDER_STATUS_UNSPECIFIED = 0;
  ORDER_STATUS_PENDING = 1;       // Order created, awaiting payment
  ORDER_STATUS_CONFIRMED = 2;     // Payment successful, ready for seller
  ORDER_STATUS_ACCEPTED = 9;      // Seller accepted the order (NEW)
  ORDER_STATUS_PROCESSING = 3;    // Order being prepared (shipment created)
  ORDER_STATUS_SHIPPED = 4;       // Order shipped to customer
  ORDER_STATUS_DELIVERED = 5;     // Order delivered successfully
  ORDER_STATUS_CANCELLED = 6;     // Order cancelled (by user or admin)
  ORDER_STATUS_REFUNDED = 7;      // Payment refunded
  ORDER_STATUS_FAILED = 8;        // Order processing failed
}

// PaymentStatus represents the current state of payment
enum PaymentStatus {
  PAYMENT_STATUS_UNSPECIFIED = 0;
  PAYMENT_STATUS_PENDING = 1;      // Payment initiated, awaiting confirmation
  PAYMENT_STATUS_PROCESSING = 2;   // Payment being processed
  PAYMENT_STATUS_COMPLETED = 3;    // Payment successful
  PAYMENT_STATUS_FAILED = 4;       // Payment failed
  PAYMENT_STATUS_REFUNDED = 5;     // Payment refunded to customer
  PAYMENT_STATUS_COD_PENDING = 6;  // Cash on Delivery - payment will be collected at delivery
}

// ReservationStatus represents the state of inventory reservation
enum ReservationStatus {
  RESERVATION_STATUS_UNSPECIFIED = 0;
  RESERVATION_STATUS_ACTIVE = 1;     // Reservation active, stock held
  RESERVATION_STATUS_COMMITTED = 2;  // Reservation committed (order confirmed)
  RESERVATION_STATUS_RELEASED = 3;   // Reservation released, stock restored
  RESERVATION_STATUS_EXPIRED = 4;    // Reservation expired (TTL exceeded)
}

// ============================================================================
// CORE ENTITIES - Shopping Cart
// ============================================================================

// Cart represents a shopping cart (anonymous or authenticated)
message Cart {
  int64 id = 1;
  optional int64 user_id = 2;        // NULL for anonymous carts
  optional string session_id = 3;    // NULL for authenticated carts
  int64 storefront_id = 4;           // Required - cart belongs to one storefront
  google.protobuf.Timestamp created_at = 5;
  google.protobuf.Timestamp updated_at = 6;

  // Relations (loaded on demand)
  repeated CartItem items = 7;       // Cart items
}

// CartItem represents a single item in shopping cart
message CartItem {
  int64 id = 1;
  int64 cart_id = 2;
  int64 listing_id = 3;              // FK to listings (for C2C) or products (for B2C)
  optional int64 variant_id = 4;     // FK to listing_variants or product_variants
  int32 quantity = 5;                // Quantity to purchase
  double price_snapshot = 6;         // Price at add-to-cart time (for comparison)
  google.protobuf.Timestamp created_at = 7;
  google.protobuf.Timestamp updated_at = 8;

  // Embedded data (for frontend display)
  optional string listing_name = 9;  // Listing/product name
  optional string listing_image = 10; // Primary image URL
  optional google.protobuf.Struct variant_data = 11; // Variant attributes (color, size, etc.)
  optional int32 available_stock = 12; // Current stock availability
  optional double current_price = 13;  // Current price (may differ from price_snapshot)
}

// ============================================================================
// CORE ENTITIES - Order Management
// ============================================================================

// Order represents a customer order
message Order {
  // Identification
  int64 id = 1;
  string order_number = 2;           // Unique order number (e.g., ORD-2025-001234)
  optional int64 user_id = 3;        // NULL for guest orders
  int64 storefront_id = 4;           // Storefront that fulfills the order

  // Order status
  OrderStatus status = 5;            // Order lifecycle status

  // Financial data
  OrderFinancials financials = 6;    // All money-related fields

  // Payment information
  optional string payment_method = 7;       // cash, card, bank_transfer, paypal, etc.
  PaymentStatus payment_status = 8;         // Payment processing status
  optional string payment_transaction_id = 9; // External payment ID
  optional google.protobuf.Timestamp payment_completed_at = 10;

  // Shipping information
  google.protobuf.Struct shipping_address = 11; // JSONB: {street, city, postal_code, country, ...}
  google.protobuf.Struct billing_address = 12;  // JSONB: {street, city, postal_code, country, ...}
  optional string shipping_method = 13;         // standard, express, overnight
  optional string shipping_provider = 14;       // Post Express, AKS, DHL, etc.
  optional string tracking_number = 15;         // Shipment tracking number
  optional int64 shipment_id = 16;              // FK to Delivery Service shipment

  // Escrow (platform holds funds)
  optional google.protobuf.Timestamp escrow_release_date = 17; // When funds released to seller
  int32 escrow_days = 18;                       // Days to hold in escrow (default: 3)

  // Customer contact
  optional string customer_name = 19;
  optional string customer_email = 20;
  optional string customer_phone = 21;

  // Notes
  optional string customer_notes = 22;          // Customer instructions
  optional string admin_notes = 23;             // Internal admin notes
  optional string seller_notes = 32;            // Seller notes about the order

  // Timestamps
  google.protobuf.Timestamp created_at = 24;
  google.protobuf.Timestamp updated_at = 25;
  optional google.protobuf.Timestamp confirmed_at = 26;
  optional google.protobuf.Timestamp accepted_at = 33;   // When seller accepted (NEW)
  optional google.protobuf.Timestamp shipped_at = 27;
  optional google.protobuf.Timestamp delivered_at = 28;
  optional google.protobuf.Timestamp cancelled_at = 29;

  // Shipping label
  optional string label_url = 34;               // URL to shipping label PDF (NEW)

  // Relations (loaded on demand)
  repeated OrderItem items = 30;                // Order line items

  // Storefront info (for display)
  optional string storefront_name = 31;         // Storefront/seller name for frontend display
}

// OrderFinancials contains all money-related fields
message OrderFinancials {
  double subtotal = 1;               // Sum of all items (before tax/shipping)
  double tax = 2;                    // Tax amount
  double shipping_cost = 3;          // Shipping cost
  double discount = 4;               // Discount amount (coupons, promotions)
  double total = 5;                  // Final amount to pay
  double commission = 6;             // Platform commission (for accounting)
  double seller_amount = 7;          // Amount seller receives (total - commission)
  string currency = 8;               // ISO 4217 code (USD, EUR, RSD)
}

// OrderItem represents a single line item in an order
message OrderItem {
  int64 id = 1;
  int64 order_id = 2;
  int64 listing_id = 3;              // FK to listings or products
  optional int64 variant_id = 4;     // FK to listing_variants or product_variants

  // Snapshot data (immutable after order creation)
  string listing_name = 5;           // Product name at purchase time
  optional string sku = 6;           // SKU at purchase time
  google.protobuf.Struct variant_data = 7; // Variant attributes snapshot (color, size, etc.)
  google.protobuf.Struct attributes = 8;   // Product attributes snapshot

  // Quantity and pricing
  int32 quantity = 9;                // Quantity ordered
  double unit_price = 10;            // Price per item
  double subtotal = 11;              // quantity * unit_price
  double discount = 12;              // Item-level discount
  double total = 13;                 // subtotal - discount

  // Product snapshot
  optional string image_url = 14;    // Primary image at purchase time

  google.protobuf.Timestamp created_at = 15;
}

// ============================================================================
// CORE ENTITIES - Inventory Reservations
// ============================================================================

// InventoryReservation represents a temporary stock hold
message InventoryReservation {
  int64 id = 1;
  int64 listing_id = 2;              // FK to listing or product
  optional int64 variant_id = 3;     // FK to variant (if applicable)
  int64 order_id = 4;                // FK to order
  int32 quantity = 5;                // Quantity reserved
  ReservationStatus status = 6;      // Reservation state
  google.protobuf.Timestamp expires_at = 7;  // TTL for reservation (default: NOW() + 30 minutes)
  google.protobuf.Timestamp created_at = 8;
  google.protobuf.Timestamp updated_at = 9;
  optional google.protobuf.Timestamp committed_at = 10; // When reservation committed
  optional google.protobuf.Timestamp released_at = 11;  // When reservation released
}

// ============================================================================
// REQUEST/RESPONSE - Cart Operations
// ============================================================================

// AddToCartRequest adds an item to cart
// Validation: listing must exist, storefront_id must match listing's storefront
message AddToCartRequest {
  optional int64 user_id = 1;        // NULL for anonymous carts
  optional string session_id = 2;    // Required for anonymous carts
  int64 storefront_id = 3;           // Required - ensures cart-storefront consistency
  int64 listing_id = 4;              // Required - product or listing ID
  optional int64 variant_id = 5;     // Optional - variant ID
  int32 quantity = 6;                // Required - quantity to add
}

message AddToCartResponse {
  Cart cart = 1;                     // Updated cart with all items
  string message = 2;                // Success message or warning
}

// UpdateCartItemRequest updates quantity or variant
message UpdateCartItemRequest {
  int64 cart_item_id = 1;            // Cart item to update
  optional int64 user_id = 2;        // For ownership validation
  optional string session_id = 3;    // For anonymous cart validation
  optional int32 quantity = 4;       // New quantity (if updating quantity)
  optional int64 variant_id = 5;     // New variant (if changing variant)
}

message UpdateCartItemResponse {
  CartItem item = 1;                 // Updated cart item
  string message = 2;
}

// RemoveFromCartRequest removes an item from cart
message RemoveFromCartRequest {
  int64 cart_item_id = 1;
  optional int64 user_id = 2;
  optional string session_id = 3;
}

message RemoveFromCartResponse {
  bool success = 1;
  string message = 2;
}

// GetCartRequest retrieves user's cart for a storefront
message GetCartRequest {
  optional int64 user_id = 1;        // NULL for anonymous
  optional string session_id = 2;    // Required for anonymous
  int64 storefront_id = 3;           // Cart is per-storefront
}

message GetCartResponse {
  Cart cart = 1;
  CartSummary summary = 2;           // Calculated summary (subtotal, total items, etc.)
}

// CartSummary provides calculated cart statistics
message CartSummary {
  int32 total_items = 1;             // Sum of quantities
  double subtotal = 2;               // Sum of (quantity * current_price)
  double estimated_tax = 3;          // Estimated tax
  double estimated_shipping = 4;     // Estimated shipping cost
  double estimated_total = 5;        // subtotal + tax + shipping
  repeated string warnings = 6;      // Warnings (price changes, out of stock, etc.)
}

// ClearCartRequest removes all items from cart
message ClearCartRequest {
  optional int64 user_id = 1;
  optional string session_id = 2;
  int64 storefront_id = 3;
}

// GetUserCartsRequest retrieves all carts for a user (across storefronts)
message GetUserCartsRequest {
  int64 user_id = 1;                 // Required - authenticated user
}

message GetUserCartsResponse {
  repeated Cart carts = 1;           // All user's carts
  int32 total_carts = 2;
}

// ============================================================================
// REQUEST/RESPONSE - Order Operations
// ============================================================================

// OrderItemInput represents a single item for direct checkout (without cart)
message OrderItemInput {
  int64 product_id = 1;              // Required - product/listing ID
  optional int64 variant_id = 2;     // Optional - variant ID
  int32 quantity = 3;                // Required - quantity to order
}

// CreateOrderRequest creates a new order from cart OR direct items
// Validation:
// - Either cart_id > 0 OR len(items) > 0 (at least one required)
// - All listings must exist and be available
// - Prices must match (or accept price changes)
// - Stock must be available for all items
// - Addresses must be valid
message CreateOrderRequest {
  optional int64 user_id = 1;        // NULL for guest orders
  optional string session_id = 2;    // For anonymous carts
  int64 storefront_id = 3;           // Required

  // Cart-based checkout (existing flow)
  optional int64 cart_id = 4;        // Cart to convert to order

  // Shipping information
  google.protobuf.Struct shipping_address = 5; // Required
  google.protobuf.Struct billing_address = 6;  // Optional (defaults to shipping)
  string shipping_method = 7;        // Required

  // Payment information
  string payment_method = 8;         // Required

  // Customer contact (required for guest orders)
  optional string customer_name = 9;
  optional string customer_email = 10;
  optional string customer_phone = 11;

  // Optional notes
  optional string customer_notes = 12;

  // Price validation
  bool accept_price_changes = 13;    // If false, reject if prices changed

  // Direct checkout (new flow) - field number 15+ to avoid conflicts
  repeated OrderItemInput items = 15; // Alternative to cart_id for direct checkout
}

message CreateOrderResponse {
  Order order = 1;
  string message = 2;                // Success message
  repeated string warnings = 3;      // Warnings (price changes, etc.)
}

// GetOrderRequest retrieves a single order
message GetOrderRequest {
  int64 order_id = 1;                // Required
  optional int64 user_id = 2;        // For ownership validation (NULL = admin)
}

message GetOrderResponse {
  Order order = 1;
}

// ListOrdersRequest retrieves orders with filters
message ListOrdersRequest {
  optional int64 user_id = 1;        // Filter by user (NULL = all users, admin only)
  optional int64 storefront_id = 2;  // Filter by storefront
  optional OrderStatus status = 3;   // Filter by status
  optional PaymentStatus payment_status = 4; // Filter by payment status
  optional google.protobuf.Timestamp date_from = 5;
  optional google.protobuf.Timestamp date_to = 6;
  optional string search = 7;        // Search by order_number, customer_name, email
  string sort_by = 8;                // created_at, total, status (default: created_at)
  string sort_order = 9;             // asc, desc (default: desc)
  int32 page = 10;                   // Page number (1-based)
  int32 page_size = 11;              // Items per page (default: 20, max: 100)
}

message ListOrdersResponse {
  repeated Order orders = 1;
  int32 total_count = 2;
  int32 page = 3;
  int32 page_size = 4;
  OrderStatsSummary stats = 5;      // Optional summary statistics
}

// OrderStatsSummary provides aggregated statistics
message OrderStatsSummary {
  int32 total_orders = 1;
  int32 pending_orders = 2;
  int32 confirmed_orders = 3;
  int32 shipped_orders = 4;
  int32 delivered_orders = 5;
  int32 cancelled_orders = 6;
  double total_revenue = 7;
  double pending_revenue = 8;
}

// CancelOrderRequest cancels an order
// Validation: Order must be in pending or confirmed status
message CancelOrderRequest {
  int64 order_id = 1;
  optional int64 user_id = 2;        // For ownership validation (NULL = admin)
  optional string reason = 3;        // Cancellation reason
  bool refund = 4;                   // If true, trigger refund (default: true)
}

message CancelOrderResponse {
  Order order = 1;                   // Updated order
  string message = 2;
  bool refund_initiated = 3;         // True if refund was triggered
}

// UpdateOrderStatusRequest updates order status (admin only)
// Validation: Must follow state machine transitions
// - pending → confirmed (after payment)
// - confirmed → processing
// - processing → shipped
// - shipped → delivered
// - pending/confirmed → cancelled
message UpdateOrderStatusRequest {
  int64 order_id = 1;
  OrderStatus new_status = 2;
  optional string tracking_number = 3; // Required when status = shipped
  optional string admin_notes = 4;     // Optional admin notes
}

message UpdateOrderStatusResponse {
  Order order = 1;
  string message = 2;
  repeated string warnings = 3;      // Warnings about state transitions
}

// GetOrderStatsRequest retrieves order statistics (admin)
message GetOrderStatsRequest {
  optional int64 storefront_id = 1;  // Filter by storefront (NULL = all)
  optional google.protobuf.Timestamp date_from = 2;
  optional google.protobuf.Timestamp date_to = 3;
}

message GetOrderStatsResponse {
  OrderStatsSummary stats = 1;
  repeated OrderStatusCount status_breakdown = 2;
  repeated DailyOrderStats daily_stats = 3;
}

// OrderStatusCount represents count per status
message OrderStatusCount {
  OrderStatus status = 1;
  int32 count = 2;
  double total_amount = 3;
}

// DailyOrderStats represents daily aggregated statistics
message DailyOrderStats {
  string date = 1;                   // YYYY-MM-DD
  int32 order_count = 2;
  double total_revenue = 3;
  double avg_order_value = 4;
}

// ============================================================================
// SHIPMENT WORKFLOW MESSAGES (NEW)
// ============================================================================

// AcceptOrderRequest - seller accepts the order
message AcceptOrderRequest {
  int64 order_id = 1;
  int64 seller_id = 2;               // User ID of seller (for authorization)
  optional string seller_notes = 3;  // Optional notes from seller
}

message AcceptOrderResponse {
  Order order = 1;
  string message = 2;
}

// CreateOrderShipmentRequest - create shipment with delivery provider
message CreateOrderShipmentRequest {
  int64 order_id = 1;
  int64 seller_id = 2;                    // User ID of seller
  string provider_code = 3;               // post_express, bex_express, aks, d_express, city_express
  PackageInfo package_info = 4;           // Package dimensions and weight
  bool use_cod = 5;                       // Cash on delivery
  double cod_amount = 6;                  // COD amount (if use_cod = true)
  bool use_insurance = 7;                 // Insurance for package
  double insurance_value = 8;             // Declared value for insurance
}

// PackageInfo contains package dimensions and weight
message PackageInfo {
  double weight_kg = 1;                   // Weight in kg
  double length_cm = 2;                   // Length in cm
  double width_cm = 3;                    // Width in cm
  double height_cm = 4;                   // Height in cm
  bool is_fragile = 5;                    // Fragile goods flag
  string description = 6;                 // Package contents description
}

message CreateOrderShipmentResponse {
  Order order = 1;                        // Updated order with tracking info
  ShipmentInfo shipment = 2;              // Shipment details from delivery service
  string label_url = 3;                   // URL to shipping label PDF
  string message = 4;
}

// ShipmentInfo contains shipment details
message ShipmentInfo {
  int64 shipment_id = 1;                  // ID from delivery service
  string tracking_number = 2;             // Tracking number
  string provider = 3;                    // Provider name
  string status = 4;                      // Current shipment status
  double delivery_cost = 5;               // Delivery cost
  optional string estimated_delivery = 6; // Estimated delivery date (RFC3339)
}

// MarkOrderShippedRequest - mark order as shipped
message MarkOrderShippedRequest {
  int64 order_id = 1;
  int64 seller_id = 2;                    // User ID of seller
  optional string seller_notes = 3;       // Optional notes
}

message MarkOrderShippedResponse {
  Order order = 1;
  string message = 2;
}

// GetOrderTrackingRequest - get tracking info
message GetOrderTrackingRequest {
  int64 order_id = 1;
  int64 user_id = 2;                      // Can be seller or buyer
}

message GetOrderTrackingResponse {
  string tracking_number = 1;
  string provider = 2;
  string status = 3;
  optional string estimated_delivery = 4; // RFC3339
  repeated TrackingEvent events = 5;      // Timeline of events
}

// TrackingEvent represents a single tracking event
message TrackingEvent {
  string status = 1;                      // pending, picked_up, in_transit, delivered, etc.
  string location = 2;                    // Location description
  string description = 3;                 // Event description
  google.protobuf.Timestamp timestamp = 4; // Event time
}

// ============================================================================
// SERVICE DEFINITION - OrderService
// ============================================================================

// OrderService provides RPC methods for managing shopping carts and orders
service OrderService {
  // =========================================
  // Cart Operations (6 methods)
  // =========================================

  // AddToCart adds an item to shopping cart
  // Creates cart if doesn't exist
  // Validates: listing exists, storefront matches, stock available
  rpc AddToCart(AddToCartRequest) returns (AddToCartResponse);

  // UpdateCartItem updates quantity or variant for a cart item
  // Validates: ownership, stock availability
  rpc UpdateCartItem(UpdateCartItemRequest) returns (UpdateCartItemResponse);

  // RemoveFromCart removes an item from cart
  // Validates: ownership
  rpc RemoveFromCart(RemoveFromCartRequest) returns (RemoveFromCartResponse);

  // GetCart retrieves user's cart for a storefront
  // Returns: cart with items, prices, stock availability
  rpc GetCart(GetCartRequest) returns (GetCartResponse);

  // ClearCart removes all items from cart
  // Used after order creation or manual clear
  rpc ClearCart(ClearCartRequest) returns (google.protobuf.Empty);

  // GetUserCarts retrieves all carts for authenticated user
  // Returns: carts across all storefronts
  rpc GetUserCarts(GetUserCartsRequest) returns (GetUserCartsResponse);

  // =========================================
  // Order Operations (6 methods)
  // =========================================

  // CreateOrder creates a new order from cart
  // Transaction:
  // 1. Validate cart items (prices, stock)
  // 2. BEGIN TRANSACTION
  // 3. Lock listings (SELECT FOR UPDATE ORDER BY id ASC - prevent deadlocks)
  // 4. Create order + order_items (snapshot data)
  // 5. Reserve inventory (TTL 30 min)
  // 6. Deduct stock
  // 7. Clear cart
  // 8. COMMIT TRANSACTION
  // 9. Publish OrderCreatedEvent → Payment Service
  rpc CreateOrder(CreateOrderRequest) returns (CreateOrderResponse);

  // GetOrder retrieves a single order by ID
  // Validates: ownership (user can only see own orders)
  rpc GetOrder(GetOrderRequest) returns (GetOrderResponse);

  // ListOrders retrieves orders with filters and pagination
  // Admin: can see all orders
  // User: can only see own orders
  rpc ListOrders(ListOrdersRequest) returns (ListOrdersResponse);

  // CancelOrder cancels an order and releases inventory
  // Validates: order status (only pending/confirmed allowed)
  // Actions:
  // 1. Update order.status = cancelled
  // 2. Release reservations
  // 3. Restore stock
  // 4. Publish OrderCancelledEvent → Payment Service (for refund)
  rpc CancelOrder(CancelOrderRequest) returns (CancelOrderResponse);

  // UpdateOrderStatus updates order status (admin only)
  // Validates: status transition rules (state machine)
  // On status = shipped: requires tracking_number
  // On status = delivered: sets escrow_release_date
  rpc UpdateOrderStatus(UpdateOrderStatusRequest) returns (UpdateOrderStatusResponse);

  // GetOrderStats retrieves order statistics (admin)
  // Returns: aggregated stats, status breakdown, daily trends
  rpc GetOrderStats(GetOrderStatsRequest) returns (GetOrderStatsResponse);

  // =========================================
  // Seller Shipment Operations (4 methods) - NEW
  // =========================================

  // AcceptOrder - seller accepts the order for processing
  // Validates: order.status == confirmed, caller is storefront owner
  // Actions: status → accepted, set accepted_at, notify buyer
  rpc AcceptOrder(AcceptOrderRequest) returns (AcceptOrderResponse);

  // CreateOrderShipment - create shipment via Delivery Service
  // Validates: order.status == accepted, caller is storefront owner
  // Actions: call Delivery.CreateShipment, status → processing, set tracking_number, label_url
  rpc CreateOrderShipment(CreateOrderShipmentRequest) returns (CreateOrderShipmentResponse);

  // MarkOrderShipped - seller marks order as shipped
  // Validates: order.status == processing, tracking_number exists
  // Actions: status → shipped, set shipped_at, notify buyer
  rpc MarkOrderShipped(MarkOrderShippedRequest) returns (MarkOrderShippedResponse);

  // GetOrderTracking - get tracking info from Delivery Service
  // Returns: tracking events timeline from delivery provider
  rpc GetOrderTracking(GetOrderTrackingRequest) returns (GetOrderTrackingResponse);
}

// ============================================================================
// VALIDATION RULES (as comments for implementation)
// ============================================================================

// Cart Validation:
// - AddToCart:
//   - listing must exist and be active
//   - storefront_id must match listing.storefront_id
//   - stock must be available (quantity <= listing.stock)
//   - price_snapshot set to current listing price
// - UpdateCartItem:
//   - quantity must be > 0
//   - stock must be available
//   - user must own cart (user_id or session_id match)
// - RemoveFromCart:
//   - cart item must exist
//   - user must own cart

// Order Creation Validation:
// - All cart items must be valid:
//   - Listings exist and are active
//   - Stock available for all items
//   - Prices match (or accept_price_changes = true)
// - Addresses must be valid JSONB
// - Payment method must be supported by storefront
// - Shipping method must be supported by storefront
// - For guest orders: customer_email required

// Order Status Transitions (State Machine):
// - pending → confirmed (after payment success)
// - pending → cancelled (user cancels before payment)
// - confirmed → processing (storefront accepts order)
// - confirmed → cancelled (storefront rejects, or user cancels)
// - processing → shipped (order dispatched)
// - shipped → delivered (order received)
// - delivered → refunded (customer returns)
// Invalid transitions will be rejected with error

// Inventory Reservation Rules:
// - TTL: 30 minutes for pending orders
// - Status transitions:
//   - active → committed (order confirmed, payment successful)
//   - active → released (order cancelled)
//   - active → expired (TTL exceeded, cron job cleanup)
// - Stock deduction happens at order creation
// - Stock restoration happens at cancellation or expiration
// - Reservations prevent overselling (concurrent orders check reservations)

// Lock Order for Deadlock Prevention:
// - Always lock listings in same order: ORDER BY id ASC
// - PostgreSQL row-level locks: SELECT FOR UPDATE
// - Lock all listings in cart before any modifications
// - Example: Cart has [listing_5, listing_3, listing_8]
//   → Lock order: listing_3, listing_5, listing_8 (sorted by ID)

// ============================================================================
// NOTES
// ============================================================================

// Integration Points:
// - Payment Service: Publishes OrderCreatedEvent, OrderCancelledEvent
// - Delivery Service: Publishes OrderConfirmedEvent (after payment)
// - Auth Service: Validates user_id for authenticated orders
// - Listings Service: Validates listings, manages stock

// Escrow Flow:
// 1. Order created → status=pending
// 2. Payment successful → status=confirmed, escrow_release_date=NOW()+escrow_days
// 3. Order delivered → status=delivered
// 4. Escrow timer expires → funds released to seller (handled by Payment Service)
// 5. If cancelled before delivery → refund to buyer

// Anonymous Cart → Authenticated Cart Merge:
// - On login, merge session cart to user cart
// - If user already has cart for storefront → merge items
// - Delete anonymous cart after merge

// Multi-Storefront Support:
// - User can have multiple carts (one per storefront)
// - Order belongs to single storefront
// - Cannot mix items from different storefronts in one order
