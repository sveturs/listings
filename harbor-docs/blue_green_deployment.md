# Blue-Green Deployment на Sve Tu Platform

## Что такое Blue-Green Deployment?

Blue-Green Deployment - это методика обновления приложений с нулевым временем простоя, при которой поддерживаются два идентичных рабочих окружения:
- **Blue** - текущая версия приложения в production
- **Green** - новая версия приложения для тестирования и подготовки

Преимущества данной методики:
- Нулевое время простоя при обновлении
- Возможность быстрого отката при проблемах
- Проверка работоспособности перед переключением трафика
- Минимизация рисков при деплое

## Архитектура Blue-Green Deployment на Sve Tu Platform

Наша реализация использует:
1. Docker контейнеры с суффиксами `-blue` и `-green` для бэкенда
2. Проксирование через NGINX
3. Промежуточный прокси-контейнер `backend`, который всегда указывает на активный контейнер
4. Автоматическую проверку работоспособности нового деплоя перед переключением

### Схема работы

```
                      +---------------+
                      |               |
                      |    NGINX      |
                      |               |
                      +-------+-------+
                              |
                              v
                      +---------------+
                      |               |
                      |  Proxy (backend)|
                      |               |
                      +-------+-------+
                              |
                +-------------+--------------+
                |                            |
        +-------v-------+          +--------v------+
        |               |          |               |
        | backend-blue  |  или     | backend-green |
        |               |          |               |
        +---------------+          +---------------+
```

## Использование скрипта

### Синтаксис

```bash
./scripts/blue_green_deploy_on_svetu.rs.sh [backend|frontend|all] [-m] [harbor-password]
```

### Параметры:

1. **Первый аргумент** (обязательный): 
   - `backend` - обновление только бэкенда
   - `frontend` - обновление только фронтенда
   - `all` - обновление и бэкенда, и фронтенда

2. **Флаг `-m`** (опциональный): 
   - Запускает миграции базы данных после успешного деплоя бэкенда

3. **Harbor password** (опциональный):
   - Пароль для авторизации в Harbor
   - Если не указан, будет использован пароль по умолчанию или переменная окружения `HARBOR_PASSWORD`

### Примеры использования:

```bash
# Обновление только бэкенда
./scripts/blue_green_deploy_on_svetu.rs.sh backend

# Обновление бэкенда и применение миграций
./scripts/blue_green_deploy_on_svetu.rs.sh backend -m

# Обновление только фронтенда
./scripts/blue_green_deploy_on_svetu.rs.sh frontend

# Обновление всего приложения с миграциями
./scripts/blue_green_deploy_on_svetu.rs.sh all -m

# Обновление с использованием безопасной передачи пароля
HARBOR_PASSWORD="мой_секретный_пароль" ./scripts/blue_green_deploy_on_svetu.rs.sh backend
```

## Логирование и диагностика

Скрипт создает подробные логи выполнения:
- Основной лог: `/var/log/blue_green_deploy_TIMESTAMP.log`
- Серверный лог: `/var/log/blue_green_server_TIMESTAMP.log`
- Фронтенд лог: `/var/log/blue_green_frontend_TIMESTAMP.log`
- Лог ошибок: `/var/log/blue_green_errors.log`

Эти логи можно использовать для диагностики проблем:
```bash
# Просмотр последнего лога деплоя
ls -ltr /var/log/blue_green_deploy_* | tail -1 | awk '{print $9}' | xargs cat

# Просмотр ошибок
cat /var/log/blue_green_errors.log
```

## Процесс Blue-Green деплоя бэкенда

1. Определение текущего активного контейнера (blue или green)
2. Сборка нового Docker-образа и загрузка в Harbor
3. Создание нового контейнера (blue или green) с новой версией
4. Тщательная проверка работоспособности нового контейнера:
   - Тесты подключения к БД, MinIO, OpenSearch
   - Проверки API-эндпоинтов (health, категории)
   - Мониторинг логов
5. Создание/обновление прокси-контейнера `backend`, указывающего на новую версию
6. Тестирование прохождения запросов через NGINX -> Proxy -> New Container
7. Если все тесты успешны, останавливается старый контейнер, и трафик продолжает идти через новый
8. Если требуется, применяются миграции БД

## Процесс Blue-Green деплоя фронтенда

1. Сборка фронтенд-приложения и создание Docker-образа
2. Загрузка образа в Harbor
3. Создание резервной копии текущей версии
4. Извлечение файлов новой сборки
5. Настройка конфигурации для production (env.js)
6. Обновление файлов на сервере
7. Перезагрузка NGINX для применения изменений
8. Проверка доступности фронтенда

## Решение проблем

### Часто встречающиеся проблемы:

1. **Не работает доступ к админке после деплоя**
   - Проверьте правильность настройки прокси-контейнера
   - Убедитесь, что NGINX корректно обращается к контейнеру `backend`
   - Проверьте подключение обоих контейнеров к одной Docker сети

2. **Ошибка "Bind for 0.0.0.0:3000 failed: port is already allocated"**
   - Прокси-контейнер не должен привязываться к порту хоста
   - Убедитесь, что в команде запуска нет `-p 3000:3000`

3. **Проблемы с DNS-разрешением между контейнерами**
   - Проверьте принадлежность контейнеров к одной сети Docker
   - Попробуйте переподключить контейнеры к сети: `docker network disconnect [сеть] [контейнер]` и затем `docker network connect [сеть] [контейнер]`

4. **Не проходят миграции**
   - Проверьте доступность репозитория GitHub
   - Убедитесь в корректности токена GitHub
   - Проверьте наличие актуальных миграций в репозитории

## Безопасность

- Не храните пароли в скрипте
- Используйте переменную окружения HARBOR_PASSWORD
- Периодически меняйте пароли и токены
- Обеспечьте безопасность логов (уровень прав доступа)