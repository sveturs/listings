# Структура категорий и атрибутов маркетплейса 

## Обзор системы категорий и атрибутов

Система категорий и атрибутов в маркетплейсе реализует гибкую иерархическую структуру для классификации товаров с динамическими атрибутами для каждой категории.

## Файлы, отвечающие за категории и атрибуты

### Модели данных:

1. **`/backend/internal/domain/models/models.go`**
   - Содержит основные структуры для категорий:
     - `MarketplaceCategory` - базовая модель категории
     - `CategoryTreeNode` - структура для хранения дерева категорий

2. **`/backend/internal/domain/models/category_attributes.go`**
   - Содержит структуры для атрибутов категорий:
     - `CategoryAttribute` - основная модель атрибута категории
     - `AttributeOptions` - параметры атрибута (варианты для выбора, мин/макс значения)
     - `ListingAttributeValue` - значение атрибута для объявления
     - `CategoryAttributeMapping` - связь между категорией и атрибутом

3. **`/backend/internal/domain/models/category_suggestion.go`**
   - Содержит структуру для поисковых подсказок категорий:
     - `CategorySuggestion` - модель для автодополнения категорий

### Сервисные интерфейсы:

4. **`/backend/internal/proj/marketplace/service/interface.go`**
   - Определяет интерфейс для работы с категориями и атрибутами:
     - `GetCategories()` - получение всех категорий
     - `GetCategoryTree()` - получение иерархического дерева категорий
     - `GetCategoryAttributes()` - получение атрибутов для категории
     - `SaveListingAttributes()` - сохранение значений атрибутов для объявления
     - `GetAttributeRanges()` - получение диапазонов числовых атрибутов

### Реализация сервисов:

5. **`/backend/internal/proj/marketplace/service/marketplace.go`**
   - Реализует методы для работы с категориями и атрибутами:
     - `GetCategories()` - получение списка категорий из БД
     - `GetCategoryTree()` - получение иерархии категорий
     - `GetCategoryAttributes()` - получение атрибутов для категории с обработкой JSON полей

### HTTP обработчики:

6. **`/backend/internal/proj/marketplace/handler/marketplace.go`**
   - Содержит обработчики HTTP-запросов для работы с категориями:
     - `GetCategoryAttributes()` - API для получения атрибутов категории
     - `GetCategoryTree()` - API для получения дерева категорий с кешированием
     - `GetAttributeRanges()` - API для получения диапазонов значений атрибутов

### Работа с базой данных:

7. **`/backend/internal/storage/postgres/db.go`**
   - Содержит методы для доступа к данным в PostgreSQL:
     - `GetCategories()` - получение категорий из БД
     - `GetCategoryByID()` - получение категории по ID
     - `GetCategoryTree()` - построение дерева категорий
     - `GetCategoryAttributes()` - получение атрибутов категории
     - `SaveListingAttributes()` - сохранение значений атрибутов
     - `GetAttributeRanges()` - получение диапазонов значений

### Данные категорий:

8. **`/backend/categories.yaml`**
   - YAML-файл с иерархической структурой категорий для инициализации

## Ключевые особенности

1. **Многоязычность**: Категории и атрибуты поддерживают переводы на разные языки через поле `translations`.

2. **Иерархическая структура**: Категории образуют древовидную структуру с родительскими и дочерними элементами.

3. **Типизированные атрибуты**: Система поддерживает различные типы атрибутов:
   - Текстовые (`text`)
   - Числовые (`number`) с единицами измерения
   - Логические (`boolean`)
   - Выбор из списка (`select`) с поддержкой множественного выбора

4. **Кеширование**: Дерево категорий кешируется на уровне обработчика для повышения производительности.

5. **Обработка метаданных**: Есть поддержка хранения дополнительной информации в полях `metadata`.

## Примеры использования атрибутов

В системе реализована поддержка категорийно-специфичных атрибутов. Например:

- **Недвижимость**: площадь (м²), количество комнат, этаж
- **Автомобили**: год выпуска, объем двигателя (л), пробег (км)
- **Электроника**: диагональ экрана (дюймы), объем памяти

Каждый атрибут может иметь единицы измерения, которые учитываются при отображении:
```go
switch attr.AttributeName {
case "area":
    attr.Unit = "m²"
    attr.DisplayValue = fmt.Sprintf("%g м²", numValue)
case "land_area":
    attr.Unit = "ar"
    attr.DisplayValue = fmt.Sprintf("%g сот", numValue)
case "mileage":
    attr.Unit = "km"
    attr.DisplayValue = fmt.Sprintf("%g км", numValue)
}
```

## API эндпоинты для работы с категориями

- `GET /api/v1/marketplace/categories` - получение всех категорий
- `GET /api/v1/marketplace/category-tree` - получение иерархического дерева категорий
- `GET /api/v1/marketplace/categories/:id/attributes` - получение атрибутов для категории
- `GET /api/v1/marketplace/categories/:id/attribute-ranges` - получение диапазонов значений атрибутов