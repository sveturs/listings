# Следующие шаги по интеграции с Harbor

После организации файлов и документации, рекомендуется выполнить следующие шаги для завершения интеграции Sve Tu Platform с Harbor.

## 1. Проверка доступности Harbor

```bash
# Проверка ping до сервера Harbor
ping 207.180.197.172

# Проверка доступности web-интерфейса Harbor
curl -I http://207.180.197.172
```

## 2. Настройка доверенных сертификатов на всех серверах

Для корректной работы с Harbor на всех серверах, которые будут взаимодействовать с реестром, необходимо настроить доверие к самоподписанным сертификатам:

```bash
# На каждом сервере
sudo mkdir -p /etc/docker/certs.d/207.180.197.172
sudo scp dima@207.180.197.172:/opt/harbor/certs/server.crt /etc/docker/certs.d/207.180.197.172/ca.crt
sudo systemctl restart docker
```

## 3. Тестирование авторизации в Harbor

```bash
# Авторизация в Harbor
docker login -u admin -p SveTu2025 207.180.197.172
```

## 4. Завершение миграции образов

Проверьте, что все необходимые образы были перенесены в Harbor:

```bash
# Список проектов и образов в Harbor (требуется аутентификация)
curl -u admin:SveTu2025 -X GET http://207.180.197.172/api/v2.0/projects/svetu/repositories
```

При необходимости, выполните миграцию оставшихся образов:

```bash
# Запуск скрипта миграции образов
./harbor-scripts/fixed_migrate_images.sh
```

## 5. Обновление docker-compose файлов

Если docker-compose файлы ещё не были обновлены:

```bash
# Обновление docker-compose.yml и docker-compose.prod.yml
./harbor-scripts/update_docker_compose.sh
```

## 6. Обновление скрипта деплоя

```bash
# Обновление deploy.sh для работы с Harbor
./harbor-scripts/update_deploy_script.sh
```

## 7. Тестирование развертывания с Harbor

```bash
# Тестирование деплоя с использованием образов из Harbor
./deploy.sh
```

## 8. Настройка CI/CD для работы с Harbor

Для автоматизации сборки и отправки образов в Harbor, настройте CI/CD:

1. Добавьте секреты для авторизации в Harbor в CI/CD
2. Обновите workflow-файлы для сборки и отправки образов в Harbor
3. Настройте автоматическое тегирование образов по версиям/коммитам

## 9. Повышение безопасности

```bash
# Изменение пароля администратора Harbor
curl -X PUT -H "Content-Type: application/json" -u admin:SveTu2025 -d '{"old_password":"SveTu2025","new_password":"НовыйСложныйПароль!"}' http://207.180.197.172/api/v2.0/users/1/password
```

## 10. Мониторинг и обслуживание

- Настройте регулярное резервное копирование данных Harbor
- Настройте мониторинг доступности Harbor
- Реализуйте политики очистки старых образов

## Дополнительные улучшения

1. **Настройка HTTPS с Let's Encrypt**:
   - Зарегистрируйте домен для Harbor
   - Используйте Let's Encrypt для получения бесплатных сертификатов

2. **Интеграция с системой аутентификации**:
   - Настройте LDAP/AD для централизованной аутентификации

3. **Репликация реестра**:
   - Настройте репликацию для обеспечения высокой доступности

4. **Миграция на Kubernetes**:
   - Рассмотрите возможность миграции на Kubernetes с использованием Harbor в качестве реестра образов