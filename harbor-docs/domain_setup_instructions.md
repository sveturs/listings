# Инструкции по настройке домена для Harbor

## Преимущества использования домена вместо IP-адреса

1. **Улучшенная безопасность** - возможность использования реальных сертификатов Let's Encrypt вместо самоподписанных
2. **Простота использования** - домен легче запомнить, чем IP-адрес
3. **Гибкость инфраструктуры** - возможность изменить IP-адрес сервера без изменения конфигурации клиентов
4. **Профессиональный вид** - более профессиональный вид в URL и документации

## Шаги по настройке домена harbor.svetu.rs

### 1. Проверка доступности домена

```bash
# Проверьте, что домен корректно настроен и указывает на сервер Harbor
ping harbor.svetu.rs
```

Если ping успешно достигает сервера Harbor (207.180.197.172), значит DNS-запись настроена правильно.

### 2. Обновление конфигурации Harbor

На сервере Harbor выполните следующие шаги:

```bash
# Скопируйте скрипт обновления домена на сервер Harbor
scp /data/hostel-booking-system/harbor-scripts/update_harbor_domain.sh dima@harbor.svetu.rs:/tmp/

# Подключитесь к серверу Harbor
ssh dima@harbor.svetu.rs

# Запустите скрипт обновления домена
chmod +x /tmp/update_harbor_domain.sh
sudo /tmp/update_harbor_domain.sh
```

Скрипт выполнит следующие действия:
- Обновит hostname в harbor.yml
- Установит certbot для получения сертификатов Let's Encrypt
- Получит и настроит SSL-сертификаты для домена
- Перезапустит Harbor с новой конфигурацией
- Настроит автоматическое обновление сертификатов

### 3. Обновление ссылок в проекте

После обновления домена Harbor, необходимо обновить все ссылки в проекте:

```bash
# В корне проекта выполните скрипт обновления ссылок
cd /data/hostel-booking-system
./harbor-scripts/update_harbor_references.sh
```

Скрипт обновит все упоминания IP-адреса Harbor (207.180.197.172) на новый домен (harbor.svetu.rs) в:
- docker-compose файлах
- скриптах деплоя
- документации

### 4. Проверка доступности Harbor по новому домену

```bash
# Проверьте доступность Harbor по HTTPS с новым доменом
curl -I https://harbor.svetu.rs
```

Вы должны увидеть ответ `HTTP/2 200`, что подтверждает корректную работу Harbor по новому домену с HTTPS.

### 5. Обновление настроек в Docker

На всех серверах, которые будут работать с Harbor, обновите настройки доверия сертификатов:

```bash
# На каждом сервере
sudo mkdir -p /etc/docker/certs.d/harbor.svetu.rs
sudo systemctl restart docker

# Проверьте авторизацию в Harbor с новым доменом
docker login harbor.svetu.rs
```

Теперь поскольку Harbor использует доверенные сертификаты Let's Encrypt, не нужно копировать сертификаты на клиентские серверы.

### 6. Тестирование работы с новым доменом

```bash
# Проверьте загрузку образа из Harbor с новым доменом
docker pull harbor.svetu.rs/svetu/backend/api:latest

# Проверьте отправку образа в Harbor с новым доменом
docker tag nginx:latest harbor.svetu.rs/svetu/nginx:test
docker push harbor.svetu.rs/svetu/nginx:test
```

## Последующие действия

После успешного обновления домена Harbor, рекомендуется:

1. **Обновить CI/CD конфигурацию** - если у вас настроены CI/CD пайплайны, обновите в них ссылки на Harbor
2. **Обновить документацию** - убедитесь, что вся документация ссылается на новый домен
3. **Проверить развертывание** - выполните тестовое развертывание с использованием нового домена Harbor
4. **Обновить пароль администратора** - измените пароль администратора Harbor для повышения безопасности

## Решение возможных проблем

### Проблема с сертификатами Let's Encrypt

Если возникли проблемы с получением сертификатов Let's Encrypt:

```bash
# Проверьте, что порт 80 и 443 доступны для certbot
sudo lsof -i :80
sudo lsof -i :443

# Если порты заняты, временно остановите сервисы
sudo docker-compose -f /opt/harbor/docker-compose.yml down

# Запустите certbot в режиме отладки
sudo certbot certonly --standalone -d harbor.svetu.rs --dry-run
```

### Проблемы с доступом к Harbor

Если после обновления домена возникли проблемы с доступом к Harbor:

```bash
# Проверьте статус Harbor
cd /opt/harbor
sudo docker-compose ps

# Просмотрите логи nginx
sudo docker-compose logs nginx

# Перезапустите Harbor
sudo docker-compose down
sudo docker-compose up -d
```