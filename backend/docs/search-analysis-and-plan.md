# Анализ текущей системы поиска и план интеграции товаров витрин

## Текущая реализация поиска

### Backend архитектура

#### 1. Поисковые endpoints
- **GET** `/api/v1/marketplace/search` - основной поиск объявлений
- **GET** `/api/v1/marketplace/suggestions` - автодополнение
- **GET** `/api/v1/marketplace/category-suggestions` - предложения категорий
- **GET** `/api/v1/marketplace/enhanced-suggestions` - расширенные предложения

#### 2. Структура поиска
```
SearchHandler → MarketplaceService → OpenSearch Repository → OpenSearch
                                    ↘ PostgreSQL (fallback)
```

#### 3. Индексация в OpenSearch
- **Индекс**: `marketplace_listings` (настроен в конфигурации)
- **Поля**: title, description, price, category_id, location, attributes и др.
- **Анализаторы**: Russian analyzer для текстовых полей
- **Nested fields**: attributes для фасетного поиска

### Frontend архитектура

#### 1. Существующие компоненты
- `MarketplaceService.search()` - API клиент для поиска
- `MarketplaceList` - отображение результатов
- `MarketplaceFilters` - фильтрация по категориям

#### 2. Отсутствующие компоненты
- ❌ SearchBar в хедере
- ❌ Страница расширенного поиска
- ❌ URL-based поиск (query params)

### Текущие проблемы

1. **Товары витрин НЕ индексируются в OpenSearch**
   - Поиск работает только для marketplace_listings
   - Нет интеграции с storefront_products

2. **Отсутствует единый поисковый интерфейс**
   - Пользователи не могут искать товары по всей платформе
   - Товары витрин невидимы для поиска

3. **Frontend ограничения**
   - Нет поисковой строки на главной странице
   - Нет страницы с результатами поиска

## План интеграции товаров витрин в поиск

### Этап 1: Подготовка индексов (Backend)

#### 1.1 Создание унифицированного индекса
```json
{
  "unified_products": {
    "mappings": {
      "properties": {
        "product_id": { "type": "integer" },
        "product_type": { "type": "keyword" }, // "marketplace" или "storefront"
        "title": {
          "type": "text",
          "analyzer": "russian",
          "fields": {
            "keyword": { "type": "keyword" }
          }
        },
        "storefront_id": { "type": "integer" },
        "storefront_name": { "type": "text" },
        // ... остальные поля
      }
    }
  }
}
```

#### 1.2 Модификация сервиса поиска
- Создать UnifiedSearchService
- Объединить поиск по двум типам продуктов
- Добавить фильтр по типу продукта

### Этап 2: Индексация товаров витрин

#### 2.1 Реализованное решение
✅ Создан `ProductRepository` для OpenSearch в storefronts
✅ Добавлена интеграция в `ProductService`
✅ Создан скрипт переиндексации

#### 2.2 Необходимые доработки
- [ ] Интегрировать в общий поисковый endpoint
- [ ] Добавить фильтрацию по витринам
- [ ] Унифицировать формат ответа

### Этап 3: Frontend интеграция

#### 3.1 Создание SearchBar компонента
```typescript
// components/search/SearchBar.tsx
interface SearchBarProps {
  onSearch: (query: string) => void;
  placeholder?: string;
  showSuggestions?: boolean;
}
```

#### 3.2 Страница результатов поиска
```typescript
// app/[locale]/search/page.tsx
- Отображение результатов
- Фильтры (категории, цена, тип продукта)
- Сортировка
- Пагинация
```

#### 3.3 Интеграция в хедер
- Добавить SearchBar в Header.tsx
- Обработка поисковых запросов
- Редирект на страницу результатов

### Этап 4: Оптимизация поиска

#### 4.1 Улучшение релевантности
- Настройка весов полей
- Добавление fuzzy search
- Учет популярности товаров

#### 4.2 Персонализация
- История поиска пользователя
- Рекомендации на основе просмотров
- Геолокационная релевантность

### Этап 5: Мониторинг и аналитика

#### 5.1 Метрики поиска
- CTR (click-through rate)
- Конверсия поиска
- Популярные запросы
- Нулевые результаты

#### 5.2 A/B тестирование
- Различные алгоритмы ранжирования
- UI/UX эксперименты
- Оптимизация производительности

## Приоритеты реализации

### Критически важное (P0)
1. ✅ Индексация товаров витрин в OpenSearch
2. Создание единого поискового API
3. Добавление SearchBar на главную

### Важное (P1)
1. Страница результатов поиска
2. Фильтры и сортировка
3. Автодополнение для всех типов продуктов

### Желательное (P2)
1. Персонализация результатов
2. Расширенная аналитика
3. A/B тестирование

## Технические детали реализации

### API изменения
```go
// Новый endpoint для унифицированного поиска
GET /api/v1/search/products
{
  "query": "string",
  "product_types": ["marketplace", "storefront"],
  "filters": {...},
  "page": 1,
  "size": 20
}
```

### Формат ответа
```json
{
  "data": [
    {
      "id": 123,
      "type": "marketplace",
      "title": "...",
      "price": 100,
      "storefront": null
    },
    {
      "id": 456,
      "type": "storefront",
      "title": "...",
      "price": 200,
      "storefront": {
        "id": 789,
        "name": "Shop Name",
        "slug": "shop-name"
      }
    }
  ],
  "meta": {
    "total": 1000,
    "page": 1,
    "facets": {...}
  }
}
```

## Следующие шаги

1. **Немедленно**: Запустить переиндексацию товаров витрин
2. **Сегодня**: Создать единый поисковый endpoint
3. **Эта неделя**: Добавить SearchBar на frontend
4. **Следующая неделя**: Реализовать страницу результатов

## Заключение

Текущая система поиска работает только с объявлениями маркетплейса. Интеграция товаров витрин критически важна для создания полноценной поисковой системы. Мы уже создали необходимую инфраструктуру для индексации товаров витрин, осталось интегрировать её в общий поиск и создать удобный пользовательский интерфейс.