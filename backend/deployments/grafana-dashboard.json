{
  "dashboard": {
    "title": "Marketplace Migration - Canary Release",
    "tags": ["marketplace", "migration", "canary", "microservice"],
    "timezone": "browser",
    "refresh": "30s",
    "time": {
      "from": "now-1h",
      "to": "now"
    },
    "templating": {
      "list": []
    },
    "annotations": {
      "list": [
        {
          "name": "Rollout Changes",
          "datasource": "Prometheus",
          "expr": "changes(marketplace_rollout_percent[1m]) > 0",
          "iconColor": "blue",
          "tagKeys": "component"
        }
      ]
    },
    "panels": [
      {
        "id": 1,
        "title": "Current Rollout Percentage",
        "type": "stat",
        "gridPos": {"x": 0, "y": 0, "w": 6, "h": 4},
        "targets": [
          {
            "expr": "marketplace_rollout_percent",
            "legendFormat": "Rollout %"
          }
        ],
        "options": {
          "graphMode": "area",
          "colorMode": "value",
          "textMode": "value_and_name"
        },
        "fieldConfig": {
          "defaults": {
            "unit": "percent",
            "thresholds": {
              "mode": "absolute",
              "steps": [
                {"value": 0, "color": "red"},
                {"value": 10, "color": "yellow"},
                {"value": 50, "color": "orange"},
                {"value": 100, "color": "green"}
              ]
            }
          }
        }
      },
      {
        "id": 2,
        "title": "Feature Flag Status",
        "type": "stat",
        "gridPos": {"x": 6, "y": 0, "w": 3, "h": 4},
        "targets": [
          {
            "expr": "marketplace_feature_flag_enabled",
            "legendFormat": "Enabled"
          }
        ],
        "options": {
          "textMode": "value",
          "colorMode": "background"
        },
        "fieldConfig": {
          "defaults": {
            "mappings": [
              {"type": "value", "value": 0, "text": "DISABLED"},
              {"type": "value", "value": 1, "text": "ENABLED"}
            ],
            "thresholds": {
              "steps": [
                {"value": 0, "color": "red"},
                {"value": 1, "color": "green"}
              ]
            }
          }
        }
      },
      {
        "id": 3,
        "title": "Canary Users",
        "type": "stat",
        "gridPos": {"x": 9, "y": 0, "w": 3, "h": 4},
        "targets": [
          {
            "expr": "marketplace_canary_users",
            "legendFormat": "Count"
          }
        ],
        "fieldConfig": {
          "defaults": {
            "unit": "short"
          }
        }
      },
      {
        "id": 4,
        "title": "Routing Distribution (Last Hour)",
        "type": "piechart",
        "gridPos": {"x": 12, "y": 0, "w": 6, "h": 8},
        "targets": [
          {
            "expr": "sum by (destination) (increase(marketplace_route_total[1h]))",
            "legendFormat": "{{destination}}"
          }
        ]
      },
      {
        "id": 5,
        "title": "Request Rate by Destination",
        "type": "graph",
        "gridPos": {"x": 18, "y": 0, "w": 6, "h": 8},
        "targets": [
          {
            "expr": "sum by (destination) (rate(marketplace_route_total[5m]))",
            "legendFormat": "{{destination}}"
          }
        ],
        "yaxes": [
          {"label": "Requests/sec", "format": "reqps"}
        ]
      },
      {
        "id": 6,
        "title": "Error Rate by Destination",
        "type": "graph",
        "gridPos": {"x": 0, "y": 4, "w": 12, "h": 8},
        "targets": [
          {
            "expr": "sum by (destination) (rate(marketplace_microservice_errors_total[5m])) / sum by (destination) (rate(marketplace_route_total[5m])) * 100",
            "legendFormat": "{{destination}} error rate"
          }
        ],
        "yaxes": [
          {"label": "Error Rate (%)", "format": "percent", "max": 5}
        ],
        "alert": {
          "conditions": [
            {
              "evaluator": {"params": [1], "type": "gt"},
              "query": {"params": ["A", "5m", "now"]}
            }
          ],
          "frequency": "1m",
          "name": "High Error Rate Alert"
        },
        "thresholds": [
          {"value": 0.5, "colorMode": "critical", "line": true, "lineColor": "yellow"},
          {"value": 1.0, "colorMode": "critical", "line": true, "lineColor": "red"}
        ]
      },
      {
        "id": 7,
        "title": "Error Breakdown by Type",
        "type": "graph",
        "gridPos": {"x": 12, "y": 8, "w": 12, "h": 8},
        "targets": [
          {
            "expr": "sum by (error_type) (rate(marketplace_microservice_errors_total[5m]))",
            "legendFormat": "{{error_type}}"
          }
        ],
        "yaxes": [
          {"label": "Errors/sec", "format": "ops"}
        ]
      },
      {
        "id": 8,
        "title": "Request Latency Percentiles (P50, P95, P99)",
        "type": "graph",
        "gridPos": {"x": 0, "y": 12, "w": 12, "h": 8},
        "targets": [
          {
            "expr": "histogram_quantile(0.50, sum by (destination, le) (rate(marketplace_route_duration_seconds_bucket[5m])))",
            "legendFormat": "{{destination}} - P50"
          },
          {
            "expr": "histogram_quantile(0.95, sum by (destination, le) (rate(marketplace_route_duration_seconds_bucket[5m])))",
            "legendFormat": "{{destination}} - P95"
          },
          {
            "expr": "histogram_quantile(0.99, sum by (destination, le) (rate(marketplace_route_duration_seconds_bucket[5m])))",
            "legendFormat": "{{destination}} - P99"
          }
        ],
        "yaxes": [
          {"label": "Latency", "format": "s"}
        ],
        "thresholds": [
          {"value": 0.3, "colorMode": "custom", "line": true, "lineColor": "yellow"},
          {"value": 0.5, "colorMode": "custom", "line": true, "lineColor": "red"}
        ]
      },
      {
        "id": 9,
        "title": "Latency by Operation",
        "type": "graph",
        "gridPos": {"x": 12, "y": 12, "w": 12, "h": 8},
        "targets": [
          {
            "expr": "histogram_quantile(0.99, sum by (operation, destination, le) (rate(marketplace_route_duration_seconds_bucket[5m])))",
            "legendFormat": "{{destination}} - {{operation}}"
          }
        ],
        "yaxes": [
          {"label": "P99 Latency", "format": "s"}
        ]
      },
      {
        "id": 10,
        "title": "Fallback Events Rate",
        "type": "graph",
        "gridPos": {"x": 0, "y": 20, "w": 12, "h": 8},
        "targets": [
          {
            "expr": "sum by (reason) (rate(marketplace_fallback_total[5m]))",
            "legendFormat": "{{reason}}"
          }
        ],
        "yaxes": [
          {"label": "Fallbacks/sec", "format": "ops"}
        ],
        "thresholds": [
          {"value": 0.1, "colorMode": "critical", "line": true, "lineColor": "red"}
        ]
      },
      {
        "id": 11,
        "title": "Traffic Distribution by User Type",
        "type": "graph",
        "gridPos": {"x": 12, "y": 20, "w": 12, "h": 8},
        "targets": [
          {
            "expr": "sum by (user_type) (rate(marketplace_route_total[5m]))",
            "legendFormat": "{{user_type}}"
          }
        ],
        "yaxes": [
          {"label": "Requests/sec", "format": "reqps"}
        ],
        "seriesOverrides": [
          {"alias": "canary", "color": "yellow"},
          {"alias": "admin", "color": "blue"},
          {"alias": "regular", "color": "green"}
        ]
      },
      {
        "id": 12,
        "title": "Success Rate Comparison",
        "type": "stat",
        "gridPos": {"x": 0, "y": 28, "w": 12, "h": 4},
        "targets": [
          {
            "expr": "(1 - (sum(rate(marketplace_microservice_errors_total[5m])) / sum(rate(marketplace_route_total{destination=\"microservice\"}[5m])))) * 100",
            "legendFormat": "Microservice Success Rate"
          },
          {
            "expr": "100",
            "legendFormat": "Monolith Success Rate (baseline)"
          }
        ],
        "fieldConfig": {
          "defaults": {
            "unit": "percent",
            "thresholds": {
              "steps": [
                {"value": 95, "color": "red"},
                {"value": 98, "color": "yellow"},
                {"value": 99, "color": "green"}
              ]
            }
          }
        }
      },
      {
        "id": 13,
        "title": "Total Request Volume",
        "type": "stat",
        "gridPos": {"x": 12, "y": 28, "w": 12, "h": 4},
        "targets": [
          {
            "expr": "sum(rate(marketplace_route_total[1m])) * 60",
            "legendFormat": "Requests/minute"
          }
        ],
        "fieldConfig": {
          "defaults": {
            "unit": "rpm"
          }
        }
      }
    ]
  }
}
