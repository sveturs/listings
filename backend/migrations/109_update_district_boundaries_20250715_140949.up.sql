-- SQL скрипт для обновления границ районов из GeoJSON файлов
-- Сгенерировано: 2025-07-15T14:09:49.792768

BEGIN;

-- Создаем резервную копию текущих границ
CREATE TABLE IF NOT EXISTS districts_boundaries_backup_20250715 AS 
SELECT id, name, boundary, updated_at FROM districts;

-- Обновления для города Лесковац

-- Район: Бубањ (источник: Бубањ)
UPDATE districts 
SET boundary = ST_GeomFromGeoJSON('{"type": "Polygon", "coordinates": [[[21.9251, 42.9887], [21.9299, 42.989700000000006], [21.9347, 42.987700000000004], [21.9395, 42.989200000000004], [21.9455, 42.986700000000006], [21.9479, 42.9827], [21.946099999999998, 42.9787], [21.9473, 42.9757], [21.9431, 42.9697], [21.938299999999998, 42.9682], [21.932299999999998, 42.9692], [21.9275, 42.968700000000005], [21.9221, 42.9737], [21.9239, 42.977700000000006], [21.921499999999998, 42.981700000000004], [21.9233, 42.984700000000004], [21.9251, 42.9887]]]}'),
    area_km2 = ST_Area(ST_GeomFromGeoJSON('{"type": "Polygon", "coordinates": [[[21.9251, 42.9887], [21.9299, 42.989700000000006], [21.9347, 42.987700000000004], [21.9395, 42.989200000000004], [21.9455, 42.986700000000006], [21.9479, 42.9827], [21.946099999999998, 42.9787], [21.9473, 42.9757], [21.9431, 42.9697], [21.938299999999998, 42.9682], [21.932299999999998, 42.9692], [21.9275, 42.968700000000005], [21.9221, 42.9737], [21.9239, 42.977700000000006], [21.921499999999998, 42.981700000000004], [21.9233, 42.984700000000004], [21.9251, 42.9887]]]}')::geography) / 1000000,
    updated_at = NOW()
WHERE id = 'b4ba8cfc-d42e-45cb-8a40-d88f3d47b474';


-- Район: Дубочица (источник: Дубочица)
UPDATE districts 
SET boundary = ST_GeomFromGeoJSON('{"type": "Polygon", "coordinates": [[[21.9251, 43.018699999999995], [21.9299, 43.0197], [21.9347, 43.0177], [21.9395, 43.0192], [21.9455, 43.0167], [21.9479, 43.012699999999995], [21.946099999999998, 43.0087], [21.9473, 43.0057], [21.9431, 42.9997], [21.938299999999998, 42.9982], [21.932299999999998, 42.999199999999995], [21.9275, 42.9987], [21.9221, 43.003699999999995], [21.9239, 43.0077], [21.921499999999998, 43.0117], [21.9233, 43.0147], [21.9251, 43.018699999999995]]]}'),
    area_km2 = ST_Area(ST_GeomFromGeoJSON('{"type": "Polygon", "coordinates": [[[21.9251, 43.018699999999995], [21.9299, 43.0197], [21.9347, 43.0177], [21.9395, 43.0192], [21.9455, 43.0167], [21.9479, 43.012699999999995], [21.946099999999998, 43.0087], [21.9473, 43.0057], [21.9431, 42.9997], [21.938299999999998, 42.9982], [21.932299999999998, 42.999199999999995], [21.9275, 42.9987], [21.9221, 43.003699999999995], [21.9239, 43.0077], [21.921499999999998, 43.0117], [21.9233, 43.0147], [21.9251, 43.018699999999995]]]}')::geography) / 1000000,
    updated_at = NOW()
WHERE id = '7cd05e68-8a97-4585-9753-49c555b7cef6';


-- Район: Хисар (источник: Хисар)
UPDATE districts 
SET boundary = ST_GeomFromGeoJSON('{"type": "Polygon", "coordinates": [[[21.9451, 42.9987], [21.9499, 42.999700000000004], [21.9547, 42.9977], [21.9595, 42.9992], [21.9655, 42.996700000000004], [21.9679, 42.9927], [21.966099999999997, 42.9887], [21.967299999999998, 42.9857], [21.9631, 42.9797], [21.958299999999998, 42.9782], [21.952299999999997, 42.9792], [21.947499999999998, 42.9787], [21.9421, 42.9837], [21.9439, 42.987700000000004], [21.941499999999998, 42.9917], [21.9433, 42.9947], [21.9451, 42.9987]]]}'),
    area_km2 = ST_Area(ST_GeomFromGeoJSON('{"type": "Polygon", "coordinates": [[[21.9451, 42.9987], [21.9499, 42.999700000000004], [21.9547, 42.9977], [21.9595, 42.9992], [21.9655, 42.996700000000004], [21.9679, 42.9927], [21.966099999999997, 42.9887], [21.967299999999998, 42.9857], [21.9631, 42.9797], [21.958299999999998, 42.9782], [21.952299999999997, 42.9792], [21.947499999999998, 42.9787], [21.9421, 42.9837], [21.9439, 42.987700000000004], [21.941499999999998, 42.9917], [21.9433, 42.9947], [21.9451, 42.9987]]]}')::geography) / 1000000,
    updated_at = NOW()
WHERE id = '72c6c046-daee-4867-afac-a917b5a0f60c';


-- Район: Центар (источник: Центар)
UPDATE districts 
SET boundary = ST_GeomFromGeoJSON('{"type": "Polygon", "coordinates": [[[21.9383, 43.0047], [21.9415, 43.0053], [21.9447, 43.0041], [21.9479, 43.005], [21.951900000000002, 43.0035], [21.953500000000002, 43.0011], [21.9523, 42.9987], [21.953100000000003, 42.9969], [21.950300000000002, 42.9933], [21.947100000000002, 42.992399999999996], [21.9431, 42.993], [21.9399, 42.9927], [21.9363, 42.9957], [21.9375, 42.9981], [21.9359, 43.0005], [21.9371, 43.0023], [21.9383, 43.0047]]]}'),
    area_km2 = ST_Area(ST_GeomFromGeoJSON('{"type": "Polygon", "coordinates": [[[21.9383, 43.0047], [21.9415, 43.0053], [21.9447, 43.0041], [21.9479, 43.005], [21.951900000000002, 43.0035], [21.953500000000002, 43.0011], [21.9523, 42.9987], [21.953100000000003, 42.9969], [21.950300000000002, 42.9933], [21.947100000000002, 42.992399999999996], [21.9431, 42.993], [21.9399, 42.9927], [21.9363, 42.9957], [21.9375, 42.9981], [21.9359, 43.0005], [21.9371, 43.0023], [21.9383, 43.0047]]]}')::geography) / 1000000,
    updated_at = NOW()
WHERE id = 'b5a0afd3-c687-4853-a7dc-dd79e67dd78a';


-- Обновления для города Београд

-- Район: Стари Град (источник: Стари Град)
UPDATE districts 
SET boundary = ST_GeomFromGeoJSON('{"type": "Polygon", "coordinates": [[[20.45, 44.82], [20.455, 44.825], [20.465, 44.82], [20.47, 44.815], [20.465, 44.81], [20.455, 44.805], [20.45, 44.81], [20.445, 44.815], [20.45, 44.82]]]}'),
    area_km2 = ST_Area(ST_GeomFromGeoJSON('{"type": "Polygon", "coordinates": [[[20.45, 44.82], [20.455, 44.825], [20.465, 44.82], [20.47, 44.815], [20.465, 44.81], [20.455, 44.805], [20.45, 44.81], [20.445, 44.815], [20.45, 44.82]]]}')::geography) / 1000000,
    updated_at = NOW()
WHERE id = '2f2c2f9a-0ecd-4df5-a5a4-ba626288a9d0';


-- Район: Врачар (источник: Врачар)
UPDATE districts 
SET boundary = ST_GeomFromGeoJSON('{"type": "Polygon", "coordinates": [[[20.465, 44.81], [20.47, 44.815], [20.48, 44.81], [20.49, 44.805], [20.49, 44.795], [20.48, 44.79], [20.47, 44.795], [20.465, 44.8], [20.465, 44.81]]]}'),
    area_km2 = ST_Area(ST_GeomFromGeoJSON('{"type": "Polygon", "coordinates": [[[20.465, 44.81], [20.47, 44.815], [20.48, 44.81], [20.49, 44.805], [20.49, 44.795], [20.48, 44.79], [20.47, 44.795], [20.465, 44.8], [20.465, 44.81]]]}')::geography) / 1000000,
    updated_at = NOW()
WHERE id = 'dce8dbfc-ef0d-492e-8d9c-ffb28e4e41c1';


-- Район: Земун (источник: Земун)
UPDATE districts 
SET boundary = ST_GeomFromGeoJSON('{"type": "Polygon", "coordinates": [[[20.32, 44.86], [20.33, 44.865], [20.34, 44.87], [20.35, 44.875], [20.36, 44.88], [20.37, 44.885], [20.38, 44.887], [20.39, 44.888], [20.4, 44.887], [20.408, 44.885], [20.41, 44.88], [20.409, 44.875], [20.407, 44.87], [20.404, 44.865], [20.4, 44.86], [20.395, 44.855], [20.39, 44.852], [20.385, 44.85], [20.38, 44.849], [20.375, 44.85], [20.37, 44.852], [20.365, 44.854], [20.36, 44.856], [20.355, 44.858], [20.35, 44.859], [20.345, 44.8595], [20.34, 44.8598], [20.335, 44.8599], [20.33, 44.86], [20.325, 44.86], [20.32, 44.86]]]}'),
    area_km2 = ST_Area(ST_GeomFromGeoJSON('{"type": "Polygon", "coordinates": [[[20.32, 44.86], [20.33, 44.865], [20.34, 44.87], [20.35, 44.875], [20.36, 44.88], [20.37, 44.885], [20.38, 44.887], [20.39, 44.888], [20.4, 44.887], [20.408, 44.885], [20.41, 44.88], [20.409, 44.875], [20.407, 44.87], [20.404, 44.865], [20.4, 44.86], [20.395, 44.855], [20.39, 44.852], [20.385, 44.85], [20.38, 44.849], [20.375, 44.85], [20.37, 44.852], [20.365, 44.854], [20.36, 44.856], [20.355, 44.858], [20.35, 44.859], [20.345, 44.8595], [20.34, 44.8598], [20.335, 44.8599], [20.33, 44.86], [20.325, 44.86], [20.32, 44.86]]]}')::geography) / 1000000,
    updated_at = NOW()
WHERE id = 'a916dcfd-a916-4c43-83e0-e3a3e2c88853';


-- Всего обновлений: 7

-- Проверка валидности геометрии
SELECT c.name as city, d.name as district, 
       ST_IsValid(d.boundary) as is_valid,
       ST_Area(d.boundary::geography) / 1000000 as area_km2,
       ST_NPoints(d.boundary) as num_points
FROM districts d
JOIN cities c ON d.city_id = c.id
WHERE d.updated_at > NOW() - INTERVAL '1 minute'
ORDER BY c.name, d.name;

-- Исправление невалидных геометрий
UPDATE districts
SET boundary = ST_MakeValid(boundary)
WHERE NOT ST_IsValid(boundary) AND boundary IS NOT NULL;

COMMIT;