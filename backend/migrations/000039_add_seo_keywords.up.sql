-- Миграция для добавления SEO ключевых слов к категориям
-- Автор: System Architect  
-- Дата: 03.09.2025
-- Задача: Генерация SEO ключевых слов для улучшения поиска и индексации

-- Обновляем корневые категории
UPDATE marketplace_categories
SET 
    seo_keywords = CASE
        -- Antiques & Art
        WHEN id = 1017 THEN 'антиквариат, искусство, картины, скульптуры, коллекционирование, раритет, винтаж, аукцион, живопись, графика'
        
        -- Automobili
        WHEN id = 1003 THEN 'автомобили, машины, авто, транспорт, продажа авто, покупка авто, б/у авто, новые авто, запчасти, автосервис'
        
        -- Books & Stationery
        WHEN id = 1012 THEN 'книги, канцелярия, учебники, блокноты, ручки, тетради, литература, бестселлеры, школьные товары, офисные принадлежности'
        
        -- Dom i bašta
        WHEN id = 1005 THEN 'дом, сад, мебель, декор, инструменты, растения, ремонт, интерьер, садовая техника, товары для дома'
        
        -- Education
        WHEN id = 1019 THEN 'образование, курсы, обучение, репетиторы, уроки, тренинги, семинары, дистанционное обучение, языковые курсы, подготовка к экзаменам'
        
        -- Elektronika
        WHEN id = 1001 THEN 'электроника, техника, смартфоны, компьютеры, ноутбуки, телевизоры, гаджеты, аудио, видео, игровые приставки'
        
        -- Events & Tickets
        WHEN id = 1020 THEN 'билеты, концерты, события, мероприятия, фестивали, театр, кино, спорт, выставки, шоу'
        
        -- Health & Beauty
        WHEN id = 1014 THEN 'здоровье, красота, косметика, парфюмерия, уход, макияж, spa, фитнес, медицина, витамины'
        
        -- Hobbies & Entertainment
        WHEN id = 1015 THEN 'хобби, развлечения, игры, коллекции, творчество, рукоделие, моделирование, настольные игры, пазлы, конструкторы'
        
        -- Hrana i piće
        WHEN id = 1008 THEN 'еда, напитки, продукты, домашняя еда, органические продукты, деликатесы, вино, кофе, чай, сладости'
        
        -- Industrija
        WHEN id = 1007 THEN 'промышленность, оборудование, станки, инструменты, материалы, производство, b2b, оптовая торговля, промышленные товары, сырье'
        
        -- Jobs
        WHEN id = 1018 THEN 'работа, вакансии, резюме, трудоустройство, карьера, подработка, фриланс, удаленная работа, стажировка, поиск работы'
        
        -- Kids & Baby
        WHEN id = 1013 THEN 'детские товары, игрушки, одежда для детей, коляски, кроватки, питание, подгузники, развивающие игры, товары для новорожденных, школьные принадлежности'
        
        -- Moda
        WHEN id = 1002 THEN 'мода, одежда, обувь, аксессуары, стиль, бренды, женская одежда, мужская одежда, сумки, украшения'
        
        -- Musical Instruments
        WHEN id = 1016 THEN 'музыкальные инструменты, гитары, пианино, барабаны, синтезаторы, скрипки, духовые инструменты, струны, аксессуары для музыкантов, звуковое оборудование'
        
        -- Nekretnine
        WHEN id = 1004 THEN 'недвижимость, квартиры, дома, аренда, продажа, покупка, земля, коммерческая недвижимость, новостройки, вторичное жилье'
        
        -- Pets
        WHEN id = 1011 THEN 'животные, питомцы, корм, аксессуары, зоотовары, собаки, кошки, птицы, рыбки, ветеринария'
        
        -- Poljoprivreda  
        WHEN id = 1006 THEN 'сельское хозяйство, тракторы, семена, удобрения, сельхозтехника, фермерство, урожай, огород, теплицы, агрономия'
        
        -- Sport i rekreacija
        WHEN id = 1010 THEN 'спорт, фитнес, тренажеры, спортивная одежда, велосипеды, туризм, активный отдых, спортивное питание, экипировка, инвентарь'
        
        -- Usluge
        WHEN id = 1009 THEN 'услуги, ремонт, строительство, транспорт, клининг, сервис, мастера, консультации, аренда, обслуживание'
        
        ELSE seo_keywords
    END
WHERE parent_id IS NULL 
  AND (seo_keywords IS NULL OR seo_keywords = '');

-- Обновляем подкатегории первого уровня на основе родительской категории и собственного названия
UPDATE marketplace_categories mc
SET 
    seo_keywords = COALESCE(
        mc.seo_keywords,
        LOWER(mc.name) || ', ' || 
        LOWER(parent.name) || ', ' ||
        CASE 
            WHEN mc.name LIKE '%telefon%' THEN 'смартфоны, мобильные телефоны, iphone, android, samsung'
            WHEN mc.name LIKE '%računar%' OR mc.name LIKE '%kompjuter%' THEN 'компьютеры, пк, настольные компьютеры, системные блоки'
            WHEN mc.name LIKE '%odeća%' OR mc.name LIKE '%odjeća%' THEN 'одежда, вещи, гардероб, стиль, мода'
            WHEN mc.name LIKE '%obuća%' OR mc.name LIKE '%cipel%' THEN 'обувь, ботинки, туфли, кроссовки, сапоги'
            WHEN mc.name LIKE '%gum%' THEN 'шины, резина, покрышки, колеса'
            WHEN mc.name LIKE '%deo%' OR mc.name LIKE '%dio%' OR mc.name LIKE '%del%' THEN 'запчасти, детали, комплектующие, расходники'
            ELSE ''
        END
    )
FROM marketplace_categories parent
WHERE mc.parent_id = parent.id
  AND mc.parent_id IS NOT NULL
  AND (mc.seo_keywords IS NULL OR mc.seo_keywords = '');

-- Генерируем базовые ключевые слова для оставшихся категорий
UPDATE marketplace_categories
SET 
    seo_keywords = LOWER(
        name || ', ' || 
        REPLACE(REPLACE(REPLACE(name, ' i ', ', '), ' & ', ', '), ' za ', ', ')
    )
WHERE seo_keywords IS NULL OR seo_keywords = '';

-- Добавляем SEO описания для корневых категорий
UPDATE marketplace_categories
SET 
    seo_description = CASE
        WHEN id = 1017 THEN 'Антиквариат и предметы искусства. Картины, скульптуры, винтажные вещи и коллекционные предметы.'
        WHEN id = 1003 THEN 'Автомобили и транспорт. Новые и подержанные авто, запчасти, аксессуары и услуги.'
        WHEN id = 1012 THEN 'Книги и канцелярские товары. Учебники, художественная литература, офисные принадлежности.'
        WHEN id = 1005 THEN 'Товары для дома и сада. Мебель, декор, инструменты, растения и садовая техника.'
        WHEN id = 1019 THEN 'Образовательные услуги. Курсы, репетиторы, тренинги и обучающие материалы.'
        WHEN id = 1001 THEN 'Электроника и технологии. Смартфоны, компьютеры, телевизоры и другая техника.'
        WHEN id = 1020 THEN 'Билеты на мероприятия. Концерты, театры, спорт, фестивали и другие события.'
        WHEN id = 1014 THEN 'Товары для здоровья и красоты. Косметика, парфюмерия, средства ухода и медицинские товары.'
        WHEN id = 1015 THEN 'Хобби и развлечения. Игры, коллекции, товары для творчества и активного отдыха.'
        WHEN id = 1008 THEN 'Продукты питания и напитки. Домашняя еда, деликатесы, органические продукты.'
        WHEN id = 1007 THEN 'Промышленные товары. Оборудование, станки, материалы для производства.'
        WHEN id = 1018 THEN 'Работа и карьера. Вакансии, резюме, фриланс и услуги по трудоустройству.'
        WHEN id = 1013 THEN 'Товары для детей. Игрушки, одежда, коляски и все для малышей.'
        WHEN id = 1002 THEN 'Модная одежда и аксессуары. Женская и мужская одежда, обувь, сумки, украшения.'
        WHEN id = 1016 THEN 'Музыкальные инструменты. Гитары, пианино, барабаны и звуковое оборудование.'
        WHEN id = 1004 THEN 'Недвижимость. Квартиры, дома, земельные участки для продажи и аренды.'
        WHEN id = 1011 THEN 'Товары для животных. Корма, аксессуары, игрушки и ветеринарные услуги.'
        WHEN id = 1006 THEN 'Сельскохозяйственные товары. Техника, семена, удобрения для фермеров и садоводов.'
        WHEN id = 1010 THEN 'Спортивные товары. Тренажеры, экипировка, одежда для спорта и активного отдыха.'
        WHEN id = 1009 THEN 'Услуги. Ремонт, строительство, транспорт, клининг и другие виды сервиса.'
        ELSE seo_description
    END
WHERE parent_id IS NULL
  AND (seo_description IS NULL OR seo_description = '');

-- Выводим статистику
DO $$
DECLARE
    total_with_keywords INTEGER;
    total_with_description INTEGER;
    total_categories INTEGER;
BEGIN
    SELECT COUNT(*) INTO total_categories FROM marketplace_categories;
    SELECT COUNT(*) INTO total_with_keywords 
    FROM marketplace_categories 
    WHERE seo_keywords IS NOT NULL AND seo_keywords != '';
    
    SELECT COUNT(*) INTO total_with_description
    FROM marketplace_categories
    WHERE seo_description IS NOT NULL AND seo_description != '';
    
    RAISE NOTICE 'SEO оптимизация завершена';
    RAISE NOTICE 'Всего категорий: %', total_categories;
    RAISE NOTICE 'Категорий с SEO ключевыми словами: %', total_with_keywords;
    RAISE NOTICE 'Категорий с SEO описанием: %', total_with_description;
END $$;