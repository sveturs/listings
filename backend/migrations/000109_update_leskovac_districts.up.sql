-- Обновление границ районов города Лесковац
-- Сгенерировано: 2025-07-15
-- Источник: Приблизительные границы на основе центральных точек

BEGIN;

-- Создаем резервную копию текущих границ Лесковца
CREATE TABLE IF NOT EXISTS districts_leskovac_backup AS 
SELECT d.*, c.name as city_name 
FROM districts d
JOIN cities c ON d.city_id = c.id
WHERE c.name = 'Лесковац';

-- Район: Бубањ
UPDATE districts 
SET boundary = ST_GeomFromGeoJSON('{"type": "Polygon", "coordinates": [[[21.9251, 42.9887], [21.9299, 42.989700000000006], [21.9347, 42.987700000000004], [21.9395, 42.989200000000004], [21.9455, 42.986700000000006], [21.9479, 42.9827], [21.946099999999998, 42.9787], [21.9473, 42.9757], [21.9431, 42.9697], [21.938299999999998, 42.9682], [21.932299999999998, 42.9692], [21.9275, 42.968700000000005], [21.9221, 42.9737], [21.9239, 42.977700000000006], [21.921499999999998, 42.981700000000004], [21.9233, 42.984700000000004], [21.9251, 42.9887]]]}'),
    area_km2 = ST_Area(ST_GeomFromGeoJSON('{"type": "Polygon", "coordinates": [[[21.9251, 42.9887], [21.9299, 42.989700000000006], [21.9347, 42.987700000000004], [21.9395, 42.989200000000004], [21.9455, 42.986700000000006], [21.9479, 42.9827], [21.946099999999998, 42.9787], [21.9473, 42.9757], [21.9431, 42.9697], [21.938299999999998, 42.9682], [21.932299999999998, 42.9692], [21.9275, 42.968700000000005], [21.9221, 42.9737], [21.9239, 42.977700000000006], [21.921499999999998, 42.981700000000004], [21.9233, 42.984700000000004], [21.9251, 42.9887]]]}')::geography) / 1000000,
    updated_at = NOW()
WHERE id = 'b4ba8cfc-d42e-45cb-8a40-d88f3d47b474';

-- Район: Дубочица
UPDATE districts 
SET boundary = ST_GeomFromGeoJSON('{"type": "Polygon", "coordinates": [[[21.9251, 43.018699999999995], [21.9299, 43.0197], [21.9347, 43.0177], [21.9395, 43.0192], [21.9455, 43.0167], [21.9479, 43.012699999999995], [21.946099999999998, 43.0087], [21.9473, 43.0057], [21.9431, 42.9997], [21.938299999999998, 42.9982], [21.932299999999998, 42.999199999999995], [21.9275, 42.9987], [21.9221, 43.003699999999995], [21.9239, 43.0077], [21.921499999999998, 43.0117], [21.9233, 43.0147], [21.9251, 43.018699999999995]]]}'),
    area_km2 = ST_Area(ST_GeomFromGeoJSON('{"type": "Polygon", "coordinates": [[[21.9251, 43.018699999999995], [21.9299, 43.0197], [21.9347, 43.0177], [21.9395, 43.0192], [21.9455, 43.0167], [21.9479, 43.012699999999995], [21.946099999999998, 43.0087], [21.9473, 43.0057], [21.9431, 42.9997], [21.938299999999998, 42.9982], [21.932299999999998, 42.999199999999995], [21.9275, 42.9987], [21.9221, 43.003699999999995], [21.9239, 43.0077], [21.921499999999998, 43.0117], [21.9233, 43.0147], [21.9251, 43.018699999999995]]]}')::geography) / 1000000,
    updated_at = NOW()
WHERE id = '7cd05e68-8a97-4585-9753-49c555b7cef6';

-- Район: Хисар
UPDATE districts 
SET boundary = ST_GeomFromGeoJSON('{"type": "Polygon", "coordinates": [[[21.9451, 42.9987], [21.9499, 42.999700000000004], [21.9547, 42.9977], [21.9595, 42.9992], [21.9655, 42.996700000000004], [21.9679, 42.9927], [21.966099999999997, 42.9887], [21.967299999999998, 42.9857], [21.9631, 42.9797], [21.958299999999998, 42.9782], [21.952299999999997, 42.9792], [21.947499999999998, 42.9787], [21.9421, 42.9837], [21.9439, 42.987700000000004], [21.941499999999998, 42.9917], [21.9433, 42.9947], [21.9451, 42.9987]]]}'),
    area_km2 = ST_Area(ST_GeomFromGeoJSON('{"type": "Polygon", "coordinates": [[[21.9451, 42.9987], [21.9499, 42.999700000000004], [21.9547, 42.9977], [21.9595, 42.9992], [21.9655, 42.996700000000004], [21.9679, 42.9927], [21.966099999999997, 42.9887], [21.967299999999998, 42.9857], [21.9631, 42.9797], [21.958299999999998, 42.9782], [21.952299999999997, 42.9792], [21.947499999999998, 42.9787], [21.9421, 42.9837], [21.9439, 42.987700000000004], [21.941499999999998, 42.9917], [21.9433, 42.9947], [21.9451, 42.9987]]]}')::geography) / 1000000,
    updated_at = NOW()
WHERE id = '72c6c046-daee-4867-afac-a917b5a0f60c';

-- Район: Центар
UPDATE districts 
SET boundary = ST_GeomFromGeoJSON('{"type": "Polygon", "coordinates": [[[21.9383, 43.004700000000004], [21.9415, 43.005279999999995], [21.9447, 43.0043], [21.9479, 43.0051], [21.9519, 43.003500000000005], [21.9535, 43.0007], [21.952699999999998, 42.9987], [21.953499999999998, 42.996700000000005], [21.951099999999998, 42.9927], [21.947899999999998, 42.9919], [21.944299999999998, 42.992300000000005], [21.9411, 42.9917], [21.937299999999998, 42.9947], [21.9383, 42.997700000000004], [21.936299999999998, 43.0007], [21.9375, 43.002700000000005], [21.9383, 43.004700000000004]]]}'),
    area_km2 = ST_Area(ST_GeomFromGeoJSON('{"type": "Polygon", "coordinates": [[[21.9383, 43.004700000000004], [21.9415, 43.005279999999995], [21.9447, 43.0043], [21.9479, 43.0051], [21.9519, 43.003500000000005], [21.9535, 43.0007], [21.952699999999998, 42.9987], [21.953499999999998, 42.996700000000005], [21.951099999999998, 42.9927], [21.947899999999998, 42.9919], [21.944299999999998, 42.992300000000005], [21.9411, 42.9917], [21.937299999999998, 42.9947], [21.9383, 42.997700000000004], [21.936299999999998, 43.0007], [21.9375, 43.002700000000005], [21.9383, 43.004700000000004]]]}')::geography) / 1000000,
    updated_at = NOW()
WHERE id = 'b5a0afd3-c687-4853-a7dc-dd79e67dd78a';

-- Обновляем центральные точки на основе новых границ
UPDATE districts 
SET center_point = ST_Centroid(boundary)
WHERE city_id IN (SELECT id FROM cities WHERE name = 'Лесковац')
  AND boundary IS NOT NULL;

-- Проверка результатов
SELECT 
    d.name as district,
    ST_IsValid(d.boundary) as is_valid,
    d.area_km2,
    ST_NPoints(d.boundary) as num_points,
    ST_Contains(d.boundary, d.center_point) as contains_center
FROM districts d
JOIN cities c ON d.city_id = c.id
WHERE c.name = 'Лесковац'
ORDER BY d.name;

-- Проверка общей площади города
SELECT 
    'Лесковац' as city,
    COUNT(*) as districts_count,
    SUM(d.area_km2) as total_area_km2,
    AVG(d.area_km2) as avg_district_area_km2
FROM districts d
JOIN cities c ON d.city_id = c.id
WHERE c.name = 'Лесковац';

COMMIT;