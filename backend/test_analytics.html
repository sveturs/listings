<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Тест аналитики поиска</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .metric-card {
            background: #f5f5f5;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }
        .metric-value {
            font-size: 2em;
            font-weight: bold;
            color: #333;
        }
        .metric-label {
            color: #666;
            margin-top: 10px;
        }
        .queries-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        .queries-table th, .queries-table td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        .queries-table th {
            background: #f8f9fa;
            font-weight: bold;
        }
        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
        .error {
            color: #d32f2f;
            padding: 20px;
            background: #ffebee;
            border-radius: 8px;
            margin: 20px 0;
        }
        .time-filters {
            margin-bottom: 20px;
        }
        .time-filters button {
            margin-right: 10px;
            padding: 8px 16px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .time-filters button.active {
            background: #0056b3;
        }
        .export-button {
            background: #28a745;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <h1>Аналитика поиска</h1>
    
    <div class="time-filters">
        <button onclick="loadAnalytics('week')" class="active" id="btn-week">7 дней</button>
        <button onclick="loadAnalytics('month')" id="btn-month">30 дней</button>
        <button onclick="loadAnalytics('quarter')" id="btn-quarter">90 дней</button>
    </div>

    <div id="content">
        <div class="loading">Загрузка данных...</div>
    </div>

    <script>
        let currentPeriod = 'week';
        let currentData = null;

        function loadAnalytics(period) {
            currentPeriod = period;
            
            // Обновляем активную кнопку
            document.querySelectorAll('.time-filters button').forEach(btn => {
                btn.classList.remove('active');
            });
            document.getElementById('btn-' + period).classList.add('active');

            const contentDiv = document.getElementById('content');
            contentDiv.innerHTML = '<div class="loading">Загрузка данных...</div>';

            fetch(`http://localhost:3000/api/v1/analytics/metrics/search?period=${period}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        currentData = data.data;
                        displayAnalytics(data.data);
                    } else {
                        throw new Error('Ошибка API: ' + (data.error || 'Неизвестная ошибка'));
                    }
                })
                .catch(error => {
                    console.error('Ошибка загрузки данных:', error);
                    contentDiv.innerHTML = `<div class="error">Ошибка загрузки данных: ${error.message}</div>`;
                });
        }

        function displayAnalytics(data) {
            const contentDiv = document.getElementById('content');
            
            const metricsHtml = `
                <div class="metrics-grid">
                    <div class="metric-card">
                        <div class="metric-value">${data.total_searches}</div>
                        <div class="metric-label">Всего поисков</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value">${data.unique_searches}</div>
                        <div class="metric-label">Уникальных запросов</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value">${data.average_search_duration_ms.toFixed(0)}ms</div>
                        <div class="metric-label">Среднее время поиска</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value">${(data.click_metrics.ctr * 100).toFixed(1)}%</div>
                        <div class="metric-label">CTR</div>
                    </div>
                </div>
            `;

            const trendsHtml = `
                <h3>Тренды поиска</h3>
                <table class="queries-table">
                    <thead>
                        <tr>
                            <th>Дата</th>
                            <th>Поисков</th>
                            <th>Кликов</th>
                            <th>CTR</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${data.search_trends.map(trend => `
                            <tr>
                                <td>${trend.date}</td>
                                <td>${trend.searches_count}</td>
                                <td>${trend.clicks_count}</td>
                                <td>${(trend.ctr * 100).toFixed(1)}%</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;

            const queriesHtml = `
                <h3>Топ поисковых запросов</h3>
                <table class="queries-table">
                    <thead>
                        <tr>
                            <th>Запрос</th>
                            <th>Количество</th>
                            <th>CTR</th>
                            <th>Среднее количество результатов</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${data.top_queries.slice(0, 20).map(query => `
                            <tr>
                                <td>${query.query || '<пустой запрос>'}</td>
                                <td>${query.count}</td>
                                <td>${(query.ctr * 100).toFixed(1)}%</td>
                                <td>${query.avg_results}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;

            contentDiv.innerHTML = metricsHtml + trendsHtml + queriesHtml + 
                '<button class="export-button" onclick="exportToCsv()">Экспорт в CSV</button>';
        }

        function exportToCsv() {
            if (!currentData) return;

            const csvContent = [
                'Запрос,Количество,CTR,Среднее количество результатов',
                ...currentData.top_queries.map(q => 
                    `"${q.query || 'пустой запрос'}",${q.count},${q.ctr},${q.avg_results}`
                )
            ].join('\n');

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `search_analytics_${currentPeriod}_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
        }

        // Загружаем данные при загрузке страницы
        document.addEventListener('DOMContentLoaded', function() {
            loadAnalytics('week');
        });
    </script>
</body>
</html>