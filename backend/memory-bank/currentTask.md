# Анализ интеграции чатов с MinIO для хранения файлов

## Структура хранения файлов

### MinIO Buckets
- **chat-files** - основной bucket для файлов чатов
  - `/document/` - документы (PDF, DOC, TXT)
  - `/image/` - изображения (JPG, PNG, WEBP)
  - `/video/` - видео файлы
  - Структура: `/{type}/{year}/{month}/{day}/{messageId}_{timestamp}_{filename}`

### Nginx проксирование
- Путь `/chat-files/` проксируется напрямую на MinIO (строки 62-72 в nginx.conf)
- Публичный доступ к файлам через HTTPS
- Кеширование на 7 дней

## Архитектура загрузки файлов

### 1. HTTP Endpoint
- `POST /api/v1/marketplace/messages/{id}/attachments`
- Multipart form upload
- Максимум 10 файлов за раз
- Проверка прав доступа (только отправитель сообщения)

### 2. Валидация файлов
**Типы файлов:**
- Изображения: JPEG, PNG, GIF, WEBP
- Видео: MP4, MPEG, QuickTime, AVI, WebM  
- Документы: PDF, DOC/DOCX, XLS/XLSX, TXT, Markdown, CSV

**Ограничения размеров:**
- Изображения: 10MB
- Видео: 100MB
- Документы: 20MB

**Безопасность:**
- Санитизация имен файлов
- Блокировка исполняемых файлов (.exe, .bat, .cmd, .js и др.)
- Проверка MIME типов
- Ограничение длины имени файла (255 символов)

### 3. Процесс загрузки
1. Валидация файла (тип, размер, имя)
2. Генерация уникального пути в MinIO
3. Загрузка в MinIO через обертку chatFileStorageWrapper
4. Сохранение метаданных в БД (таблица chat_attachments)
5. Обновление счетчика вложений в сообщении
6. Отправка обновления через WebSocket

### 4. Доступ к файлам
- Публичные URL: `/chat-files/{path}`
- Проверка прав доступа через API перед отдачей информации о файле
- Возможность генерации presigned URL для приватного доступа

## Безопасность

### Rate Limiting
- Сообщения: 30 в минуту на пользователя
- Загрузка файлов: 10 в минуту на пользователя
- WebSocket: 5 подключений в минуту

### Проверки безопасности
1. **Аутентификация**: JWT токен обязателен
2. **Авторизация**: Только участники чата могут видеть файлы
3. **Валидация**: Строгая проверка типов и размеров файлов
4. **Санитизация**: Очистка имен файлов от опасных символов
5. **CORS**: Настроен в middleware для защиты от междоменных запросов

### MinIO политики
- Bucket "chat-files" настроен с публичной политикой чтения
- Запись только через backend API
- Автоматическое создание bucket при инициализации

## Потенциальные проблемы

1. **Отсутствие сжатия изображений** - загружаются в оригинальном размере
2. **Нет генерации превью для видео** - метод GenerateVideoThumbnail не реализован
3. **Публичный доступ к файлам** - любой с URL может скачать файл
4. **Нет антивирусной проверки** - потенциальная угроза безопасности
5. **Отсутствие очистки старых файлов** - может привести к переполнению хранилища

## Рекомендации по улучшению

1. Реализовать сжатие изображений перед загрузкой
2. Добавить генерацию превью для видео
3. Реализовать приватный доступ к файлам через presigned URL
4. Добавить антивирусную проверку файлов
5. Реализовать автоматическую очистку старых файлов
6. Добавить водяные знаки на изображения при необходимости
7. Реализовать прогресс загрузки для больших файлов