#!/bin/bash

# Скрипт для переиндексации товаров витрин в OpenSearch

set -e

# Цвета для вывода
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo -e "${GREEN}=== Reindex Storefront Products in OpenSearch ===${NC}"
echo

# Проверка наличия .env файла
if [ ! -f .env ]; then
    echo -e "${RED}Error: .env file not found${NC}"
    exit 1
fi

# Загрузка переменных окружения
export $(cat .env | grep -v '^#' | xargs)

# Проверка подключения к OpenSearch
echo -e "${YELLOW}Checking OpenSearch connection...${NC}"
curl -s -o /dev/null -w "%{http_code}" http://localhost:9200 > /dev/null 2>&1
if [ $? -ne 0 ]; then
    echo -e "${RED}Error: Cannot connect to OpenSearch at localhost:9200${NC}"
    exit 1
fi
echo -e "${GREEN}OpenSearch is accessible${NC}"

# Опции по умолчанию
CREATE_INDEX=false
BATCH_SIZE=100
INDEX_NAME="storefront_products"

# Обработка аргументов командной строки
while [[ $# -gt 0 ]]; do
    case $1 in
        --create)
            CREATE_INDEX=true
            shift
            ;;
        --batch)
            BATCH_SIZE="$2"
            shift 2
            ;;
        --index)
            INDEX_NAME="$2"
            shift 2
            ;;
        --help)
            echo "Usage: $0 [options]"
            echo "Options:"
            echo "  --create       Create new index before reindexing"
            echo "  --batch SIZE   Batch size for indexing (default: 100)"
            echo "  --index NAME   Index name (default: storefront_products)"
            echo "  --help         Show this help message"
            exit 0
            ;;
        *)
            echo -e "${RED}Unknown option: $1${NC}"
            exit 1
            ;;
    esac
done

# Показать текущие настройки
echo -e "${YELLOW}Settings:${NC}"
echo "  Index name: $INDEX_NAME"
echo "  Batch size: $BATCH_SIZE"
echo "  Create index: $CREATE_INDEX"
echo

# Подтверждение
if [ "$CREATE_INDEX" = true ]; then
    echo -e "${YELLOW}WARNING: This will recreate the index '$INDEX_NAME'${NC}"
    echo -n "Are you sure you want to continue? (y/N) "
    read -r response
    if [[ ! "$response" =~ ^[Yy]$ ]]; then
        echo "Aborted."
        exit 0
    fi
fi

# Сборка приложения
echo -e "${YELLOW}Building reindex tool...${NC}"
go build -o bin/reindex-products ./cmd/reindex-products/main.go
if [ $? -ne 0 ]; then
    echo -e "${RED}Error: Failed to build reindex tool${NC}"
    exit 1
fi

# Запуск переиндексации
echo -e "${YELLOW}Starting reindexing...${NC}"
echo

FLAGS=""
if [ "$CREATE_INDEX" = true ]; then
    FLAGS="$FLAGS -create"
fi

./bin/reindex-products -batch $BATCH_SIZE -index $INDEX_NAME $FLAGS

if [ $? -eq 0 ]; then
    echo
    echo -e "${GREEN}Reindexing completed successfully!${NC}"
    
    # Показать статистику индекса
    echo
    echo -e "${YELLOW}Index statistics:${NC}"
    curl -s "http://localhost:9200/$INDEX_NAME/_count" | jq '.count' | xargs echo "Total documents:"
    
    # Показать размер индекса
    curl -s "http://localhost:9200/$INDEX_NAME/_stats/store" | jq '.indices["'$INDEX_NAME'"].total.store.size_in_bytes' | xargs -I {} echo "Index size: $(({} / 1024 / 1024)) MB"
else
    echo
    echo -e "${RED}Reindexing failed!${NC}"
    exit 1
fi