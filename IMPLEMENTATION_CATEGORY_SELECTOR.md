# Инструкция по реализации правильного выбора категорий везде в системе

## Основные принципы

1. **Использовать универсальный компонент CategoryTreeSelector**
2. **Правильно работать с кешем категорий**
3. **Поддерживать неограниченную вложенность**
4. **Обеспечивать единообразный UX во всей системе**

## Универсальный компонент CategoryTreeSelector

✅ **Компонент создан и работает**: `frontend/svetu/src/components/common/CategoryTreeSelector.tsx`

### Основные возможности:
- Рекурсивное отображение дерева категорий любой глубины
- Поддержка single и multi режимов выбора
- Отображение полного пути выбранной категории
- Поиск по категориям
- Правильная работа с кешем
- Визуальная индикация выбранной категории (галочка)
- Иконки для папок (родительские) и файлов (листовые категории)
- Отображение количества товаров в категории (badge)

### API компонента:
```typescript
interface CategoryTreeSelectorProps {
  value?: number | number[];  // ID выбранных категорий
  onChange: (value: number | number[]) => void;
  multiple?: boolean;  // мульти-выбор
  placeholder?: string;
  disabled?: boolean;
  required?: boolean;
  showPath?: boolean;  // показывать полный путь
  allowParentSelection?: boolean;  // разрешить выбор родительских категорий
  maxDepth?: number;  // ограничение глубины (опционально)
  className?: string;
}
```

## Места использования категорий в системе

### 1. Создание/редактирование объявлений ✅
- **Файлы**: 
  - `frontend/svetu/src/app/[locale]/create-listing/page.tsx` (обновлен)
  - `frontend/svetu/src/components/create-listing/steps/CategorySelectionStep.tsx` (обновлен)
  - `frontend/svetu/src/app/[locale]/marketplace/listings/[id]/edit/page.tsx`
- **Требования**:
  - Single выбор ✅
  - Показывать полный путь ✅
  - Запретить выбор родительских категорий (только листья) ✅
- **Реализация**: Компонент встроен прямо в страницу без dropdown для лучшего UX

### 2. Витрины (Showcase)
- **Файлы**:
  - `frontend/svetu/src/app/[locale]/marketplace/showcase/create/page.tsx`
  - `frontend/svetu/src/app/[locale]/marketplace/showcase/[id]/edit/page.tsx`
  - `frontend/svetu/src/app/[locale]/marketplace/showcase/[id]/products/page.tsx`
- **Требования**:
  - Multi выбор для товаров витрины
  - Single выбор для категории самой витрины
  - Показывать количество товаров в категории

### 3. Фильтры на главной странице
- **Файлы**:
  - `frontend/svetu/src/components/marketplace/ListingFilters.tsx`
  - `frontend/svetu/src/app/[locale]/marketplace/page.tsx`
- **Требования**:
  - Multi выбор
  - Показывать количество объявлений
  - Сохранять состояние в URL

### 4. Фильтры на карте
- **Файлы**:
  - `frontend/svetu/src/app/[locale]/map/page.tsx`
  - `frontend/svetu/src/components/map/MapFilters.tsx`
- **Требования**:
  - Multi выбор
  - Компактное отображение
  - Быстрая фильтрация

### 5. Админ-панель категорий
- **Файлы**:
  - `frontend/svetu/src/app/[locale]/admin/categories/page.tsx`
- **Требования**:
  - Редактирование дерева
  - Drag & Drop для изменения структуры
  - Массовые операции

## Работа с кешем

### Backend endpoints с кешем:
- `GET /api/v1/marketplace/categories` - основной endpoint (кеш 6 часов)
- `GET /api/v1/marketplace/categories/tree` - дерево категорий (кеш 6 часов)
- `GET /api/v1/marketplace/categories/{id}` - одна категория (кеш 6 часов)
- `GET /api/v1/admin/categories/all` - админские категории (кеш 6 часов)

### Инвалидация кеша происходит при:
- Создании новой категории
- Обновлении категории
- Удалении категории
- Изменении parent_id

### Ручная очистка кеша:
```bash
# Через Redis CLI
docker exec -it redis redis-cli
KEYS *categories*
DEL <key_name>

# Очистка всего кеша Redis
echo "FLUSHALL" | nc localhost 6379

# Через специальную утилиту
cd backend && go run cmd/cache-monitor/main.go
```

### ВАЖНО о переводах:
Категории кешируются с ключом, зависящим от языка. После изменения переводов в БД необходимо очистить кеш для применения изменений.

## Пошаговая реализация

### Шаг 1: Создание универсального компонента
1. Создать `CategoryTreeSelector.tsx`
2. Реализовать рекурсивное отображение
3. Добавить поддержку поиска
4. Добавить тесты

### Шаг 2: Замена во всех местах
1. Заменить существующие селекторы на CategoryTreeSelector
2. Настроить props для каждого случая использования
3. Проверить работу с кешем
4. Протестировать UX

### Шаг 3: Оптимизация
1. Добавить виртуализацию для больших списков
2. Реализовать lazy loading для глубоких деревьев
3. Добавить keyboard navigation
4. Оптимизировать рендеринг

## Чеклист для проверки

- [ ] Компонент правильно отображает все уровни вложенности
- [ ] Выбор категории работает корректно
- [ ] Отображается полный путь выбранной категории
- [ ] Работает поиск по названию
- [ ] Правильно работает с кешем
- [ ] Единообразный UX во всех местах использования
- [ ] Поддержка i18n (мультиязычность) - использовать useLocale() из next-intl
- [ ] Доступность (a11y)
- [ ] Мобильная адаптивность
- [ ] Правильная передача языка в API запросы (?lang=locale)

## Примеры использования

### В создании объявления:
```tsx
<CategoryTreeSelector
  value={formData.categoryId}
  onChange={(id) => setFormData({...formData, categoryId: id as number})}
  placeholder={t('selectCategory')}
  required
  showPath
  allowParentSelection={false}
/>
```

### В фильтрах:
```tsx
<CategoryTreeSelector
  value={selectedCategories}
  onChange={setSelectedCategories}
  multiple
  placeholder={t('filterByCategory')}
  showPath={false}
/>
```

## Отладка проблем

### Категории не обновляются:
1. Проверить кеш в Redis
2. Очистить кеш вручную
3. Проверить инвалидацию в backend

### Не отображаются вложенные категории:
1. Проверить рекурсивную функцию
2. Убедиться что parent_id правильные
3. Проверить данные из API
4. **Важно**: Backend возвращает плоский список категорий - компонент сам строит дерево

### Проблемы с производительностью:
1. Использовать React.memo
2. Добавить виртуализацию
3. Оптимизировать рекурсию

## Важные открытия при реализации

### 1. UX при создании объявлений
Изначально CategoryTreeSelector был реализован как dropdown компонент, но это создавало лишний клик для пользователя. На странице создания объявлений пользователь приходит именно за выбором категории, поэтому дерево категорий теперь отображается сразу на странице.

### 2. Структура данных из API
Backend возвращает плоский список категорий с полем parent_id. Компонент самостоятельно строит древовидную структуру в два прохода:
- Первый проход: создание Map всех категорий
- Второй проход: построение дерева через связи parent_id

### 3. Иконки без внешних зависимостей
Вместо библиотеки lucide-react используются встроенные SVG компоненты, что уменьшает размер бандла и убирает лишнюю зависимость.

### 4. Визуальные индикаторы состояния
- Папки для родительских категорий, файлы для листовых
- Галочка для выбранной категории
- Badge с количеством товаров (если есть)
- Подсветка выбранной категории цветом primary

### 5. Переводы в правильных местах
Ключи переводов для marketplace компонентов должны быть в секции `marketplace` файлов локализации, а не в корне.