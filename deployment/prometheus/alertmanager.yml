# Alertmanager Configuration for Listings Microservice
# Routes alerts to appropriate channels based on severity

global:
  # Default SMTP configuration (for email notifications)
  smtp_from: 'alerts@svetu.rs'
  smtp_smarthost: 'localhost:25'
  smtp_require_tls: false

  # Slack API URL (set via environment variable in production)
  # slack_api_url: 'https://hooks.slack.com/services/YOUR/WEBHOOK/URL'

  # PagerDuty integration key (set via environment variable in production)
  # pagerduty_url: 'https://events.pagerduty.com/v2/enqueue'

# Templates for notifications
templates:
  - '/etc/alertmanager/templates/*.tmpl'

# Route tree for alert dispatching
route:
  # Default receiver (fallback)
  receiver: 'default'

  # Group alerts by these labels
  group_by: ['alertname', 'service', 'severity']

  # Wait time before sending first notification
  group_wait: 30s

  # Wait time before sending notification about new alerts in existing group
  group_interval: 5m

  # Wait time before re-sending notification
  repeat_interval: 4h

  # Child routes (processed in order)
  routes:
    # ===================================================================
    # CRITICAL ALERTS - PagerDuty (immediate response)
    # ===================================================================
    - match:
        severity: critical
      receiver: 'pagerduty-critical'
      continue: true # Also send to Slack
      group_wait: 10s
      group_interval: 2m
      repeat_interval: 1h

    # ===================================================================
    # SLO ALERTS - PagerDuty (SLO breaches)
    # ===================================================================
    - match:
        slo: 'true'
      receiver: 'pagerduty-slo'
      continue: true
      group_wait: 30s
      group_interval: 5m
      repeat_interval: 2h

    # ===================================================================
    # WARNING ALERTS - Slack (monitoring channel)
    # ===================================================================
    - match:
        severity: warning
      receiver: 'slack-warnings'
      group_wait: 1m
      group_interval: 10m
      repeat_interval: 12h

    # ===================================================================
    # INFO ALERTS - Slack (low priority)
    # ===================================================================
    - match:
        severity: info
      receiver: 'slack-info'
      group_wait: 5m
      group_interval: 30m
      repeat_interval: 24h

# Alert receivers configuration
receivers:
  # ===================================================================
  # DEFAULT RECEIVER
  # ===================================================================
  - name: 'default'
    email_configs:
      - to: 'platform-team@svetu.rs'
        send_resolved: true
        headers:
          Subject: '[ALERT] {{ .GroupLabels.alertname }} - {{ .Status | toUpper }}'

  # ===================================================================
  # PAGERDUTY - CRITICAL ALERTS
  # ===================================================================
  - name: 'pagerduty-critical'
    pagerduty_configs:
      - routing_key: 'YOUR_PAGERDUTY_INTEGRATION_KEY' # CHANGE THIS
        severity: 'critical'
        description: '{{ .GroupLabels.alertname }}: {{ .CommonAnnotations.summary }}'
        details:
          summary: '{{ .CommonAnnotations.summary }}'
          description: '{{ .CommonAnnotations.description }}'
          impact: '{{ .CommonAnnotations.impact }}'
          current_value: '{{ .CommonAnnotations.current_value }}'
          runbook_url: '{{ .CommonAnnotations.runbook_url }}'
          dashboard_url: '{{ .CommonAnnotations.dashboard_url }}'
          num_firing: '{{ .Alerts.Firing | len }}'
          num_resolved: '{{ .Alerts.Resolved | len }}'

  # ===================================================================
  # PAGERDUTY - SLO ALERTS
  # ===================================================================
  - name: 'pagerduty-slo'
    pagerduty_configs:
      - routing_key: 'YOUR_PAGERDUTY_SLO_KEY' # CHANGE THIS
        severity: 'error'
        description: 'SLO Breach: {{ .GroupLabels.alertname }}'
        details:
          summary: '{{ .CommonAnnotations.summary }}'
          slo_target: '{{ .CommonAnnotations.slo_target }}'
          current_value: '{{ .CommonAnnotations.current_value }}'
          runbook_url: '{{ .CommonAnnotations.runbook_url }}'

  # ===================================================================
  # SLACK - WARNING ALERTS
  # ===================================================================
  - name: 'slack-warnings'
    slack_configs:
      - api_url: 'YOUR_SLACK_WEBHOOK_URL' # CHANGE THIS
        channel: '#alerts-warnings'
        send_resolved: true
        icon_emoji: ':warning:'
        title: ':warning: {{ .GroupLabels.alertname }}'
        text: |
          *Summary:* {{ .CommonAnnotations.summary }}
          *Service:* {{ .GroupLabels.service }}
          *Severity:* {{ .GroupLabels.severity | toUpper }}

          *Details:*
          {{ .CommonAnnotations.description }}

          {{ if .CommonAnnotations.current_value }}*Current Value:* {{ .CommonAnnotations.current_value }}{{ end }}
          {{ if .CommonAnnotations.impact }}*Impact:* {{ .CommonAnnotations.impact }}{{ end }}

          {{ if .CommonAnnotations.dashboard_url }}*Dashboard:* {{ .CommonAnnotations.dashboard_url }}{{ end }}

          *Firing Alerts:* {{ .Alerts.Firing | len }}
          {{ if gt (.Alerts.Resolved | len) 0 }}*Resolved Alerts:* {{ .Alerts.Resolved | len }}{{ end }}

        color: '{{ if eq .Status "firing" }}danger{{ else }}good{{ end }}'

        fields:
          - title: 'Severity'
            value: '{{ .GroupLabels.severity | toUpper }}'
            short: true

          - title: 'Service'
            value: '{{ .GroupLabels.service }}'
            short: true

          - title: 'Status'
            value: '{{ .Status | toUpper }}'
            short: true

          - title: 'Alert Count'
            value: '{{ .Alerts.Firing | len }}'
            short: true

  # ===================================================================
  # SLACK - INFO ALERTS
  # ===================================================================
  - name: 'slack-info'
    slack_configs:
      - api_url: 'YOUR_SLACK_WEBHOOK_URL' # CHANGE THIS
        channel: '#alerts-info'
        send_resolved: true
        icon_emoji: ':information_source:'
        title: ':information_source: {{ .GroupLabels.alertname }}'
        text: |
          {{ .CommonAnnotations.summary }}

          *Service:* {{ .GroupLabels.service }}
          {{ .CommonAnnotations.description }}

  # ===================================================================
  # EMAIL - PLATFORM TEAM
  # ===================================================================
  - name: 'email-platform'
    email_configs:
      - to: 'platform-team@svetu.rs'
        send_resolved: true
        headers:
          Subject: '[{{ .Status | toUpper }}] {{ .GroupLabels.alertname }} ({{ .GroupLabels.service }})'
        html: |
          <h2>{{ .GroupLabels.alertname }}</h2>

          <p><strong>Service:</strong> {{ .GroupLabels.service }}</p>
          <p><strong>Severity:</strong> {{ .GroupLabels.severity | toUpper }}</p>
          <p><strong>Status:</strong> {{ .Status | toUpper }}</p>

          <h3>Summary</h3>
          <p>{{ .CommonAnnotations.summary }}</p>

          <h3>Details</h3>
          <p>{{ .CommonAnnotations.description }}</p>

          {{ if .CommonAnnotations.impact }}
          <h3>Impact</h3>
          <p>{{ .CommonAnnotations.impact }}</p>
          {{ end }}

          {{ if .CommonAnnotations.current_value }}
          <p><strong>Current Value:</strong> {{ .CommonAnnotations.current_value }}</p>
          {{ end }}

          {{ if .CommonAnnotations.runbook_url }}
          <p><a href="{{ .CommonAnnotations.runbook_url }}">Runbook</a></p>
          {{ end }}

          {{ if .CommonAnnotations.dashboard_url }}
          <p><a href="{{ .CommonAnnotations.dashboard_url }}">Dashboard</a></p>
          {{ end }}

          <hr>
          <p><strong>Firing Alerts:</strong> {{ .Alerts.Firing | len }}</p>
          {{ if gt (.Alerts.Resolved | len) 0 }}
          <p><strong>Resolved Alerts:</strong> {{ .Alerts.Resolved | len }}</p>
          {{ end }}

# Inhibition rules (suppress alerts based on other active alerts)
inhibit_rules:
  # Inhibit warning alerts if critical alert is firing for the same service
  - source_match:
      severity: 'critical'
    target_match:
      severity: 'warning'
    equal: ['service', 'alertname']

  # Inhibit all alerts if service is down
  - source_match:
      alertname: 'ServiceDown'
    target_match_re:
      alertname: '.*'
    equal: ['service']
