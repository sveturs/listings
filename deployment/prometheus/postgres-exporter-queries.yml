# PostgreSQL Exporter Custom Queries
# Extended metrics for listings database

# ===================================================================
# DATABASE SIZE
# ===================================================================
pg_database_size:
  query: "SELECT pg_database.datname, pg_database_size(pg_database.datname) as size FROM pg_database"
  master: true
  metrics:
    - datname:
        usage: "LABEL"
        description: "Name of the database"
    - size:
        usage: "GAUGE"
        description: "Disk space used by the database"

# ===================================================================
# TABLE SIZES
# ===================================================================
pg_table_size:
  query: |
    SELECT
      schemaname,
      tablename,
      pg_total_relation_size(schemaname||'.'||tablename) AS total_bytes,
      pg_relation_size(schemaname||'.'||tablename) AS data_bytes,
      pg_indexes_size(schemaname||'.'||tablename) AS index_bytes
    FROM pg_tables
    WHERE schemaname NOT IN ('pg_catalog', 'information_schema')
  metrics:
    - schemaname:
        usage: "LABEL"
        description: "Schema name"
    - tablename:
        usage: "LABEL"
        description: "Table name"
    - total_bytes:
        usage: "GAUGE"
        description: "Total size including indexes"
    - data_bytes:
        usage: "GAUGE"
        description: "Table data size"
    - index_bytes:
        usage: "GAUGE"
        description: "Indexes size"

# ===================================================================
# ACTIVE CONNECTIONS BY DATABASE
# ===================================================================
pg_connections_by_database:
  query: |
    SELECT
      datname,
      COUNT(*) as connections
    FROM pg_stat_activity
    GROUP BY datname
  metrics:
    - datname:
        usage: "LABEL"
        description: "Database name"
    - connections:
        usage: "GAUGE"
        description: "Number of active connections"

# ===================================================================
# LONG RUNNING QUERIES
# ===================================================================
pg_long_running_queries:
  query: |
    SELECT
      datname,
      usename,
      COUNT(*) as count
    FROM pg_stat_activity
    WHERE state = 'active'
      AND query NOT LIKE '%pg_stat_activity%'
      AND NOW() - query_start > interval '30 seconds'
    GROUP BY datname, usename
  metrics:
    - datname:
        usage: "LABEL"
        description: "Database name"
    - usename:
        usage: "LABEL"
        description: "User name"
    - count:
        usage: "GAUGE"
        description: "Number of long running queries (>30s)"

# ===================================================================
# BLOAT ESTIMATE
# ===================================================================
pg_table_bloat:
  query: |
    SELECT
      schemaname,
      tablename,
      ROUND((CASE WHEN otta=0 OR sml.relpages=0 OR sml.relpages=otta THEN 0.0
        ELSE sml.relpages/otta::numeric END)::numeric, 1) AS bloat_ratio
    FROM (
      SELECT
        schemaname, tablename, cc.reltuples, cc.relpages, bs,
        CEIL((cc.reltuples*((datahdr+ma-(CASE WHEN datahdr%ma=0 THEN ma ELSE datahdr%ma END))+nullhdr2+4))/(bs-20::float)) AS otta
      FROM (
        SELECT
          ma,bs,schemaname,tablename,
          (datawidth+(hdr+ma-(case when hdr%ma=0 THEN ma ELSE hdr%ma END)))::numeric AS datahdr,
          (maxfracsum*(nullhdr+ma-(case when nullhdr%ma=0 THEN ma ELSE nullhdr%ma END))) AS nullhdr2
        FROM (
          SELECT
            schemaname, tablename, hdr, ma, bs,
            SUM((1-null_frac)*avg_width) AS datawidth,
            MAX(null_frac) AS maxfracsum,
            hdr+(
              SELECT 1+count(*)/8
              FROM pg_stats s2
              WHERE null_frac<>0 AND s2.schemaname = s.schemaname AND s2.tablename = s.tablename
            ) AS nullhdr
          FROM pg_stats s, (
            SELECT (SELECT current_setting('block_size')::numeric) AS bs,
              CASE WHEN substring(v,12,3) IN ('8.0','8.1','8.2') THEN 27 ELSE 23 END AS hdr,
              CASE WHEN v ~ 'mingw32' THEN 8 ELSE 4 END AS ma
            FROM (SELECT version() AS v) AS foo
          ) AS constants
          GROUP BY 1,2,3,4,5
        ) AS foo
      ) AS rs
      JOIN pg_class cc ON cc.relname = rs.tablename
      JOIN pg_namespace nn ON cc.relnamespace = nn.oid AND nn.nspname = rs.schemaname AND nn.nspname <> 'information_schema'
    ) AS sml
    WHERE schemaname NOT IN ('pg_catalog', 'information_schema')
  metrics:
    - schemaname:
        usage: "LABEL"
        description: "Schema name"
    - tablename:
        usage: "LABEL"
        description: "Table name"
    - bloat_ratio:
        usage: "GAUGE"
        description: "Estimated bloat ratio"

# ===================================================================
# REPLICATION LAG
# ===================================================================
pg_replication_lag:
  query: |
    SELECT
      application_name,
      EXTRACT(EPOCH FROM (now() - pg_last_xact_replay_timestamp())) AS lag_seconds
    FROM pg_stat_replication
  master: true
  metrics:
    - application_name:
        usage: "LABEL"
        description: "Replication application name"
    - lag_seconds:
        usage: "GAUGE"
        description: "Replication lag in seconds"

# ===================================================================
# DEADLOCKS
# ===================================================================
pg_deadlocks:
  query: |
    SELECT
      datname,
      deadlocks
    FROM pg_stat_database
    WHERE datname NOT IN ('template0', 'template1', 'postgres')
  metrics:
    - datname:
        usage: "LABEL"
        description: "Database name"
    - deadlocks:
        usage: "COUNTER"
        description: "Number of deadlocks detected"

# ===================================================================
# CACHE HIT RATIO
# ===================================================================
pg_cache_hit_ratio:
  query: |
    SELECT
      datname,
      CASE
        WHEN blks_read + blks_hit = 0 THEN 0
        ELSE (blks_hit::float / (blks_read + blks_hit)) * 100
      END as cache_hit_ratio
    FROM pg_stat_database
    WHERE datname NOT IN ('template0', 'template1', 'postgres')
  metrics:
    - datname:
        usage: "LABEL"
        description: "Database name"
    - cache_hit_ratio:
        usage: "GAUGE"
        description: "Cache hit ratio percentage"
