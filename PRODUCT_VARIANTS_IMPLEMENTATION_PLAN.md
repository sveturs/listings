# 📋 План реализации улучшенной системы вариаций товаров

## 🎯 Цель
Расширить существующую систему вариаций товаров для поддержки раздельного учета остатков по каждой комбинации атрибутов (например, разные остатки для разных цветов/размеров одного товара).

## 📊 Текущее состояние

### ✅ Что уже реализовано:
1. **База данных:**
   - Таблица `storefront_product_variants` с полем `stock_quantity` для каждого варианта
   - JSONB поле `variant_attributes` для хранения атрибутов варианта
   - Таблица `inventory_reservations` для резервирования товаров
   - Глобальные атрибуты в `product_variant_attributes`
   - Связь продуктов с атрибутами через `storefront_product_attributes`

2. **Backend (Go):**
   - Полная структура типов для вариантов (`ProductVariant`, `CreateVariantRequest` и т.д.)
   - API endpoints для управления вариантами
   - Поддержка массового создания вариантов (`GenerateVariantsRequest`)
   - Интеграция с транзакциями заказов

3. **Frontend (React/Next.js):**
   - Компонент `VariantSelector` для выбора вариантов
   - Отображение остатков для выбранного варианта
   - Визуальное представление атрибутов (цветовые кружки для цветов)
   - Динамическое обновление цены и остатков при выборе

### ⚠️ Что требует доработки:
1. Интерфейс создания/редактирования вариантов в админке витрины
2. Массовое управление остатками вариантов
3. Интеграция вариантов с OpenSearch для поиска
4. Отображение вариантов в листинге товаров
5. Аналитика по вариантам

## 🏗️ Архитектура решения

### 1. Структура данных

#### Атрибуты с раздельным учетом остатков:
```sql
-- Добавить в product_variant_attributes новое поле
ALTER TABLE product_variant_attributes 
ADD COLUMN affects_stock BOOLEAN NOT NULL DEFAULT false;

-- Примеры атрибутов:
-- color (affects_stock = true) - разные остатки для разных цветов
-- size (affects_stock = true) - разные остатки для разных размеров  
-- warranty (affects_stock = false) - не влияет на остатки
```

#### Матрица вариантов:
Для товара "iPhone 15" с атрибутами:
- Память: 128GB, 256GB, 512GB (affects_stock = true)
- Цвет: Black, White, Blue (affects_stock = true)
- Гарантия: 1 год, 2 года (affects_stock = false)

Создается 9 вариантов с раздельными остатками (3 памяти × 3 цвета).

### 2. UI/UX компоненты

#### 2.1 Страница создания/редактирования товара в витрине:

```typescript
// components/Storefront/ProductVariants/VariantManager.tsx
interface VariantManagerProps {
  productId: number;
  onSave: (variants: ProductVariant[]) => void;
}

// Функциональность:
// - Выбор атрибутов для товара
// - Настройка влияния на остатки (affects_stock)
// - Генерация матрицы вариантов
// - Массовое заполнение остатков
// - Загрузка изображений для вариантов
```

#### 2.2 Таблица управления остатками:

```typescript
// components/Storefront/Inventory/VariantStockTable.tsx
// Табличное представление всех вариантов с возможностью:
// - Быстрого редактирования остатков
// - Массовых операций (добавить/убрать N единиц)
// - Фильтрации по атрибутам
// - Экспорта/импорта через CSV
```

#### 2.3 Улучшенный селектор вариантов на странице товара:

```typescript
// Добавить в существующий VariantSelector:
// - Визуальные индикаторы остатков
// - Предпросмотр изображений варианта
// - Быстрый выбор популярных комбинаций
// - Уведомление о поступлении товара
```

### 3. Backend API расширения

#### 3.1 Новые endpoints:

```go
// GET /api/v1/storefront/products/{id}/variant-matrix
// Получить матрицу всех возможных комбинаций атрибутов

// POST /api/v1/storefront/products/{id}/variants/bulk-update-stock
// Массовое обновление остатков

// POST /api/v1/storefront/products/{id}/variants/import
// Импорт вариантов из CSV

// GET /api/v1/storefront/products/{id}/variants/export
// Экспорт вариантов в CSV
```

#### 3.2 Интеграция с поиском:

```json
// Структура документа в OpenSearch
{
  "id": 123,
  "title": "iPhone 15",
  "variants": [
    {
      "id": 1,
      "attributes": {
        "memory": "128GB",
        "color": "Black"
      },
      "price": 799,
      "stock_quantity": 10,
      "sku": "IP15-128-BLK"
    }
  ],
  "min_price": 799,
  "max_price": 1199,
  "total_stock": 45,
  "available_attributes": {
    "memory": ["128GB", "256GB", "512GB"],
    "color": ["Black", "White", "Blue"]
  }
}
```

### 4. Миграции базы данных

```sql
-- 000178_add_affects_stock_to_attributes.up.sql
ALTER TABLE product_variant_attributes 
ADD COLUMN affects_stock BOOLEAN NOT NULL DEFAULT false;

-- Обновить существующие атрибуты
UPDATE product_variant_attributes 
SET affects_stock = true 
WHERE name IN ('size', 'color', 'memory', 'storage');

-- 000179_add_variant_analytics.up.sql
CREATE TABLE variant_analytics (
    id SERIAL PRIMARY KEY,
    variant_id INTEGER NOT NULL REFERENCES storefront_product_variants(id),
    date DATE NOT NULL,
    views INTEGER DEFAULT 0,
    add_to_cart INTEGER DEFAULT 0,
    purchases INTEGER DEFAULT 0,
    revenue DECIMAL(15,2) DEFAULT 0,
    UNIQUE(variant_id, date)
);

CREATE INDEX idx_variant_analytics_date ON variant_analytics(date);
CREATE INDEX idx_variant_analytics_variant_id ON variant_analytics(variant_id);
```

## 📅 План реализации

### Этап 1: Backend подготовка (2-3 дня)
- [ ] Создать миграции для affects_stock и аналитики
- [ ] Реализовать API для матрицы вариантов
- [ ] Добавить endpoints для массовых операций
- [ ] Расширить интеграцию с OpenSearch

### Этап 2: UI для управления вариантами (3-4 дня)
- [ ] Компонент VariantManager для создания/редактирования
- [ ] Таблица управления остатками VariantStockTable
- [ ] Интеграция с формой создания товара
- [ ] CSV импорт/экспорт

### Этап 3: Улучшения покупательского опыта (2-3 дня)
- [ ] Расширить VariantSelector визуальными индикаторами
- [ ] Добавить фильтры по вариантам в листинг
- [ ] Показывать диапазон цен для товаров с вариантами
- [ ] Quick view с выбором варианта

### Этап 4: Аналитика и оптимизация (2 дня)
- [ ] Dashboard с аналитикой по вариантам
- [ ] Рекомендации популярных комбинаций
- [ ] A/B тестирование отображения вариантов
- [ ] Оптимизация производительности

## 🎨 UI/UX примеры

### Селектор вариантов (улучшенный):
```
┌─────────────────────────────────────┐
│ Выберите конфигурацию:              │
├─────────────────────────────────────┤
│ Память:                             │
│ [128GB] [256GB✓] [512GB]           │
│                                     │
│ Цвет:                               │
│ [●] [○] [●]  ← с индикацией остатков│
│  5   0   12                         │
│                                     │
│ 899 € (В наличии: 12 шт)           │
│ SKU: IP15-256-BLUE                  │
└─────────────────────────────────────┘
```

### Таблица управления остатками:
```
┌────────────┬────────┬────────┬────────┬────────┐
│ Вариант    │ SKU    │ Цена   │ Остаток│ Действия│
├────────────┼────────┼────────┼────────┼────────┤
│ 128GB/Black│ IP15...│ 799 €  │ [10] ▼ │ ✏️ 🗑️  │
│ 128GB/White│ IP15...│ 799 €  │ [15] ▼ │ ✏️ 🗑️  │
│ 256GB/Black│ IP15...│ 899 €  │ [0]  ▼ │ ✏️ 🗑️  │
└────────────┴────────┴────────┴────────┴────────┘
[Массовые операции ▼] [Импорт CSV] [Экспорт]
```

## 🔧 Технические детали

### Оптимизация производительности:
1. Кэширование матрицы вариантов в Redis
2. Lazy loading изображений вариантов
3. Дебаунс при изменении остатков
4. Batch операции для массовых обновлений

### Безопасность:
1. Проверка прав на редактирование вариантов
2. Лимиты на количество вариантов (max 100 на товар)
3. Валидация атрибутов при создании
4. Аудит изменений остатков

## 📊 Метрики успеха

1. **Технические:**
   - Время загрузки страницы с вариантами < 2с
   - Успешность синхронизации остатков > 99.9%
   - Покрытие тестами > 80%

2. **Бизнес:**
   - Увеличение конверсии на 15-20%
   - Снижение возвратов из-за неправильного выбора варианта
   - Рост среднего чека за счет апселла вариантов

## 🚀 MVP функциональность

Для первого релиза достаточно:
1. ✅ Базовое создание вариантов с остатками
2. ✅ Селектор на странице товара
3. ✅ Простая таблица управления остатками
4. ✅ Интеграция с корзиной и заказами

## если силы останутся, то и
- CSV импорт/экспорт
- Расширенная аналитика
- A/B тестирование
- Рекомендации комбинаций
